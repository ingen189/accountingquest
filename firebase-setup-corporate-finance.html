<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup - Corporate Finance</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0f1419;
            color: #e0e0e0;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.6;
        }
        h1 { color: #4ade80; margin-bottom: 10px; }
        h2 { color: #60a5fa; margin-top: 30px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        h3 { color: #f59e0b; }
        
        .card {
            background: #1a1f26;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .btn {
            background: #4ade80;
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 5px;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-orange { background: #f59e0b; color: black; }
        .btn-red { background: #ef4444; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        
        #log {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
        }
        .log-success { color: #4ade80; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .log-warn { color: #f59e0b; }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-ok { background: #166534; color: #4ade80; }
        .status-error { background: #7f1d1d; color: #fca5a5; }
        .status-pending { background: #1e3a5f; color: #93c5fd; }
        
        textarea {
            width: 100%;
            height: 150px;
            background: #1a1f26;
            color: #e0e0e0;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 12px;
            font-family: monospace;
            font-size: 0.9em;
            resize: vertical;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 700px) {
            .grid-2 { grid-template-columns: 1fr; }
        }
        
        code {
            background: #2d3748;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .tree {
            font-family: monospace;
            background: #1a1f26;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.8;
        }
        .tree-folder { color: #f59e0b; }
        .tree-file { color: #4ade80; }
        .tree-comment { color: #6b7280; }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Firebase Setup - Corporate Finance</h1>
    <p>Dette verktÃ¸yet hjelper deg Ã¥ sette opp riktig Firebase-struktur for Corporate Finance modulen.</p>
    
    <h2>ğŸ“Š Ã˜nsket Struktur</h2>
    <div class="tree">
<span class="tree-folder">ğŸ“ modules/</span>
   â””â”€â”€ <span class="tree-folder">corporate_finance/</span>
         â”œâ”€â”€ name: "Corporate Finance"
         â”œâ”€â”€ icon: "ğŸ“ˆ"
         â”œâ”€â”€ topics: [npv, wacc, bonds, ...]
         â””â”€â”€ enabled: true

<span class="tree-folder">ğŸ“ questions/</span> <span class="tree-comment"># SpÃ¸rsmÃ¥l (synlig for brukere)</span>
   â””â”€â”€ <span class="tree-folder">corporate_finance/</span>
         â””â”€â”€ <span class="tree-file">{questionId}</span>
               â”œâ”€â”€ id, title, question, topic, type
               â”œâ”€â”€ options (for MC)
               â””â”€â”€ data, grid (for Excel)

<span class="tree-folder">ğŸ“ solutions/</span> <span class="tree-comment"># Fasit (krever auth)</span>
   â””â”€â”€ <span class="tree-folder">corporate_finance/</span>
         â””â”€â”€ <span class="tree-file">{questionId}</span>
               â”œâ”€â”€ correct: "a"
               â”œâ”€â”€ explanation: "..."
               â””â”€â”€ hints: [...]

<span class="tree-folder">ğŸ“ user_progress/</span>
   â””â”€â”€ <span class="tree-folder">{userId}/</span>
         â””â”€â”€ <span class="tree-folder">corporate_finance/</span>
               â””â”€â”€ <span class="tree-file">{topicId}</span>
    </div>
    
    <h2>ğŸ”Œ 1. Firebase Tilkobling</h2>
    <div class="card">
        <p>Status: <span class="status status-pending" id="firebase-status">Kobler til...</span></p>
        <p>Bruker: <span id="user-status">-</span></p>
        <button class="btn btn-blue" onclick="checkFirebase()">ğŸ”„ Sjekk tilkobling</button>
    </div>
    
    <h2>ğŸ“‹ 2. Sjekk Eksisterende Data</h2>
    <div class="card">
        <div class="grid-2">
            <div>
                <h3>NÃ¥vÃ¦rende stier:</h3>
                <p id="current-paths">Klikk "Analyser" for Ã¥ se...</p>
            </div>
            <div>
                <h3>Antall spÃ¸rsmÃ¥l:</h3>
                <p id="question-counts">-</p>
            </div>
        </div>
        <button class="btn btn-blue" onclick="analyzeDatabase()">ğŸ” Analyser Database</button>
    </div>
    
    <h2>ğŸš€ 3. Setup & Migrering</h2>
    <div class="card">
        <h3>Velg handling:</h3>
        <button class="btn" onclick="setupModuleMetadata()">ğŸ“ 1. Opprett Module Metadata</button>
        <button class="btn btn-orange" onclick="migrateFromCorporateFinance()">ğŸ“¦ 2. Migrer fra corporateFinance/</button>
        <button class="btn btn-purple" onclick="importFromJSON()">ğŸ“„ 3. Importer fra JSON</button>
        <br><br>
        <p><strong>RekkefÃ¸lge:</strong> KjÃ¸r 1 fÃ¸rst, deretter enten 2 (hvis du har data i corporateFinance/) eller 3 (hvis du har JSON-fil).</p>
    </div>
    
    <h2>ğŸ“„ 4. JSON Import</h2>
    <div class="card">
        <p>Lim inn JSON-array med spÃ¸rsmÃ¥l (fra bok260_24v2_questions.json eller lignende):</p>
        <textarea id="jsonInput" placeholder='[{"id": "cf_001", "topic": "wacc", ...}, ...]'></textarea>
        <br><br>
        <input type="file" id="fileInput" accept=".json" onchange="loadFile(event)">
        <br><br>
        <button class="btn btn-purple" onclick="previewJSON()">ğŸ‘ï¸ ForhÃ¥ndsvis</button>
        <button class="btn" onclick="importJSON()">ğŸš€ Importer til Firebase</button>
    </div>
    
    <h2>ğŸ“œ Logg</h2>
    <div id="log"></div>
    <button class="btn btn-red" onclick="clearLog()">ğŸ—‘ï¸ TÃ¸m logg</button>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "525417361926",
            appId: "1:525417361926:web:ec9b737f82af9b21700987"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        // Logging
        function log(msg, type = '') {
            const el = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `<span class="log-${type}">[${time}] ${msg}</span>\n`;
            el.scrollTop = el.scrollHeight;
        }
        function clearLog() { document.getElementById('log').innerHTML = ''; }
        
        // Check Firebase connection
        async function checkFirebase() {
            const statusEl = document.getElementById('firebase-status');
            const userEl = document.getElementById('user-status');
            
            try {
                // Sign in
                const result = await auth.signInAnonymously();
                statusEl.textContent = 'Tilkoblet âœ“';
                statusEl.className = 'status status-ok';
                userEl.textContent = result.user.uid;
                log('Firebase tilkoblet! UID: ' + result.user.uid, 'success');
            } catch (e) {
                statusEl.textContent = 'Feil!';
                statusEl.className = 'status status-error';
                log('Firebase feil: ' + e.message, 'error');
            }
        }
        
        // Analyze database
        async function analyzeDatabase() {
            log('Analyserer database...', 'info');
            
            const paths = [
                'corporateFinance/exercises',
                'questions/corporate_finance',
                'solutions/corporate_finance',
                'modules/corporate_finance'
            ];
            
            let html = '';
            let counts = {};
            
            for (const path of paths) {
                try {
                    const snap = await db.ref(path).once('value');
                    const data = snap.val();
                    const count = data ? Object.keys(data).length : 0;
                    const status = count > 0 ? 'âœ…' : 'âŒ';
                    html += `${status} <code>${path}</code>: ${count} items<br>`;
                    counts[path] = count;
                    log(`${path}: ${count} items`, count > 0 ? 'success' : 'warn');
                } catch (e) {
                    html += `âš ï¸ <code>${path}</code>: Feil<br>`;
                    log(`${path}: ${e.message}`, 'error');
                }
            }
            
            document.getElementById('current-paths').innerHTML = html;
            
            // Summary
            const total = (counts['questions/corporate_finance'] || 0) + (counts['corporateFinance/exercises'] || 0);
            document.getElementById('question-counts').textContent = `${total} totalt funnet`;
        }
        
        // Setup module metadata
        async function setupModuleMetadata() {
            log('Oppretter module metadata...', 'info');
            
            try {
                await db.ref('modules/corporate_finance').set({
                    name: 'Corporate Finance',
                    icon: 'ğŸ“ˆ',
                    enabled: true,
                    topics: ['npv', 'irr', 'wacc', 'capm', 'bonds', 'stocks', 'portfolio', 'annuity', 'forex', 'options'],
                    lastUpdated: new Date().toISOString()
                });
                log('âœ“ modules/corporate_finance opprettet!', 'success');
            } catch (e) {
                log('Feil: ' + e.message, 'error');
            }
        }
        
        // Migrate from corporateFinance/exercises
        async function migrateFromCorporateFinance() {
            log('Starter migrering fra corporateFinance/exercises...', 'info');
            
            try {
                const snap = await db.ref('corporateFinance/exercises').once('value');
                const data = snap.val();
                
                if (!data) {
                    log('Ingen data funnet i corporateFinance/exercises', 'warn');
                    return;
                }
                
                const questions = Object.entries(data);
                log(`Fant ${questions.length} spÃ¸rsmÃ¥l Ã¥ migrere`, 'info');
                
                let success = 0;
                let errors = 0;
                
                for (const [id, q] of questions) {
                    try {
                        // Prepare question data (without solution)
                        const questionData = {
                            id: id,
                            module: 'corporate_finance',
                            topic: q.topic || 'mixed',
                            difficulty: q.difficulty || 'medium',
                            type: q.type || 'calculation',
                            title: q.title || id,
                            question: q.question || q.q || '',
                            options: q.options || null,
                            data: q.data || null,
                            grid: q.grid || null,
                            source: q.source || null,
                            tags: q.tags || null
                        };
                        
                        // Remove nulls
                        Object.keys(questionData).forEach(k => {
                            if (questionData[k] === null) delete questionData[k];
                        });
                        
                        // Prepare solution data
                        const solutionData = {
                            correct: q.answer || q.correct || (q.solution && q.solution.correct),
                            explanation: q.explanation || q.exp || (q.solution && q.solution.explanation),
                            hints: q.hints || (q.solution && q.solution.hints) || [],
                            tolerance: q.tolerance || null,
                            formula: q.formula || null
                        };
                        
                        Object.keys(solutionData).forEach(k => {
                            if (solutionData[k] === null) delete solutionData[k];
                        });
                        
                        // Write to new paths
                        await db.ref('questions/corporate_finance/' + id).set(questionData);
                        await db.ref('solutions/corporate_finance/' + id).set(solutionData);
                        
                        success++;
                        log(`âœ“ ${id}`, 'success');
                    } catch (e) {
                        errors++;
                        log(`âœ— ${id}: ${e.message}`, 'error');
                    }
                }
                
                log(`\nMigrering fullfÃ¸rt! ${success} OK, ${errors} feil`, success > 0 ? 'success' : 'error');
                
            } catch (e) {
                log('Migrering feilet: ' + e.message, 'error');
            }
        }
        
        // Load file
        function loadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('jsonInput').value = e.target.result;
                log('Fil lastet: ' + file.name, 'success');
            };
            reader.readAsText(file);
        }
        
        // Preview JSON
        function previewJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                log('Ingen JSON Ã¥ forhÃ¥ndsvise', 'warn');
                return;
            }
            
            try {
                const data = JSON.parse(input);
                const questions = Array.isArray(data) ? data : Object.values(data);
                
                log(`=== FORHÃ…NDSVISNING ===`, 'info');
                log(`Totalt: ${questions.length} spÃ¸rsmÃ¥l`, 'info');
                
                // Count by topic
                const topics = {};
                questions.forEach(q => {
                    const t = q.topic || 'unknown';
                    topics[t] = (topics[t] || 0) + 1;
                });
                
                log('\nPer topic:', 'info');
                Object.entries(topics).forEach(([t, c]) => log(`  ${t}: ${c}`));
                
                if (questions.length > 0) {
                    log('\nFÃ¸rste spÃ¸rsmÃ¥l:', 'info');
                    log(`  ID: ${questions[0].id}`);
                    log(`  Title: ${questions[0].title}`);
                    log(`  Topic: ${questions[0].topic}`);
                }
                
            } catch (e) {
                log('Ugyldig JSON: ' + e.message, 'error');
            }
        }
        
        // Import JSON
        async function importJSON() {
            const input = document.getElementById('jsonInput').value.trim();
            if (!input) {
                log('Ingen JSON Ã¥ importere', 'warn');
                return;
            }
            
            try {
                const data = JSON.parse(input);
                const questions = Array.isArray(data) ? data : Object.values(data);
                
                log(`Starter import av ${questions.length} spÃ¸rsmÃ¥l...`, 'info');
                
                let success = 0;
                let errors = 0;
                
                for (const q of questions) {
                    const id = q.id;
                    if (!id) {
                        log('SpÃ¸rsmÃ¥l mangler ID, hopper over', 'warn');
                        errors++;
                        continue;
                    }
                    
                    try {
                        // Question data
                        const questionData = {
                            id: id,
                            module: q.module || 'corporate_finance',
                            category: q.category || 'corporate_finance',
                            topic: q.topic,
                            difficulty: q.difficulty || 'medium',
                            type: q.type,
                            title: q.title,
                            question: q.question || q.q,
                            q: q.q,
                            options: q.options || null,
                            data: q.data || null,
                            grid: q.grid || null,
                            template: q.template || null,
                            dropZones: q.dropZones || null,
                            draggables: q.draggables || null,
                            pairs: q.pairs || null,
                            categories: q.categories || null,
                            items: q.items || null,
                            input_fields: q.input_fields || null,
                            source: q.source || null,
                            tags: q.tags || null,
                            wiki: q.wiki || null,
                            linkedTo: q.linkedTo || null,
                            variant: q.variant || null,
                            subtype: q.subtype || null
                        };
                        
                        // Remove nulls
                        Object.keys(questionData).forEach(k => {
                            if (questionData[k] === null || questionData[k] === undefined) delete questionData[k];
                        });
                        
                        // Solution data
                        const solutionData = {
                            correct: q.answer || q.a || (q.options ? q.options.find(o => o.correct)?.id : null),
                            answer: q.answer,
                            explanation: q.explanation || q.exp,
                            exp: q.exp,
                            formula: q.formula || null,
                            hints: q.hints || [],
                            tolerance: q.tolerance || null,
                            steps: q.steps || null,
                            scoring: q.scoring || null
                        };
                        
                        Object.keys(solutionData).forEach(k => {
                            if (solutionData[k] === null || solutionData[k] === undefined) delete solutionData[k];
                        });
                        
                        // Write
                        await db.ref('questions/corporate_finance/' + id).set(questionData);
                        await db.ref('solutions/corporate_finance/' + id).set(solutionData);
                        
                        success++;
                        if (success % 10 === 0) {
                            log(`Importert ${success}/${questions.length}...`, 'info');
                        }
                        
                    } catch (e) {
                        errors++;
                        log(`âœ— ${id}: ${e.message}`, 'error');
                    }
                }
                
                log(`\n=== IMPORT FULLFÃ˜RT ===`, 'info');
                log(`âœ“ Suksess: ${success}`, 'success');
                if (errors > 0) log(`âœ— Feil: ${errors}`, 'error');
                
                // Update metadata
                await db.ref('modules/corporate_finance').update({
                    lastUpdated: new Date().toISOString(),
                    questionCount: success
                });
                log('Metadata oppdatert', 'success');
                
            } catch (e) {
                log('Import feilet: ' + e.message, 'error');
            }
        }
        
        function importFromJSON() {
            document.getElementById('jsonInput').focus();
            log('Last opp JSON-fil eller lim inn data, deretter klikk "Importer til Firebase"', 'info');
        }
        
        // Auto-connect on load
        window.onload = checkFirebase;
    </script>
</body>
</html>
