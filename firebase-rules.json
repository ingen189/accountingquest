{
  "rules": {
    // =====================
    // MULTIPLAYER GAMES
    // =====================
    "games": {
      "$gamePin": {
        // Anyone can read game info (needed for joining)
        ".read": true,
        
        // Only authenticated users can create games
        ".write": "auth != null && !data.exists()",
        
        // Game metadata
        "quiz": {
          ".write": "auth != null && !data.exists()"
        },
        "status": {
          ".write": "auth != null"
        },
        "hostId": {
          ".write": "auth != null && !data.exists()"
        },
        
        // Current question - only host can update
        "currentQuestion": {
          ".write": "auth != null && data.parent().child('hostId').val() == auth.uid"
        },
        "currentQuestionIndex": {
          ".write": "auth != null && data.parent().child('hostId').val() == auth.uid"
        },
        
        // Players - anyone can join (with validation)
        "players": {
          "$oderId": {
            // Spillere kan opprette seg selv, men KUN HOST kan endre score
            ".write": "!data.exists() || data.parent().parent().child('hostId').val() == auth.uid",
            ".validate": "newData.hasChildren(['name', 'joinedAt'])",
            
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 30"
            },
            "avatar": {
              ".validate": "newData.isString() && newData.val().length <= 10"
            },
            "score": {
              // KUN HOST kan endre score - anti-cheat!
              ".write": "data.parent().parent().parent().child('hostId').val() == auth.uid",
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "correctCount": {
              ".write": "data.parent().parent().parent().child('hostId').val() == auth.uid",
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "joinedAt": {
              ".validate": "newData.val() <= now"
            }
          }
        },
        
        // Answers - players can only submit their own
        "answers": {
          "$oderId": {
            // Spillere kan sende svar, host kan legge til scored/points
            ".write": "true",
            ".validate": "newData.hasChildren(['questionIndex'])",
            
            "questionIndex": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "answer": {
              ".validate": "true"
            },
            "type": {
              ".validate": "newData.isString()"
            },
            "timeLeft": {
              ".validate": "newData.isNumber() && newData.val() >= 0"
            },
            "answeredAt": {
              ".validate": "newData.val() <= now + 5000"
            },
            // Disse feltene settes KUN av host etter validering
            "scored": {
              ".write": "data.parent().parent().parent().child('hostId').val() == auth.uid",
              ".validate": "newData.isBoolean()"
            },
            "correct": {
              ".write": "data.parent().parent().parent().child('hostId').val() == auth.uid",
              ".validate": "newData.isBoolean()"
            },
            "points": {
              ".write": "data.parent().parent().parent().child('hostId').val() == auth.uid",
              ".validate": "newData.isNumber()"
            }
          }
        }
      }
    },
    
    // =====================
    // PUBLIC QUIZZES
    // =====================
    "public_quizzes": {
      // Anyone can read public quizzes
      ".read": true,
      
      "$quizId": {
        // Only authenticated users can create/edit their own quizzes
        ".write": "auth != null && (!data.exists() || data.child('createdBy').val() == auth.uid)",
        
        ".validate": "newData.hasChildren(['title', 'questions', 'createdAt'])",
        
        "title": {
          ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 100"
        },
        "description": {
          ".validate": "newData.isString() && newData.val().length <= 500"
        },
        "category": {
          ".validate": "newData.isString()"
        },
        "language": {
          ".validate": "newData.isString() && newData.val().length == 2"
        },
        "questions": {
          ".validate": "newData.hasChildren()"
        },
        "createdBy": {
          ".validate": "newData.val() == auth.uid"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        }
      }
    },
    
    // =====================
    // USER PROGRESS (Single-player)
    // =====================
    "user_progress": {
      "$userId": {
        // Users can only read/write their own progress
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId",
        
        "bokforing": {
          "$lessonId": {
            "completed": { ".validate": "newData.isBoolean()" },
            "score": { ".validate": "newData.isNumber() && newData.val() >= 0" },
            "attempts": { ".validate": "newData.isNumber() && newData.val() >= 0" },
            "lastAttempt": { ".validate": "newData.isNumber()" }
          }
        },
        "quiz": {
          "$category": {
            "completed": { ".validate": "newData.isNumber() && newData.val() >= 0" },
            "correct": { ".validate": "newData.isNumber() && newData.val() >= 0" },
            "lastAttempt": { ".validate": "newData.isNumber()" }
          }
        },
        "analyse": {
          "$taskId": {
            "completed": { ".validate": "newData.isBoolean()" },
            "score": { ".validate": "newData.isNumber()" },
            "lastAttempt": { ".validate": "newData.isNumber()" }
          }
        },
        "case_studies": {
          "$caseId": {
            "completed": { ".validate": "newData.isBoolean()" },
            "score": { ".validate": "newData.isNumber()" },
            "lastAttempt": { ".validate": "newData.isNumber()" }
          }
        },
        "hjernetrim": {
          "$challengeId": {
            "completed": { ".validate": "newData.isBoolean()" },
            "score": { ".validate": "newData.isNumber()" },
            "lastAttempt": { ".validate": "newData.isNumber()" }
          }
        },
        "achievements": {
          "$achievementId": {
            "unlockedAt": { ".validate": "newData.isNumber()" }
          }
        },
        "stats": {
          "totalScore": { ".validate": "newData.isNumber()" },
          "totalTime": { ".validate": "newData.isNumber()" },
          "streak": { ".validate": "newData.isNumber()" },
          "lastActive": { ".validate": "newData.isNumber()" }
        }
      }
    },
    
    // =====================
    // DUELS (1v1)
    // =====================
    "duels": {
      // Open duels - anyone can read to find opponents
      "open": {
        ".read": true,
        "$duelId": {
          ".write": "auth != null",
          ".validate": "newData.hasChildren(['challengerId', 'category', 'createdAt'])",
          
          "challengerId": { ".validate": "newData.val() == auth.uid" },
          "challengerName": { ".validate": "newData.isString()" },
          "category": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isNumber()" }
        }
      },
      
      // Active duels
      "active": {
        "$duelId": {
          ".read": "auth != null && (data.child('player1/id').val() == auth.uid || data.child('player2/id').val() == auth.uid)",
          ".write": "auth != null && (data.child('player1/id').val() == auth.uid || data.child('player2/id').val() == auth.uid || !data.exists())",
          
          "player1": {
            "id": { ".validate": "newData.isString()" },
            "name": { ".validate": "newData.isString()" },
            "score": { ".validate": "newData.isNumber()" },
            "answers": { ".validate": "true" }
          },
          "player2": {
            "id": { ".validate": "newData.isString()" },
            "name": { ".validate": "newData.isString()" },
            "score": { ".validate": "newData.isNumber()" },
            "answers": { ".validate": "true" }
          },
          "questions": { ".validate": "true" },
          "currentQuestion": { ".validate": "newData.isNumber()" },
          "status": { ".validate": "newData.isString()" },
          "winner": { ".validate": "newData.isString()" }
        }
      },
      
      // Duel history
      "history": {
        "$oderId": {
          ".read": "auth != null && (data.child('player1').val() == auth.uid || data.child('player2').val() == auth.uid)",
          ".write": "auth != null"
        }
      }
    },
    
    // =====================
    // LEADERBOARDS
    // =====================
    "leaderboards": {
      ".read": true,
      
      "weekly": {
        "$oderId": {
          ".write": "auth != null && $oderId == auth.uid",
          ".validate": "newData.hasChildren(['name', 'score'])",
          "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "score": { ".validate": "newData.isNumber() && newData.val() >= 0" },
          "updatedAt": { ".validate": "newData.isNumber()" }
        }
      },
      "allTime": {
        "$oderId": {
          ".write": "auth != null && $oderId == auth.uid",
          "name": { ".validate": "newData.isString() && newData.val().length <= 30" },
          "score": { ".validate": "newData.isNumber() && newData.val() >= 0" }
        }
      }
    },
    
    // =====================
    // GAME RESULTS (for export)
    // =====================
    "game_results": {
      "$gamePin": {
        // Only host can read/write results
        ".read": "auth != null",
        ".write": "auth != null",
        
        "quiz": { ".validate": "true" },
        "players": { ".validate": "true" },
        "answers": { ".validate": "true" },
        "completedAt": { ".validate": "newData.isNumber()" }
      }
    }
  }
}
