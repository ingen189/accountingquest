<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duell - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öîÔ∏è</text></svg>">
    <meta name="theme-color" content="#0f1419">

    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
        
    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ===== PAGE SPECIFIC STYLES ===== */

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 30px;
        }
        .logo { font-size: 1.8em; font-weight: bold; color: var(--accent); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { font-size: 2em; }
        .user-stats { text-align: right; }
        .user-name { font-weight: bold; }
        .user-record { color: var(--text-secondary); font-size: 0.9em; }

        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Lobby */
        .lobby-title { text-align: center; font-size: 2.5em; margin-bottom: 30px; }
        .lobby-title span { color: var(--accent); }

        .action-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        .action-card {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .action-card:hover { border-color: var(--accent); transform: translateY(-5px); }
        .action-card .icon { font-size: 4em; margin-bottom: 15px; }
        .action-card h3 { font-size: 1.5em; margin-bottom: 10px; }
        .action-card p { color: var(--text-secondary); }

        /* Category Selection */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .category-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .category-btn:hover, .category-btn.selected { 
            border-color: var(--accent); 
            background: rgba(74, 222, 128, 0.1); 
        }
        .category-btn .icon { font-size: 2.5em; margin-bottom: 10px; display: block; }

        /* Waiting for opponent */
        .waiting-box {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            margin: 30px 0;
        }
        .waiting-icon { font-size: 5em; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .waiting-text { font-size: 1.5em; margin-top: 20px; color: var(--text-secondary); }
        .cancel-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 30px;
        }
        .cancel-btn:hover { background: #555; }

        /* Open Duels List */
        .duels-list { margin-top: 30px; }
        .duels-list h3 { margin-bottom: 20px; color: var(--accent); }
        .duel-item {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .duel-info { display: flex; align-items: center; gap: 15px; }
        .duel-challenger { font-weight: bold; font-size: 1.2em; }
        .duel-category { color: var(--text-secondary); }
        .join-btn {
            background: var(--accent);
            color: #1a1a2e;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .join-btn:hover { background: var(--accent-hover); }

        /* Duel Arena */
        .arena-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .player-box {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 20px 30px;
            text-align: center;
            min-width: 200px;
        }
        .player-box.me { border-color: var(--accent); }
        .player-box.opponent { border-color: var(--warning); }
        .player-box .avatar { font-size: 3em; }
        .player-box .name { font-weight: bold; margin: 10px 0; }
        .player-box .score { font-size: 2em; color: var(--accent); font-weight: bold; }
        .vs-text { font-size: 3em; font-weight: bold; color: var(--error); }

        .question-box {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }
        .question-number { color: var(--text-secondary); margin-bottom: 15px; }
        .question-text { font-size: 1.8em; line-height: 1.4; }
        .timer-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-top: 20px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.1s linear;
        }
        .timer-fill.warning { background: var(--warning); }
        .timer-fill.danger { background: var(--error); }

        .answers-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .answer-btn {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px;
            font-size: 1.1em;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }
        .answer-btn:hover:not(:disabled) { border-color: var(--accent); }
        .answer-btn.selected { background: var(--accent); color: #1a1a2e; border-color: var(--accent); }
        .answer-btn.correct { background: var(--accent-hover); border-color: var(--accent-hover); }
        .answer-btn.wrong { background: var(--error); border-color: var(--error); }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.7; }

        /* Results */
        .result-box {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
        }
        .result-icon { font-size: 6em; margin-bottom: 20px; }
        .result-title { font-size: 2.5em; margin-bottom: 30px; }
        .result-title.win { color: var(--accent); }
        .result-title.lose { color: var(--error); }
        .result-title.draw { color: var(--warning); }
        .final-scores {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 30px 0;
        }
        .final-score {
            text-align: center;
        }
        .final-score .name { color: var(--text-secondary); margin-bottom: 10px; }
        .final-score .score { font-size: 3em; font-weight: bold; }
        .final-score.winner .score { color: var(--accent); }

        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        .btn {
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        .btn-primary { background: var(--accent); color: #1a1a2e; font-weight: bold; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: #555; }

        /* Leaderboard */
        .leaderboard {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        .leaderboard h3 { color: var(--accent); margin-bottom: 20px; }
        .lb-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--bg-tertiary);
            gap: 15px;
        }
        .lb-item:last-child { border-bottom: none; }
        .lb-rank { font-size: 1.5em; font-weight: bold; width: 40px; }
        .lb-rank.gold { color: #fbbf24; }
        .lb-rank.silver { color: var(--text-secondary); }
        .lb-rank.bronze { color: var(--warning); }
        .lb-name { flex: 1; }
        .lb-wins { color: var(--accent); font-weight: bold; }

        @media (max-width: 768px) {
            .action-cards { grid-template-columns: 1fr; }
            .answers-grid { grid-template-columns: 1fr; }
            .arena-header { flex-direction: column; gap: 20px; }
            .player-box { width: 100%; }
        }
    
    </style>

</head>
<body>
    <div class="container">
        <header>
            <div class="logo">‚öîÔ∏è Duell Arena</div>
            <div class="user-info">
                <div class="user-stats">
                    <div class="user-name" id="user-name">Laster...</div>
                    <div class="user-record" id="user-record">0 seire / 0 tap</div>
                </div>
                <div class="user-avatar" id="user-avatar">üòä</div>
            </div>
        </header>

        <!-- Lobby Screen -->
        <div class="screen active" id="lobby-screen">
            <h1 class="lobby-title">‚öîÔ∏è <span>1v1 Duell</span></h1>

            <div class="action-cards">
                <div class="action-card" onclick="showCreateDuel()">
                    <div class="icon">üéØ</div>
                    <h3>Opprett Duell</h3>
                    <p>Velg kategori og vent p√• motstandere</p>
                </div>
                <div class="action-card" onclick="showOpenDuels()">
                    <div class="icon">üîç</div>
                    <h3>Finn Motstand</h3>
                    <p>Bli med i en eksisterende duell</p>
                </div>
            </div>

            <div class="leaderboard">
                <h3>üèÜ Topp Duellister</h3>
                <div id="leaderboard-list">
                    <p style="color: var(--text-secondary); text-align: center; padding: 20px;">Laster...</p>
                </div>
            </div>
        </div>

        <!-- Create Duel Screen -->
        <div class="screen" id="create-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Velg kategori</h2>
            
            <div class="category-grid" id="category-grid">
                <div class="category-btn" data-category="bokforing" onclick="selectCategory(this)">
                    <span class="icon">üìö</span>
                    Bokf√∏ring
                </div>
                <div class="category-btn" data-category="mva" onclick="selectCategory(this)">
                    <span class="icon">üí∞</span>
                    MVA
                </div>
                <div class="category-btn" data-category="lonn" onclick="selectCategory(this)">
                    <span class="icon">üëî</span>
                    L√∏nn
                </div>
                <div class="category-btn" data-category="analyse" onclick="selectCategory(this)">
                    <span class="icon">üìä</span>
                    Analyse
                </div>
                <div class="category-btn" data-category="skatt" onclick="selectCategory(this)">
                    <span class="icon">üèõÔ∏è</span>
                    Skatt
                </div>
                <div class="category-btn" data-category="random" onclick="selectCategory(this)">
                    <span class="icon">üé≤</span>
                    Tilfeldig
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-primary" id="create-duel-btn" onclick="createDuel()" disabled>
                    ‚öîÔ∏è Opprett Duell
                </button>
                <button class="btn btn-secondary" onclick="backToLobby()" style="margin-left: 15px;">
                    ‚Üê Tilbake
                </button>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div class="screen" id="waiting-screen">
            <div class="waiting-box">
                <div class="waiting-icon">‚è≥</div>
                <div class="waiting-text">Venter p√• motstander...</div>
                <p style="color: var(--text-secondary); margin-top: 15px;">Kategori: <span id="waiting-category">-</span></p>
                <button class="cancel-btn" onclick="cancelDuel()">‚úï Avbryt</button>
            </div>
        </div>

        <!-- Open Duels Screen -->
        <div class="screen" id="open-duels-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">üîç √Öpne Dueller</h2>
            
            <div class="duels-list" id="duels-list">
                <p style="color: var(--text-secondary); text-align: center;">Laster...</p>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="backToLobby()">‚Üê Tilbake</button>
            </div>
        </div>

        <!-- Arena Screen -->
        <div class="screen" id="arena-screen">
            <div class="arena-header">
                <div class="player-box me">
                    <div class="avatar" id="my-avatar">üòä</div>
                    <div class="name" id="my-name">Meg</div>
                    <div class="score" id="my-score">0</div>
                </div>
                <div class="vs-text">VS</div>
                <div class="player-box opponent">
                    <div class="avatar" id="opp-avatar">üòà</div>
                    <div class="name" id="opp-name">Motstander</div>
                    <div class="score" id="opp-score">0</div>
                </div>
            </div>

            <div class="question-box">
                <div class="question-number" id="q-number">Sp√∏rsm√•l 1 av 5</div>
                <div class="question-text" id="q-text">Laster sp√∏rsm√•l...</div>
                <div class="timer-bar">
                    <div class="timer-fill" id="timer-fill" style="width: 100%;"></div>
                </div>
            </div>

            <div class="answers-grid" id="answers-grid">
                <!-- Answers inserted here -->
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="result-box">
                <div class="result-icon" id="result-icon">üèÜ</div>
                <div class="result-title" id="result-title">Du vant!</div>
                
                <div class="final-scores">
                    <div class="final-score" id="final-me">
                        <div class="name">Du</div>
                        <div class="score">0</div>
                    </div>
                    <div class="final-score" id="final-opp">
                        <div class="name">Motstander</div>
                        <div class="score">0</div>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="playAgain()">üîÑ Spill igjen</button>
                    <button class="btn btn-secondary" onclick="backToLobby()">‚Üê Lobby</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        var firebaseConfig = {
            apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "525417361926",
            appId: "1:525417361926:web:ec9b737f82af9b21700987"
        };
        
        // Globale variabler
        var db = null;
        var auth = null;
        var firebaseReady = false;

        // State - definert globalt F√òR funksjoner
        var state = {
            oderId: null,
            userName: '',
            userAvatar: 'üòä',
            wins: 0,
            losses: 0,
            selectedCategory: null,
            currentDuelId: null,
            duelData: null,
            currentQuestion: 0,
            myScore: 0,
            oppScore: 0,
            hasAnswered: false,
            timer: null,
            timeLeft: 15,
            listeners: []
        };

        // Sample questions (in production, load from Firebase)
        var sampleQuestions = {
            bokforing: [
                { text: "Hvilken konto brukes for varekj√∏p?", answers: ["1500 Varelager", "4000 Varekostnad", "3000 Salgsinntekt", "2400 Leverand√∏rgjeld"], correct: 1 },
                { text: "Hva er debet i en T-konto?", answers: ["Venstre side", "H√∏yre side", "√òverst", "Nederst"], correct: 0 },
                { text: "Hvilken klasse er eiendeler?", answers: ["Klasse 1", "Klasse 2", "Klasse 3", "Klasse 4"], correct: 0 },
                { text: "Hva er MVA-satsen for mat i Norge?", answers: ["25%", "15%", "12%", "0%"], correct: 1 },
                { text: "Hvilket prinsipp krever at inntekter f√∏res n√•r de er opptjent?", answers: ["Forsiktighetsprinsippet", "Sammenstillingsprinsippet", "Opptjeningsprinsippet", "Kongruensprinsippet"], correct: 2 }
            ],
            mva: [
                { text: "Hva er standard MVA-sats i Norge?", answers: ["20%", "25%", "22%", "24%"], correct: 1 },
                { text: "Hvilken MVA-kode brukes for inng√•ende MVA?", answers: ["1", "2", "3", "0"], correct: 0 },
                { text: "N√•r m√• MVA-oppgave leveres?", answers: ["Hver m√•ned", "Annenhver m√•ned", "Hvert kvartal", "Hvert √•r"], correct: 1 },
                { text: "Hva er MVA-satsen for persontransport?", answers: ["25%", "15%", "12%", "0%"], correct: 2 },
                { text: "Hvilken konto er utg√•ende MVA?", answers: ["2700", "2710", "2711", "2712"], correct: 0 }
            ],
            random: []
        };

        // Initialize Firebase med retry-logikk
        function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.log('Venter p√• Firebase SDK...');
                setTimeout(initFirebase, 100);
                return;
            }
            
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database();
                auth = firebase.auth();
                firebaseReady = true;
                console.log('üî• Firebase klar!');
                
                // N√• kan vi initialisere appen
                initApp();
            } catch (error) {
                console.error('Firebase init feil:', error);
                setTimeout(initFirebase, 500);
            }
        }

        // Initialize app (kalles etter Firebase er klar)
        function initApp() {
            // Load user data
            var savedName = localStorage.getItem('aq_duel_name');
            var savedAvatar = localStorage.getItem('aq_duel_avatar');
            
            state.userName = savedName || 'Spiller' + Math.floor(Math.random() * 1000);
            state.userAvatar = savedAvatar || ['üòä', 'üòé', 'ü§ì', 'ü¶ä', 'üê±', 'üê∂'][Math.floor(Math.random() * 6)];
            
            document.getElementById('user-name').textContent = state.userName;
            document.getElementById('user-avatar').textContent = state.userAvatar;

            // Fill random category
            sampleQuestions.random = shuffleArray([].concat(sampleQuestions.bokforing, sampleQuestions.mva)).slice(0, 5);

            // Anonymous auth
            auth.signInAnonymously()
                .then(function(result) {
                    state.oderId = result.user.uid;
                    console.log('Innlogget som:', state.oderId);
                    loadUserStats();
                    loadLeaderboard();
                })
                .catch(function(error) {
                    console.error('Auth feil:', error);
                    // Fortsett uten auth for lokal testing
                    state.oderId = 'local_' + Date.now();
                    loadLeaderboard();
                });
        }
        
        // Gammel init funksjon for bakoverkompatibilitet
        function init() {
            initFirebase();
        }

        function loadUserStats() {
            if (!firebaseReady || !db) return;
            
            db.ref('duels/stats/' + state.oderId).once('value').then(function(snap) {
                var stats = snap.val() || { wins: 0, losses: 0 };
                state.wins = stats.wins;
                state.losses = stats.losses;
                document.getElementById('user-record').textContent = state.wins + ' seire / ' + state.losses + ' tap';
            }).catch(function(err) {
                console.log('Kunne ikke laste stats:', err);
            });
        }

        function loadLeaderboard() {
            if (!firebaseReady || !db) {
                document.getElementById('leaderboard-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Venter p√• tilkobling...</p>';
                return;
            }
            
            db.ref('duels/stats').orderByChild('wins').limitToLast(10).once('value').then(function(snap) {
                var players = [];
                snap.forEach(function(child) {
                    players.push({ id: child.key, ...child.val() });
                });
                players.reverse();

                var html = '';
                players.forEach(function(p, i) {
                    var rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : ''));
                    html += '<div class="lb-item">' +
                        '<div class="lb-rank ' + rankClass + '">' + (i + 1) + '</div>' +
                        '<div class="lb-name">' + (p.name || 'Anonym') + '</div>' +
                        '<div class="lb-wins">' + (p.wins || 0) + ' üèÜ</div>' +
                    '</div>';
                });

                document.getElementById('leaderboard-list').innerHTML = html || '<p style="color: var(--text-secondary); text-align: center;">Ingen dueller enn√•</p>';
            });
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(screenId).classList.add('active');
        }

        function backToLobby() {
            cancelDuel();
            showScreen('lobby-screen');
        }

        function showCreateDuel() {
            showScreen('create-screen');
        }

        function selectCategory(el) {
            document.querySelectorAll('.category-btn').forEach(function(b) { b.classList.remove('selected'); });
            el.classList.add('selected');
            state.selectedCategory = el.dataset.category;
            document.getElementById('create-duel-btn').disabled = false;
        }

        // Create duel
        function createDuel() {
            if (!state.selectedCategory) return;
            if (!firebaseReady || !db) {
                alert('Venter p√• tilkobling til server...');
                return;
            }

            var duelId = 'duel_' + Date.now();
            state.currentDuelId = duelId;

            var duelData = {
                challengerId: state.oderId,
                challengerName: state.userName,
                challengerAvatar: state.userAvatar,
                category: state.selectedCategory,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };

            db.ref('duels/open/' + duelId).set(duelData).then(function() {
                document.getElementById('waiting-category').textContent = state.selectedCategory;
                showScreen('waiting-screen');

                // Listen for opponent joining
                var listener = db.ref('duels/active/' + duelId).on('value', function(snap) {
                    if (snap.exists() && snap.val().player2) {
                        state.listeners.push({ ref: 'duels/active/' + duelId, callback: listener });
                        startDuel(duelId, snap.val());
                    }
                });
            });
        }

        function cancelDuel() {
            if (state.currentDuelId && firebaseReady && db) {
                db.ref('duels/open/' + state.currentDuelId).remove();
                state.currentDuelId = null;
            }
            clearListeners();
        }

        // Show open duels
        function showOpenDuels() {
            showScreen('open-duels-screen');
            
            if (!firebaseReady || !db) {
                document.getElementById('duels-list').innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 30px;">Venter p√• tilkobling...</p>';
                return;
            }
            
            db.ref('duels/open').orderByChild('createdAt').limitToLast(20).once('value').then(function(snap) {
                var duels = [];
                snap.forEach(function(child) {
                    if (child.val().challengerId !== state.oderId) {
                        duels.push({ id: child.key, ...child.val() });
                    }
                });
                duels.reverse();

                var html = '';
                if (duels.length === 0) {
                    html = '<p style="color: var(--text-secondary); text-align: center; padding: 30px;">Ingen √•pne dueller. Opprett en selv!</p>';
                } else {
                    duels.forEach(function(duel) {
                        html += '<div class="duel-item">' +
                            '<div class="duel-info">' +
                                '<span style="font-size: 2em;">' + (duel.challengerAvatar || 'üòä') + '</span>' +
                                '<div>' +
                                    '<div class="duel-challenger">' + duel.challengerName + '</div>' +
                                    '<div class="duel-category">' + getCategoryName(duel.category) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<button class="join-btn" onclick="joinDuel(\'' + duel.id + '\')">‚öîÔ∏è Utfordre</button>' +
                        '</div>';
                    });
                }

                document.getElementById('duels-list').innerHTML = html;
            });
        }

        function getCategoryName(cat) {
            var names = {
                bokforing: 'üìö Bokf√∏ring',
                mva: 'üí∞ MVA',
                lonn: 'üëî L√∏nn',
                analyse: 'üìä Analyse',
                skatt: 'üèõÔ∏è Skatt',
                random: 'üé≤ Tilfeldig'
            };
            return names[cat] || cat;
        }

        // Join duel
        function joinDuel(duelId) {
            if (!firebaseReady || !db) {
                alert('Venter p√• tilkobling til server...');
                return;
            }
            
            db.ref('duels/open/' + duelId).once('value').then(function(snap) {
                if (!snap.exists()) {
                    alert('Denne duellen finnes ikke lenger');
                    showOpenDuels();
                    return;
                }

                var openDuel = snap.val();
                state.currentDuelId = duelId;

                // Get questions
                var questions = getQuestionsForCategory(openDuel.category);

                // Create active duel
                var activeDuel = {
                    player1: {
                        id: openDuel.challengerId,
                        name: openDuel.challengerName,
                        avatar: openDuel.challengerAvatar,
                        score: 0,
                        currentAnswer: null
                    },
                    player2: {
                        id: state.oderId,
                        name: state.userName,
                        avatar: state.userAvatar,
                        score: 0,
                        currentAnswer: null
                    },
                    category: openDuel.category,
                    questions: questions,
                    currentQuestion: 0,
                    status: 'playing',
                    startedAt: firebase.database.ServerValue.TIMESTAMP
                };

                // Move to active
                db.ref('duels/active/' + duelId).set(activeDuel);
                db.ref('duels/open/' + duelId).remove();

                startDuel(duelId, activeDuel);
            });
        }

        function getQuestionsForCategory(category) {
            var questions = sampleQuestions[category] || sampleQuestions.random;
            return shuffleArray(questions.slice()).slice(0, 5);
        }

        // Start duel
        function startDuel(duelId, duelData) {
            state.currentDuelId = duelId;
            state.duelData = duelData;
            state.currentQuestion = 0;
            state.myScore = 0;
            state.oppScore = 0;

            // Determine if I'm player1 or player2
            var isPlayer1 = duelData.player1.id === state.oderId;
            var me = isPlayer1 ? duelData.player1 : duelData.player2;
            var opp = isPlayer1 ? duelData.player2 : duelData.player1;

            document.getElementById('my-name').textContent = me.name;
            document.getElementById('my-avatar').textContent = me.avatar || 'üòä';
            document.getElementById('opp-name').textContent = opp.name;
            document.getElementById('opp-avatar').textContent = opp.avatar || 'üòà';

            showScreen('arena-screen');
            
            // Listen for updates
            var listener = db.ref('duels/active/' + duelId).on('value', function(snap) {
                if (!snap.exists()) return;
                var data = snap.val();
                updateDuelState(data);
            });
            state.listeners.push({ ref: 'duels/active/' + duelId, callback: listener });

            showQuestion();
        }

        function updateDuelState(data) {
            var isPlayer1 = data.player1.id === state.oderId;
            var me = isPlayer1 ? data.player1 : data.player2;
            var opp = isPlayer1 ? data.player2 : data.player1;

            state.myScore = me.score || 0;
            state.oppScore = opp.score || 0;

            document.getElementById('my-score').textContent = state.myScore;
            document.getElementById('opp-score').textContent = state.oppScore;

            // Check if opponent answered
            if (data.currentQuestion !== state.currentQuestion) {
                state.currentQuestion = data.currentQuestion;
                state.hasAnswered = false;
                showQuestion();
            }

            if (data.status === 'finished') {
                showResults();
            }
        }

        function showQuestion() {
            var questions = state.duelData.questions;
            if (state.currentQuestion >= questions.length) {
                endDuel();
                return;
            }

            var q = questions[state.currentQuestion];
            state.hasAnswered = false;

            document.getElementById('q-number').textContent = 'Sp√∏rsm√•l ' + (state.currentQuestion + 1) + ' av ' + questions.length;
            document.getElementById('q-text').textContent = q.text;

            var answersHtml = '';
            q.answers.forEach(function(answer, i) {
                answersHtml += '<button class="answer-btn" onclick="selectAnswer(' + i + ')" data-index="' + i + '">' + answer + '</button>';
            });
            document.getElementById('answers-grid').innerHTML = answersHtml;

            startTimer();
        }

        function startTimer() {
            state.timeLeft = 15;
            var timerFill = document.getElementById('timer-fill');
            timerFill.style.width = '100%';
            timerFill.className = 'timer-fill';

            if (state.timer) clearInterval(state.timer);

            state.timer = setInterval(function() {
                state.timeLeft -= 0.1;
                var percent = (state.timeLeft / 15) * 100;
                timerFill.style.width = percent + '%';

                if (state.timeLeft <= 5) timerFill.classList.add('warning');
                if (state.timeLeft <= 2) timerFill.classList.add('danger');

                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    if (!state.hasAnswered) {
                        submitAnswer(-1); // Timeout
                    }
                }
            }, 100);
        }

        function selectAnswer(index) {
            if (state.hasAnswered) return;
            state.hasAnswered = true;
            clearInterval(state.timer);

            var buttons = document.querySelectorAll('.answer-btn');
            buttons.forEach(function(btn) { btn.disabled = true; });
            buttons[index].classList.add('selected');

            submitAnswer(index);
        }

        function submitAnswer(answerIndex) {
            var q = state.duelData.questions[state.currentQuestion];
            var isCorrect = answerIndex === q.correct;
            var points = isCorrect ? Math.max(50, Math.floor(state.timeLeft * 10)) : 0;

            // Show correct/wrong
            var buttons = document.querySelectorAll('.answer-btn');
            buttons[q.correct].classList.add('correct');
            if (answerIndex >= 0 && answerIndex !== q.correct) {
                buttons[answerIndex].classList.add('wrong');
            }

            // Update score in Firebase
            var playerKey = state.duelData.player1.id === state.oderId ? 'player1' : 'player2';
            var newScore = state.myScore + points;

            db.ref('duels/active/' + state.currentDuelId + '/' + playerKey).update({
                score: newScore,
                currentAnswer: answerIndex
            });

            // Move to next question after delay
            setTimeout(function() {
                var nextQ = state.currentQuestion + 1;
                if (nextQ >= state.duelData.questions.length) {
                    endDuel();
                } else {
                    db.ref('duels/active/' + state.currentDuelId + '/currentQuestion').set(nextQ);
                }
            }, 2000);
        }

        function endDuel() {
            clearInterval(state.timer);
            db.ref('duels/active/' + state.currentDuelId + '/status').set('finished');
            showResults();
        }

        function showResults() {
            clearListeners();
            showScreen('results-screen');

            var isWinner = state.myScore > state.oppScore;
            var isDraw = state.myScore === state.oppScore;

            var icon = isWinner ? 'üèÜ' : (isDraw ? 'ü§ù' : 'üòî');
            var title = isWinner ? 'Du vant!' : (isDraw ? 'Uavgjort!' : 'Du tapte');
            var titleClass = isWinner ? 'win' : (isDraw ? 'draw' : 'lose');

            document.getElementById('result-icon').textContent = icon;
            document.getElementById('result-title').textContent = title;
            document.getElementById('result-title').className = 'result-title ' + titleClass;

            var finalMe = document.getElementById('final-me');
            var finalOpp = document.getElementById('final-opp');
            
            finalMe.querySelector('.score').textContent = state.myScore;
            finalOpp.querySelector('.score').textContent = state.oppScore;
            finalMe.className = 'final-score' + (isWinner ? ' winner' : '');
            finalOpp.className = 'final-score' + (!isWinner && !isDraw ? ' winner' : '');

            // Update stats
            if (isWinner) {
                state.wins++;
            } else if (!isDraw) {
                state.losses++;
            }

            db.ref('duels/stats/' + state.oderId).set({
                name: state.userName,
                wins: state.wins,
                losses: state.losses
            });

            document.getElementById('user-record').textContent = state.wins + ' seire / ' + state.losses + ' tap';
        }

        function playAgain() {
            state.currentDuelId = null;
            state.duelData = null;
            showScreen('lobby-screen');
            loadLeaderboard();
        }

        function clearListeners() {
            state.listeners.forEach(function(l) {
                db.ref(l.ref).off('value', l.callback);
            });
            state.listeners = [];
        }

        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        // Initialize theme after DOM loads
        if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
            ThemeManager.init();
        }
    </script>
</body>
</html>
