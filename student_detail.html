<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student detaljer - AccountingQuest</title>
    <link rel="stylesheet" href="main.css">
    <style>
        .student-container {
            max-width: 1200px;
            margin: 40px auto;
        }
        
        .student-header {
            background: var(--bg-secondary);
            border: 3px solid var(--accent);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .student-avatar {
            font-size: 6em;
        }
        
        .student-info {
            flex: 1;
        }
        
        .student-name {
            font-size: 3em;
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .student-email {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .student-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--text-secondary);
            margin-top: 15px;
        }
        
        .student-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .action-btn.danger {
            background: var(--danger);
            color: white;
        }
        
        .action-btn.secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 3em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: var(--text-secondary);
        }
        
        .progress-section {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 20px;
        }
        
        .progress-bars {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .progress-item {
            background: var(--bg-primary);
            border-radius: 15px;
            padding: 20px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .progress-label {
            font-weight: bold;
        }
        
        .progress-percentage {
            color: var(--accent);
            font-weight: bold;
        }
        
        .progress-bar {
            background: var(--bg-tertiary);
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: var(--accent);
            height: 100%;
            transition: width 0.3s;
        }
        
        .submissions-section {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 20px;
            padding: 30px;
        }
        
        .submission-card {
            background: var(--bg-primary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .submission-icon {
            font-size: 3em;
        }
        
        .submission-content {
            flex: 1;
        }
        
        .submission-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .submission-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            color: var(--text-secondary);
        }
        
        .submission-score {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }
        
        .accuracy-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .accuracy-high {
            background: var(--success);
            color: white;
        }
        
        .accuracy-medium {
            background: var(--warning);
            color: var(--bg-primary);
        }
        
        .accuracy-low {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="goBack()">‚Üê Tilbake til klasserom</div>
            <h1>üë§ Student detaljer</h1>
        </div>

        <div class="student-container">
            <!-- Student Header -->
            <div class="student-header">
                <div class="student-avatar">üòä</div>
                <div class="student-info">
                    <div class="student-name" id="student-name">Laster...</div>
                    <div class="student-email" id="student-email"></div>
                    <div class="student-meta">
                        <span id="joined-date">üìÖ Ble med: -</span>
                        <span id="last-active">‚è∞ Sist aktiv: -</span>
                        <span id="classroom-name">üìö Klasserom: -</span>
                    </div>
                </div>
                <div class="student-actions">
                    <button class="action-btn secondary" onclick="sendMessage()">üìß Send melding</button>
                    <button class="action-btn danger" onclick="removeStudent()">üóëÔ∏è Fjern fra klasserom</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-points">0</div>
                    <div class="stat-label">Total poeng</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completed-count">0</div>
                    <div class="stat-label">Fullf√∏rt oppgaver</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="average-score">0%</div>
                    <div class="stat-label">Gjennomsnitt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-time">0:00</div>
                    <div class="stat-label">Total tid</div>
                </div>
            </div>

            <!-- Progress by Category -->
            <div class="progress-section">
                <div class="section-title">üìä Progresjon per kategori</div>
                <div class="progress-bars">
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">‚ùì Quiz</span>
                            <span class="progress-percentage" id="quiz-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="quiz-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">üìä Bokf√∏ring</span>
                            <span class="progress-percentage" id="bokforing-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bokforing-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-header">
                            <span class="progress-label">üìà Analyse</span>
                            <span class="progress-percentage" id="analyse-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="analyse-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Submissions -->
            <div class="submissions-section">
                <div class="section-title">üìù Alle innleveringer</div>
                <div id="submissions-list">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>Ingen innleveringer enn√•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase init
        (function initFirebase() {
            var attempts = 0;
            var maxAttempts = 50;
            
            function tryInit() {
                attempts++;
                
                if (typeof firebase === 'undefined') {
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 100);
                    }
                    return;
                }
                
                try {
                    var firebaseConfig = {
                        apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
                        authDomain: "accountingquest-multiplayer.firebaseapp.com",
                        databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "accountingquest-multiplayer",
                        storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                        messagingSenderId: "525417361926",
                        appId: "1:525417361926:web:ec9b737f82af9b21700987"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    window.db = firebase.database();
                    
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', init);
                    } else {
                        setTimeout(init, 100);
                    }
                } catch (error) {
                    console.error('üî• Firebase error:', error);
                }
            }
            
            tryInit();
        })();
        
        var currentUser = null;
        var classroomId = null;
        var studentId = null;
        var student = null;
        var classroom = null;
        var progress = null;
        var submissions = [];
        var assignments = {};
        
        function init() {
            console.log('üöÄ Init student detail...');
            
            // Get IDs from URL
            var params = new URLSearchParams(window.location.search);
            classroomId = params.get('classroom');
            studentId = params.get('student');
            
            if (!classroomId || !studentId) {
                alert('Mangler classroom eller student ID');
                window.history.back();
                return;
            }
            
            // Authenticate
            firebase.auth().signInAnonymously()
                .then(function() {
                    currentUser = firebase.auth().currentUser;
                    loadData();
                });
        }
        
        function loadData() {
            console.log('üìö Loading data...');
            
            // Load classroom
            db.ref('classrooms/' + classroomId).once('value')
                .then(function(snapshot) {
                    classroom = snapshot.val();
                    student = classroom.students[studentId];
                    
                    if (!student) {
                        alert('Student ikke funnet');
                        window.history.back();
                        return;
                    }
                    
                    updateHeader();
                    
                    // Load progress
                    return db.ref('classroom_progress/' + classroomId + '/' + studentId).once('value');
                })
                .then(function(snapshot) {
                    progress = snapshot.val() || {
                        totalPoints: 0,
                        completedAssignments: 0,
                        assignments: {}
                    };
                    
                    updateStats();
                    
                    // Load all assignments
                    return db.ref('assignments').orderByChild('classroomId').equalTo(classroomId).once('value');
                })
                .then(function(snapshot) {
                    snapshot.forEach(function(child) {
                        var assignment = child.val();
                        assignments[child.key] = assignment;
                    });
                    
                    updateProgress();
                    
                    // Load submissions
                    return db.ref('submissions').orderByChild('studentId').equalTo(studentId).once('value');
                })
                .then(function(snapshot) {
                    submissions = [];
                    snapshot.forEach(function(child) {
                        var submission = child.val();
                        if (submission.classroomId === classroomId) {
                            submission.id = child.key;
                            submissions.push(submission);
                        }
                    });
                    
                    renderSubmissions();
                });
        }
        
        function updateHeader() {
            document.getElementById('student-name').textContent = student.name;
            document.getElementById('student-email').textContent = student.email || 'Ingen e-post';
            document.getElementById('joined-date').textContent = 'üìÖ Ble med: ' + new Date(student.joinedAt).toLocaleDateString('no');
            
            if (progress && progress.lastActive) {
                document.getElementById('last-active').textContent = '‚è∞ Sist aktiv: ' + new Date(progress.lastActive).toLocaleDateString('no');
            }
            
            document.getElementById('classroom-name').textContent = 'üìö ' + classroom.name;
        }
        
        function updateStats() {
            document.getElementById('total-points').textContent = progress.totalPoints || 0;
            document.getElementById('completed-count').textContent = progress.completedAssignments || 0;
            
            // Calculate average score
            var assignmentsList = progress.assignments || {};
            var assignmentKeys = Object.keys(assignmentsList);
            
            if (assignmentKeys.length > 0) {
                var totalScore = 0;
                var totalMax = 0;
                
                assignmentKeys.forEach(function(key) {
                    var assignment = assignments[key];
                    if (assignment) {
                        totalScore += assignmentsList[key].score || 0;
                        totalMax += assignment.points || 100;
                    }
                });
                
                var average = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;
                document.getElementById('average-score').textContent = average + '%';
            }
            
            // Calculate total time
            var totalTime = 0;
            submissions.forEach(function(sub) {
                totalTime += sub.timeSpent || 0;
            });
            
            var hours = Math.floor(totalTime / 3600);
            var minutes = Math.floor((totalTime % 3600) / 60);
            document.getElementById('total-time').textContent = hours + ':' + (minutes < 10 ? '0' : '') + minutes;
        }
        
        function updateProgress() {
            var typeCount = {
                quiz: { completed: 0, total: 0 },
                bokforing: { completed: 0, total: 0 },
                analyse: { completed: 0, total: 0 }
            };
            
            Object.keys(assignments).forEach(function(key) {
                var assignment = assignments[key];
                var type = assignment.type;
                
                if (typeCount[type]) {
                    typeCount[type].total++;
                    
                    if (progress.assignments && progress.assignments[key] && progress.assignments[key].completed) {
                        typeCount[type].completed++;
                    }
                }
            });
            
            // Update quiz
            var quizPercent = typeCount.quiz.total > 0 ? Math.round((typeCount.quiz.completed / typeCount.quiz.total) * 100) : 0;
            document.getElementById('quiz-percentage').textContent = quizPercent + '%';
            document.getElementById('quiz-progress').style.width = quizPercent + '%';
            
            // Update bokforing
            var bokforingPercent = typeCount.bokforing.total > 0 ? Math.round((typeCount.bokforing.completed / typeCount.bokforing.total) * 100) : 0;
            document.getElementById('bokforing-percentage').textContent = bokforingPercent + '%';
            document.getElementById('bokforing-progress').style.width = bokforingPercent + '%';
            
            // Update analyse
            var analysePercent = typeCount.analyse.total > 0 ? Math.round((typeCount.analyse.completed / typeCount.analyse.total) * 100) : 0;
            document.getElementById('analyse-percentage').textContent = analysePercent + '%';
            document.getElementById('analyse-progress').style.width = analysePercent + '%';
        }
        
        function renderSubmissions() {
            var container = document.getElementById('submissions-list');
            
            if (submissions.length === 0) {
                container.innerHTML =
                    '<div class="empty-state">' +
                        '<div class="empty-icon">üì≠</div>' +
                        '<div>Ingen innleveringer enn√•</div>' +
                    '</div>';
                return;
            }
            
            container.innerHTML = '';
            
            // Sort by date descending
            submissions.sort(function(a, b) {
                return b.submittedAt - a.submittedAt;
            });
            
            submissions.forEach(function(submission) {
                var assignment = assignments[submission.assignmentId];
                if (!assignment) return;
                
                var accuracy = submission.accuracy || 0;
                var accuracyClass = 'accuracy-high';
                if (accuracy < 50) accuracyClass = 'accuracy-low';
                else if (accuracy < 70) accuracyClass = 'accuracy-medium';
                
                var typeIcons = {
                    quiz: '‚ùì',
                    bokforing: 'üìä',
                    analyse: 'üìà',
                    case: 'üìë'
                };
                
                var card = document.createElement('div');
                card.className = 'submission-card';
                
                card.innerHTML =
                    '<div class="submission-icon">' + (typeIcons[assignment.type] || 'üìù') + '</div>' +
                    '<div class="submission-content">' +
                        '<div class="submission-title">' + assignment.title + '</div>' +
                        '<div class="submission-meta">' +
                            '<span>üìÖ ' + new Date(submission.submittedAt).toLocaleString('no') + '</span>' +
                            '<span>' + (submission.correctCount || 0) + ' / ' + (submission.totalQuestions || 0) + ' riktige</span>' +
                            '<span>‚è±Ô∏è ' + formatTime(submission.timeSpent || 0) + '</span>' +
                            '<span class="accuracy-badge ' + accuracyClass + '">' + accuracy + '%</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="submission-score">' + (submission.score || 0) + ' / ' + assignment.points + '</div>';
                
                container.appendChild(card);
            });
        }
        
        function formatTime(seconds) {
            var minutes = Math.floor(seconds / 60);
            var secs = seconds % 60;
            return minutes + ':' + (secs < 10 ? '0' : '') + secs;
        }
        
        function sendMessage() {
            alert('E-post funksjonalitet kommer snart!\n\nVil sende melding til: ' + student.name);
        }
        
        function removeStudent() {
            if (!confirm('Er du sikker p√• at du vil fjerne ' + student.name + ' fra klasserommet?\n\nDette kan ikke angres.')) {
                return;
            }
            
            console.log('üóëÔ∏è Removing student...');
            
            // Remove from classroom
            db.ref('classrooms/' + classroomId + '/students/' + studentId).remove()
                .then(function() {
                    console.log('‚úÖ Student removed!');
                    alert('Student fjernet fra klasserom!');
                    goBack();
                })
                .catch(function(error) {
                    console.error('üî• Error:', error);
                    alert('Kunne ikke fjerne student: ' + error.message);
                });
        }
        
        function goBack() {
            window.location.href = 'classroom_manage.html?id=' + classroomId;
        }
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
            ThemeManager.init();
        }
    </script>
</body>
</html>
