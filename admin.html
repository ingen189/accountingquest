<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîß</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #2d333b;
            --accent: #4ade80;
            --accent-hover: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #2d333b;
            --radius: 10px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', -apple-system, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh; 
        }
        
        .header { 
            background: var(--bg-secondary); 
            padding: 15px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { color: var(--accent); font-size: 1.4em; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .user-info { color: var(--text-secondary); font-size: 0.85em; }
        
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85em;
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--accent); color: #1a1a1a; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #1a1a1a; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.75em; }
        
        .container { display: flex; min-height: calc(100vh - 60px); }
        
        .sidebar { 
            width: 220px; 
            background: var(--bg-secondary); 
            border-right: 1px solid var(--border);
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-section { 
            padding: 12px 20px 8px; 
            font-size: 0.7em; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        .sidebar-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--text-secondary); 
            font-size: 0.9em;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .sidebar-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-item.active { 
            background: rgba(74, 222, 128, 0.1); 
            color: var(--accent); 
            border-left-color: var(--accent); 
        }
        .sidebar-item .count {
            margin-left: auto;
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .page-title { font-size: 1.5em; color: var(--accent); }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .stat-card { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 20px; 
            text-align: center; 
        }
        .stat-value { font-size: 2em; font-weight: bold; color: var(--accent); }
        .stat-label { color: var(--text-secondary); font-size: 0.8em; margin-top: 5px; }
        
        .table-container { 
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }
        .search-input {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            width: 250px;
            font-size: 0.9em;
        }
        .search-input:focus { outline: none; border-color: var(--accent); }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .data-table th, .data-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        .data-table th { 
            background: var(--bg-tertiary); 
            font-weight: 600; 
            color: var(--accent);
            font-size: 0.75em;
            text-transform: uppercase;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover { background: rgba(74, 222, 128, 0.05); }
        .data-table-scroll { max-height: 60vh; overflow-y: auto; }
        
        .badge { 
            display: inline-block; 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 0.75em; 
            font-weight: 600; 
        }
        .badge-green { background: rgba(74, 222, 128, 0.2); color: var(--accent); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .badge-orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
        .badge-gray { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        .role-admin { background: #ef4444; color: white; }
        .role-teacher_pro { background: #8b5cf6; color: white; }
        .role-teacher { background: #a78bfa; color: white; }
        .role-pro { background: #f59e0b; color: white; }
        .role-student { background: #34d399; color: #1f2937; }
        .role-free { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.85em; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            background: var(--bg-tertiary); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            color: var(--text-primary); 
            font-size: 0.9em; 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; 
            border-color: var(--accent); 
        }
        .form-group textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.85); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 25px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
        }
        .modal-header h2 { color: var(--accent); font-size: 1.2em; }
        .modal-close { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 1.5em; 
            cursor: pointer; 
        }
        .modal-footer { 
            display: flex; 
            gap: 10px; 
            justify-content: flex-end; 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1px solid var(--border); 
        }
        
        .seed-card { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 20px; 
        }
        .seed-card h3 { color: var(--text-primary); margin-bottom: 10px; }
        .seed-card p { color: var(--text-secondary); font-size: 0.85em; margin-bottom: 15px; }
        
        .progress-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        
        .role-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .role-option { 
            padding: 12px; 
            background: var(--bg-tertiary); 
            border: 2px solid transparent; 
            border-radius: 8px; 
            cursor: pointer;
            text-align: center;
        }
        .role-option:hover { border-color: var(--border); }
        .role-option.selected { border-color: var(--accent); background: rgba(74, 222, 128, 0.1); }
        
        .message { padding: 12px 18px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; }
        .message.success { background: rgba(74, 222, 128, 0.15); border: 1px solid var(--accent); color: var(--accent); }
        .message.error { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); }
        .message.info { background: rgba(59, 130, 246, 0.15); border: 1px solid var(--info); color: var(--info); }
        
        .danger-zone { 
            background: rgba(239, 68, 68, 0.1); 
            border: 2px solid var(--danger); 
            border-radius: var(--radius); 
            padding: 20px; 
            margin-top: 25px; 
        }
        .danger-zone h3 { color: var(--danger); margin-bottom: 10px; }
        
        .loading { display: flex; align-items: center; justify-content: center; height: 150px; color: var(--text-secondary); }
        .spinner { 
            width: 30px; height: 30px; 
            border: 3px solid var(--bg-tertiary); 
            border-top-color: var(--accent); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin-right: 12px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            padding: 12px 20px; border-radius: 8px; font-size: 0.9em; z-index: 2000;
            transform: translateY(100px); opacity: 0; transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--accent); color: #1a1a1a; }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--info); color: white; }
        
        .access-denied { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; text-align: center; 
        }
        .access-denied h1 { font-size: 4em; margin-bottom: 20px; }
        
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; display: flex; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--border); }
            .sidebar-section { display: none; }
            .sidebar-item { white-space: nowrap; padding: 10px 15px; border-left: none; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="access-denied">
        <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
        <p>Sjekker tilgang...</p>
    </div>
    
    <div id="access-denied" class="access-denied" style="display: none;">
        <h1>üîí</h1>
        <h2>Ingen tilgang</h2>
        <p style="color: var(--text-secondary); margin: 20px 0;">Du m√• v√¶re admin for √• f√• tilgang.</p>
        <a href="index.html" class="btn btn-primary">‚Üê Tilbake til forsiden</a>
    </div>
    
    <div id="app" style="display: none;">
        <header class="header">
            <h1>üîß Admin Dashboard</h1>
            <div class="header-actions">
                <span class="user-info" id="user-info"></span>
                <a href="index.html" class="btn btn-secondary">‚Üê Tilbake</a>
                <button class="btn btn-danger" onclick="logout()">Logg ut</button>
            </div>
        </header>
        
        <div class="container">
            <nav class="sidebar">
                <div class="sidebar-section">Oversikt</div>
                <div class="sidebar-item active" data-page="dashboard">üìä Dashboard</div>
                
                <div class="sidebar-section">Brukere</div>
                <div class="sidebar-item" data-page="users">üë• Brukere</div>
                <div class="sidebar-item" data-page="teachers">üë®‚Äçüè´ L√¶rere</div>
                
                <div class="sidebar-section">Innhold</div>
                <div class="sidebar-item" data-page="quiz">‚ùì Quiz</div>
                <div class="sidebar-item" data-page="corporate-finance">üìà Corporate Finance</div>
                <div class="sidebar-item" data-page="bokforing">üìñ Bokf√∏ring</div>
                <div class="sidebar-item" data-page="wiki">üìö Wiki</div>
                
                <div class="sidebar-section">Verkt√∏y</div>
                <div class="sidebar-item" data-page="seeder">üå± Seed Data</div>
                <div class="sidebar-item" data-page="import">üì• Import</div>
                <div class="sidebar-item" data-page="export">üì§ Eksport</div>
                <div class="sidebar-item" data-page="database">üóÑÔ∏è Database</div>
            </nav>
            
            <main class="main">
                <!-- Dashboard -->
                <div id="page-dashboard" class="page active">
                    <div class="page-header">
                        <h2 class="page-title">üìä Dashboard</h2>
                        <button class="btn btn-primary" onclick="refreshAll()">üîÑ Oppdater</button>
                    </div>
                    <div id="dashboard-message"></div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="stat-users">-</div><div class="stat-label">Brukere</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-teachers">-</div><div class="stat-label">L√¶rere</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-quiz">-</div><div class="stat-label">Quiz</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-cf">-</div><div class="stat-label">Corporate Finance</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-bokforing">-</div><div class="stat-label">Bokf√∏ring</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-wiki">-</div><div class="stat-label">Wiki</div></div>
                    </div>
                </div>
                
                <!-- Users -->
                <div id="page-users" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üë• Brukere</h2>
                        <button class="btn btn-primary" onclick="loadUsers()">üîÑ Oppdater</button>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" placeholder="S√∏k brukere..." id="user-search" onkeyup="filterUsers()">
                        </div>
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>Bruker</th><th>Rolle</th><th>Opprettet</th><th>Handlinger</th></tr></thead>
                                <tbody id="users-table-body"><tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers -->
                <div id="page-teachers" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üë®‚Äçüè´ L√¶rere</h2>
                        <button class="btn btn-primary" onclick="loadTeachers()">üîÑ Oppdater</button>
                    </div>
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>Navn</th><th>E-post</th><th>Skole</th><th>Status</th></tr></thead>
                                <tbody id="teachers-table-body"><tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz -->
                <div id="page-quiz" class="page">
                    <div class="page-header">
                        <h2 class="page-title">‚ùì Quiz</h2>
                        <div>
                            <button class="btn btn-info" onclick="openQuizModal()">+ Nytt sp√∏rsm√•l</button>
                            <button class="btn btn-primary" onclick="loadQuiz()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" placeholder="S√∏k..." id="quiz-search" onkeyup="filterQuiz()">
                        </div>
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>Sp√∏rsm√•l</th><th>Kategori</th><th>Type</th><th>Handlinger</th></tr></thead>
                                <tbody id="quiz-table-body"><tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Corporate Finance -->
                <div id="page-corporate-finance" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìà Corporate Finance</h2>
                        <div>
                            <button class="btn btn-info" onclick="openCFModal()">+ Ny oppgave</button>
                            <button class="btn btn-primary" onclick="loadCorporateFinance()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="cf-total">-</div><div class="stat-label">Totalt</div></div>
                        <div class="stat-card"><div class="stat-value" id="cf-mc">-</div><div class="stat-label">Multiple Choice</div></div>
                        <div class="stat-card"><div class="stat-value" id="cf-calc">-</div><div class="stat-label">Beregning</div></div>
                    </div>
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>ID</th><th>Tittel</th><th>Topic</th><th>Type</th><th>Handlinger</th></tr></thead>
                                <tbody id="cf-table-body"><tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="danger-zone">
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                        <button class="btn btn-danger" onclick="purgeCF()">üóëÔ∏è Slett alle CF-oppgaver</button>
                    </div>
                </div>
                
                <!-- Bokf√∏ring -->
                <div id="page-bokforing" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìñ Bokf√∏ring</h2>
                        <div>
                            <button class="btn btn-info" onclick="openBokforingModal()">+ Ny oppgave</button>
                            <button class="btn btn-primary" onclick="loadBokforing()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>Nr</th><th>Beskrivelse</th><th>Niv√•</th><th>Handlinger</th></tr></thead>
                                <tbody id="bokforing-table-body"><tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Wiki -->
                <div id="page-wiki" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìö Wiki</h2>
                        <div>
                            <button class="btn btn-info" onclick="openWikiModal()">+ Ny artikkel</button>
                            <button class="btn btn-primary" onclick="loadWiki()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead><tr><th>Tittel</th><th>Kategori</th><th>Lov</th><th>Handlinger</th></tr></thead>
                                <tbody id="wiki-table-body"><tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Seeder -->
                <div id="page-seeder" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üå± Seed Data</h2>
                    </div>
                    <div id="seeder-message"></div>
                    <div class="stats-grid">
                        <div class="seed-card">
                            <h3>‚ùì Quiz (90+ sp√∏rsm√•l)</h3>
                            <p>Regnskap, bokf√∏ring, MVA, skatt, analyse</p>
                            <button class="btn btn-primary" onclick="seedQuiz()">üå± Seed Quiz</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-quiz" style="width:0%"></div></div>
                        </div>
                        <div class="seed-card">
                            <h3>üìñ Bokf√∏ring (19 oppgaver)</h3>
                            <p>Bilagsf√∏ring med l√∏sninger</p>
                            <button class="btn btn-primary" onclick="seedBokforing()">üå± Seed Bokf√∏ring</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-bokforing" style="width:0%"></div></div>
                        </div>
                        <div class="seed-card">
                            <h3>üìö Wiki (artikler)</h3>
                            <p>Regnskapsloven, lover, definisjoner</p>
                            <button class="btn btn-primary" onclick="seedWiki()">üå± Seed Wiki</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-wiki" style="width:0%"></div></div>
                        </div>
                        <div class="seed-card">
                            <h3>üìà Corporate Finance</h3>
                            <p>NPV, IRR, WACC eksempler</p>
                            <button class="btn btn-primary" onclick="seedCorporateFinance()">üå± Seed CF</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-cf" style="width:0%"></div></div>
                        </div>
                        <div class="seed-card">
                            <h3>üß† Hjernetrim</h3>
                            <p>Mattespill og hjernetrim</p>
                            <button class="btn btn-primary" onclick="seedHjernetrim()">üå± Seed Hjernetrim</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-hjernetrim" style="width:0%"></div></div>
                        </div>
                        <div class="seed-card">
                            <h3>üöÄ Alt p√• en gang</h3>
                            <p>Seed alt innhold</p>
                            <button class="btn btn-warning" onclick="seedAll()">üå± Seed ALT</button>
                        </div>
                    </div>
                </div>
                
                <!-- Import -->
                <div id="page-import" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üì• Importer Data</h2>
                    </div>
                    <div id="import-message"></div>
                    <div class="seed-card">
                        <h3>üìÑ Last opp JSON-fil</h3>
                        <p>Velg en JSON-fil med quiz eller corporate finance sp√∏rsm√•l</p>
                        <input type="file" id="json-file-input" accept=".json" style="display: none;" onchange="handleJsonFile(event)">
                        <button class="btn btn-primary" onclick="document.getElementById('json-file-input').click()">üìÇ Velg fil</button>
                        <span id="json-preview-count" style="margin-left: 15px; color: var(--text-secondary);">Ingen fil valgt</span>
                    </div>
                    <div id="json-preview" style="display: none; margin-top: 20px;">
                        <div class="seed-card">
                            <h3>Forh√•ndsvisning</h3>
                            <div id="json-categories" style="margin-bottom: 15px;"></div>
                            <button class="btn btn-primary" onclick="importJsonToFirebase()" id="btn-import-json" disabled>‚¨ÜÔ∏è Importer til Firebase</button>
                            <div class="progress-bar"><div class="progress-fill" id="prog-json-import" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>
                
                <!-- Export -->
                <div id="page-export" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üì§ Eksporter Data</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="seed-card">
                            <h3>‚ùì Quiz</h3>
                            <p>Alle quiz-sp√∏rsm√•l</p>
                            <button class="btn btn-info" onclick="exportQuizJSON()">üì• JSON</button>
                            <button class="btn btn-info" onclick="exportQuizExcel()">üì• Excel</button>
                        </div>
                        <div class="seed-card">
                            <h3>üìà Corporate Finance</h3>
                            <p>Alle CF-oppgaver</p>
                            <button class="btn btn-info" onclick="exportCFJSON()">üì• JSON</button>
                        </div>
                        <div class="seed-card">
                            <h3>üë• Brukere</h3>
                            <p>Brukerliste</p>
                            <button class="btn btn-info" onclick="exportUsersJSON()">üì• JSON</button>
                        </div>
                        <div class="seed-card">
                            <h3>üóÑÔ∏è Full Backup</h3>
                            <p>Hele databasen</p>
                            <button class="btn btn-warning" onclick="exportFullBackup()">üì• Full Backup</button>
                        </div>
                    </div>
                </div>
                
                <!-- Database Browser -->
                <div id="page-database" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üóÑÔ∏è Database Browser</h2>
                    </div>
                    <div class="form-group">
                        <label>Database-sti</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="db-path" placeholder="f.eks. users" style="flex: 1;">
                            <button class="btn btn-primary" onclick="browseDB()">üìÇ Bla</button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;">
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('users')">users</button>
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('quizQuestions')">quizQuestions</button>
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('solutions/corporate_finance')">CF solutions</button>
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('questions/corporate_finance')">CF questions</button>
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('bokforing')">bokforing</button>
                        <button class="btn btn-sm btn-secondary" onclick="setDBPath('wiki')">wiki</button>
                    </div>
                    <pre id="db-output" style="background: #000; padding: 15px; border-radius: 8px; max-height: 500px; overflow: auto; font-size: 0.8em;"></pre>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Role Modal -->
    <div class="modal" id="role-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Endre rolle</h2>
                <button class="modal-close" onclick="closeModal('role-modal')">&times;</button>
            </div>
            <p>Bruker: <strong id="edit-user-name"></strong></p>
            <input type="hidden" id="edit-user-id">
            <div class="role-options" id="role-selector" style="margin-top: 15px;">
                <div class="role-option" data-role="admin">üëë Admin</div>
                <div class="role-option" data-role="teacher_pro">üë®‚Äçüè´ L√¶rer Pro</div>
                <div class="role-option" data-role="teacher">üë®‚Äçüè´ L√¶rer</div>
                <div class="role-option" data-role="pro">‚≠ê Pro</div>
                <div class="role-option" data-role="student">üìö Student</div>
                <div class="role-option" data-role="free">üÜì Gratis</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('role-modal')">Avbryt</button>
                <button class="btn btn-primary" onclick="saveRole()">Lagre</button>
            </div>
        </div>
    </div>
    
    <!-- Quiz Modal -->
    <div class="modal" id="quiz-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="quiz-modal-title">Nytt sp√∏rsm√•l</h2>
                <button class="modal-close" onclick="closeModal('quiz-modal')">&times;</button>
            </div>
            <form onsubmit="saveQuiz(event)">
                <input type="hidden" id="q-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="q-type">
                            <option value="mc">Flervalg (MC)</option>
                            <option value="tf">Sant/Usant</option>
                            <option value="para">Tekstsvar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="q-category">
                            <option value="regnskap">Regnskap</option>
                            <option value="bokforing">Bokf√∏ring</option>
                            <option value="mva">MVA</option>
                            <option value="skatt">Skatt</option>
                            <option value="analyse">Analyse</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sp√∏rsm√•l</label>
                    <textarea id="q-question" required></textarea>
                </div>
                <div class="form-group">
                    <label>Alternativer (ett per linje)</label>
                    <textarea id="q-options" placeholder="Alternativ 1&#10;Alternativ 2&#10;Alternativ 3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Riktig svar</label>
                        <input type="text" id="q-answer" placeholder="0 for f√∏rste, true/false">
                    </div>
                    <div class="form-group">
                        <label>Lovhenvisning</label>
                        <input type="text" id="q-law" placeholder="¬ß 4-1 (BOKL)">
                    </div>
                </div>
                <div class="form-group">
                    <label>Forklaring</label>
                    <textarea id="q-explanation"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quiz-modal')">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- CF Modal -->
    <div class="modal" id="cf-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cf-modal-title">Ny CF-oppgave</h2>
                <button class="modal-close" onclick="closeModal('cf-modal')">&times;</button>
            </div>
            <form onsubmit="saveCF(event)">
                <input type="hidden" id="cf-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="cf-type">
                            <option value="multiple_choice">Multiple Choice</option>
                            <option value="calculation">Beregning</option>
                            <option value="true_false">Sant/Usant</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Topic</label>
                        <select id="cf-topic">
                            <option value="npv">NPV</option>
                            <option value="irr">IRR</option>
                            <option value="bonds">Obligasjoner</option>
                            <option value="stocks">Aksjer</option>
                            <option value="wacc">WACC</option>
                            <option value="portfolio">Portef√∏lje</option>
                            <option value="capm">CAPM</option>
                            <option value="leverage">Gearing</option>
                            <option value="forex">Valuta</option>
                            <option value="options">Opsjoner</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tittel</label>
                        <input type="text" id="cf-title" required>
                    </div>
                    <div class="form-group">
                        <label>Vanskelighetsgrad</label>
                        <select id="cf-difficulty">
                            <option value="easy">Lett</option>
                            <option value="medium">Middels</option>
                            <option value="hard">Vanskelig</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sp√∏rsm√•l</label>
                    <textarea id="cf-question" required></textarea>
                </div>
                <div class="form-group">
                    <label>Alternativer (ett per linje, for MC)</label>
                    <textarea id="cf-options" placeholder="A: F√∏rste alternativ&#10;B: Andre alternativ&#10;C: Tredje alternativ"></textarea>
                </div>
                <div class="form-group">
                    <label>Data (JSON format for beregninger)</label>
                    <textarea id="cf-data" placeholder='{"investment": 100000, "rate": 0.10}'></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Riktig svar</label>
                        <input type="text" id="cf-answer" placeholder="a, b, c eller tall">
                    </div>
                    <div class="form-group">
                        <label>Toleranse (for beregninger)</label>
                        <input type="number" id="cf-tolerance" value="0" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Forklaring</label>
                    <textarea id="cf-explanation"></textarea>
                </div>
                <div class="form-group">
                    <label>Formel</label>
                    <input type="text" id="cf-formula" placeholder="NPV = Œ£(CF_t / (1+r)^t)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('cf-modal')">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bokf√∏ring Modal -->
    <div class="modal" id="bokforing-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bokforing-modal-title">Ny bokf√∏ringsoppgave</h2>
                <button class="modal-close" onclick="closeModal('bokforing-modal')">&times;</button>
            </div>
            <form onsubmit="saveBokforing(event)">
                <input type="hidden" id="bok-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Oppgavenummer</label>
                        <input type="number" id="bok-num" required>
                    </div>
                    <div class="form-group">
                        <label>Vanskelighetsgrad</label>
                        <select id="bok-difficulty">
                            <option value="easy">Lett</option>
                            <option value="medium">Middels</option>
                            <option value="hard">Vanskelig</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Beskrivelse</label>
                    <textarea id="bok-description" required placeholder="Varekj√∏p kontant kr 5.000"></textarea>
                </div>
                <div class="form-group">
                    <label>Hint</label>
                    <textarea id="bok-hint" placeholder="Varekj√∏p debiteres, bank krediteres"></textarea>
                </div>
                <div class="form-group">
                    <label>Lovhenvisning</label>
                    <input type="text" id="bok-law" placeholder="¬ß5-1 BOKL">
                </div>
                <div class="form-group">
                    <label>L√∏sning (JSON: debit og credit)</label>
                    <textarea id="bok-solution" placeholder='{"debit": {"4300": 5000}, "credit": {"1920": 5000}}'></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bokforing-modal')">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Wiki Modal -->
    <div class="modal" id="wiki-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="wiki-modal-title">Ny wiki-artikkel</h2>
                <button class="modal-close" onclick="closeModal('wiki-modal')">&times;</button>
            </div>
            <form onsubmit="saveWiki(event)">
                <input type="hidden" id="wiki-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tittel</label>
                        <input type="text" id="wiki-title" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori</label>
                        <select id="wiki-category">
                            <option value="lover">Lover</option>
                            <option value="definisjoner">Definisjoner</option>
                            <option value="regnskap">Regnskap</option>
                            <option value="skatt">Skatt</option>
                            <option value="mva">MVA</option>
                            <option value="analyse">Analyse</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Lovhenvisning</label>
                    <input type="text" id="wiki-lawref" placeholder="RSKL, BOKL, MVAL...">
                </div>
                <div class="form-group">
                    <label>Sammendrag</label>
                    <textarea id="wiki-summary" placeholder="Kort beskrivelse..."></textarea>
                </div>
                <div class="form-group">
                    <label>Innhold (Markdown st√∏ttes)</label>
                    <textarea id="wiki-content" style="min-height: 200px;" placeholder="## Overskrift&#10;&#10;Innhold her..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('wiki-modal')">Avbryt</button>
                    <button type="submit" class="btn btn-primary">Lagre</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDmLjTJPexLM2PkDHLHhO0KLVozxaEB9JM",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "1042365043389",
            appId: "1:1042365043389:web:a9f933aef3d5c3f6c37edc"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        const ADMIN_UID = '4fmvu6yn2UVB7rxM4L5pJUWnme72';
        const ROLE_LABELS = { admin: 'Admin', teacher_pro: 'L√¶rer Pro', teacher: 'L√¶rer', pro: 'Pro', student: 'Student', free: 'Gratis' };
        
        let currentUser = null;
        let allUsers = [];
        let allQuiz = [];
        let allCF = [];
        let allBokforing = [];
        let allWiki = [];
        let selectedRole = null;
        let pendingJsonData = null;
        
        // Auth
        auth.onAuthStateChanged(async user => {
            console.log('Auth state changed:', user ? user.email : 'not logged in', 'isAnonymous:', user?.isAnonymous);
            
            if (!user || user.isAnonymous) {
                // Not logged in - show login prompt
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîí</div>
                        <h2 style="margin-bottom: 10px;">Logg inn for √• fortsette</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Du m√• v√¶re logget inn som admin for √• f√• tilgang.</p>
                        <a href="auth.html" class="btn btn-primary" style="text-decoration: none;">üîë Logg inn</a>
                        <br><br>
                        <a href="index.html" class="btn btn-secondary" style="text-decoration: none;">‚Üê Tilbake til forsiden</a>
                    </div>
                `;
                document.getElementById('access-denied').style.display = 'flex';
                return;
            }
            
            currentUser = user;
            console.log('Logged in as:', user.uid, user.email);
            
            try {
                const snap = await db.ref('users/' + user.uid).once('value');
                const userData = snap.val() || {};
                
                // Accept multiple admin role formats (admin, Administrator, etc.)
                const userRole = (userData.role || '').toLowerCase();
                const isAdminRole = userRole === 'admin' || userRole === 'administrator';
                const isAdmin = user.uid === ADMIN_UID || isAdminRole;
                
                console.log('Auth check:', { 
                    uid: user.uid, 
                    ADMIN_UID, 
                    isAdmin, 
                    role: userData.role,
                    userRole,
                    isAdminRole,
                    uidMatch: user.uid === ADMIN_UID 
                });
                
                if (!isAdmin) {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('access-denied').style.display = 'flex';
                    return;
                }
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('user-info').textContent = user.email;
                
                refreshAll();
            } catch (err) {
                console.error('Error checking admin status:', err);
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').style.display = 'flex';
            }
        });
        
        function logout() { auth.signOut().then(() => window.location.href = 'index.html'); }
        
        // Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                if (!page) return;
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById('page-' + page).classList.add('active');
                
                if (page === 'users') loadUsers();
                else if (page === 'teachers') loadTeachers();
                else if (page === 'quiz') loadQuiz();
                else if (page === 'corporate-finance') loadCorporateFinance();
                else if (page === 'bokforing') loadBokforing();
                else if (page === 'wiki') loadWiki();
            });
        });
        
        // Dashboard
        async function refreshAll() {
            showToast('Oppdaterer...', 'info');
            const [users, quiz, cf, bokforing, wiki, teachers] = await Promise.all([
                db.ref('users').once('value'),
                db.ref('quizQuestions').once('value'),
                db.ref('solutions/corporate_finance').once('value'),
                db.ref('bokforing').once('value'),
                db.ref('wiki').once('value'),
                db.ref('teachers').once('value')
            ]);
            
            document.getElementById('stat-users').textContent = Object.keys(users.val() || {}).length;
            document.getElementById('stat-teachers').textContent = Object.keys(teachers.val() || {}).length;
            document.getElementById('stat-quiz').textContent = Object.keys(quiz.val() || {}).length;
            document.getElementById('stat-cf').textContent = Object.keys(cf.val() || {}).length;
            document.getElementById('stat-bokforing').textContent = Object.keys(bokforing.val() || {}).length;
            document.getElementById('stat-wiki').textContent = Object.keys(wiki.val() || {}).length;
            
            showToast('Oppdatert!', 'success');
        }
        
        // Users
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('users').once('value');
            allUsers = Object.entries(snap.val() || {}).map(([uid, data]) => ({ uid, ...data }));
            allUsers.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            renderUsers(allUsers);
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (!users.length) { tbody.innerHTML = '<tr><td colspan="4">Ingen brukere</td></tr>'; return; }
            
            tbody.innerHTML = users.map(u => {
                const role = u.role || 'free';
                const name = u.username || u.email?.split('@')[0] || 'Anonym';
                const created = u.createdAt ? new Date(u.createdAt).toLocaleDateString('no-NO') : '-';
                return `<tr>
                    <td><div style="font-weight:500">${name}</div><div style="font-size:0.75em;color:var(--text-muted)">${u.email || u.uid}</div></td>
                    <td><span class="badge role-${role}">${ROLE_LABELS[role] || role}</span></td>
                    <td>${created}</td>
                    <td><button class="btn btn-sm btn-secondary" onclick="editRole('${u.uid}','${name}','${role}')">‚úèÔ∏è</button></td>
                </tr>`;
            }).join('');
        }
        
        function filterUsers() {
            const s = document.getElementById('user-search').value.toLowerCase();
            renderUsers(allUsers.filter(u => (u.email||'').toLowerCase().includes(s) || (u.username||'').toLowerCase().includes(s)));
        }
        
        function editRole(uid, name, role) {
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-user-name').textContent = name;
            document.querySelectorAll('#role-selector .role-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.role === role);
                if (o.dataset.role === role) selectedRole = role;
            });
            document.getElementById('role-modal').classList.add('show');
        }
        
        document.querySelectorAll('#role-selector .role-option').forEach(o => {
            o.addEventListener('click', () => {
                document.querySelectorAll('#role-selector .role-option').forEach(x => x.classList.remove('selected'));
                o.classList.add('selected');
                selectedRole = o.dataset.role;
            });
        });
        
        async function saveRole() {
            const uid = document.getElementById('edit-user-id').value;
            if (!selectedRole) { showToast('Velg rolle', 'error'); return; }
            await db.ref('users/' + uid + '/role').set(selectedRole);
            showToast('Rolle oppdatert!', 'success');
            closeModal('role-modal');
            loadUsers();
        }
        
        // Teachers
        async function loadTeachers() {
            const tbody = document.getElementById('teachers-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('teachers').once('value');
            const teachers = snap.val() || {};
            
            if (!Object.keys(teachers).length) { tbody.innerHTML = '<tr><td colspan="4">Ingen l√¶rere</td></tr>'; return; }
            
            tbody.innerHTML = Object.entries(teachers).map(([id, t]) => `
                <tr>
                    <td>${t.name || '-'}</td>
                    <td>${t.email || '-'}</td>
                    <td>${t.school || '-'}</td>
                    <td><span class="badge ${t.verified ? 'badge-green' : 'badge-orange'}">${t.verified ? 'Verifisert' : 'Venter'}</span></td>
                </tr>
            `).join('');
        }
        
        // Quiz
        async function loadQuiz() {
            const tbody = document.getElementById('quiz-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('quizQuestions').once('value');
            allQuiz = Object.entries(snap.val() || {}).map(([id, q]) => ({ id, ...q }));
            renderQuiz(allQuiz);
        }
        
        function renderQuiz(questions) {
            const tbody = document.getElementById('quiz-table-body');
            if (!questions.length) { tbody.innerHTML = '<tr><td colspan="4">Ingen sp√∏rsm√•l</td></tr>'; return; }
            
            tbody.innerHTML = questions.slice(0, 100).map(q => `
                <tr>
                    <td>${(q.q || q.question || '').substring(0, 60)}...</td>
                    <td><span class="badge badge-blue">${q.category || '-'}</span></td>
                    <td><span class="badge badge-gray">${q.type || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editQuizItem('${q.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteQuiz('${q.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterQuiz() {
            const s = document.getElementById('quiz-search').value.toLowerCase();
            renderQuiz(allQuiz.filter(q => (q.q||q.question||'').toLowerCase().includes(s) || (q.category||'').includes(s)));
        }
        
        function openQuizModal(data = null) {
            document.getElementById('quiz-modal-title').textContent = data ? 'Rediger sp√∏rsm√•l' : 'Nytt sp√∏rsm√•l';
            document.getElementById('q-id').value = data?.id || '';
            document.getElementById('q-type').value = data?.type || 'mc';
            document.getElementById('q-category').value = data?.category || 'regnskap';
            document.getElementById('q-question').value = data?.q || data?.question || '';
            document.getElementById('q-options').value = (data?.opts || []).join('\n');
            document.getElementById('q-answer').value = data?.a ?? '';
            document.getElementById('q-law').value = data?.l || '';
            document.getElementById('q-explanation').value = data?.exp || '';
            document.getElementById('quiz-modal').classList.add('show');
        }
        
        function editQuizItem(id) {
            const q = allQuiz.find(x => x.id === id);
            if (q) openQuizModal(q);
        }
        
        async function saveQuiz(e) {
            e.preventDefault();
            const id = document.getElementById('q-id').value || 'q_' + Date.now();
            const opts = document.getElementById('q-options').value.split('\n').filter(x => x.trim());
            let answer = document.getElementById('q-answer').value;
            if (answer === 'true') answer = true;
            else if (answer === 'false') answer = false;
            else if (!isNaN(answer)) answer = parseInt(answer);
            
            const data = {
                type: document.getElementById('q-type').value,
                category: document.getElementById('q-category').value,
                q: document.getElementById('q-question').value,
                opts: opts.length ? opts : null,
                a: answer,
                l: document.getElementById('q-law').value,
                exp: document.getElementById('q-explanation').value,
                createdAt: Date.now()
            };
            
            await db.ref('quizQuestions/' + id).set(data);
            showToast('Lagret!', 'success');
            closeModal('quiz-modal');
            loadQuiz();
        }
        
        async function deleteQuiz(id) {
            if (!confirm('Slett sp√∏rsm√•l?')) return;
            await db.ref('quizQuestions/' + id).remove();
            showToast('Slettet!', 'success');
            loadQuiz();
        }
        
        // Corporate Finance
        async function loadCorporateFinance() {
            const tbody = document.getElementById('cf-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('solutions/corporate_finance').once('value');
            allCF = Object.entries(snap.val() || {}).map(([id, q]) => ({ id, ...q }));
            
            let mc = 0, calc = 0;
            allCF.forEach(q => { if ((q.type||'').includes('mc')) mc++; else calc++; });
            document.getElementById('cf-total').textContent = allCF.length;
            document.getElementById('cf-mc').textContent = mc;
            document.getElementById('cf-calc').textContent = calc;
            
            if (!allCF.length) { tbody.innerHTML = '<tr><td colspan="5">Ingen oppgaver</td></tr>'; return; }
            
            tbody.innerHTML = allCF.map(q => `
                <tr>
                    <td><code style="font-size:0.8em">${q.id}</code></td>
                    <td>${q.title || '-'}</td>
                    <td><span class="badge badge-blue">${q.topic || '-'}</span></td>
                    <td><span class="badge badge-gray">${q.type || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editCFItem('${q.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCF('${q.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deleteCF(id) {
            if (!confirm('Slett?')) return;
            await db.ref('solutions/corporate_finance/' + id).remove();
            await db.ref('questions/corporate_finance/' + id).remove();
            showToast('Slettet!', 'success');
            loadCorporateFinance();
        }
        
        function openCFModal(data = null) {
            document.getElementById('cf-modal-title').textContent = data ? 'Rediger CF-oppgave' : 'Ny CF-oppgave';
            document.getElementById('cf-id').value = data?.id || '';
            document.getElementById('cf-type').value = data?.type || 'multiple_choice';
            document.getElementById('cf-topic').value = data?.topic || 'npv';
            document.getElementById('cf-title').value = data?.title || '';
            document.getElementById('cf-difficulty').value = data?.difficulty || 'medium';
            document.getElementById('cf-question').value = data?.question || data?.q || '';
            
            // Handle options
            let optionsText = '';
            if (data?.options) {
                if (Array.isArray(data.options)) {
                    optionsText = data.options.map(o => typeof o === 'object' ? `${o.id}: ${o.text}` : o).join('\n');
                }
            }
            document.getElementById('cf-options').value = optionsText;
            
            document.getElementById('cf-data').value = data?.data ? JSON.stringify(data.data, null, 2) : '';
            document.getElementById('cf-answer').value = data?.correct || data?.answer || '';
            document.getElementById('cf-tolerance').value = data?.tolerance || 0;
            document.getElementById('cf-explanation').value = data?.explanation || data?.exp || '';
            document.getElementById('cf-formula').value = data?.formula || '';
            
            document.getElementById('cf-modal').classList.add('show');
        }
        
        async function editCFItem(id) {
            // Fetch both question and solution
            const [qSnap, sSnap] = await Promise.all([
                db.ref('questions/corporate_finance/' + id).once('value'),
                db.ref('solutions/corporate_finance/' + id).once('value')
            ]);
            const question = qSnap.val() || {};
            const solution = sSnap.val() || {};
            openCFModal({ id, ...question, ...solution });
        }
        
        async function saveCF(e) {
            e.preventDefault();
            const id = document.getElementById('cf-id').value || 'cf_' + Date.now();
            
            // Parse options
            const optionsText = document.getElementById('cf-options').value;
            let options = null;
            if (optionsText.trim()) {
                options = optionsText.split('\n').filter(l => l.trim()).map(line => {
                    const match = line.match(/^([a-zA-Z]):\s*(.+)$/);
                    return match ? { id: match[1].toLowerCase(), text: match[2] } : { id: 'x', text: line };
                });
            }
            
            // Parse data JSON
            let dataObj = null;
            const dataText = document.getElementById('cf-data').value;
            if (dataText.trim()) {
                try { dataObj = JSON.parse(dataText); } catch (e) { showToast('Ugyldig JSON i data-felt', 'error'); return; }
            }
            
            const questionData = {
                id: id,
                module: 'corporate_finance',
                type: document.getElementById('cf-type').value,
                topic: document.getElementById('cf-topic').value,
                title: document.getElementById('cf-title').value,
                difficulty: document.getElementById('cf-difficulty').value,
                question: document.getElementById('cf-question').value,
                options: options,
                data: dataObj,
                createdAt: Date.now()
            };
            
            // Remove nulls
            Object.keys(questionData).forEach(k => { if (questionData[k] === null) delete questionData[k]; });
            
            const solutionData = {
                correct: document.getElementById('cf-answer').value,
                tolerance: parseFloat(document.getElementById('cf-tolerance').value) || 0,
                explanation: document.getElementById('cf-explanation').value,
                formula: document.getElementById('cf-formula').value
            };
            
            await db.ref('questions/corporate_finance/' + id).set(questionData);
            await db.ref('solutions/corporate_finance/' + id).set(solutionData);
            
            showToast('Lagret!', 'success');
            closeModal('cf-modal');
            loadCorporateFinance();
        }
        
        async function purgeCF() {
            if (!confirm('Slett ALLE CF-oppgaver?')) return;
            if (!confirm('Er du HELT sikker?')) return;
            await db.ref('solutions/corporate_finance').remove();
            await db.ref('questions/corporate_finance').remove();
            showToast('Alle CF-oppgaver slettet!', 'success');
            loadCorporateFinance();
        }
        
        // Bokf√∏ring
        async function loadBokforing() {
            const tbody = document.getElementById('bokforing-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('bokforing').once('value');
            const data = snap.val() || {};
            
            if (!Object.keys(data).length) { tbody.innerHTML = '<tr><td colspan="4">Ingen oppgaver</td></tr>'; return; }
            
            allBokforing = Object.entries(data).map(([id, b]) => ({ id, ...b }));
            
            tbody.innerHTML = allBokforing.map(b => `
                <tr>
                    <td>${b.num || b.id}</td>
                    <td>${(b.description || '').substring(0, 50)}...</td>
                    <td><span class="badge badge-blue">${b.difficulty || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editBokforingItem('${b.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBokforing('${b.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deleteBokforing(id) {
            if (!confirm('Slett?')) return;
            await db.ref('bokforing/' + id).remove();
            showToast('Slettet!', 'success');
            loadBokforing();
        }
        
        function openBokforingModal(data = null) {
            document.getElementById('bokforing-modal-title').textContent = data ? 'Rediger bokf√∏ringsoppgave' : 'Ny bokf√∏ringsoppgave';
            document.getElementById('bok-id').value = data?.id || '';
            document.getElementById('bok-num').value = data?.num || '';
            document.getElementById('bok-difficulty').value = data?.difficulty || 'easy';
            document.getElementById('bok-description').value = data?.description || '';
            document.getElementById('bok-hint').value = data?.hint || '';
            document.getElementById('bok-law').value = data?.law || '';
            document.getElementById('bok-solution').value = data?.solution ? JSON.stringify(data.solution, null, 2) : '';
            document.getElementById('bokforing-modal').classList.add('show');
        }
        
        function editBokforingItem(id) {
            const b = allBokforing.find(x => x.id === id);
            if (b) openBokforingModal(b);
        }
        
        async function saveBokforing(e) {
            e.preventDefault();
            const id = document.getElementById('bok-id').value || 'bok_' + Date.now();
            
            let solution = null;
            const solText = document.getElementById('bok-solution').value;
            if (solText.trim()) {
                try { solution = JSON.parse(solText); } catch (e) { showToast('Ugyldig JSON i l√∏sning', 'error'); return; }
            }
            
            const data = {
                num: parseInt(document.getElementById('bok-num').value) || 0,
                difficulty: document.getElementById('bok-difficulty').value,
                description: document.getElementById('bok-description').value,
                hint: document.getElementById('bok-hint').value,
                law: document.getElementById('bok-law').value,
                solution: solution,
                createdAt: Date.now()
            };
            
            await db.ref('bokforing/' + id).set(data);
            showToast('Lagret!', 'success');
            closeModal('bokforing-modal');
            loadBokforing();
        }
        
        // Wiki
        async function loadWiki() {
            const tbody = document.getElementById('wiki-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('wiki').once('value');
            const data = snap.val() || {};
            
            if (!Object.keys(data).length) { tbody.innerHTML = '<tr><td colspan="4">Ingen artikler</td></tr>'; return; }
            
            allWiki = Object.entries(data).map(([id, w]) => ({ id, ...w }));
            
            tbody.innerHTML = allWiki.map(w => `
                <tr>
                    <td>${w.title || w.id}</td>
                    <td><span class="badge badge-purple">${w.category || '-'}</span></td>
                    <td>${w.lawRef || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="editWikiItem('${w.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWiki('${w.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deleteWiki(id) {
            if (!confirm('Slett?')) return;
            await db.ref('wiki/' + id).remove();
            showToast('Slettet!', 'success');
            loadWiki();
        }
        
        function openWikiModal(data = null) {
            document.getElementById('wiki-modal-title').textContent = data ? 'Rediger artikkel' : 'Ny artikkel';
            document.getElementById('wiki-id').value = data?.id || '';
            document.getElementById('wiki-title').value = data?.title || '';
            document.getElementById('wiki-category').value = data?.category || 'definisjoner';
            document.getElementById('wiki-lawref').value = data?.lawRef || '';
            document.getElementById('wiki-summary').value = data?.summary || '';
            document.getElementById('wiki-content').value = data?.content || '';
            document.getElementById('wiki-modal').classList.add('show');
        }
        
        function editWikiItem(id) {
            const w = allWiki.find(x => x.id === id);
            if (w) openWikiModal(w);
        }
        
        async function saveWiki(e) {
            e.preventDefault();
            const id = document.getElementById('wiki-id').value || 'wiki_' + Date.now();
            
            const data = {
                title: document.getElementById('wiki-title').value,
                category: document.getElementById('wiki-category').value,
                lawRef: document.getElementById('wiki-lawref').value,
                summary: document.getElementById('wiki-summary').value,
                content: document.getElementById('wiki-content').value,
                createdAt: Date.now()
            };
            
            await db.ref('wiki/' + id).set(data);
            showToast('Lagret!', 'success');
            closeModal('wiki-modal');
            loadWiki();
        }
        
        // Database Browser
        function setDBPath(path) { document.getElementById('db-path').value = path; browseDB(); }
        
        async function browseDB() {
            const path = document.getElementById('db-path').value.trim();
            const output = document.getElementById('db-output');
            if (!path) { output.textContent = 'Skriv inn en sti'; return; }
            
            output.textContent = 'Laster...';
            try {
                const snap = await db.ref(path).once('value');
                const data = snap.val();
                output.textContent = data ? JSON.stringify(data, null, 2) : 'Ingen data funnet';
            } catch (e) {
                output.textContent = 'Feil: ' + e.message;
            }
        }
        
        // Seeding functions
        async function seedQuiz() {
            const prog = document.getElementById('prog-quiz');
            prog.style.width = '10%';
            showMsg('seeder-message', 'üîÑ Seeder quiz...', 'info');
            
            const questions = [
                {type:"mc",category:"regnskap",q:"Hva best√•r √•rsregnskapet av?",opts:["Kun resultat og balanse","Resultat, balanse og noter","Resultat, balanse, kontantstr√∏m og noter","Kun balansen"],a:2,l:"¬ß 3-2 (RSKL)",exp:"√Örsregnskapet best√•r av resultat, balanse, kontantstr√∏m og noter."},
                {type:"tf",category:"regnskap",q:"Balanselikningen er Eiendeler = Egenkapital + Gjeld",a:true,l:"¬ß 4-1 (RSKL)",exp:"Alt selskapet eier er finansiert av eiere eller kreditorer."},
                {type:"mc",category:"bokforing",q:"Hvor lenge skal bilag oppbevares?",opts:["3 √•r","5 √•r","7 √•r","10 √•r"],a:1,l:"¬ß 13 (BOKL)",exp:"Bilag skal oppbevares i 5 √•r."},
                {type:"mc",category:"bokforing",q:"Hvilken kontoklass er kostnader?",opts:["1000-1999","3000-3999","4000-7999","8000-8999"],a:2,l:"NS 4102",exp:"Kontoklass 4-7 er kostnader."},
                {type:"mc",category:"mva",q:"Hva er standard MVA-sats i Norge?",opts:["15%","20%","25%","27%"],a:2,l:"¬ß 5-1 (MVAL)",exp:"Alminnelig sats er 25%."},
                {type:"tf",category:"mva",q:"Matvarer har 15% MVA",a:true,l:"¬ß 5-2 (MVAL)",exp:"N√¶ringsmidler har 15%."},
                {type:"mc",category:"skatt",q:"Hva er selskapsskattesatsen?",opts:["20%","22%","24%","27%"],a:1,l:"SKTL",exp:"Satsen er 22%."},
                {type:"mc",category:"analyse",q:"Hva m√•ler likviditetsgrad 1?",opts:["L√∏nnsomhet","Evne til √• betale kortsiktig gjeld","Soliditet","Effektivitet"],a:1,l:"GRS",exp:"LG1 = Oml√∏psmidler / Kortsiktig gjeld."}
            ];
            
            prog.style.width = '50%';
            const batch = {};
            questions.forEach((q, i) => batch['quiz_' + Date.now() + '_' + i] = {...q, createdAt: Date.now()});
            await db.ref('quizQuestions').update(batch);
            prog.style.width = '100%';
            showMsg('seeder-message', '‚úÖ ' + questions.length + ' quiz-sp√∏rsm√•l lagt til!', 'success');
            refreshAll();
        }
        
        async function seedBokforing() {
            const prog = document.getElementById('prog-bokforing');
            prog.style.width = '10%';
            showMsg('seeder-message', 'üîÑ Seeder bokf√∏ring...', 'info');
            
            const exercises = [
                {num:1,difficulty:"easy",description:"Varekj√∏p kontant kr 5.000",hint:"Varekj√∏p debiteres, bank krediteres",law:"¬ß5-1 BOKL",solution:{debit:{4300:5000},credit:{1920:5000}}},
                {num:2,difficulty:"easy",description:"Varesalg kontant kr 10.000 + 25% MVA",hint:"Bank debiteres, salg og MVA krediteres",law:"¬ß5-1 BOKL",solution:{debit:{1920:12500},credit:{3000:10000,2700:2500}}},
                {num:3,difficulty:"medium",description:"Kj√∏p av inventar kr 50.000 + MVA",hint:"Inventar og inng. MVA debiteres",law:"¬ß5-3 BOKL",solution:{debit:{1200:50000,2710:12500},credit:{2400:62500}}}
            ];
            
            prog.style.width = '50%';
            const batch = {};
            exercises.forEach(e => batch['bok_' + e.num] = {...e, createdAt: Date.now()});
            await db.ref('bokforing').update(batch);
            prog.style.width = '100%';
            showMsg('seeder-message', '‚úÖ ' + exercises.length + ' bokf√∏ringsoppgaver lagt til!', 'success');
            refreshAll();
        }
        
        async function seedWiki() {
            const prog = document.getElementById('prog-wiki');
            prog.style.width = '10%';
            showMsg('seeder-message', 'üîÑ Seeder wiki...', 'info');
            
            const articles = [
                {id:"rskl-intro",title:"Regnskapsloven",category:"lover",lawRef:"RSKL",summary:"Regnskapsloven regulerer bokf√∏ring og √•rsregnskap"},
                {id:"bokl-intro",title:"Bokf√∏ringsloven",category:"lover",lawRef:"BOKL",summary:"Bokf√∏ringsloven stiller krav til bilag og oppbevaring"},
                {id:"mval-intro",title:"Merverdiavgiftsloven",category:"lover",lawRef:"MVAL",summary:"MVA-loven regulerer merverdiavgift"}
            ];
            
            prog.style.width = '50%';
            const batch = {};
            articles.forEach(a => batch[a.id] = {...a, createdAt: Date.now()});
            await db.ref('wiki').update(batch);
            prog.style.width = '100%';
            showMsg('seeder-message', '‚úÖ ' + articles.length + ' wiki-artikler lagt til!', 'success');
            refreshAll();
        }
        
        async function seedCorporateFinance() {
            const prog = document.getElementById('prog-cf');
            prog.style.width = '10%';
            showMsg('seeder-message', 'üîÑ Seeder Corporate Finance...', 'info');
            
            const questions = {
                cf_npv_calc_001: {id:'cf_npv_calc_001',module:'corporate_finance',topic:'npv',difficulty:'medium',type:'calculation',title:'NPV Beregning',question:'Investering 100.000, CF √•r 1: 40.000, √•r 2: 50.000. r=10%. Beregn NPV.',data:{investment:100000,cf_year1:40000,cf_year2:50000,discount_rate:0.10},input_fields:[{id:'npv',label:'NPV',unit:'NOK'}]},
                cf_stocks_mc_001: {id:'cf_stocks_mc_001',module:'corporate_finance',topic:'stocks',difficulty:'easy',type:'multiple_choice',title:'Gordon Growth',question:'Hvilken formel beskriver Gordon Growth Model?',options:[{id:'a',text:'P‚ÇÄ = D‚ÇÅ / (r - g)'},{id:'b',text:'P‚ÇÄ = D‚ÇÄ / (r + g)'},{id:'c',text:'P‚ÇÄ = D‚ÇÅ √ó (r - g)'}]}
            };
            
            const solutions = {
                cf_npv_calc_001: {correct:{npv:-17355.37},tolerance:10,explanation:'NPV = 40000/1.1 + 50000/1.1¬≤ - 100000'},
                cf_stocks_mc_001: {correct:'a',explanation:'Gordon Growth: P‚ÇÄ = D‚ÇÅ / (r - g)'}
            };
            
            prog.style.width = '50%';
            await db.ref('questions/corporate_finance').update(questions);
            await db.ref('solutions/corporate_finance').update(solutions);
            prog.style.width = '100%';
            showMsg('seeder-message', '‚úÖ CF-eksempler lagt til!', 'success');
            refreshAll();
        }
        
        async function seedHjernetrim() {
            const prog = document.getElementById('prog-hjernetrim');
            prog.style.width = '50%';
            showMsg('seeder-message', 'üîÑ Seeder hjernetrim...', 'info');
            
            // Hjernetrim bruker localStorage, ikke Firebase - bare vis melding
            prog.style.width = '100%';
            showMsg('seeder-message', '‚úÖ Hjernetrim bruker lokal data - ingen Firebase-seed n√∏dvendig', 'success');
        }
        
        async function seedAll() {
            showMsg('seeder-message', 'üîÑ Seeder alt...', 'info');
            await seedQuiz();
            await seedBokforing();
            await seedWiki();
            await seedCorporateFinance();
            showMsg('seeder-message', '‚úÖ Alt innhold seeded!', 'success');
        }
        
        // Import
        function handleJsonFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    let questions = data.quizQuestions || data;
                    if (Array.isArray(data)) {
                        questions = {};
                        data.forEach((q, i) => questions[q.id || 'q_' + i] = q);
                    }
                    
                    pendingJsonData = questions;
                    const count = Object.keys(questions).length;
                    document.getElementById('json-preview-count').textContent = count + ' sp√∏rsm√•l funnet';
                    document.getElementById('json-preview').style.display = 'block';
                    document.getElementById('btn-import-json').disabled = false;
                    
                    const cats = {};
                    Object.values(questions).forEach(q => { cats[q.category || 'ukjent'] = (cats[q.category || 'ukjent'] || 0) + 1; });
                    document.getElementById('json-categories').innerHTML = Object.entries(cats).map(([c, n]) => `<span class="badge badge-blue">${c}: ${n}</span>`).join(' ');
                    
                    showMsg('import-message', '‚úÖ Fil lastet: ' + file.name, 'success');
                } catch (err) {
                    showMsg('import-message', '‚ùå Ugyldig JSON: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        async function importJsonToFirebase() {
            if (!pendingJsonData) return;
            const count = Object.keys(pendingJsonData).length;
            if (!confirm('Importer ' + count + ' sp√∏rsm√•l?')) return;
            
            const prog = document.getElementById('prog-json-import');
            const btn = document.getElementById('btn-import-json');
            btn.disabled = true;
            prog.style.width = '50%';
            
            // Detect if CF
            const first = Object.values(pendingJsonData)[0];
            const isCF = first?.module === 'corporate_finance' || first?.category === 'corporate_finance';
            
            if (isCF) {
                for (const [id, q] of Object.entries(pendingJsonData)) {
                    await db.ref('questions/corporate_finance/' + id).set(q);
                    if (q.correct || q.a) {
                        await db.ref('solutions/corporate_finance/' + id).set({correct: q.correct || q.a, explanation: q.explanation || q.exp || ''});
                    }
                }
            } else {
                await db.ref('quizQuestions').update(pendingJsonData);
            }
            
            prog.style.width = '100%';
            showMsg('import-message', '‚úÖ ' + count + ' sp√∏rsm√•l importert!', 'success');
            pendingJsonData = null;
            document.getElementById('json-preview').style.display = 'none';
            refreshAll();
        }
        
        // Export
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            showToast('Eksportert!', 'success');
        }
        
        async function exportQuizJSON() {
            const snap = await db.ref('quizQuestions').once('value');
            downloadJSON(snap.val() || {}, 'quiz_' + new Date().toISOString().split('T')[0] + '.json');
        }
        
        async function exportQuizExcel() {
            const snap = await db.ref('quizQuestions').once('value');
            const data = Object.entries(snap.val() || {}).map(([id, q]) => ({ID: id, Type: q.type, Kategori: q.category, Sp√∏rsm√•l: q.q, Svar: q.a, Lov: q.l}));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Quiz');
            XLSX.writeFile(wb, 'quiz.xlsx');
            showToast('Eksportert!', 'success');
        }
        
        async function exportCFJSON() {
            const [q, s] = await Promise.all([db.ref('questions/corporate_finance').once('value'), db.ref('solutions/corporate_finance').once('value')]);
            downloadJSON({questions: q.val(), solutions: s.val()}, 'corporate_finance_' + new Date().toISOString().split('T')[0] + '.json');
        }
        
        async function exportUsersJSON() {
            const snap = await db.ref('users').once('value');
            downloadJSON(snap.val() || {}, 'users_' + new Date().toISOString().split('T')[0] + '.json');
        }
        
        async function exportFullBackup() {
            showToast('Laster ned backup...', 'info');
            const snap = await db.ref('/').once('value');
            downloadJSON(snap.val() || {}, 'full_backup_' + new Date().toISOString().split('T')[0] + '.json');
        }
        
        // Helpers
        function closeModal(id) { document.getElementById(id).classList.remove('show'); selectedRole = null; }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast ' + type + ' show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function showMsg(elId, msg, type) {
            const el = document.getElementById(elId);
            if (el) el.innerHTML = '<div class="message ' + type + '">' + msg + '</div>';
        }
        
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));
    </script>
</body>
</html>
