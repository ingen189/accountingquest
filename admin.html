<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîß</text></svg>">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #2d333b;
            --accent: #4ade80;
            --accent-hover: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border: #2d333b;
            --radius: 10px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', -apple-system, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh; 
        }
        
        /* Header */
        .header { 
            background: var(--bg-secondary); 
            padding: 15px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 { color: var(--accent); font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .user-info { color: var(--text-secondary); font-size: 0.85em; }
        
        /* Buttons */
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.85em;
            transition: all 0.2s; 
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-primary { background: var(--accent); color: #1a1a1a; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: #1a1a1a; }
        .btn-info { background: var(--info); color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.75em; }
        
        /* Layout */
        .container { display: flex; min-height: calc(100vh - 60px); }
        
        /* Sidebar */
        .sidebar { 
            width: 240px; 
            background: var(--bg-secondary); 
            border-right: 1px solid var(--border);
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar-section { 
            padding: 12px 20px 8px; 
            font-size: 0.7em; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 1px;
        }
        .sidebar-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--text-secondary); 
            font-size: 0.9em;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }
        .sidebar-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .sidebar-item.active { 
            background: rgba(74, 222, 128, 0.1); 
            color: var(--accent); 
            border-left-color: var(--accent); 
        }
        .sidebar-item .count {
            margin-left: auto;
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        
        /* Main content */
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .page-title { font-size: 1.5em; color: var(--accent); }
        
        /* Stats grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        .stat-card { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 20px; 
            text-align: center; 
        }
        .stat-value { font-size: 2em; font-weight: bold; color: var(--accent); }
        .stat-label { color: var(--text-secondary); font-size: 0.8em; margin-top: 5px; }
        
        /* Tables */
        .table-container { 
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 10px;
        }
        .search-input {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            width: 250px;
            font-size: 0.9em;
        }
        .search-input:focus { outline: none; border-color: var(--accent); }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .data-table th, .data-table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid var(--border); 
        }
        .data-table th { 
            background: var(--bg-tertiary); 
            font-weight: 600; 
            color: var(--accent);
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        .data-table tr:hover { background: rgba(74, 222, 128, 0.05); }
        .data-table-scroll { max-height: 60vh; overflow-y: auto; }
        
        /* Badges */
        .badge { 
            display: inline-block; 
            padding: 3px 10px; 
            border-radius: 12px; 
            font-size: 0.75em; 
            font-weight: 600; 
        }
        .badge-green { background: rgba(74, 222, 128, 0.2); color: var(--accent); }
        .badge-blue { background: rgba(59, 130, 246, 0.2); color: var(--info); }
        .badge-orange { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-red { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: var(--purple); }
        .badge-gray { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        /* Role badges */
        .role-admin { background: #ef4444; color: white; }
        .role-teacher_pro { background: #8b5cf6; color: white; }
        .role-teacher { background: #a78bfa; color: white; }
        .role-teacher_lite { background: #c4b5fd; color: #1f2937; }
        .role-pro { background: #f59e0b; color: white; }
        .role-student_pro { background: #10b981; color: white; }
        .role-student { background: #34d399; color: #1f2937; }
        .role-free { background: var(--bg-tertiary); color: var(--text-secondary); }
        
        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            color: var(--text-secondary); 
            font-size: 0.85em; 
        }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px 12px; 
            background: var(--bg-tertiary); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            color: var(--text-primary); 
            font-size: 0.9em; 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { 
            outline: none; 
            border-color: var(--accent); 
        }
        .form-group textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0, 0, 0, 0.85); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 25px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
        }
        .modal-header h2 { color: var(--accent); font-size: 1.2em; }
        .modal-close { 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            font-size: 1.5em; 
            cursor: pointer; 
            line-height: 1;
        }
        .modal-footer { 
            display: flex; 
            gap: 10px; 
            justify-content: flex-end; 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1px solid var(--border); 
        }
        
        /* Tabs */
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--border);
            overflow-x: auto;
        }
        .tab { 
            padding: 10px 18px; 
            background: none; 
            border: none; 
            color: var(--text-secondary); 
            cursor: pointer; 
            font-size: 0.9em;
            white-space: nowrap;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { 
            color: var(--accent); 
            border-bottom: 2px solid var(--accent); 
            margin-bottom: -2px; 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Path selector */
        .path-selector { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
        }
        .path-btn { 
            padding: 8px 14px; 
            background: var(--bg-tertiary); 
            border: 2px solid transparent; 
            border-radius: 6px; 
            color: var(--text-primary); 
            cursor: pointer; 
            font-size: 0.85em;
        }
        .path-btn:hover { background: var(--bg-secondary); }
        .path-btn.active { border-color: var(--accent); background: rgba(74, 222, 128, 0.1); }
        
        /* Log */
        .log { 
            background: #000; 
            border-radius: 8px; 
            padding: 15px; 
            font-family: 'Consolas', monospace; 
            font-size: 0.8em; 
            max-height: 250px; 
            overflow-y: auto; 
        }
        .log-entry { margin: 3px 0; }
        .log-success { color: #22c55e; }
        .log-error { color: #ef4444; }
        .log-info { color: #60a5fa; }
        .log-warning { color: #f59e0b; }
        
        /* Danger zone */
        .danger-zone { 
            background: rgba(239, 68, 68, 0.1); 
            border: 2px solid var(--danger); 
            border-radius: var(--radius); 
            padding: 20px; 
            margin-top: 25px; 
        }
        .danger-zone h3 { color: var(--danger); margin-bottom: 10px; }
        .danger-zone p { color: #f87171; font-size: 0.9em; margin-bottom: 15px; }
        
        /* Cards */
        .card { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 20px; 
            margin-bottom: 15px;
        }
        .card h3 { color: var(--text-primary); margin-bottom: 10px; font-size: 1.1em; }
        .card p { color: var(--text-secondary); font-size: 0.85em; margin-bottom: 15px; }
        
        /* Progress bar */
        .progress-bar { 
            height: 6px; 
            background: var(--bg-tertiary); 
            border-radius: 3px; 
            overflow: hidden; 
            margin-top: 10px; 
        }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; }
        
        /* Role options */
        .role-options { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .role-option { 
            padding: 12px; 
            background: var(--bg-tertiary); 
            border: 2px solid transparent; 
            border-radius: 8px; 
            cursor: pointer;
            text-align: center;
        }
        .role-option:hover { border-color: var(--border); }
        .role-option.selected { border-color: var(--accent); background: rgba(74, 222, 128, 0.1); }
        .role-option-title { font-weight: 600; margin-bottom: 4px; }
        .role-option-desc { font-size: 0.75em; color: var(--text-secondary); }
        
        /* Loading */
        .loading { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 150px; 
            color: var(--text-secondary); 
        }
        .spinner { 
            width: 30px; 
            height: 30px; 
            border: 3px solid var(--bg-tertiary); 
            border-top-color: var(--accent); 
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            margin-right: 12px; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--accent); color: #1a1a1a; }
        .toast.error { background: var(--danger); color: white; }
        .toast.info { background: var(--info); color: white; }
        
        /* Access denied */
        .access-denied { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            text-align: center; 
        }
        .access-denied h1 { font-size: 4em; margin-bottom: 20px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { 
                width: 100%; 
                display: flex; 
                overflow-x: auto; 
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            .sidebar-section { display: none; }
            .sidebar-item { white-space: nowrap; padding: 10px 15px; border-left: none; }
            .sidebar-item.active { border-left: none; border-bottom: 2px solid var(--accent); }
            .form-row { grid-template-columns: 1fr; }
            .role-options { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="access-denied">
        <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
        <p>Sjekker tilgang...</p>
    </div>
    
    <!-- Access Denied -->
    <div id="access-denied" class="access-denied" style="display: none;">
        <h1>üîí</h1>
        <h2>Ingen tilgang</h2>
        <p style="color: var(--text-secondary); margin: 20px 0;">Du m√• v√¶re admin for √• f√• tilgang til denne siden.</p>
        <a href="index.html" class="btn btn-primary">‚Üê Tilbake til forsiden</a>
    </div>
    
    <!-- Main App -->
    <div id="app" style="display: none;">
        <header class="header">
            <h1>üîß Admin Dashboard</h1>
            <div class="header-actions">
                <span class="user-info" id="user-info"></span>
                <a href="index.html" class="btn btn-secondary">‚Üê Tilbake</a>
                <button class="btn btn-danger" onclick="logout()">Logg ut</button>
            </div>
        </header>
        
        <div class="container">
            <!-- Sidebar Navigation -->
            <nav class="sidebar">
                <div class="sidebar-section">Oversikt</div>
                <div class="sidebar-item active" data-page="dashboard">üìä Dashboard</div>
                
                <div class="sidebar-section">Brukere</div>
                <div class="sidebar-item" data-page="users">üë• Brukere <span class="count" id="nav-users-count">0</span></div>
                <div class="sidebar-item" data-page="teachers">üë®‚Äçüè´ L√¶rere <span class="count" id="nav-teachers-count">0</span></div>
                <div class="sidebar-item" data-page="classrooms">üè´ Klasserom <span class="count" id="nav-classrooms-count">0</span></div>
                
                <div class="sidebar-section">Innhold</div>
                <div class="sidebar-item" data-page="quiz">‚ùì Quiz <span class="count" id="nav-quiz-count">0</span></div>
                <div class="sidebar-item" data-page="corporate-finance">üìà Corporate Finance <span class="count" id="nav-cf-count">0</span></div>
                <div class="sidebar-item" data-page="bokforing">üìñ Bokf√∏ring <span class="count" id="nav-bokforing-count">0</span></div>
                <div class="sidebar-item" data-page="wiki">üìö Wiki <span class="count" id="nav-wiki-count">0</span></div>
                
                <div class="sidebar-section">System</div>
                <div class="sidebar-item" data-page="seeder">üå± Import/Seed</div>
                <div class="sidebar-item" data-page="export">üì§ Eksport</div>
                <div class="sidebar-item" data-page="database">üóÑÔ∏è Database Browser</div>
            </nav>
            
            <!-- Main Content -->
            <main class="main">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page active">
                    <div class="page-header">
                        <h2 class="page-title">üìä Dashboard</h2>
                        <button class="btn btn-primary" onclick="refreshAll()">üîÑ Oppdater alt</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-users">-</div>
                            <div class="stat-label">Brukere totalt</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-active">-</div>
                            <div class="stat-label">Aktive i dag</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-teachers">-</div>
                            <div class="stat-label">L√¶rere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-pro">-</div>
                            <div class="stat-label">Pro-brukere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-questions">-</div>
                            <div class="stat-label">Sp√∏rsm√•l totalt</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-wiki">-</div>
                            <div class="stat-label">Wiki-artikler</div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üîç Hurtigs√∏k</h3>
                        <input type="text" class="search-input" style="width: 100%; margin-top: 10px;" placeholder="S√∏k etter bruker, sp√∏rsm√•l, eller innhold..." id="global-search" onkeyup="globalSearch(this.value)">
                        <div id="global-search-results" style="margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Users Page -->
                <div id="page-users" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üë• Brukeradministrasjon</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportUsers()">üì§ Eksporter</button>
                            <button class="btn btn-primary" onclick="loadUsers()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="users-total">-</div>
                            <div class="stat-label">Totalt</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="users-pro">-</div>
                            <div class="stat-label">Pro</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="users-teachers">-</div>
                            <div class="stat-label">L√¶rere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="users-today">-</div>
                            <div class="stat-label">Aktive i dag</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" placeholder="S√∏k brukere..." id="user-search" onkeyup="filterUsers()">
                            <select id="user-role-filter" onchange="filterUsers()" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                                <option value="">Alle roller</option>
                                <option value="admin">Admin</option>
                                <option value="teacher_pro">L√¶rer Pro</option>
                                <option value="teacher">L√¶rer</option>
                                <option value="pro">Pro</option>
                                <option value="student">Student</option>
                                <option value="free">Gratis</option>
                            </select>
                        </div>
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Bruker</th>
                                        <th>Rolle</th>
                                        <th>Opprettet</th>
                                        <th>Sist aktiv</th>
                                        <th>Handlinger</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers Page -->
                <div id="page-teachers" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üë®‚Äçüè´ L√¶rere</h2>
                        <button class="btn btn-primary" onclick="loadTeachers()">üîÑ Oppdater</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Navn</th>
                                        <th>E-post</th>
                                        <th>Skole</th>
                                        <th>Plan</th>
                                        <th>Status</th>
                                        <th>Handlinger</th>
                                    </tr>
                                </thead>
                                <tbody id="teachers-table-body">
                                    <tr><td colspan="6" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Classrooms Page -->
                <div id="page-classrooms" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üè´ Klasserom</h2>
                        <button class="btn btn-primary" onclick="loadClassrooms()">üîÑ Oppdater</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Navn</th>
                                        <th>L√¶rer</th>
                                        <th>Kode</th>
                                        <th>Elever</th>
                                        <th>Opprettet</th>
                                    </tr>
                                </thead>
                                <tbody id="classrooms-table-body">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Quiz Page -->
                <div id="page-quiz" class="page">
                    <div class="page-header">
                        <h2 class="page-title">‚ùì Quiz-sp√∏rsm√•l</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportQuiz()">üì§ Eksporter</button>
                            <button class="btn btn-primary" onclick="loadQuiz()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="quiz-total">-</div>
                            <div class="stat-label">Totalt</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="quiz-mc">-</div>
                            <div class="stat-label">Multiple Choice</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="quiz-calc">-</div>
                            <div class="stat-label">Beregning</div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" placeholder="S√∏k sp√∏rsm√•l..." id="quiz-search" onkeyup="filterQuiz()">
                        </div>
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tittel</th>
                                        <th>Kategori</th>
                                        <th>Type</th>
                                        <th>Handlinger</th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-table-body">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Corporate Finance Page -->
                <div id="page-corporate-finance" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìà Corporate Finance</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="exportCF()">üì§ Eksporter</button>
                            <button class="btn btn-primary" onclick="loadCorporateFinance()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="showCFTab('questions')">Sp√∏rsm√•l</button>
                        <button class="tab" onclick="showCFTab('solutions')">L√∏sninger</button>
                        <button class="tab" onclick="showCFTab('structure')">Struktur</button>
                    </div>
                    
                    <div class="path-selector">
                        <button class="path-btn active" data-path="solutions/corporate_finance">solutions/corporate_finance</button>
                        <button class="path-btn" data-path="questions/corporate_finance">questions/corporate_finance</button>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="cf-total">-</div>
                            <div class="stat-label">Totalt</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cf-mc">-</div>
                            <div class="stat-label">Multiple Choice</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cf-calc">-</div>
                            <div class="stat-label">Beregning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="cf-tf">-</div>
                            <div class="stat-label">Sant/Usant</div>
                        </div>
                    </div>
                    
                    <div id="cf-tab-questions" class="tab-content active">
                        <div class="table-container">
                            <div class="table-header">
                                <input type="text" class="search-input" placeholder="S√∏k oppgaver..." id="cf-search" onkeyup="filterCF()">
                            </div>
                            <div class="data-table-scroll">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Tittel</th>
                                            <th>Topic</th>
                                            <th>Type</th>
                                            <th>Difficulty</th>
                                            <th>Handlinger</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cf-table-body">
                                        <tr><td colspan="6" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div id="cf-tab-structure" class="tab-content">
                        <div class="card">
                            <h3>üìã Anbefalt database-struktur</h3>
                            <p>Se CF_DATABASE_STRUCTURE.md for komplett dokumentasjon</p>
                            <pre style="background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; margin-top: 15px; font-size: 0.8em;">
questions/corporate_finance/{questionId}/
  id: "cf_npv_001"
  module: "corporate_finance"
  topic: "npv" | "bonds" | "stocks" | "wacc" | "portfolio" | "annuity" | "forex" | "options"
  difficulty: "easy" | "medium" | "hard"
  type: "calculation" | "multiple_choice" | "true_false" | "excel_grid"
  title: "NPV Beregning"
  question: "Et prosjekt krever..."
  data: { investment: 100000, ... }
  input_fields: [{ id: "npv", label: "NPV", unit: "NOK" }]
  hints: ["Hint 1", "Hint 2"]

solutions/corporate_finance/{questionId}/
  correct: { npv: 12396.69 } | "b"
  tolerance: 0.1
  explanation: "..."
  formula: "NPV = ..."</pre>
                        </div>
                    </div>
                    
                    <div class="danger-zone">
                        <h3>‚ö†Ô∏è Danger Zone</h3>
                        <p>Disse handlingene kan ikke angres!</p>
                        <button class="btn btn-danger" onclick="purgeCF()">üóëÔ∏è Slett ALLE CF-oppgaver</button>
                        <button class="btn btn-warning" onclick="purgeCFByTopic()">üóëÔ∏è Slett etter topic</button>
                    </div>
                </div>
                
                <!-- Bokf√∏ring Page -->
                <div id="page-bokforing" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìñ Bokf√∏ring</h2>
                        <button class="btn btn-primary" onclick="loadBokforing()">üîÑ Oppdater</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tittel</th>
                                        <th>Niv√•</th>
                                        <th>Handlinger</th>
                                    </tr>
                                </thead>
                                <tbody id="bokforing-table-body">
                                    <tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Wiki Page -->
                <div id="page-wiki" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üìö Wiki</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="showWikiEditor()">+ Ny artikkel</button>
                            <button class="btn btn-primary" onclick="loadWiki()">üîÑ Oppdater</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <input type="text" class="search-input" placeholder="S√∏k artikler..." id="wiki-search" onkeyup="filterWiki()">
                        </div>
                        <div class="data-table-scroll">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tittel</th>
                                        <th>Kategori</th>
                                        <th>Lov</th>
                                        <th>Oppdatert</th>
                                        <th>Handlinger</th>
                                    </tr>
                                </thead>
                                <tbody id="wiki-table-body">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Seeder Page -->
                <div id="page-seeder" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üå± Import / Seed Data</h2>
                    </div>
                    
                    <div class="card">
                        <h3>üì§ Importer fra JSON/Excel</h3>
                        <p>Last opp en fil med sp√∏rsm√•l i riktig format</p>
                        <input type="file" id="import-file" accept=".json,.xlsx,.xls" style="margin-top: 15px;">
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="importFile()">üì• Importer</button>
                        </div>
                        <div class="progress-bar" style="display: none;" id="import-progress">
                            <div class="progress-fill" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üß™ Seed eksempeldata</h3>
                        <p>Legg til noen eksempeloppgaver for testing</p>
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="seedCFExamples()">üìà CF Eksempler</button>
                            <button class="btn btn-secondary" onclick="seedQuizExamples()">‚ùì Quiz Eksempler</button>
                            <button class="btn btn-secondary" onclick="seedWikiExamples()">üìö Wiki Eksempler</button>
                        </div>
                    </div>
                </div>
                
                <!-- Export Page -->
                <div id="page-export" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üì§ Eksporter Data</h2>
                    </div>
                    
                    <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div class="card">
                            <h3>üë• Brukere</h3>
                            <p>Eksporter alle brukerdata</p>
                            <button class="btn btn-info" onclick="exportUsers()">üì• Last ned JSON</button>
                        </div>
                        <div class="card">
                            <h3>‚ùì Quiz</h3>
                            <p>Eksporter alle quiz-sp√∏rsm√•l</p>
                            <button class="btn btn-info" onclick="exportQuiz()">üì• Last ned JSON</button>
                        </div>
                        <div class="card">
                            <h3>üìà Corporate Finance</h3>
                            <p>Eksporter CF-oppgaver</p>
                            <button class="btn btn-info" onclick="exportCF()">üì• Last ned JSON</button>
                        </div>
                        <div class="card">
                            <h3>üìö Wiki</h3>
                            <p>Eksporter wiki-artikler</p>
                            <button class="btn btn-info" onclick="exportWiki()">üì• Last ned JSON</button>
                        </div>
                        <div class="card">
                            <h3>üóÑÔ∏è Full Backup</h3>
                            <p>Eksporter hele databasen</p>
                            <button class="btn btn-warning" onclick="exportFullBackup()">üì• Full Backup</button>
                        </div>
                    </div>
                </div>
                
                <!-- Database Browser Page -->
                <div id="page-database" class="page">
                    <div class="page-header">
                        <h2 class="page-title">üóÑÔ∏è Database Browser</h2>
                    </div>
                    
                    <div class="form-group">
                        <label>Database-sti</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="db-path" placeholder="f.eks. users eller questions/corporate_finance" style="flex: 1;">
                            <button class="btn btn-primary" onclick="browseDB()">üìÇ Bla</button>
                        </div>
                    </div>
                    
                    <div class="path-selector">
                        <button class="path-btn" onclick="setDBPath('users')">users</button>
                        <button class="path-btn" onclick="setDBPath('teachers')">teachers</button>
                        <button class="path-btn" onclick="setDBPath('classrooms')">classrooms</button>
                        <button class="path-btn" onclick="setDBPath('quizQuestions')">quizQuestions</button>
                        <button class="path-btn" onclick="setDBPath('questions/corporate_finance')">questions/cf</button>
                        <button class="path-btn" onclick="setDBPath('solutions/corporate_finance')">solutions/cf</button>
                        <button class="path-btn" onclick="setDBPath('wiki/articles')">wiki</button>
                    </div>
                    
                    <div class="log" id="db-browser-output" style="max-height: 500px;">
                        <div class="log-info">Velg en sti for √• bla i databasen</div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Role Edit Modal -->
    <div class="modal" id="role-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Endre rolle</h2>
                <button class="modal-close" onclick="closeModal('role-modal')">&times;</button>
            </div>
            <p style="margin-bottom: 15px;">Bruker: <strong id="edit-user-name"></strong></p>
            <input type="hidden" id="edit-user-id">
            
            <div class="role-options" id="role-selector">
                <div class="role-option" data-role="admin">
                    <div class="role-option-title">üëë Admin</div>
                    <div class="role-option-desc">Full tilgang</div>
                </div>
                <div class="role-option" data-role="teacher_pro">
                    <div class="role-option-title">üë®‚Äçüè´ L√¶rer Pro</div>
                    <div class="role-option-desc">Alle l√¶rer-funksjoner</div>
                </div>
                <div class="role-option" data-role="teacher">
                    <div class="role-option-title">üë®‚Äçüè´ L√¶rer</div>
                    <div class="role-option-desc">Standard l√¶rer</div>
                </div>
                <div class="role-option" data-role="pro">
                    <div class="role-option-title">‚≠ê Pro</div>
                    <div class="role-option-desc">Premium-bruker</div>
                </div>
                <div class="role-option" data-role="student">
                    <div class="role-option-title">üìö Student</div>
                    <div class="role-option-desc">Student-konto</div>
                </div>
                <div class="role-option" data-role="free">
                    <div class="role-option-title">üÜì Gratis</div>
                    <div class="role-option-desc">Grunnleggende tilgang</div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('role-modal')">Avbryt</button>
                <button class="btn btn-primary" onclick="saveRole()">Lagre</button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDmLjTJPexLM2PkDHLHhO0KLVozxaEB9JM",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "1042365043389",
            appId: "1:1042365043389:web:a9f933aef3d5c3f6c37edc"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        const ADMIN_UID = '4fmvu6yn2UVB7rxM4L5pJUWnme72';
        const ROLE_LABELS = {
            'admin': 'Admin',
            'teacher_pro': 'L√¶rer Pro',
            'teacher': 'L√¶rer',
            'teacher_lite': 'L√¶rer Lite',
            'pro': 'Pro',
            'student_pro': 'Student Pro',
            'student': 'Student',
            'free': 'Gratis'
        };
        
        let currentUser = null;
        let allUsers = [];
        let allQuiz = [];
        let allCF = [];
        let allWiki = [];
        let selectedRole = null;
        let cfPath = 'solutions/corporate_finance';
        
        // Auth check
        auth.onAuthStateChanged(async user => {
            if (!user) {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').style.display = 'flex';
                return;
            }
            
            currentUser = user;
            
            // Check admin
            const snap = await db.ref('users/' + user.uid).once('value');
            const userData = snap.val() || {};
            const isAdmin = user.uid === ADMIN_UID || userData.role === 'admin';
            
            if (!isAdmin) {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('access-denied').style.display = 'flex';
                return;
            }
            
            // Show app
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('user-info').textContent = user.email;
            
            // Load initial data
            refreshAll();
        });
        
        function logout() {
            auth.signOut().then(() => window.location.href = 'index.html');
        }
        
        // Navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                if (!page) return;
                
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                
                item.classList.add('active');
                document.getElementById('page-' + page).classList.add('active');
                
                // Load data for page
                if (page === 'users') loadUsers();
                else if (page === 'teachers') loadTeachers();
                else if (page === 'classrooms') loadClassrooms();
                else if (page === 'quiz') loadQuiz();
                else if (page === 'corporate-finance') loadCorporateFinance();
                else if (page === 'bokforing') loadBokforing();
                else if (page === 'wiki') loadWiki();
            });
        });
        
        // CF Path selector
        document.querySelectorAll('#page-corporate-finance .path-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#page-corporate-finance .path-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                cfPath = btn.dataset.path;
                loadCorporateFinance();
            });
        });
        
        // Refresh all data
        async function refreshAll() {
            showToast('Oppdaterer...', 'info');
            
            // Load counts
            const [users, quiz, cf, wiki, teachers, classrooms] = await Promise.all([
                db.ref('users').once('value'),
                db.ref('quizQuestions').once('value'),
                db.ref('solutions/corporate_finance').once('value'),
                db.ref('wiki/articles').once('value'),
                db.ref('teachers').once('value'),
                db.ref('classrooms').once('value')
            ]);
            
            const usersData = users.val() || {};
            const usersArray = Object.values(usersData);
            const now = Date.now();
            const today = now - 24 * 60 * 60 * 1000;
            
            document.getElementById('stat-users').textContent = Object.keys(usersData).length;
            document.getElementById('stat-active').textContent = usersArray.filter(u => u.lastActive > today).length;
            document.getElementById('stat-teachers').textContent = Object.keys(teachers.val() || {}).length;
            document.getElementById('stat-pro').textContent = usersArray.filter(u => u.role === 'pro' || u.role === 'student_pro').length;
            document.getElementById('stat-questions').textContent = Object.keys(quiz.val() || {}).length + Object.keys(cf.val() || {}).length;
            document.getElementById('stat-wiki').textContent = Object.keys(wiki.val() || {}).length;
            
            // Nav counts
            document.getElementById('nav-users-count').textContent = Object.keys(usersData).length;
            document.getElementById('nav-teachers-count').textContent = Object.keys(teachers.val() || {}).length;
            document.getElementById('nav-classrooms-count').textContent = Object.keys(classrooms.val() || {}).length;
            document.getElementById('nav-quiz-count').textContent = Object.keys(quiz.val() || {}).length;
            document.getElementById('nav-cf-count').textContent = Object.keys(cf.val() || {}).length;
            document.getElementById('nav-wiki-count').textContent = Object.keys(wiki.val() || {}).length;
            
            showToast('Oppdatert!', 'success');
        }
        
        // Users
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('users').once('value');
            const users = snap.val() || {};
            
            allUsers = Object.entries(users).map(([uid, data]) => ({ uid, ...data }));
            allUsers.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            const now = Date.now();
            const today = now - 24 * 60 * 60 * 1000;
            
            document.getElementById('users-total').textContent = allUsers.length;
            document.getElementById('users-pro').textContent = allUsers.filter(u => u.role === 'pro' || u.role === 'student_pro').length;
            document.getElementById('users-teachers').textContent = allUsers.filter(u => u.role?.startsWith('teacher')).length;
            document.getElementById('users-today').textContent = allUsers.filter(u => u.lastActive > today).length;
            
            renderUsers(allUsers);
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ingen brukere funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => {
                const role = user.role || 'free';
                const created = user.createdAt ? new Date(user.createdAt).toLocaleDateString('no-NO') : '-';
                const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString('no-NO') : '-';
                const name = user.username || user.displayName || user.email?.split('@')[0] || 'Anonym';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 500;">${name}</div>
                            <div style="font-size: 0.75em; color: var(--text-muted); font-family: monospace;">${user.uid.substring(0, 12)}...</div>
                            ${user.email ? `<div style="font-size: 0.75em; color: var(--text-secondary);">${user.email}</div>` : ''}
                        </td>
                        <td><span class="badge role-${role}">${ROLE_LABELS[role] || role}</span></td>
                        <td>${created}</td>
                        <td>${lastActive}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editRole('${user.uid}', '${name}', '${role}')">‚úèÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterUsers() {
            const search = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('user-role-filter').value;
            
            let filtered = allUsers.filter(u => {
                const matchSearch = !search || 
                    (u.email && u.email.toLowerCase().includes(search)) ||
                    (u.username && u.username.toLowerCase().includes(search)) ||
                    u.uid.toLowerCase().includes(search);
                const matchRole = !roleFilter || u.role === roleFilter;
                return matchSearch && matchRole;
            });
            
            renderUsers(filtered);
        }
        
        function editRole(uid, name, currentRole) {
            document.getElementById('edit-user-id').value = uid;
            document.getElementById('edit-user-name').textContent = name;
            
            document.querySelectorAll('#role-selector .role-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.role === currentRole) {
                    opt.classList.add('selected');
                    selectedRole = currentRole;
                }
            });
            
            document.getElementById('role-modal').classList.add('show');
        }
        
        document.querySelectorAll('#role-selector .role-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('#role-selector .role-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedRole = opt.dataset.role;
            });
        });
        
        async function saveRole() {
            const uid = document.getElementById('edit-user-id').value;
            if (!selectedRole) { showToast('Velg en rolle', 'error'); return; }
            
            try {
                await db.ref('users/' + uid + '/role').set(selectedRole);
                showToast('Rolle oppdatert!', 'success');
                closeModal('role-modal');
                loadUsers();
            } catch (e) {
                showToast('Feil: ' + e.message, 'error');
            }
        }
        
        // Teachers
        async function loadTeachers() {
            const tbody = document.getElementById('teachers-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('teachers').once('value');
            const teachers = snap.val() || {};
            
            if (Object.keys(teachers).length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Ingen l√¶rere funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(teachers).map(([id, t]) => `
                <tr>
                    <td>${t.name || '-'}</td>
                    <td>${t.email || '-'}</td>
                    <td>${t.school || '-'}</td>
                    <td><span class="badge badge-blue">${t.subscription?.plan || 'free'}</span></td>
                    <td><span class="badge ${t.verified ? 'badge-green' : 'badge-orange'}">${t.verified ? 'Verifisert' : 'Venter'}</span></td>
                    <td><button class="btn btn-sm btn-secondary">‚úèÔ∏è</button></td>
                </tr>
            `).join('');
        }
        
        // Classrooms
        async function loadClassrooms() {
            const tbody = document.getElementById('classrooms-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('classrooms').once('value');
            const classrooms = snap.val() || {};
            
            if (Object.keys(classrooms).length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ingen klasserom funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(classrooms).map(([id, c]) => {
                const studentCount = c.students ? Object.keys(c.students).length : 0;
                const created = c.createdAt ? new Date(c.createdAt).toLocaleDateString('no-NO') : '-';
                return `
                    <tr>
                        <td>${c.name || '-'}</td>
                        <td>${c.teacherName || c.teacherId?.substring(0, 8) || '-'}</td>
                        <td><code>${c.code || '-'}</code></td>
                        <td>${studentCount}</td>
                        <td>${created}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Quiz
        async function loadQuiz() {
            const tbody = document.getElementById('quiz-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('quizQuestions').once('value');
            const quiz = snap.val() || {};
            
            allQuiz = Object.entries(quiz).map(([id, q]) => ({ id, ...q }));
            
            let mc = 0, calc = 0;
            allQuiz.forEach(q => {
                if (q.type === 'mc' || q.type === 'multiple_choice') mc++;
                else calc++;
            });
            
            document.getElementById('quiz-total').textContent = allQuiz.length;
            document.getElementById('quiz-mc').textContent = mc;
            document.getElementById('quiz-calc').textContent = calc;
            
            renderQuiz(allQuiz);
        }
        
        function renderQuiz(questions) {
            const tbody = document.getElementById('quiz-table-body');
            
            if (questions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ingen sp√∏rsm√•l funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = questions.slice(0, 100).map(q => `
                <tr>
                    <td><code style="font-size: 0.8em;">${q.id}</code></td>
                    <td>${q.title || q.q?.substring(0, 50) || '-'}${q.q?.length > 50 ? '...' : ''}</td>
                    <td><span class="badge badge-blue">${q.category || '-'}</span></td>
                    <td><span class="badge badge-gray">${q.type || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewQuestion('${q.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteQuiz('${q.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterQuiz() {
            const search = document.getElementById('quiz-search').value.toLowerCase();
            const filtered = allQuiz.filter(q => 
                q.id.toLowerCase().includes(search) ||
                (q.title && q.title.toLowerCase().includes(search)) ||
                (q.q && q.q.toLowerCase().includes(search))
            );
            renderQuiz(filtered);
        }
        
        async function deleteQuiz(id) {
            if (!confirm(`Slett sp√∏rsm√•l "${id}"?`)) return;
            await db.ref('quizQuestions/' + id).remove();
            showToast('Slettet!', 'success');
            loadQuiz();
        }
        
        // Corporate Finance
        async function loadCorporateFinance() {
            const tbody = document.getElementById('cf-table-body');
            tbody.innerHTML = '<tr><td colspan="6" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref(cfPath).once('value');
            const data = snap.val() || {};
            
            allCF = Object.entries(data).map(([id, q]) => ({ id, ...q }));
            
            let mc = 0, calc = 0, tf = 0;
            allCF.forEach(q => {
                const type = q.type || '';
                if (type.includes('mc') || type.includes('multiple')) mc++;
                else if (type.includes('tf') || type.includes('true')) tf++;
                else calc++;
            });
            
            document.getElementById('cf-total').textContent = allCF.length;
            document.getElementById('cf-mc').textContent = mc;
            document.getElementById('cf-calc').textContent = calc;
            document.getElementById('cf-tf').textContent = tf;
            
            renderCF(allCF);
        }
        
        function renderCF(questions) {
            const tbody = document.getElementById('cf-table-body');
            
            if (questions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">Ingen oppgaver funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = questions.map(q => `
                <tr>
                    <td><code style="font-size: 0.8em;">${q.id}</code></td>
                    <td>${q.title || q.question?.substring(0, 40) || '-'}</td>
                    <td><span class="badge badge-blue">${q.topic || '-'}</span></td>
                    <td><span class="badge badge-gray">${q.type || '-'}</span></td>
                    <td><span class="badge badge-${q.difficulty === 'easy' ? 'green' : q.difficulty === 'hard' ? 'red' : 'orange'}">${q.difficulty || '-'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="viewCF('${q.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteCF('${q.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterCF() {
            const search = document.getElementById('cf-search').value.toLowerCase();
            const filtered = allCF.filter(q => 
                q.id.toLowerCase().includes(search) ||
                (q.title && q.title.toLowerCase().includes(search)) ||
                (q.topic && q.topic.toLowerCase().includes(search))
            );
            renderCF(filtered);
        }
        
        function showCFTab(tab) {
            document.querySelectorAll('#page-corporate-finance .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#page-corporate-finance .tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('cf-tab-' + tab).classList.add('active');
        }
        
        async function deleteCF(id) {
            if (!confirm(`Slett oppgave "${id}"?`)) return;
            await db.ref(cfPath + '/' + id).remove();
            showToast('Slettet!', 'success');
            loadCorporateFinance();
        }
        
        async function purgeCF() {
            if (!confirm('‚ö†Ô∏è Slett ALLE oppgaver fra ' + cfPath + '?')) return;
            if (!confirm('Er du HELT sikker?')) return;
            
            await db.ref(cfPath).remove();
            showToast('Alle oppgaver slettet!', 'success');
            loadCorporateFinance();
        }
        
        async function purgeCFByTopic() {
            const topic = prompt('Topic √• slette (npv, stocks, bonds, etc.):');
            if (!topic) return;
            
            const toDelete = allCF.filter(q => q.topic === topic || q.id.includes(topic));
            if (toDelete.length === 0) {
                showToast('Ingen oppgaver funnet', 'error');
                return;
            }
            
            if (!confirm(`Slett ${toDelete.length} oppgaver med topic "${topic}"?`)) return;
            
            const updates = {};
            toDelete.forEach(q => updates[q.id] = null);
            await db.ref(cfPath).update(updates);
            
            showToast(`Slettet ${toDelete.length} oppgaver`, 'success');
            loadCorporateFinance();
        }
        
        // Bokf√∏ring
        async function loadBokforing() {
            const tbody = document.getElementById('bokforing-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('bokforing').once('value');
            const data = snap.val() || {};
            
            if (Object.keys(data).length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Ingen bokf√∏ringsoppgaver funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = Object.entries(data).map(([id, b]) => `
                <tr>
                    <td><code>${id}</code></td>
                    <td>${b.title || '-'}</td>
                    <td><span class="badge badge-blue">${b.level || b.difficulty || '-'}</span></td>
                    <td><button class="btn btn-sm btn-secondary">üëÅÔ∏è</button></td>
                </tr>
            `).join('');
        }
        
        // Wiki
        async function loadWiki() {
            const tbody = document.getElementById('wiki-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="loading"><div class="spinner"></div>Laster...</td></tr>';
            
            const snap = await db.ref('wiki/articles').once('value');
            const data = snap.val() || {};
            
            allWiki = Object.entries(data).map(([id, a]) => ({ id, ...a }));
            
            renderWiki(allWiki);
        }
        
        function renderWiki(articles) {
            const tbody = document.getElementById('wiki-table-body');
            
            if (articles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Ingen artikler funnet</td></tr>';
                return;
            }
            
            tbody.innerHTML = articles.map(a => {
                const updated = a.updatedAt ? new Date(a.updatedAt).toLocaleDateString('no-NO') : '-';
                return `
                    <tr>
                        <td>${a.title || '-'}</td>
                        <td><span class="badge badge-purple">${a.category || '-'}</span></td>
                        <td>${a.law || '-'}</td>
                        <td>${updated}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="editWiki('${a.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWiki('${a.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterWiki() {
            const search = document.getElementById('wiki-search').value.toLowerCase();
            const filtered = allWiki.filter(a => 
                (a.title && a.title.toLowerCase().includes(search)) ||
                (a.category && a.category.toLowerCase().includes(search))
            );
            renderWiki(filtered);
        }
        
        async function deleteWiki(id) {
            if (!confirm('Slett artikkel?')) return;
            await db.ref('wiki/articles/' + id).remove();
            showToast('Slettet!', 'success');
            loadWiki();
        }
        
        // Database Browser
        function setDBPath(path) {
            document.getElementById('db-path').value = path;
            browseDB();
        }
        
        async function browseDB() {
            const path = document.getElementById('db-path').value.trim();
            const output = document.getElementById('db-browser-output');
            
            if (!path) {
                output.innerHTML = '<div class="log-warning">Skriv inn en sti</div>';
                return;
            }
            
            output.innerHTML = '<div class="log-info">Laster...</div>';
            
            try {
                const snap = await db.ref(path).once('value');
                const data = snap.val();
                
                if (data === null) {
                    output.innerHTML = '<div class="log-warning">Ingen data funnet p√• denne stien</div>';
                    return;
                }
                
                const count = typeof data === 'object' ? Object.keys(data).length : 1;
                output.innerHTML = `<div class="log-success">Fant ${count} elementer</div><pre style="margin-top: 10px; white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                output.innerHTML = `<div class="log-error">Feil: ${e.message}</div>`;
            }
        }
        
        // Export functions
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            showToast('Eksportert!', 'success');
        }
        
        async function exportUsers() {
            const snap = await db.ref('users').once('value');
            downloadJSON(snap.val() || {}, `users_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        async function exportQuiz() {
            const snap = await db.ref('quizQuestions').once('value');
            downloadJSON(snap.val() || {}, `quiz_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        async function exportCF() {
            const snap = await db.ref(cfPath).once('value');
            downloadJSON(snap.val() || {}, `cf_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        async function exportWiki() {
            const snap = await db.ref('wiki/articles').once('value');
            downloadJSON(snap.val() || {}, `wiki_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        async function exportFullBackup() {
            showToast('Laster ned full backup...', 'info');
            const snap = await db.ref('/').once('value');
            downloadJSON(snap.val() || {}, `full_backup_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        // Seed examples
        async function seedCFExamples() {
            const examples = {
                cf_npv_calc_001: {
                    id: 'cf_npv_calc_001',
                    module: 'corporate_finance',
                    topic: 'npv',
                    difficulty: 'medium',
                    type: 'calculation',
                    title: 'NPV Beregning',
                    question: 'Et prosjekt krever investering p√• 100 000 NOK og gir kontantstr√∏m p√• 40 000 i √•r 1, 50 000 i √•r 2. Med 10% avkastningskrav, hva er NPV?',
                    data: { investment: 100000, cf_year1: 40000, cf_year2: 50000, discount_rate: 0.10 },
                    input_fields: [{ id: 'npv', label: 'NPV', unit: 'NOK' }],
                    hints: ['NPV = Œ£(CF_t / (1+r)^t) - I‚ÇÄ']
                }
            };
            
            const solutions = {
                cf_npv_calc_001: {
                    correct: { npv: -17355.37 },
                    tolerance: 10,
                    explanation: 'NPV = 40000/1.1 + 50000/1.1¬≤ - 100000 = -17355.37'
                }
            };
            
            await db.ref('questions/corporate_finance').update(examples);
            await db.ref('solutions/corporate_finance').update(solutions);
            
            showToast('CF-eksempler lagt til!', 'success');
            loadCorporateFinance();
        }
        
        // Modal
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
            selectedRole = null;
        }
        
        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target === modal) closeModal(modal.id);
            });
        });
    </script>
</body>
</html>
