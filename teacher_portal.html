<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¶rerportal - AccountingQuest</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: #2d2d2d;
            border-bottom: 2px solid #4ade80;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #4ade80;
        }

        .header-actions { display: flex; gap: 15px; flex-wrap: wrap; }

        .btn {
            background: #404040;
            color: #e0e0e0;
            border: 2px solid #555;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .btn:hover { background: #4a4a4a; border-color: #4ade80; }
        .btn.primary { background: #4ade80; border-color: #4ade80; color: #1a1a2e; }
        .btn.primary:hover { background: #22c55e; }
        .btn.danger { background: #ef4444; border-color: #ef4444; color: white; }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: #2d2d2d;
            border: 2px solid #404040;
            color: #9ca3af;
            padding: 15px 25px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab:hover { border-color: #4ade80; color: #e0e0e0; }
        .tab.active { background: #4ade80; border-color: #4ade80; color: #1a1a2e; }

        .tab-content {
            display: none;
            background: #2d2d2d;
            border: 2px solid #404040;
            border-radius: 0 10px 10px 10px;
            padding: 30px;
        }

        .tab-content.active { display: block; }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card {
            background: #1a1a2e;
            border: 2px solid #404040;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: #4ade80;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(74, 222, 128, 0.2);
        }

        .card-icon { font-size: 2.5em; margin-bottom: 15px; }
        .card-title { font-size: 1.3em; color: #4ade80; margin-bottom: 10px; font-weight: bold; }
        .card-desc { color: #9ca3af; font-size: 0.95em; line-height: 1.5; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active { display: flex; justify-content: center; align-items: flex-start; }

        .modal-content {
            background: #2d2d2d;
            border-radius: 20px;
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            position: relative;
        }

        .modal-header {
            background: #1a1a2e;
            padding: 25px 30px;
            border-bottom: 2px solid #404040;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 { color: #4ade80; font-size: 1.5em; }

        .modal-close {
            background: #ef4444;
            color: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.3em;
        }

        .modal-body { padding: 30px; }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4ade80;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            background: #1a1a2e;
            border: 2px solid #404040;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4ade80;
        }

        .form-group textarea { min-height: 100px; resize: vertical; }

        /* Question Type Selector */
        .type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .type-option {
            background: #1a1a2e;
            border: 2px solid #404040;
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .type-option:hover { border-color: #4ade80; }
        .type-option.selected { border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .type-option .icon { font-size: 2em; margin-bottom: 10px; }
        .type-option .label { font-size: 0.9em; color: #9ca3af; }

        /* Options Builder */
        .options-list { margin-top: 15px; }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1a1a2e;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .option-item input[type="checkbox"],
        .option-item input[type="radio"] {
            width: 20px; height: 20px;
            cursor: pointer;
        }

        .option-item input[type="text"] { flex: 1; }

        .option-item .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            width: 30px; height: 30px;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Drag & Drop Builder */
        .drag-drop-builder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .dd-column h4 { color: #4ade80; margin-bottom: 15px; }

        .dd-item {
            background: #1a1a2e;
            border: 2px solid #404040;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .dd-item input { flex: 1; }
        .dd-item select { width: 150px; }

        /* Bokf√∏ring Builder */
        .bokforing-builder {
            background: #1a1a2e;
            border: 2px solid #404040;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .posting-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 50px;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .posting-row input,
        .posting-row select {
            padding: 10px;
            background: #2d2d2d;
            border: 2px solid #404040;
            border-radius: 5px;
            color: #e0e0e0;
        }

        /* Quiz List */
        .quiz-list { margin-top: 20px; }

        .quiz-item {
            background: #1a1a2e;
            border: 2px solid #404040;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .quiz-item:hover { border-color: #4ade80; }

        .quiz-info h3 { color: #4ade80; margin-bottom: 5px; }
        .quiz-meta { color: #9ca3af; font-size: 0.9em; }
        .quiz-meta span { margin-right: 15px; }

        .quiz-actions { display: flex; gap: 10px; flex-wrap: wrap; }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .badge.public { background: #4ade80; color: #1a1a2e; }
        .badge.private { background: #f59e0b; color: #1a1a2e; }
        .badge.easy { background: #22c55e; color: white; }
        .badge.medium { background: #f59e0b; color: #1a1a2e; }
        .badge.hard { background: #ef4444; color: white; }
        .badge.expert { background: #8b5cf6; color: white; }

        /* Questions Preview */
        .questions-preview {
            margin-top: 20px;
            border-top: 2px solid #404040;
            padding-top: 20px;
        }

        .question-preview-item {
            background: #1a1a2e;
            border-left: 4px solid #4ade80;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }

        .question-preview-item .q-number { color: #4ade80; font-weight: bold; }
        .question-preview-item .q-type { color: #9ca3af; font-size: 0.85em; margin-left: 10px; }
        .question-preview-item .q-text { margin-top: 8px; }

        /* Save Actions */
        .save-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #404040;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header { padding: 15px 20px; }
            .form-row { grid-template-columns: 1fr; }
            .type-grid { grid-template-columns: repeat(2, 1fr); }
            .drag-drop-builder { grid-template-columns: 1fr; }
            .posting-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">üë®‚Äçüè´ L√¶rerportal</div>
        <div class="header-actions">
            <button class="btn" onclick="window.location.href='index.html'">‚Üê Tilbake</button>
            <button class="btn primary" onclick="openCreateQuiz()">+ Ny Quiz</button>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('mine')">üìö Mine Quizzer</div>
            <div class="tab" onclick="switchTab('public')">üåç Offentlige</div>
            <div class="tab" onclick="switchTab('start')">üéÆ Start Spill</div>
            <div class="tab" onclick="switchTab('stats')">üìä Statistikk</div>
        </div>

        <!-- Mine Quizzer -->
        <div class="tab-content active" id="tab-mine">
            <h2 style="color: #4ade80; margin-bottom: 20px;">Mine Quizzer</h2>
            <div id="my-quizzes-list">
                <p style="color: #9ca3af; text-align: center; padding: 40px;">
                    Laster quizzer...
                </p>
            </div>
        </div>

        <!-- Offentlige Quizzer -->
        <div class="tab-content" id="tab-public">
            <h2 style="color: #4ade80; margin-bottom: 20px;">üåç Offentlige Quizzer</h2>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <select id="filter-language" onchange="loadPublicQuizzes()">
                        <option value="">Alle spr√•k</option>
                        <option value="no">üá≥üá¥ Norsk</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <select id="filter-category" onchange="loadPublicQuizzes()">
                        <option value="">Alle kategorier</option>
                        <option value="bokforing">Bokf√∏ring</option>
                        <option value="mva">MVA</option>
                        <option value="lonn">L√∏nn</option>
                        <option value="analyse">Regnskapsanalyse</option>
                        <option value="skatt">Skatt</option>
                    </select>
                </div>
            </div>
            <div id="public-quizzes-list">
                <p style="color: #9ca3af; text-align: center; padding: 40px;">
                    Laster offentlige quizzer...
                </p>
            </div>
        </div>

        <!-- Start Spill -->
        <div class="tab-content" id="tab-start">
            <h2 style="color: #4ade80; margin-bottom: 20px;">üéÆ Start Multiplayer Spill</h2>
            <p style="color: #9ca3af; margin-bottom: 30px;">Velg en quiz for √• starte en live-konkurranse med PIN-kode.</p>
            <div id="start-quiz-list">
                <p style="color: #9ca3af; text-align: center; padding: 40px;">
                    Laster quizzer...
                </p>
            </div>
        </div>

        <!-- Statistikk -->
        <div class="tab-content" id="tab-stats">
            <h2 style="color: #4ade80; margin-bottom: 20px;">üìä Spillstatistikk</h2>
            <p style="color: #9ca3af;">Kommer snart: Se resultater fra tidligere spill, eksporter til Excel, og analyser elevprestasjoner.</p>
        </div>
    </div>

    <!-- Create/Edit Quiz Modal -->
    <div class="modal" id="quiz-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Opprett Ny Quiz</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Quiz Info -->
                <div id="step-info">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quiz Tittel *</label>
                            <input type="text" id="quiz-title" placeholder="F.eks. Bokf√∏ring Grunnleggende">
                        </div>
                        <div class="form-group">
                            <label>Kategori</label>
                            <select id="quiz-category">
                                <option value="bokforing">üìö Bokf√∏ring</option>
                                <option value="mva">üí∞ MVA</option>
                                <option value="lonn">üëî L√∏nn</option>
                                <option value="analyse">üìä Regnskapsanalyse</option>
                                <option value="skatt">üèõÔ∏è Skatt</option>
                                <option value="case">üíº Case Studies</option>
                                <option value="other">üìù Annet</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Beskrivelse</label>
                        <textarea id="quiz-description" placeholder="Beskriv hva quizzen handler om..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Spr√•k</label>
                            <select id="quiz-language">
                                <option value="no">üá≥üá¥ Norsk</option>
                                <option value="en">üá¨üáß English</option>
                                <option value="de">üá©üá™ Deutsch</option>
                                <option value="fr">üá´üá∑ Fran√ßais</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Synlighet</label>
                            <select id="quiz-visibility">
                                <option value="private">üîí Privat (bare meg)</option>
                                <option value="public">üåç Offentlig (alle kan bruke)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tid per sp√∏rsm√•l</label>
                            <select id="quiz-time">
                                <option value="15">15 sekunder</option>
                                <option value="20">20 sekunder</option>
                                <option value="30" selected>30 sekunder</option>
                                <option value="45">45 sekunder</option>
                                <option value="60">60 sekunder</option>
                                <option value="90">90 sekunder</option>
                                <option value="120">120 sekunder</option>
                            </select>
                        </div>
                    </div>

                    <!-- Questions Preview -->
                    <div class="questions-preview" id="questions-preview">
                        <h3 style="color: #4ade80; margin-bottom: 15px;">
                            Sp√∏rsm√•l (<span id="question-count">0</span>)
                        </h3>
                        <div id="questions-list">
                            <p style="color: #9ca3af; text-align: center; padding: 20px;">
                                Ingen sp√∏rsm√•l lagt til enn√•
                            </p>
                        </div>
                        <button class="btn primary" onclick="openQuestionBuilder()" style="margin-top: 15px;">
                            + Legg til sp√∏rsm√•l
                        </button>
                    </div>

                    <div class="save-actions">
                        <button class="btn" onclick="closeModal()">Avbryt</button>
                        <button class="btn primary" onclick="saveQuiz()">üíæ Lagre Quiz</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Builder Modal -->
    <div class="modal" id="question-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Legg til sp√∏rsm√•l</h2>
                <button class="modal-close" onclick="closeQuestionModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Question Type Selection -->
                <label style="color: #4ade80; font-weight: bold; margin-bottom: 15px; display: block;">
                    Velg sp√∏rsm√•lstype:
                </label>
                <div class="type-grid" id="type-selector">
                    <div class="type-option" data-type="multiple_choice" onclick="selectQuestionType('multiple_choice')">
                        <div class="icon">üîò</div>
                        <div class="label">Multiple Choice</div>
                    </div>
                    <div class="type-option" data-type="multiple_select" onclick="selectQuestionType('multiple_select')">
                        <div class="icon">‚òëÔ∏è</div>
                        <div class="label">Velg Flere</div>
                    </div>
                    <div class="type-option" data-type="true_false" onclick="selectQuestionType('true_false')">
                        <div class="icon">‚úÖ‚ùå</div>
                        <div class="label">Sant/Usant</div>
                    </div>
                    <div class="type-option" data-type="paragraph" onclick="selectQuestionType('paragraph')">
                        <div class="icon">üìú</div>
                        <div class="label">Paragraf</div>
                    </div>
                    <div class="type-option" data-type="drag_drop" onclick="selectQuestionType('drag_drop')">
                        <div class="icon">üéØ</div>
                        <div class="label">Dra & Slipp</div>
                    </div>
                    <div class="type-option" data-type="bokforing" onclick="selectQuestionType('bokforing')">
                        <div class="icon">üìä</div>
                        <div class="label">Bokf√∏ring</div>
                    </div>
                    <div class="type-option" data-type="analyse" onclick="selectQuestionType('analyse')">
                        <div class="icon">üìà</div>
                        <div class="label">Analyse</div>
                    </div>
                </div>

                <!-- Question Content (changes based on type) -->
                <div id="question-content" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Sp√∏rsm√•l/Oppgavetekst *</label>
                            <textarea id="q-text" placeholder="Skriv sp√∏rsm√•let her..."></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Vanskelighetsgrad</label>
                            <select id="q-difficulty">
                                <option value="easy">üü¢ Lett (100 poeng)</option>
                                <option value="medium" selected>üü° Middels (200 poeng)</option>
                                <option value="hard">üî¥ Vanskelig (300 poeng)</option>
                                <option value="expert">üü£ Ekspert (500 poeng)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lovhenvisning (valgfritt)</label>
                            <input type="text" id="q-law" placeholder="F.eks. Bokf√∏ringsloven ¬ß 5">
                        </div>
                    </div>

                    <!-- Type-specific content -->
                    <div id="type-specific-content"></div>

                    <div class="save-actions">
                        <button class="btn" onclick="closeQuestionModal()">Avbryt</button>
                        <button class="btn primary" onclick="saveQuestion()">‚úì Legg til</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for Firebase to load
        var db = null;
        var auth = null;
        var firebaseReady = false;
        
        // State
        var currentUser = null;
        var currentQuiz = null;
        var currentQuestions = [];
        var editingQuizId = null;
        var selectedQuestionType = null;

        // Difficulty points mapping
        var difficultyPoints = {
            easy: 100,
            medium: 200,
            hard: 300,
            expert: 500
        };

        // Language flags
        var languageFlags = {
            no: 'üá≥üá¥',
            en: 'üá¨üáß',
            de: 'üá©üá™',
            fr: 'üá´üá∑'
        };

        // Category icons
        var categoryIcons = {
            bokforing: 'üìö',
            mva: 'üí∞',
            lonn: 'üëî',
            analyse: 'üìä',
            skatt: 'üèõÔ∏è',
            'case': 'üíº',
            other: 'üìù'
        };

        // Initialize Firebase when ready
        function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.log('Waiting for Firebase...');
                setTimeout(initFirebase, 100);
                return;
            }
            
            try {
                var firebaseConfig = {
                    apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
                    authDomain: "accountingquest-multiplayer.firebaseapp.com",
                    databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "accountingquest-multiplayer",
                    storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                    messagingSenderId: "525417361926",
                    appId: "1:525417361926:web:ec9b737f82af9b21700987"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.database();
                auth = firebase.auth();
                firebaseReady = true;
                
                console.log('Firebase initialized successfully');
                
                // Now set up auth listener
                auth.onAuthStateChanged(function(user) {
                    currentUser = user;
                    loadMyQuizzes();
                    loadPublicQuizzes();
                });
            } catch (error) {
                console.error('Firebase init error:', error);
                // Still allow local functionality
                loadMyQuizzes();
            }
        }

        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            if (tabId === 'start') {
                loadStartQuizList();
            }
        }

        // Load my quizzes
        function loadMyQuizzes() {
            var container = document.getElementById('my-quizzes-list');
            
            // Load from localStorage for now (would be Firebase for logged-in users)
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            
            if (savedQuizzes.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Du har ingen quizzer enn√•. Klikk "+ Ny Quiz" for √• komme i gang!</p>';
                return;
            }

            var html = '';
            savedQuizzes.forEach(function(quiz, index) {
                var langFlag = languageFlags[quiz.language] || 'üåê';
                var catIcon = categoryIcons[quiz.category] || 'üìù';
                
                html += '<div class="quiz-item">' +
                    '<div class="quiz-info">' +
                        '<h3>' + catIcon + ' ' + quiz.title + '</h3>' +
                        '<div class="quiz-meta">' +
                            '<span>' + langFlag + ' ' + quiz.language.toUpperCase() + '</span>' +
                            '<span>üìù ' + (quiz.questions ? quiz.questions.length : 0) + ' sp√∏rsm√•l</span>' +
                            '<span class="badge ' + quiz.visibility + '">' + (quiz.visibility === 'public' ? 'üåç Offentlig' : 'üîí Privat') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="quiz-actions">' +
                        '<button class="btn" onclick="editQuiz(' + index + ')">‚úèÔ∏è Rediger</button>' +
                        '<button class="btn primary" onclick="startGameWithQuiz(' + index + ')">üéÆ Start</button>' +
                        '<button class="btn danger" onclick="deleteQuiz(' + index + ')">üóëÔ∏è</button>' +
                    '</div>' +
                '</div>';
            });
            
            container.innerHTML = html;
        }

        // Load public quizzes
        function loadPublicQuizzes() {
            var container = document.getElementById('public-quizzes-list');
            
            if (!firebaseReady || !db) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Kobler til database...</p>';
                return;
            }
            
            var langFilter = document.getElementById('filter-language').value;
            var catFilter = document.getElementById('filter-category').value;
            
            db.ref('public_quizzes').once('value')
                .then(function(snapshot) {
                    var quizzes = [];
                    snapshot.forEach(function(child) {
                        var quiz = child.val();
                        quiz.id = child.key;
                        
                        // Apply filters
                        if (langFilter && quiz.language !== langFilter) return;
                        if (catFilter && quiz.category !== catFilter) return;
                        
                        quizzes.push(quiz);
                    });
                    
                    if (quizzes.length === 0) {
                        container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 40px;">Ingen offentlige quizzer funnet.</p>';
                        return;
                    }
                    
                    var html = '';
                    quizzes.forEach(function(quiz) {
                        var langFlag = languageFlags[quiz.language] || 'üåê';
                        var catIcon = categoryIcons[quiz.category] || 'üìù';
                        
                        html += '<div class="quiz-item">' +
                            '<div class="quiz-info">' +
                                '<h3>' + catIcon + ' ' + quiz.title + '</h3>' +
                                '<div class="quiz-meta">' +
                                    '<span>' + langFlag + '</span>' +
                                    '<span>üìù ' + (quiz.questions ? quiz.questions.length : 0) + ' sp√∏rsm√•l</span>' +
                                    '<span>üë§ ' + (quiz.createdByName || 'Anonym') + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="quiz-actions">' +
                                '<button class="btn" onclick="copyQuiz(\'' + quiz.id + '\')">üìã Kopier</button>' +
                                '<button class="btn primary" onclick="startGameWithPublicQuiz(\'' + quiz.id + '\')">üéÆ Start</button>' +
                            '</div>' +
                        '</div>';
                    });
                    
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error('Error loading public quizzes:', error);
                    container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Kunne ikke laste quizzer.</p>';
                });
        }

        // Load quizzes for starting game
        function loadStartQuizList() {
            var container = document.getElementById('start-quiz-list');
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            
            // Add demo quizzes
            var allQuizzes = [
                { title: 'Demo: Bokf√∏ring Grunnleggende', category: 'bokforing', questions: [{},{},{},{},{}], isDemo: true, demoId: 'demo_bokforing' },
                { title: 'Demo: MVA-regler', category: 'mva', questions: [{},{},{},{}], isDemo: true, demoId: 'demo_mva' },
                { title: 'Demo: Regnskapsprinsipper', category: 'analyse', questions: [{},{},{}], isDemo: true, demoId: 'demo_regnskap' }
            ].concat(savedQuizzes);
            
            var html = '<div class="cards-grid">';
            allQuizzes.forEach(function(quiz, index) {
                var catIcon = categoryIcons[quiz.category] || 'üìù';
                var questionCount = quiz.questions ? quiz.questions.length : 0;
                
                html += '<div class="card" onclick="' + (quiz.isDemo ? 'startDemoGame(\'' + quiz.demoId + '\')' : 'startGameWithQuiz(' + (index - 3) + ')') + '">' +
                    '<div class="card-icon">' + catIcon + '</div>' +
                    '<div class="card-title">' + quiz.title + '</div>' +
                    '<div class="card-desc">' + questionCount + ' sp√∏rsm√•l' + (quiz.isDemo ? ' ‚Ä¢ Demo' : '') + '</div>' +
                '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Open create quiz modal
        function openCreateQuiz() {
            editingQuizId = null;
            currentQuestions = [];
            
            document.getElementById('quiz-title').value = '';
            document.getElementById('quiz-description').value = '';
            document.getElementById('quiz-category').value = 'bokforing';
            document.getElementById('quiz-language').value = 'no';
            document.getElementById('quiz-visibility').value = 'private';
            document.getElementById('quiz-time').value = '30';
            
            updateQuestionsPreview();
            
            document.getElementById('modal-title').textContent = 'Opprett Ny Quiz';
            document.getElementById('quiz-modal').classList.add('active');
        }

        // Edit existing quiz
        function editQuiz(index) {
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            var quiz = savedQuizzes[index];
            
            if (!quiz) return;
            
            editingQuizId = index;
            currentQuestions = quiz.questions || [];
            
            document.getElementById('quiz-title').value = quiz.title || '';
            document.getElementById('quiz-description').value = quiz.description || '';
            document.getElementById('quiz-category').value = quiz.category || 'bokforing';
            document.getElementById('quiz-language').value = quiz.language || 'no';
            document.getElementById('quiz-visibility').value = quiz.visibility || 'private';
            document.getElementById('quiz-time').value = quiz.timePerQuestion || '30';
            
            updateQuestionsPreview();
            
            document.getElementById('modal-title').textContent = 'Rediger Quiz';
            document.getElementById('quiz-modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('quiz-modal').classList.remove('active');
        }

        // Open question builder
        function openQuestionBuilder() {
            selectedQuestionType = null;
            document.querySelectorAll('.type-option').forEach(function(t) { t.classList.remove('selected'); });
            document.getElementById('question-content').style.display = 'none';
            document.getElementById('type-specific-content').innerHTML = '';
            document.getElementById('q-text').value = '';
            document.getElementById('q-difficulty').value = 'medium';
            document.getElementById('q-law').value = '';
            
            document.getElementById('question-modal').classList.add('active');
        }

        // Close question modal
        function closeQuestionModal() {
            document.getElementById('question-modal').classList.remove('active');
        }

        // Select question type
        function selectQuestionType(type) {
            selectedQuestionType = type;
            
            document.querySelectorAll('.type-option').forEach(function(t) { t.classList.remove('selected'); });
            document.querySelector('.type-option[data-type="' + type + '"]').classList.add('selected');
            
            document.getElementById('question-content').style.display = 'block';
            
            // Build type-specific content
            var container = document.getElementById('type-specific-content');
            
            switch(type) {
                case 'multiple_choice':
                    container.innerHTML = buildMultipleChoiceUI(false);
                    break;
                case 'multiple_select':
                    container.innerHTML = buildMultipleChoiceUI(true);
                    break;
                case 'true_false':
                    container.innerHTML = buildTrueFalseUI();
                    break;
                case 'paragraph':
                    container.innerHTML = buildParagraphUI();
                    break;
                case 'drag_drop':
                    container.innerHTML = buildDragDropUI();
                    break;
                case 'bokforing':
                    container.innerHTML = buildBokforingUI();
                    break;
                case 'analyse':
                    container.innerHTML = buildAnalyseUI();
                    break;
            }
        }

        // Build Multiple Choice UI
        function buildMultipleChoiceUI(multiSelect) {
            var inputType = multiSelect ? 'checkbox' : 'radio';
            return '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Svaralternativer:</label>' +
                '<p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">' + 
                (multiSelect ? 'Kryss av for alle riktige svar' : 'Velg det riktige svaret') + '</p>' +
                '<div class="options-list" id="options-list">' +
                    '<div class="option-item">' +
                        '<input type="' + inputType + '" name="correct" value="0">' +
                        '<input type="text" placeholder="Alternativ A" class="option-text">' +
                        '<button class="remove-btn" onclick="removeOption(this)">√ó</button>' +
                    '</div>' +
                    '<div class="option-item">' +
                        '<input type="' + inputType + '" name="correct" value="1">' +
                        '<input type="text" placeholder="Alternativ B" class="option-text">' +
                        '<button class="remove-btn" onclick="removeOption(this)">√ó</button>' +
                    '</div>' +
                '</div>' +
                '<button class="btn" onclick="addOption(\'' + inputType + '\')" style="margin-top: 10px;">+ Legg til alternativ</button>' +
                '<div class="form-group" style="margin-top: 15px;">' +
                    '<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">' +
                        '<input type="checkbox" id="shuffle-options" checked style="width: 20px; height: 20px;">' +
                        '<span>üîÄ Randomiser rekkef√∏lge for hver spiller</span>' +
                    '</label>' +
                '</div>';
        }

        // Build True/False UI
        function buildTrueFalseUI() {
            return '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Riktig svar:</label>' +
                '<div class="form-group">' +
                    '<select id="tf-answer">' +
                        '<option value="true">‚úÖ Sant</option>' +
                        '<option value="false">‚ùå Usant</option>' +
                    '</select>' +
                '</div>';
        }

        // Build Paragraph UI
        function buildParagraphUI() {
            return '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Paragrafhenvisning:</label>' +
                '<div class="form-group">' +
                    '<input type="text" id="para-ref" placeholder="F.eks. Bokf√∏ringsloven ¬ß 5">' +
                '</div>' +
                '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">N√∏kkelord (kommaseparert):</label>' +
                '<div class="form-group">' +
                    '<input type="text" id="para-keywords" placeholder="F.eks. prim√¶rdokumentasjon, bilag, oppbevaring">' +
                '</div>';
        }

        // Build Drag & Drop UI
        function buildDragDropUI() {
            return '<div class="drag-drop-builder">' +
                '<div class="dd-column">' +
                    '<h4>Kategorier:</h4>' +
                    '<div id="dd-categories">' +
                        '<div class="dd-item">' +
                            '<input type="text" placeholder="Kategori 1" class="dd-cat" oninput="updateDDSelects()">' +
                            '<button class="remove-btn" onclick="removeDDItem(this); updateDDSelects()">√ó</button>' +
                        '</div>' +
                        '<div class="dd-item">' +
                            '<input type="text" placeholder="Kategori 2" class="dd-cat" oninput="updateDDSelects()">' +
                            '<button class="remove-btn" onclick="removeDDItem(this); updateDDSelects()">√ó</button>' +
                        '</div>' +
                    '</div>' +
                    '<button class="btn" onclick="addDDCategory()" style="margin-top: 10px;">+ Kategori</button>' +
                '</div>' +
                '<div class="dd-column">' +
                    '<h4>Elementer (dra til riktig kategori):</h4>' +
                    '<div id="dd-items">' +
                        '<div class="dd-item">' +
                            '<input type="text" placeholder="Element" class="dd-element">' +
                            '<select class="dd-element-cat"><option value="">-- Velg kategori --</option></select>' +
                            '<button class="remove-btn" onclick="removeDDItem(this)">√ó</button>' +
                        '</div>' +
                    '</div>' +
                    '<button class="btn" onclick="addDDItem()" style="margin-top: 10px;">+ Element</button>' +
                '</div>' +
            '</div>' +
            '<div class="form-group" style="margin-top: 15px;">' +
                '<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">' +
                    '<input type="checkbox" id="shuffle-dd" checked style="width: 20px; height: 20px;">' +
                    '<span>üîÄ Randomiser rekkef√∏lge for hver spiller</span>' +
                '</label>' +
            '</div>';
        }

        // Build Bokf√∏ring UI
        function buildBokforingUI() {
            return '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Scenario/Bilag:</label>' +
                '<div class="form-group">' +
                    '<textarea id="bok-scenario" placeholder="Beskriv transaksjonen, f.eks: Bedriften kj√∏per kontorrekvisita for kr 5.000 eks. mva. Betalt kontant."></textarea>' +
                '</div>' +
                
                '<div class="form-row">' +
                    '<div class="form-group">' +
                        '<label>Kontoformat:</label>' +
                        '<select id="bok-format" onchange="updateBokforingFormat()">' +
                            '<option value="fortegn">üìä Fortegnskonto (Konto | Debet | Kredit)</option>' +
                            '<option value="tkonto">üìã T-konto (klassisk)</option>' +
                        '</select>' +
                    '</div>' +
                    '<div class="form-group">' +
                        '<label>MVA-behandling:</label>' +
                        '<select id="bok-mva">' +
                            '<option value="none">Ingen MVA</option>' +
                            '<option value="25">25% MVA</option>' +
                            '<option value="15">15% MVA</option>' +
                            '<option value="12">12% MVA</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                
                '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Forventede posteringer (fasit):</label>' +
                '<p style="color: #9ca3af; font-size: 0.9em; margin-bottom: 15px;">Legg inn riktige posteringer som studentene skal finne frem til.</p>' +
                
                '<div id="bok-builder-container">' +
                    buildFortegnskontoUI() +
                '</div>' +
                
                '<div class="form-group" style="margin-top: 15px;">' +
                    '<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">' +
                        '<input type="checkbox" id="bok-prefill" style="width: 20px; height: 20px;">' +
                        '<span>üìù Forh√•ndsutfyll kontonummer (studenten fyller bare bel√∏p)</span>' +
                    '</label>' +
                '</div>';
        }
        
        function buildFortegnskontoUI() {
            return '<div class="bokforing-builder" id="postings-list" style="overflow-x: auto;">' +
                '<table style="width: 100%; border-collapse: collapse;">' +
                    '<thead>' +
                        '<tr style="background: #1a1a2e;">' +
                            '<th style="padding: 12px; text-align: left; color: #9ca3af; border-bottom: 2px solid #4ade80;">#</th>' +
                            '<th style="padding: 12px; text-align: left; color: #9ca3af; border-bottom: 2px solid #4ade80;">Konto</th>' +
                            '<th style="padding: 12px; text-align: right; color: #9ca3af; border-bottom: 2px solid #4ade80;">Debet</th>' +
                            '<th style="padding: 12px; text-align: right; color: #9ca3af; border-bottom: 2px solid #4ade80;">Kredit</th>' +
                            '<th style="padding: 12px; width: 50px;"></th>' +
                        '</tr>' +
                    '</thead>' +
                    '<tbody id="fortegn-rows">' +
                        '<tr class="posting-row-fortegn">' +
                            '<td style="padding: 8px; color: #9ca3af;">1</td>' +
                            '<td style="padding: 8px;"><input type="text" placeholder="Kontonr" class="bok-konto" style="width: 100%;"></td>' +
                            '<td style="padding: 8px;"><input type="number" placeholder="0" class="bok-debet" style="width: 100%; text-align: right;"></td>' +
                            '<td style="padding: 8px;"><input type="number" placeholder="0" class="bok-kredit" style="width: 100%; text-align: right;"></td>' +
                            '<td style="padding: 8px;"><button class="remove-btn" onclick="removeFortegnRow(this)">√ó</button></td>' +
                        '</tr>' +
                    '</tbody>' +
                '</table>' +
            '</div>' +
            '<button class="btn" onclick="addFortegnRow()" style="margin-top: 10px;">+ Legg til rad</button>';
        }
        
        function buildTkontoUI() {
            return '<div class="bokforing-builder" id="postings-list">' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">' +
                    '<div>' +
                        '<h4 style="color: #4ade80; margin-bottom: 10px; text-align: center;">DEBET</h4>' +
                        '<div id="tkonto-debet">' +
                            '<div class="tkonto-entry">' +
                                '<input type="text" placeholder="Konto" class="tk-konto-d" style="width: 60%;">' +
                                '<input type="number" placeholder="Bel√∏p" class="tk-belop-d" style="width: 35%;">' +
                                '<button class="remove-btn" onclick="removeTkontoEntry(this)" style="margin-left: 5px;">√ó</button>' +
                            '</div>' +
                        '</div>' +
                        '<button class="btn" onclick="addTkontoEntry(\'debet\')" style="margin-top: 10px; width: 100%;">+ Debet</button>' +
                    '</div>' +
                    '<div>' +
                        '<h4 style="color: #ef4444; margin-bottom: 10px; text-align: center;">KREDIT</h4>' +
                        '<div id="tkonto-kredit">' +
                            '<div class="tkonto-entry">' +
                                '<input type="text" placeholder="Konto" class="tk-konto-k" style="width: 60%;">' +
                                '<input type="number" placeholder="Bel√∏p" class="tk-belop-k" style="width: 35%;">' +
                                '<button class="remove-btn" onclick="removeTkontoEntry(this)" style="margin-left: 5px;">√ó</button>' +
                            '</div>' +
                        '</div>' +
                        '<button class="btn" onclick="addTkontoEntry(\'kredit\')" style="margin-top: 10px; width: 100%;">+ Kredit</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }
        
        function updateBokforingFormat() {
            var format = document.getElementById('bok-format').value;
            var container = document.getElementById('bok-builder-container');
            
            if (format === 'fortegn') {
                container.innerHTML = buildFortegnskontoUI();
            } else {
                container.innerHTML = buildTkontoUI();
            }
        }
        
        function addFortegnRow() {
            var tbody = document.getElementById('fortegn-rows');
            var rowNum = tbody.children.length + 1;
            var tr = document.createElement('tr');
            tr.className = 'posting-row-fortegn';
            tr.innerHTML = '<td style="padding: 8px; color: #9ca3af;">' + rowNum + '</td>' +
                '<td style="padding: 8px;"><input type="text" placeholder="Kontonr" class="bok-konto" style="width: 100%;"></td>' +
                '<td style="padding: 8px;"><input type="number" placeholder="0" class="bok-debet" style="width: 100%; text-align: right;"></td>' +
                '<td style="padding: 8px;"><input type="number" placeholder="0" class="bok-kredit" style="width: 100%; text-align: right;"></td>' +
                '<td style="padding: 8px;"><button class="remove-btn" onclick="removeFortegnRow(this)">√ó</button></td>';
            tbody.appendChild(tr);
        }
        
        function removeFortegnRow(btn) {
            btn.closest('tr').remove();
            // Oppdater radnumre
            var rows = document.querySelectorAll('#fortegn-rows tr');
            rows.forEach(function(row, index) {
                row.querySelector('td').textContent = index + 1;
            });
        }
        
        function addTkontoEntry(side) {
            var container = document.getElementById('tkonto-' + side);
            var div = document.createElement('div');
            div.className = 'tkonto-entry';
            div.style.marginTop = '10px';
            var suffix = side === 'debet' ? 'd' : 'k';
            div.innerHTML = '<input type="text" placeholder="Konto" class="tk-konto-' + suffix + '" style="width: 60%;">' +
                '<input type="number" placeholder="Bel√∏p" class="tk-belop-' + suffix + '" style="width: 35%;">' +
                '<button class="remove-btn" onclick="removeTkontoEntry(this)" style="margin-left: 5px;">√ó</button>';
            container.appendChild(div);
        }
        
        function removeTkontoEntry(btn) {
            btn.parentElement.remove();
        }

        // Build Analyse UI
        function buildAnalyseUI() {
            return '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Type analyse:</label>' +
                '<div class="form-group">' +
                    '<select id="analyse-type">' +
                        '<option value="n√∏kkeltall">N√∏kkeltallsberegning</option>' +
                        '<option value="horisontal">Horisontal analyse</option>' +
                        '<option value="vertikal">Vertikal analyse</option>' +
                    '</select>' +
                '</div>' +
                '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Oppgi tall:</label>' +
                '<div class="form-row">' +
                    '<div class="form-group"><label>Omsetning</label><input type="number" id="a-omsetning" placeholder="0"></div>' +
                    '<div class="form-group"><label>Resultat</label><input type="number" id="a-resultat" placeholder="0"></div>' +
                    '<div class="form-group"><label>Eiendeler</label><input type="number" id="a-eiendeler" placeholder="0"></div>' +
                    '<div class="form-group"><label>Gjeld</label><input type="number" id="a-gjeld" placeholder="0"></div>' +
                '</div>' +
                '<label style="color: #4ade80; font-weight: bold; margin-bottom: 10px; display: block;">Forventet svar:</label>' +
                '<div class="form-group">' +
                    '<input type="text" id="a-expected" placeholder="F.eks. 15% eller 2.5">' +
                '</div>';
        }

        // Helper functions for dynamic content
        function addOption(type) {
            var list = document.getElementById('options-list');
            var count = list.children.length;
            var labels = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            
            var div = document.createElement('div');
            div.className = 'option-item';
            div.innerHTML = '<input type="' + type + '" name="correct" value="' + count + '">' +
                '<input type="text" placeholder="Alternativ ' + labels[count] + '" class="option-text">' +
                '<button class="remove-btn" onclick="removeOption(this)">√ó</button>';
            list.appendChild(div);
        }

        function removeOption(btn) {
            btn.parentElement.remove();
        }

        function addPosting() {
            var list = document.getElementById('postings-list');
            var div = document.createElement('div');
            div.className = 'posting-row';
            div.innerHTML = '<input type="text" placeholder="Debet konto">' +
                '<input type="text" placeholder="Kredit konto">' +
                '<input type="number" placeholder="Bel√∏p">' +
                '<button class="remove-btn" onclick="removePosting(this)">√ó</button>';
            list.appendChild(div);
        }

        function removePosting(btn) {
            btn.parentElement.remove();
        }

        function removeDDItem(btn) {
            btn.parentElement.remove();
        }

        function addDDCategory() {
            var list = document.getElementById('dd-categories');
            var div = document.createElement('div');
            div.className = 'dd-item';
            div.innerHTML = '<input type="text" placeholder="Ny kategori" class="dd-cat" oninput="updateDDSelects()">' +
                '<button class="remove-btn" onclick="removeDDItem(this); updateDDSelects()">√ó</button>';
            list.appendChild(div);
            updateDDSelects();
        }

        function addDDItem() {
            var list = document.getElementById('dd-items');
            var div = document.createElement('div');
            div.className = 'dd-item';
            div.innerHTML = '<input type="text" placeholder="Element" class="dd-element">' +
                '<select class="dd-element-cat"><option value="">-- Velg kategori --</option></select>' +
                '<button class="remove-btn" onclick="removeDDItem(this)">√ó</button>';
            list.appendChild(div);
            updateDDSelects();
        }

        function updateDDSelects() {
            var categories = [];
            document.querySelectorAll('.dd-cat').forEach(function(input) {
                var val = input.value.trim();
                if (val) categories.push(val);
            });
            
            var options = '<option value="">-- Velg kategori --</option>' + 
                categories.map(function(c) { return '<option value="' + c + '">' + c + '</option>'; }).join('');
            
            document.querySelectorAll('.dd-element-cat').forEach(function(select) {
                var currentVal = select.value;
                select.innerHTML = options;
                // Pr√∏v √• beholde valgt verdi
                if (currentVal && categories.includes(currentVal)) {
                    select.value = currentVal;
                }
            });
        }

        // Save question
        function saveQuestion() {
            if (!selectedQuestionType) {
                alert('Velg en sp√∏rsm√•lstype!');
                return;
            }
            
            var text = document.getElementById('q-text').value.trim();
            if (!text) {
                alert('Skriv inn sp√∏rsm√•lstekst!');
                return;
            }
            
            var question = {
                type: selectedQuestionType,
                text: text,
                difficulty: document.getElementById('q-difficulty').value,
                points: difficultyPoints[document.getElementById('q-difficulty').value] || 200,
                lawReference: document.getElementById('q-law').value
            };
            
            // Collect type-specific data
            switch(selectedQuestionType) {
                case 'multiple_choice':
                case 'multiple_select':
                    question.options = [];
                    question.shuffle = document.getElementById('shuffle-options') ? document.getElementById('shuffle-options').checked : true;
                    var items = document.querySelectorAll('#options-list .option-item');
                    items.forEach(function(item, index) {
                        var optText = item.querySelector('.option-text').value.trim();
                        var isCorrect = item.querySelector('input[type="radio"], input[type="checkbox"]').checked;
                        if (optText) {
                            question.options.push({ text: optText, correct: isCorrect });
                        }
                    });
                    if (question.options.length < 2) {
                        alert('Legg til minst 2 alternativer!');
                        return;
                    }
                    break;
                    
                case 'true_false':
                    question.correctAnswer = document.getElementById('tf-answer').value === 'true';
                    break;
                    
                case 'paragraph':
                    question.paragraphRef = document.getElementById('para-ref').value;
                    question.keywords = document.getElementById('para-keywords').value.split(',').map(function(k) { return k.trim(); });
                    break;
                    
                case 'drag_drop':
                    question.shuffle = document.getElementById('shuffle-dd') ? document.getElementById('shuffle-dd').checked : true;
                    question.categories = [];
                    document.querySelectorAll('.dd-cat').forEach(function(input) {
                        if (input.value.trim()) question.categories.push(input.value.trim());
                    });
                    question.items = [];
                    document.querySelectorAll('#dd-items .dd-item').forEach(function(item) {
                        var textInput = item.querySelector('.dd-element').value.trim();
                        var catSelect = item.querySelector('.dd-element-cat').value;
                        if (textInput && catSelect) question.items.push({ text: textInput, category: catSelect });
                    });
                    if (question.categories.length < 2) {
                        alert('Legg til minst 2 kategorier!');
                        return;
                    }
                    if (question.items.length < 2) {
                        alert('Legg til minst 2 elementer!');
                        return;
                    }
                    break;
                    
                case 'bokforing':
                    question.scenario = document.getElementById('bok-scenario').value;
                    question.mvaRate = document.getElementById('bok-mva').value;
                    question.format = document.getElementById('bok-format').value;
                    question.prefill = document.getElementById('bok-prefill') ? document.getElementById('bok-prefill').checked : false;
                    question.postings = [];
                    
                    if (question.format === 'fortegn') {
                        // Fortegnskonto format
                        document.querySelectorAll('#fortegn-rows tr').forEach(function(row) {
                            var konto = row.querySelector('.bok-konto');
                            var debet = row.querySelector('.bok-debet');
                            var kredit = row.querySelector('.bok-kredit');
                            if (konto && konto.value) {
                                question.postings.push({
                                    konto: konto.value,
                                    debet: parseFloat(debet.value) || 0,
                                    kredit: parseFloat(kredit.value) || 0
                                });
                            }
                        });
                    } else {
                        // T-konto format
                        document.querySelectorAll('.tk-konto-d').forEach(function(input, index) {
                            var belopInput = document.querySelectorAll('.tk-belop-d')[index];
                            if (input.value && belopInput.value) {
                                question.postings.push({
                                    konto: input.value,
                                    debet: parseFloat(belopInput.value),
                                    kredit: 0
                                });
                            }
                        });
                        document.querySelectorAll('.tk-konto-k').forEach(function(input, index) {
                            var belopInput = document.querySelectorAll('.tk-belop-k')[index];
                            if (input.value && belopInput.value) {
                                question.postings.push({
                                    konto: input.value,
                                    debet: 0,
                                    kredit: parseFloat(belopInput.value)
                                });
                            }
                        });
                    }
                    
                    if (question.postings.length === 0) {
                        alert('Legg til minst √©n postering!');
                        return;
                    }
                    break;
                    
                case 'analyse':
                    question.analyseType = document.getElementById('analyse-type').value;
                    question.data = {
                        omsetning: parseFloat(document.getElementById('a-omsetning').value) || 0,
                        resultat: parseFloat(document.getElementById('a-resultat').value) || 0,
                        eiendeler: parseFloat(document.getElementById('a-eiendeler').value) || 0,
                        gjeld: parseFloat(document.getElementById('a-gjeld').value) || 0
                    };
                    question.expectedAnswer = document.getElementById('a-expected').value;
                    break;
            }
            
            currentQuestions.push(question);
            updateQuestionsPreview();
            closeQuestionModal();
        }

        // Update questions preview
        function updateQuestionsPreview() {
            var container = document.getElementById('questions-list');
            document.getElementById('question-count').textContent = currentQuestions.length;
            
            if (currentQuestions.length === 0) {
                container.innerHTML = '<p style="color: #9ca3af; text-align: center; padding: 20px;">Ingen sp√∏rsm√•l lagt til enn√•</p>';
                return;
            }
            
            var typeLabels = {
                multiple_choice: 'üîò Multiple Choice',
                multiple_select: '‚òëÔ∏è Velg Flere',
                true_false: '‚úÖ Sant/Usant',
                paragraph: 'üìú Paragraf',
                drag_drop: 'üéØ Dra & Slipp',
                bokforing: 'üìä Bokf√∏ring',
                analyse: 'üìà Analyse'
            };
            
            var html = '';
            currentQuestions.forEach(function(q, index) {
                var typeLabel = typeLabels[q.type] || 'üìù Ukjent';
                var points = q.points || 200;
                html += '<div class="question-preview-item">' +
                    '<span class="q-number">#' + (index + 1) + '</span>' +
                    '<span class="q-type">' + typeLabel + '</span>' +
                    '<span class="badge ' + (q.difficulty || 'medium') + '" style="margin-left: 10px;">' + points + 'p</span>' +
                    '<button class="btn danger" style="float: right; padding: 5px 10px;" onclick="removeQuestion(' + index + ')">√ó</button>' +
                    '<div class="q-text">' + (q.text ? q.text.substring(0, 100) + (q.text.length > 100 ? '...' : '') : 'Ingen tekst') + '</div>' +
                '</div>';
            });
            
            container.innerHTML = html;
        }

        // Remove question
        function removeQuestion(index) {
            currentQuestions.splice(index, 1);
            updateQuestionsPreview();
        }

        // Save quiz
        function saveQuiz() {
            var title = document.getElementById('quiz-title').value.trim();
            if (!title) {
                alert('Skriv inn en tittel!');
                return;
            }
            
            if (currentQuestions.length === 0) {
                alert('Legg til minst ett sp√∏rsm√•l!');
                return;
            }
            
            var quiz = {
                title: title,
                description: document.getElementById('quiz-description').value,
                category: document.getElementById('quiz-category').value,
                language: document.getElementById('quiz-language').value,
                visibility: document.getElementById('quiz-visibility').value,
                timePerQuestion: parseInt(document.getElementById('quiz-time').value),
                questions: currentQuestions,
                createdAt: Date.now(),
                createdBy: currentUser ? currentUser.uid : 'local',
                createdByName: currentUser ? (currentUser.displayName || currentUser.email) : 'Lokal bruker'
            };
            
            // Save to localStorage
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            
            if (editingQuizId !== null) {
                savedQuizzes[editingQuizId] = quiz;
            } else {
                savedQuizzes.push(quiz);
            }
            
            localStorage.setItem('teacher_quizzes', JSON.stringify(savedQuizzes));
            
            // If public, also save to Firebase
            if (quiz.visibility === 'public' && firebaseReady && db) {
                var quizId = 'quiz_' + Date.now();
                db.ref('public_quizzes/' + quizId).set(quiz)
                    .then(function() {
                        console.log('Quiz published publicly');
                    })
                    .catch(function(error) {
                        console.error('Error publishing quiz:', error);
                        alert('Quiz lagret lokalt, men kunne ikke publiseres offentlig.');
                    });
            } else if (quiz.visibility === 'public' && !firebaseReady) {
                alert('Quiz lagret lokalt. Offentlig publisering krever internett-tilkobling.');
            }
            
            alert('‚úÖ Quiz lagret!');
            closeModal();
            loadMyQuizzes();
        }

        // Delete quiz
        function deleteQuiz(index) {
            if (!confirm('Er du sikker p√• at du vil slette denne quizzen?')) return;
            
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            savedQuizzes.splice(index, 1);
            localStorage.setItem('teacher_quizzes', JSON.stringify(savedQuizzes));
            loadMyQuizzes();
        }

        // Start game with quiz
        function startGameWithQuiz(index) {
            var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
            var quiz = savedQuizzes[index];
            
            if (!quiz || !quiz.questions || quiz.questions.length === 0) {
                alert('Denne quizzen har ingen sp√∏rsm√•l!');
                return;
            }
            
            // Convert to multiplayer format
            var multiplayerQuiz = convertToMultiplayerFormat(quiz);
            startMultiplayerGame(multiplayerQuiz);
        }

        // Start demo game
        function startDemoGame(demoId) {
            var quiz = getDemoQuiz(demoId);
            if (quiz) {
                startMultiplayerGame(quiz);
            }
        }

        // Get demo quiz
        function getDemoQuiz(demoId) {
            var demos = {
                demo_bokforing: {
                    title: 'Bokf√∏ring Grunnleggende',
                    timePerQuestion: 30,
                    questions: [
                        { text: 'Hva er debet-siden av en konto?', answers: ['Venstre side', 'H√∏yre side', '√òverst', 'Nederst'], correct: 0 },
                        { text: 'Hvilken konto √∏ker ved debitering?', answers: ['Gjeld', 'Inntekt', 'Eiendeler', 'Egenkapital'], correct: 2 },
                        { text: 'Hva betyr MVA?', answers: ['Moms ved anskaffelse', 'Merverdiavgift', 'M√•nedlig verdianslag', 'Materiell verdianskuelse'], correct: 1 },
                        { text: 'Hvilket prinsipp sier at inntekter og kostnader skal f√∏res i den perioden de oppst√•r?', answers: ['Kontantprinsippet', 'Sammenstillingsprinsippet', 'Forsiktighetsprinsippet', 'Periodiseringsprinsippet'], correct: 3 },
                        { text: 'Hva er en kontoplan?', answers: ['En plan for kontorinnredning', 'En oversikt over alle kontoer i regnskapet', 'En betalingsplan', 'En budsjettplan'], correct: 1 }
                    ]
                },
                demo_mva: {
                    title: 'MVA-regler',
                    timePerQuestion: 30,
                    questions: [
                        { text: 'Hva er standard MVA-sats i Norge?', answers: ['15%', '20%', '25%', '27%'], correct: 2 },
                        { text: 'Hvilken MVA-sats gjelder for matvarer?', answers: ['0%', '12%', '15%', '25%'], correct: 1 },
                        { text: 'N√•r m√• MVA-oppgaven normalt leveres?', answers: ['M√•nedlig', 'Annenhver m√•ned', 'Kvartalsvis', '√Örlig'], correct: 1 },
                        { text: 'Hva er fradragsberettiget inng√•ende MVA?', answers: ['MVA p√• private kj√∏p', 'MVA p√• n√¶ringsrelaterte kj√∏p', 'All MVA', 'Ingen MVA'], correct: 1 }
                    ]
                },
                demo_regnskap: {
                    title: 'Regnskapsprinsipper',
                    timePerQuestion: 30,
                    questions: [
                        { text: 'Hva inneb√¶rer forsiktighetsprinsippet?', answers: ['Alltid velge h√∏yeste verdi', 'Ikke overvurdere eiendeler eller undervurdere gjeld', 'Utsette alle kostnader', 'Ignorere usikre poster'], correct: 1 },
                        { text: 'Hva er hovedform√•let med √•rsregnskapet?', answers: ['Beregne skatt', 'Gi informasjon til interessenter', 'Tilfredsstille myndighetene', 'Beregne utbytte'], correct: 1 },
                        { text: 'Hva er egenkapital?', answers: ['Eiendeler minus gjeld', 'Inntekter minus kostnader', 'Bankinnskudd', 'Aksjekapital'], correct: 0 }
                    ]
                }
            };
            return demos[demoId];
        }

        // Convert quiz to multiplayer format
        function convertToMultiplayerFormat(quiz) {
            var converted = {
                title: quiz.title,
                timePerQuestion: quiz.timePerQuestion || 30,
                questions: []
            };
            
            quiz.questions.forEach(function(q) {
                var mpQuestion = {
                    text: q.text,
                    answers: [],
                    correct: 0,
                    points: q.points || 200,
                    type: q.type
                };
                
                switch(q.type) {
                    case 'multiple_choice':
                    case 'multiple_select':
                        q.options.forEach(function(opt, i) {
                            mpQuestion.answers.push(opt.text);
                            if (opt.correct) mpQuestion.correct = i;
                        });
                        break;
                    case 'true_false':
                        mpQuestion.answers = ['Sant', 'Usant'];
                        mpQuestion.correct = q.correctAnswer ? 0 : 1;
                        break;
                    default:
                        // For other types, create simple format
                        mpQuestion.answers = ['Alternativ A', 'Alternativ B', 'Alternativ C', 'Alternativ D'];
                        mpQuestion.correct = 0;
                }
                
                converted.questions.push(mpQuestion);
            });
            
            return converted;
        }

        // Start multiplayer game
        function startMultiplayerGame(quiz) {
            if (!firebaseReady || !db) {
                alert('Venter p√• database-tilkobling. Pr√∏v igjen om noen sekunder.');
                return;
            }
            
            var pin = Math.floor(100000 + Math.random() * 900000).toString();
            
            db.ref('games/' + pin).set({
                pin: pin,
                status: 'lobby',
                quiz: quiz,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {}
            }).then(function() {
                window.location.href = 'game_host.html?pin=' + pin;
            }).catch(function(error) {
                console.error('Error creating game:', error);
                alert('Kunne ikke opprette spill. Pr√∏v igjen.');
            });
        }

        // Copy public quiz
        function copyQuiz(quizId) {
            if (!firebaseReady || !db) {
                alert('Venter p√• database-tilkobling...');
                return;
            }
            db.ref('public_quizzes/' + quizId).once('value')
                .then(function(snapshot) {
                    var quiz = snapshot.val();
                    if (quiz) {
                        quiz.visibility = 'private';
                        quiz.title = quiz.title + ' (kopi)';
                        
                        var savedQuizzes = JSON.parse(localStorage.getItem('teacher_quizzes') || '[]');
                        savedQuizzes.push(quiz);
                        localStorage.setItem('teacher_quizzes', JSON.stringify(savedQuizzes));
                        
                        alert('‚úÖ Quiz kopiert til dine quizzer!');
                        loadMyQuizzes();
                        switchTab('mine');
                    }
                });
        }

        // Start game with public quiz
        function startGameWithPublicQuiz(quizId) {
            if (!firebaseReady || !db) {
                alert('Venter p√• database-tilkobling...');
                return;
            }
            db.ref('public_quizzes/' + quizId).once('value')
                .then(function(snapshot) {
                    var quiz = snapshot.val();
                    if (quiz) {
                        var multiplayerQuiz = convertToMultiplayerFormat(quiz);
                        startMultiplayerGame(multiplayerQuiz);
                    }
                });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Start Firebase initialization
            initFirebase();
            // Load local quizzes immediately
            loadMyQuizzes();
        });
    </script>
</body>
</html>
