<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question Admin - AccountingQuest</title>
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #2d3748;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --accent-green: #4ade80;
            --accent-blue: #3b82f6;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --border-color: #374151;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }
        
        h1 {
            color: var(--accent-green);
            font-size: 1.8em;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-connected {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }
        
        .status-disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        
        .card h2 {
            color: var(--accent-blue);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:last-child {
            margin-bottom: 0;
        }
        
        .btn-primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }
        
        .btn-primary:hover {
            background: #3bc46e;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2563eb;
        }
        
        .btn-warning {
            background: var(--accent-orange);
            color: white;
        }
        
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-green);
        }
        
        .stat-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        
        .tab:hover {
            border-color: var(--accent-blue);
        }
        
        .tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .question-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .question-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .question-item:hover {
            border-color: var(--accent-green);
        }
        
        .question-item.selected {
            border-color: var(--accent-green);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .question-title {
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .question-id {
            font-size: 0.8em;
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        .question-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }
        
        .badge-type {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        .badge-easy {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent-green);
        }
        
        .badge-medium {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }
        
        .badge-hard {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        .question-preview {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .detail-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 25px;
        }
        
        .detail-panel h3 {
            color: var(--accent-green);
            margin-bottom: 15px;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h4 {
            color: var(--accent-blue);
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .detail-content {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .log-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
        }
        
        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-success { color: var(--accent-green); }
        .log-error { color: var(--accent-red); }
        .log-info { color: var(--accent-blue); }
        .log-warning { color: var(--accent-orange); }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö Question Admin Panel</h1>
            <span class="status-badge status-disconnected" id="connection-status">
                üî¥ Kobler til...
            </span>
        </header>
        
        <div class="grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Actions -->
                <div class="card">
                    <h2>‚ö° Actions</h2>
                    <button class="btn btn-primary" onclick="seedDatabase()">
                        üå± Seed Corporate Finance
                    </button>
                    <button class="btn btn-secondary" onclick="loadAllQuestions()">
                        üîÑ Refresh Questions
                    </button>
                    <button class="btn btn-warning" onclick="exportToJson()">
                        üì• Export to JSON
                    </button>
                    <button class="btn btn-danger" onclick="clearModule('corporate_finance')">
                        üóëÔ∏è Clear Module
                    </button>
                </div>
                
                <!-- Stats -->
                <div class="card">
                    <h2>üìä Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="stat-total">0</div>
                            <div class="stat-label">Total Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-topics">0</div>
                            <div class="stat-label">Topics</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-mc">0</div>
                            <div class="stat-label">Multiple Choice</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="stat-calc">0</div>
                            <div class="stat-label">Calculations</div>
                        </div>
                    </div>
                </div>
                
                <!-- Log -->
                <div class="card">
                    <h2>üìù Activity Log</h2>
                    <div class="log-container" id="log-container">
                        <div class="log-entry log-info">Ready...</div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <!-- Topic Tabs -->
                <div class="card">
                    <h2>üè∑Ô∏è Topics</h2>
                    <div class="tabs" id="topic-tabs">
                        <div class="tab active" data-topic="all">All</div>
                        <div class="tab" data-topic="npv">NPV</div>
                        <div class="tab" data-topic="bonds">Bonds</div>
                        <div class="tab" data-topic="stocks">Stocks</div>
                        <div class="tab" data-topic="wacc">WACC</div>
                        <div class="tab" data-topic="portfolio">Portfolio</div>
                        <div class="tab" data-topic="annuity">Annuity</div>
                        <div class="tab" data-topic="forex">Forex</div>
                        <div class="tab" data-topic="options">Options</div>
                        <div class="tab" data-topic="leverage">Leverage</div>
                    </div>
                </div>
                
                <!-- Question List -->
                <div class="card">
                    <h2>üìã Questions <span id="question-count">(0)</span></h2>
                    <div class="progress-bar" id="progress-bar" style="display: none;">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="question-list" id="question-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <p>No questions loaded yet.<br>Click "Seed Corporate Finance" to populate.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Detail Panel -->
                <div class="detail-panel" id="detail-panel" style="display: none;">
                    <h3 id="detail-title">Question Details</h3>
                    <div class="detail-section">
                        <h4>Question</h4>
                        <div class="detail-content" id="detail-question"></div>
                    </div>
                    <div class="detail-section">
                        <h4>Solution</h4>
                        <div class="detail-content" id="detail-solution"></div>
                    </div>
                    <div class="detail-section">
                        <h4>Full JSON</h4>
                        <div class="detail-content" id="detail-json"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Our Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/question-service.js"></script>
    <script src="js/seed-corporate-finance.js"></script>
    
    <script>
        // ==================== STATE ====================
        
        var state = {
            questions: [],
            selectedTopic: 'all',
            selectedQuestion: null
        };
        
        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            initFirebase();
            setupEventListeners();
        });
        
        function initFirebase() {
            log('Initializing Firebase...', 'info');
            
            FirebaseConfig.init()
                .then(function() {
                    updateConnectionStatus(true);
                    log('Firebase connected!', 'success');
                    loadAllQuestions();
                })
                .catch(function(err) {
                    updateConnectionStatus(false);
                    log('Firebase connection failed: ' + err.message, 'error');
                });
        }
        
        function setupEventListeners() {
            // Topic tabs
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    selectTopic(this.dataset.topic);
                });
            });
        }
        
        // ==================== UI UPDATES ====================
        
        function updateConnectionStatus(connected) {
            var el = document.getElementById('connection-status');
            if (connected) {
                el.className = 'status-badge status-connected';
                el.innerHTML = 'üü¢ Connected';
            } else {
                el.className = 'status-badge status-disconnected';
                el.innerHTML = 'üî¥ Disconnected';
            }
        }
        
        function updateStats() {
            var total = state.questions.length;
            var topics = new Set(state.questions.map(function(q) { return q.topic; })).size;
            var mc = state.questions.filter(function(q) { return q.type === 'multiple_choice'; }).length;
            var calc = state.questions.filter(function(q) { return q.type === 'calculation' || q.type === 'excel_grid'; }).length;
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-topics').textContent = topics;
            document.getElementById('stat-mc').textContent = mc;
            document.getElementById('stat-calc').textContent = calc;
        }
        
        function log(message, type) {
            type = type || 'info';
            var container = document.getElementById('log-container');
            var entry = document.createElement('div');
            entry.className = 'log-entry log-' + type;
            entry.textContent = '[' + new Date().toLocaleTimeString() + '] ' + message;
            container.insertBefore(entry, container.firstChild);
            
            // Keep only last 50 entries
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }
        
        function showProgress(show) {
            document.getElementById('progress-bar').style.display = show ? 'block' : 'none';
        }
        
        function updateProgress(percent) {
            document.getElementById('progress-fill').style.width = percent + '%';
        }
        
        // ==================== QUESTION DISPLAY ====================
        
        function selectTopic(topic) {
            state.selectedTopic = topic;
            
            // Update tabs
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.toggle('active', tab.dataset.topic === topic);
            });
            
            renderQuestionList();
        }
        
        function renderQuestionList() {
            var container = document.getElementById('question-list');
            var filtered = state.questions;
            
            if (state.selectedTopic !== 'all') {
                filtered = filtered.filter(function(q) {
                    return q.topic === state.selectedTopic;
                });
            }
            
            document.getElementById('question-count').textContent = '(' + filtered.length + ')';
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No questions found.</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(function(q) {
                var diffClass = 'badge-' + (q.difficulty || 'medium');
                return '<div class="question-item" data-id="' + q.id + '" onclick="selectQuestion(\'' + q.id + '\')">' +
                    '<div class="question-header">' +
                        '<div>' +
                            '<div class="question-title">' + (q.title || q.id) + '</div>' +
                            '<div class="question-id">' + q.id + '</div>' +
                        '</div>' +
                        '<div class="question-badges">' +
                            '<span class="badge badge-type">' + q.type + '</span>' +
                            '<span class="badge ' + diffClass + '">' + (q.difficulty || 'medium') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="question-preview">' + truncate(q.question || q.description || '', 150) + '</div>' +
                '</div>';
            }).join('');
        }
        
        function selectQuestion(id) {
            var q = state.questions.find(function(q) { return q.id === id; });
            if (!q) return;
            
            state.selectedQuestion = q;
            
            // Update selection UI
            document.querySelectorAll('.question-item').forEach(function(el) {
                el.classList.toggle('selected', el.dataset.id === id);
            });
            
            // Show detail panel
            var panel = document.getElementById('detail-panel');
            panel.style.display = 'block';
            
            document.getElementById('detail-title').textContent = q.title || q.id;
            document.getElementById('detail-question').textContent = q.question || q.description || 'N/A';
            document.getElementById('detail-solution').textContent = JSON.stringify(q.solution, null, 2);
            document.getElementById('detail-json').textContent = JSON.stringify(q, null, 2);
        }
        
        function truncate(str, len) {
            if (str.length <= len) return str;
            return str.substring(0, len) + '...';
        }
        
        // ==================== DATABASE OPERATIONS ====================
        
        function loadAllQuestions() {
            log('Loading questions from Firebase...', 'info');
            showProgress(true);
            updateProgress(30);
            
            var db = FirebaseConfig.getDb();
            if (!db) {
                log('Database not ready', 'error');
                showProgress(false);
                return;
            }
            
            db.ref('questions/corporate_finance').once('value')
                .then(function(snapshot) {
                    updateProgress(70);
                    var data = snapshot.val();
                    
                    if (!data) {
                        state.questions = [];
                        log('No questions in database', 'warning');
                    } else {
                        state.questions = extractQuestions(data);
                        log('Loaded ' + state.questions.length + ' questions', 'success');
                    }
                    
                    updateStats();
                    renderQuestionList();
                    updateProgress(100);
                    setTimeout(function() { showProgress(false); }, 500);
                })
                .catch(function(err) {
                    log('Load failed: ' + err.message, 'error');
                    showProgress(false);
                });
        }
        
        function extractQuestions(obj, questions) {
            questions = questions || [];
            
            if (!obj || typeof obj !== 'object') return questions;
            
            // Check if this is a question object
            if (obj.id && obj.type) {
                questions.push(obj);
                return questions;
            }
            
            // Recurse into children
            Object.keys(obj).forEach(function(key) {
                if (key.startsWith('_')) return;
                extractQuestions(obj[key], questions);
            });
            
            return questions;
        }
        
        function seedDatabase() {
            if (!confirm('This will upload all Corporate Finance questions to Firebase. Continue?')) {
                return;
            }
            
            log('Starting seed process...', 'info');
            showProgress(true);
            
            var questions = CorporateFinanceSeedData.getAllQuestions();
            var total = questions.length;
            var completed = 0;
            var errors = 0;
            
            log('Uploading ' + total + ' questions...', 'info');
            
            var db = FirebaseConfig.getDb();
            if (!db) {
                log('Database not ready', 'error');
                showProgress(false);
                return;
            }
            
            // Upload questions sequentially
            var promise = Promise.resolve();
            
            questions.forEach(function(q, index) {
                promise = promise.then(function() {
                    var path = 'questions/' + q.module + '/' + q.topic + '/' + q.difficulty + '/' + q.id;
                    
                    return db.ref(path).set(q)
                        .then(function() {
                            completed++;
                            updateProgress(Math.round((completed / total) * 100));
                        })
                        .catch(function(err) {
                            errors++;
                            log('Failed to upload ' + q.id + ': ' + err.message, 'error');
                        });
                });
            });
            
            promise.then(function() {
                log('Seed complete! ' + completed + ' uploaded, ' + errors + ' errors', errors > 0 ? 'warning' : 'success');
                showProgress(false);
                loadAllQuestions();
            });
        }
        
        function clearModule(module) {
            if (!confirm('‚ö†Ô∏è WARNING: This will DELETE all questions in the "' + module + '" module. This cannot be undone!')) {
                return;
            }
            
            if (!confirm('Are you REALLY sure? Type "DELETE" in the next prompt to confirm.')) {
                return;
            }
            
            var confirmation = prompt('Type DELETE to confirm:');
            if (confirmation !== 'DELETE') {
                log('Delete cancelled', 'info');
                return;
            }
            
            log('Deleting module: ' + module, 'warning');
            
            var db = FirebaseConfig.getDb();
            db.ref('questions/' + module).remove()
                .then(function() {
                    log('Module deleted successfully', 'success');
                    loadAllQuestions();
                })
                .catch(function(err) {
                    log('Delete failed: ' + err.message, 'error');
                });
        }
        
        function exportToJson() {
            if (state.questions.length === 0) {
                log('No questions to export', 'warning');
                return;
            }
            
            var data = JSON.stringify(state.questions, null, 2);
            var blob = new Blob([data], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            
            var a = document.createElement('a');
            a.href = url;
            a.download = 'corporate_finance_questions.json';
            a.click();
            
            URL.revokeObjectURL(url);
            log('Exported ' + state.questions.length + ' questions', 'success');
        }
    </script>
</body>
</html>
