<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrer som l√¶rer - AccountingQuest</title>
    <link rel="stylesheet" href="main.css">
    <style>
        .registration-container {
            max-width: 700px;
            margin: 60px auto;
            padding: 50px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: 25px;
        }
        
        .registration-title {
            font-size: 2.5em;
            color: var(--accent);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .registration-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--accent);
            outline: none;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .verification-status {
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
        }
        
        .verification-status.show {
            display: block;
        }
        
        .verification-status.success {
            background: var(--success);
            color: white;
        }
        
        .verification-status.warning {
            background: var(--warning);
            color: var(--bg-primary);
        }
        
        .plan-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .plan-card {
            background: var(--bg-primary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .plan-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
        }
        
        .plan-card.selected {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .plan-card.selected .plan-price,
        .plan-card.selected .plan-feature {
            color: var(--bg-primary);
        }
        
        .plan-badge {
            position: absolute;
            top: -10px;
            right: 15px;
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .plan-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .plan-price {
            font-size: 2em;
            color: var(--accent);
            font-weight: bold;
            margin: 15px 0;
        }
        
        .plan-period {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        .plan-features {
            text-align: left;
            margin-top: 20px;
        }
        
        .plan-feature {
            margin: 10px 0;
            color: var(--text-secondary);
        }
        
        .plan-feature.included::before {
            content: '‚úÖ ';
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-back {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .trial-notice {
            background: var(--success);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .upload-area {
            border: 2px dashed var(--bg-tertiary);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--accent);
            background: var(--bg-primary);
        }
        
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="window.location.href='teacher_portal.html'">‚Üê Tilbake</div>
            <h1>üë®‚Äçüè´ Registrer som l√¶rer</h1>
        </div>

        <div class="registration-container">
            <!-- Step 1: Basic Info -->
            <div class="step active" id="step1">
                <div class="registration-title">üìù Grunnleggende informasjon</div>
                <div class="registration-subtitle">Fortell oss litt om deg selv</div>
                
                <div class="form-group">
                    <label>Fullt navn *</label>
                    <input type="text" id="teacher-name" placeholder="Ole Hansen" required>
                </div>
                
                <div class="form-group">
                    <label>E-postadresse *</label>
                    <input type="email" id="teacher-email" placeholder="ole.hansen@uis.no" required>
                    <small>Bruk din skole/universitets e-post for automatisk godkjenning</small>
                </div>
                
                <div class="form-group">
                    <label>Institusjon/Skole *</label>
                    <input type="text" id="teacher-school" placeholder="Universitetet i Stavanger" required>
                </div>
                
                <div class="form-group">
                    <label>Rolle</label>
                    <select id="teacher-role">
                        <option value="lecturer">Universitets-/h√∏yskolelektor</option>
                        <option value="professor">Professor</option>
                        <option value="teacher">VGS-l√¶rer</option>
                        <option value="instructor">Instrukt√∏r/Kursleder</option>
                        <option value="other">Annet</option>
                    </select>
                </div>
                
                <div class="verification-status" id="verification-status"></div>
                
                <button class="btn primary" onclick="verifyAndNext()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                    Neste ‚Üí
                </button>
            </div>

            <!-- Step 2: Plan Selection -->
            <div class="step" id="step2">
                <div class="registration-title">üíé Velg plan</div>
                <div class="registration-subtitle">Alle planer inkluderer 14 dagers gratis pr√∏veperiode</div>
                
                <div class="trial-notice">
                    üéâ 14 dager gratis pr√∏veperiode - ingen binding!
                </div>
                
                <div class="plan-cards">
                    <div class="plan-card" onclick="selectPlan('basic')">
                        <div class="plan-name">Basic</div>
                        <div class="plan-price">499 kr</div>
                        <div class="plan-period">per semester</div>
                        <div class="plan-features">
                            <div class="plan-feature included">3 klasserom</div>
                            <div class="plan-feature included">100 elever totalt</div>
                            <div class="plan-feature included">Multiplayer quiz</div>
                            <div class="plan-feature included">Excel export</div>
                            <div class="plan-feature included">Basis statistikk</div>
                        </div>
                    </div>
                    
                    <div class="plan-card" onclick="selectPlan('pro')">
                        <div class="plan-badge">POPUL√ÜR</div>
                        <div class="plan-name">Pro</div>
                        <div class="plan-price">999 kr</div>
                        <div class="plan-period">per √•r</div>
                        <div class="plan-features">
                            <div class="plan-feature included">Ubegrensede klasserom</div>
                            <div class="plan-feature included">Ubegrensede elever</div>
                            <div class="plan-feature included">Multiplayer + Battles</div>
                            <div class="plan-feature included">Avansert statistikk</div>
                            <div class="plan-feature included">E-post notifikasjoner</div>
                            <div class="plan-feature included">Prioritert support</div>
                        </div>
                    </div>
                    
                    <div class="plan-card" onclick="selectPlan('school')">
                        <div class="plan-name">Skole</div>
                        <div class="plan-price">2999 kr</div>
                        <div class="plan-period">per √•r</div>
                        <div class="plan-features">
                            <div class="plan-feature included">10+ l√¶rere</div>
                            <div class="plan-feature included">Delt oppgavebank</div>
                            <div class="plan-feature included">Admin dashboard</div>
                            <div class="plan-feature included">Custom branding</div>
                            <div class="plan-feature included">Faktura</div>
                            <div class="plan-feature included">Dedikert support</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-back" onclick="showStep(1)" style="flex: 1;">‚Üê Tilbake</button>
                    <button class="btn primary" onclick="continueToPayment()" style="flex: 2;" id="continue-btn" disabled>
                        Fortsett til betaling
                    </button>
                </div>
            </div>

            <!-- Step 3: Manual Verification -->
            <div class="step" id="step3">
                <div class="registration-title">üìÑ Verifisering</div>
                <div class="registration-subtitle">Last opp bevis p√• at du er l√¶rer</div>
                
                <p style="margin-bottom: 30px;">
                    Vi kunne ikke automatisk verifisere din e-post. Last opp ett av f√∏lgende:
                </p>
                
                <ul style="margin-bottom: 30px; color: var(--text-secondary);">
                    <li>Arbeidskontrakt</li>
                    <li>Ansattbevis</li>
                    <li>Brev p√• skolens brevhode</li>
                    <li>Skjermbildet av ansattportal</li>
                </ul>
                
                <div class="upload-area" onclick="document.getElementById('file-upload').click()">
                    <div class="upload-icon">üìé</div>
                    <div>Klikk for √• laste opp dokument</div>
                    <input type="file" id="file-upload" style="display: none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleFileUpload(event)">
                </div>
                
                <div id="file-name" style="margin-top: 15px; color: var(--success); display: none;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-back" onclick="showStep(1)">‚Üê Tilbake</button>
                    <button class="btn primary" onclick="submitManualVerification()" id="submit-manual-btn" disabled>
                        Send inn for godkjenning
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase init
        (function initFirebase() {
            var attempts = 0;
            var maxAttempts = 50;
            
            function tryInit() {
                attempts++;
                
                if (typeof firebase === 'undefined') {
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 100);
                    }
                    return;
                }
                
                try {
                    var firebaseConfig = {
                        apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
                        authDomain: "accountingquest-multiplayer.firebaseapp.com",
                        databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "accountingquest-multiplayer",
                        storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                        messagingSenderId: "525417361926",
                        appId: "1:525417361926:web:ec9b737f82af9b21700987"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    window.db = firebase.database();
                } catch (error) {
                    console.error('üî• Firebase error:', error);
                }
            }
            
            tryInit();
        })();
        
        var teacherDomains = [
            // Universiteter
            'uis.no', 'uio.no', 'ntnu.no', 'uib.no', 'uit.no',
            'nmbu.no', 'oslomet.no', 'hiof.no', 'hvl.no',
            'inn.no', 'usn.no', 'nord.no', 'khio.no',
            'bi.no', 'nmh.no', 'nih.no', 'mf.no', 'nla.no',
            
            // Fylker (VGS)
            'rogfk.no', 'viken.no', 'vestfoldfylke.no',
            'mrfylke.no', 'trondelagfylke.no', 'tffk.no',
            'vfk.no', 'sfj.no', 'hfk.no',
            
            // Skoler
            'skole.rogaland.no', 'skole.oslo.no', 'skole.bergen.no',
            'vgs.no', 'gs.no'
        ];
        
        var currentData = {};
        var selectedPlan = null;
        var uploadedFile = null;
        
        function verifyAndNext() {
            var name = document.getElementById('teacher-name').value.trim();
            var email = document.getElementById('teacher-email').value.trim();
            var school = document.getElementById('teacher-school').value.trim();
            var role = document.getElementById('teacher-role').value;
            
            if (!name || !email || !school) {
                alert('Vennligst fyll inn alle obligatoriske felter');
                return;
            }
            
            // Save data
            currentData = { name, email, school, role };
            
            // Check email domain
            var domain = email.split('@')[1];
            var statusEl = document.getElementById('verification-status');
            
            if (teacherDomains.includes(domain)) {
                statusEl.className = 'verification-status success show';
                statusEl.innerHTML = '‚úÖ E-post verifisert automatisk! Du kan fortsette til planvalg.';
                currentData.verified = true;
                currentData.verificationMethod = 'email_domain';
                
                setTimeout(function() {
                    showStep(2);
                }, 1500);
            } else {
                statusEl.className = 'verification-status warning show';
                statusEl.innerHTML = '‚ö†Ô∏è Vi kunne ikke automatisk verifisere din e-post. Du m√• laste opp dokumentasjon.';
                currentData.verified = false;
                currentData.verificationMethod = 'manual';
                
                setTimeout(function() {
                    showStep(3);
                }, 2000);
            }
        }
        
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(function(step) {
                step.classList.remove('active');
            });
            document.getElementById('step' + stepNumber).classList.add('active');
        }
        
        function selectPlan(plan) {
            selectedPlan = plan;
            
            document.querySelectorAll('.plan-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            document.getElementById('continue-btn').disabled = false;
        }
        
        function continueToPayment() {
            if (!selectedPlan) {
                alert('Velg en plan f√∏rst');
                return;
            }
            
            currentData.plan = selectedPlan;
            
            // In production, redirect to Vipps payment
            alert('I produksjon: Redirect til Vipps betaling\n\nPlan: ' + selectedPlan + '\n\nFor n√•: Oppretter gratis pr√∏veperiode...');
            
            createTeacherAccount();
        }
        
        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (file) {
                uploadedFile = file;
                document.getElementById('file-name').textContent = '‚úÖ ' + file.name + ' lastet opp';
                document.getElementById('file-name').style.display = 'block';
                document.getElementById('submit-manual-btn').disabled = false;
            }
        }
        
        function submitManualVerification() {
            if (!uploadedFile) {
                alert('Last opp et dokument f√∏rst');
                return;
            }
            
            // In production: Upload file to Firebase Storage
            alert('Takk! Din registrering er sendt til godkjenning.\n\nVi vil kontakte deg innen 1-2 virkedager.\n\nDu f√•r tilgang til 14 dagers gratis pr√∏veperiode mens vi behandler s√∏knaden.');
            
            currentData.verified = false;
            currentData.verificationStatus = 'pending';
            currentData.plan = 'pro'; // Default to pro for manual verification
            
            createTeacherAccount();
        }
        
        function createTeacherAccount() {
            firebase.auth().signInAnonymously()
                .then(function(result) {
                    var userId = result.user.uid;
                    
                    var teacherData = {
                        userId: userId,
                        name: currentData.name,
                        email: currentData.email,
                        school: currentData.school,
                        role: currentData.role,
                        verified: currentData.verified,
                        verificationMethod: currentData.verificationMethod,
                        verificationStatus: currentData.verificationStatus || 'approved',
                        createdAt: Date.now(),
                        subscription: {
                            plan: currentData.plan,
                            status: 'trial',
                            startDate: Date.now(),
                            trialEndDate: Date.now() + (14 * 24 * 60 * 60 * 1000), // 14 days
                            features: getFeatures(currentData.plan)
                        }
                    };
                    
                    return db.ref('teachers/' + userId).set(teacherData);
                })
                .then(function() {
                    alert('‚úÖ Konto opprettet!\n\n14 dagers gratis pr√∏veperiode startet.\n\nVelkommen til AccountingQuest!');
                    window.location.href = 'classroom_dashboard.html';
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    alert('Kunne ikke opprette konto: ' + error.message);
                });
        }
        
        function getFeatures(plan) {
            var features = {
                basic: {
                    maxClassrooms: 3,
                    maxStudents: 100,
                    multiplayer: true,
                    excel: true,
                    stats: 'basic'
                },
                pro: {
                    maxClassrooms: 999,
                    maxStudents: 999,
                    multiplayer: true,
                    excel: true,
                    stats: 'advanced',
                    email: true,
                    priority: true
                },
                school: {
                    maxClassrooms: 999,
                    maxStudents: 999,
                    maxTeachers: 999,
                    multiplayer: true,
                    excel: true,
                    stats: 'advanced',
                    email: true,
                    priority: true,
                    branding: true,
                    api: true
                }
            };
            
            return features[plan] || features.basic;
        }
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
            ThemeManager.init();
        }
    </script>
</body>
</html>
