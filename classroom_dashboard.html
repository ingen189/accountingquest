<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klasserom Dashboard - AccountingQuest</title>
    <link rel="stylesheet" href="main.css">
    <style>
        .classroom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .classroom-card {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .classroom-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .classroom-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .classroom-name {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 10px;
        }
        
        .classroom-code {
            display: inline-block;
            background: var(--accent);
            color: var(--bg-primary);
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            letter-spacing: 2px;
            margin: 15px 0;
        }
        
        .classroom-stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px 0;
            border-top: 1px solid var(--bg-tertiary);
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .stat {
            flex: 1;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }
        
        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .classroom-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-action {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-manage {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .btn-manage:hover {
            transform: scale(1.05);
        }
        
        .btn-archive {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .create-classroom-card {
            background: linear-gradient(135deg, var(--accent) 0%, var(--success) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            min-height: 300px;
        }
        
        .create-classroom-card:hover {
            transform: translateY(-5px) scale(1.02);
        }
        
        .create-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
        
        .create-text {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--bg-primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 2em;
            color: var(--accent);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-secondary);
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
        
        .empty-text {
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        
        .last-active {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="window.location.href='teacher_portal.html'">‚Üê Tilbake</div>
            <h1>üìö Mine Klasserom</h1>
        </div>

        <div class="classroom-grid" id="classroom-grid">
            <!-- Create new classroom card -->
            <div class="classroom-card create-classroom-card" onclick="openCreateModal()">
                <div class="create-icon">‚ûï</div>
                <div class="create-text">Opprett nytt klasserom</div>
            </div>
            
            <!-- Classrooms will be loaded here -->
        </div>

        <div class="empty-state" id="empty-state" style="display: none;">
            <div class="empty-icon">üìö</div>
            <div class="empty-text">Du har ingen klasserom enn√•</div>
            <p>Opprett ditt f√∏rste klasserom og begynn √• administrere elever og oppgaver!</p>
        </div>
    </div>

    <!-- Create Classroom Modal -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-title">üìö Opprett nytt klasserom</div>
            
            <div class="form-group">
                <label>Klasserom navn *</label>
                <input type="text" id="classroom-name" placeholder="F.eks. Regnskap 101" maxlength="100">
            </div>
            
            <div class="form-group">
                <label>Beskrivelse</label>
                <textarea id="classroom-description" placeholder="Beskriv klasserommet..."></textarea>
            </div>
            
            <div class="form-group">
                <label>Skole√•r</label>
                <select id="classroom-year">
                    <option value="2024/2025">2024/2025</option>
                    <option value="2025/2026" selected>2025/2026</option>
                    <option value="2026/2027">2026/2027</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button class="btn secondary" onclick="closeCreateModal()" style="flex: 1;">Avbryt</button>
                <button class="btn primary" onclick="createClassroom()" style="flex: 1;">Opprett</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Wait for Firebase to load
        (function initFirebase() {
            var attempts = 0;
            var maxAttempts = 50;
            
            function tryInit() {
                attempts++;
                
                if (typeof firebase === 'undefined') {
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 100);
                    } else {
                        console.error('‚ùå Firebase not loaded');
                        alert('Firebase kunne ikke lastes. Sjekk internettforbindelsen.');
                    }
                    return;
                }
                
                try {
                    var firebaseConfig = {
                        apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
                        authDomain: "accountingquest-multiplayer.firebaseapp.com",
                        databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                        projectId: "accountingquest-multiplayer",
                        storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                        messagingSenderId: "525417361926",
                        appId: "1:525417361926:web:ec9b737f82af9b21700987"
                    };
                    
                    if (!firebase.apps.length) {
                        firebase.initializeApp(firebaseConfig);
                        console.log('‚úÖ Firebase initialized');
                    }
                    
                    window.db = firebase.database();
                    console.log('‚úÖ Database ready');
                    
                    // Wait for DOM
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', init);
                    } else {
                        setTimeout(init, 100);
                    }
                } catch (error) {
                    console.error('üî• Firebase initialization error:', error);
                }
            }
            
            tryInit();
        })();
        
        var currentUser = null;
        var classrooms = [];
        
        function init() {
            console.log('üöÄ Initializing classroom dashboard...');
            
            // Authenticate
            firebase.auth().signInAnonymously()
                .then(function() {
                    currentUser = firebase.auth().currentUser;
                    console.log('‚úÖ Authenticated:', currentUser.uid);
                    loadClassrooms();
                })
                .catch(function(error) {
                    console.error('üî• Auth error:', error);
                });
        }
        
        function loadClassrooms() {
            console.log('üìö Loading classrooms...');
            
            // Load classrooms where teacherId matches current user
            db.ref('classrooms').orderByChild('teacherId').equalTo(currentUser.uid)
                .once('value')
                .then(function(snapshot) {
                    classrooms = [];
                    var container = document.getElementById('classroom-grid');
                    
                    // Keep create card
                    var createCard = container.querySelector('.create-classroom-card');
                    container.innerHTML = '';
                    container.appendChild(createCard);
                    
                    if (!snapshot.exists()) {
                        document.getElementById('empty-state').style.display = 'block';
                        return;
                    }
                    
                    document.getElementById('empty-state').style.display = 'none';
                    
                    snapshot.forEach(function(child) {
                        var classroom = child.val();
                        classroom.id = child.key;
                        classrooms.push(classroom);
                        
                        renderClassroom(classroom);
                    });
                    
                    console.log('‚úÖ Loaded', classrooms.length, 'classrooms');
                })
                .catch(function(error) {
                    console.error('üî• Error loading classrooms:', error);
                });
        }
        
        function renderClassroom(classroom) {
            var container = document.getElementById('classroom-grid');
            
            var studentCount = classroom.students ? Object.keys(classroom.students).length : 0;
            var lastActive = classroom.lastActive ? formatTimeAgo(classroom.lastActive) : 'Aldri';
            
            var card = document.createElement('div');
            card.className = 'classroom-card';
            card.innerHTML = 
                '<div class="classroom-icon">üìñ</div>' +
                '<div class="classroom-name">' + classroom.name + '</div>' +
                '<div class="classroom-code">üìå ' + classroom.code + '</div>' +
                '<div class="classroom-stats">' +
                    '<div class="stat">' +
                        '<div class="stat-value">' + studentCount + '</div>' +
                        '<div class="stat-label">Elever</div>' +
                    '</div>' +
                    '<div class="stat">' +
                        '<div class="stat-value">0</div>' +
                        '<div class="stat-label">Oppgaver</div>' +
                    '</div>' +
                '</div>' +
                '<div class="last-active">Sist aktiv: ' + lastActive + '</div>' +
                '<div class="classroom-actions">' +
                    '<button class="btn-action btn-manage" onclick="manageClassroom(\'' + classroom.id + '\')">Administrer</button>' +
                    '<button class="btn-action btn-archive" onclick="archiveClassroom(\'' + classroom.id + '\')">Arkiver</button>' +
                '</div>';
            
            container.appendChild(card);
        }
        
        function openCreateModal() {
            document.getElementById('create-modal').classList.add('active');
        }
        
        function closeCreateModal() {
            document.getElementById('create-modal').classList.remove('active');
            document.getElementById('classroom-name').value = '';
            document.getElementById('classroom-description').value = '';
        }
        
        function createClassroom() {
            var name = document.getElementById('classroom-name').value.trim();
            if (!name) {
                alert('Skriv inn et navn!');
                return;
            }
            
            // Generate 6-digit code
            var code = generateCode();
            
            var classroom = {
                name: name,
                description: document.getElementById('classroom-description').value,
                year: document.getElementById('classroom-year').value,
                teacherId: currentUser.uid,
                teacherName: currentUser.displayName || currentUser.email || 'L√¶rer',
                code: code,
                createdAt: Date.now(),
                archived: false
            };
            
            console.log('üìù Creating classroom:', classroom);
            
            // Save to Firebase
            db.ref('classrooms').push(classroom)
                .then(function() {
                    console.log('‚úÖ Classroom created!');
                    closeCreateModal();
                    loadClassrooms();
                    
                    alert('Klasserom opprettet!\n\nKlasseromskode: ' + code + '\n\nDel denne koden med elevene dine!');
                })
                .catch(function(error) {
                    console.error('üî• Error creating classroom:', error);
                    alert('Kunne ikke opprette klasserom: ' + error.message);
                });
        }
        
        function generateCode() {
            var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            var code = '';
            for (var i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        function manageClassroom(classroomId) {
            window.location.href = 'classroom_manage.html?id=' + classroomId;
        }
        
        function archiveClassroom(classroomId) {
            if (confirm('Er du sikker p√• at du vil arkivere dette klasserommet?')) {
                db.ref('classrooms/' + classroomId + '/archived').set(true)
                    .then(function() {
                        loadClassrooms();
                    });
            }
        }
        
        function formatTimeAgo(timestamp) {
            var now = Date.now();
            var diff = now - timestamp;
            var seconds = Math.floor(diff / 1000);
            var minutes = Math.floor(seconds / 60);
            var hours = Math.floor(minutes / 60);
            var days = Math.floor(hours / 24);
            
            if (days > 0) return days + 'd siden';
            if (hours > 0) return hours + 't siden';
            if (minutes > 0) return minutes + 'min siden';
            return 'Nylig';
        }
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
            ThemeManager.init();
        }
    </script>
</body>
</html>
