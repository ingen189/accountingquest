<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bokf√∏ringsspill - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìí</text></svg>">
    <meta name="theme-color" content="var(--bg-primary)">

        
    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ===== PAGE SPECIFIC STYLES ===== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: var(--border-color);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background: var(--bg-tertiary);
        }

        .wiki-btn {
            background: linear-gradient(135deg, var(--warning), #f59e0b);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wiki-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgb(245 158 11 / 0.4);
        }

        .module-name {
            color: var(--accent);
            font-size: 0.9em;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .nav-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .nav-stat-label {
            color: var(--text-secondary);
        }

        .nav-stat-value {
            color: var(--accent);
            font-weight: bold;
        }

        .theme-toggle {
            background: var(--border-color);
            border: none;
            color: var(--warning);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
        }

        /* Main Menu */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
            padding: 40px 20px;
        }

        .main-menu h1 {
            font-size: 3.5em;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .main-menu p {
            font-size: 1.3em;
            margin-bottom: 50px;
            color: var(--text-secondary);
            text-align: center;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            max-width: 1200px;
            width: 100%;
        }

        .menu-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 35px 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--info));
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .menu-card:hover::before {
            transform: scaleX(1);
        }

        .menu-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent);
            box-shadow: 0 10px 40px rgb(74 222 128 / 0.2);
        }

        .menu-card-icon {
            font-size: 3.5em;
            margin-bottom: 18px;
        }

        .menu-card h3 {
            font-size: 1.6em;
            margin-bottom: 12px;
            color: var(--accent);
        }

        .menu-card p {
            font-size: 1em;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .menu-card .difficulty-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 12px;
        }

        .difficulty-easy {
            background: rgb(74 222 128 / 0.2);
            color: var(--accent);
        }

        .difficulty-medium {
            background: rgb(245 158 11 / 0.2);
            color: var(--warning);
        }

        .difficulty-hard {
            background: rgb(239 68 68 / 0.2);
            color: var(--error);
        }

        .difficulty-challenge {
            background: rgb(168 85 247 / 0.2);
            color: var(--accent);
        }

        /* Game Container */
        .game-container {
            display: none;
            min-height: calc(100vh - 60px);
        }

        /* Progress Bar */
        .progress-section {
            padding: 20px 30px;
            background: var(--bg-secondary);
        }

        .progress-bar-container {
            background: var(--bg-primary);
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--info));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Main Content */
        .main-content {
            display: flex;
            height: calc(100vh - 150px);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            flex-shrink: 0;
        }

        /* Scrollbar styling for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 10px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .sidebar h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .sidebar-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .sidebar-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .sidebar-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Account List */
        .account-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Scrollbar styling for sidebar */
        .sidebar::-webkit-scrollbar {
            width: 12px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 6px;
            border: 2px solid var(--border-color);
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        .account-group {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .account-group-header {
            padding: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--text-primary);
            transition: background 0.2s;
            font-size: 0.95em;
        }

        .account-group-header:hover {
            background: var(--border-color);
        }

        .account-group-header.has-stars {
            background: rgb(74 222 128 / 0.1);
            border-left: 3px solid var(--accent);
        }

        .account-group-header .chevron {
            transition: transform 0.3s;
            font-size: 0.8em;
        }

        .account-group-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .account-group-items {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .account-group-items.collapsed {
            max-height: 0;
        }

        .account-subgroup {
            background: var(--bg-primary);
            padding: 8px 12px;
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .account-item {
            padding: 10px 12px;
            font-size: 0.9em;
            cursor: grab;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .account-item:active {
            cursor: grabbing;
        }

        .account-item:hover {
            background: var(--border-color);
            border-left-color: var(--accent);
        }

        .account-item.starred {
            background: rgb(74 222 128 / 0.05);
        }

        .account-code {
            color: var(--accent);
            font-weight: bold;
            margin-right: 8px;
        }

        .account-star {
            color: var(--warning);
            font-size: 1.1em;
        }

        /* Workspace */
        .workspace {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--bg-primary);
            height: 100%;
        }

        /* Scrollbar styling for workspace */
        .workspace::-webkit-scrollbar {
            width: 10px;
        }

        .workspace::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 5px;
        }

        .workspace::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        .workspace::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .task-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .task-title {
            font-size: 1.8em;
            color: var(--accent);
            margin-bottom: 15px;
        }

        .task-description {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            border-left: 4px solid var(--accent);
            color: var(--text-primary);
        }

        /* Balance Display */
        .balance-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .balance-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .balance-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .balance-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .balance-value.debit {
            color: var(--info);
        }

        .balance-value.credit {
            color: var(--warning);
        }

        .balance-value.balanced {
            color: var(--accent);
        }

        .balance-value.unbalanced {
            color: var(--error);
        }

        /* Spreadsheet */
        .spreadsheet-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* ExcelGrid Styles */
        .excel-grid-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            background: var(--bg-primary);
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .excel-table th {
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 12px;
            border: 1px solid var(--bg-tertiary);
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .excel-table td {
            border: 1px solid var(--bg-tertiary);
            padding: 0;
        }

        .excel-table td.row-number {
            background: var(--border-color);
            color: var(--text-secondary);
            text-align: center;
            font-weight: bold;
            padding: 12px;
            font-size: 0.9em;
        }

        .cell-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .excel-cell {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 12px;
            font-size: 0.95em;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
            transition: background 0.2s;
        }

        .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgb(74 222 128 / 0.05);
            z-index: 5;
        }

        .excel-cell:hover {
            background: rgb(255 255 255 / 0.03);
        }

        .excel-cell.readonly {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .excel-cell.account-cell {
            text-align: left;
        }

        .excel-cell.drag-over {
            background: rgb(74 222 128 / 0.2) !important;
            outline: 2px dashed var(--accent) !important;
        }

        /* Fill Handle */
        .fill-handle {
            position: absolute;
            right: 1px;
            bottom: 1px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border: 2px solid var(--bg-primary);
            border-radius: 50%;
            cursor: crosshair;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        .fill-handle:hover {
            width: 14px;
            height: 14px;
            right: -1px;
            bottom: -1px;
            background: var(--success-bright, #5ef77c);
            box-shadow: 0 3px 8px rgb(74 222 128 / 0.8);
        }

        .excel-cell.filling {
            background: rgb(74 222 128 / 0.15) !important;
        }

        .excel-cell.selecting-mode {
            cursor: crosshair;
            background: rgb(59 130 246 / 0.1);
        }

        .excel-cell.selected-for-formula {
            outline: 3px solid var(--info) !important;
            background: rgba(59, 130, 246, 0.2) !important;
            animation: cellPulse 0.5s;
        }

        @keyframes cellPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 15px rgb(59 130 246 / 0.8); }
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgb(74 222 128 / 0.4);
        }

        .btn-secondary {
            background: var(--warning);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgb(245 158 11 / 0.4);
        }

        .btn-tertiary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-tertiary:hover {
            background: var(--bg-tertiary);
        }

        .btn-danger {
            background: var(--error);
            color: var(--text-primary);
        }

        .btn-danger:hover {
            background: #ef4444;
        }

        .btn-next {
            background: var(--info);
            color: var(--text-primary);
        }

        .btn-next:hover {
            background: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Hint Box */
        .hint-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--warning);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .hint-box.visible {
            display: block;
        }

        .hint-box strong {
            color: var(--warning);
        }

        /* Calculator */
        .calculator {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
        }

        .calc-display {
            background: var(--bg-primary);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 1.5em;
            min-height: 60px;
            color: var(--text-primary);
        }

        .calc-equation {
            font-size: 0.6em;
            color: var(--text-secondary);
            min-height: 20px;
            margin-bottom: 5px;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 15px;
            background: var(--border-color);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background: var(--bg-tertiary);
        }

        .calc-btn.operator {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .calc-btn.equals {
            background: var(--info);
            color: var(--text-primary);
            grid-column: span 2;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 400px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }

            .balance-display {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .top-nav {
                padding: 10px 15px;
            }

            .nav-right {
                gap: 15px;
            }

            .nav-stat {
                font-size: 0.85em;
            }

            .workspace {
                padding: 20px 15px;
            }

            .menu-grid {
                grid-template-columns: 1fr;
            }

            .main-menu h1 {
                font-size: 2.5em;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Light Mode */
        body.light-mode {
            background: var(--bg-card);
            color: var(--bg-secondary);
        }

        body.light-mode .top-nav {
            background: #ffffff;
            border-bottom: 1px solid var(--border-color);
        }

        body.light-mode .back-btn,
        body.light-mode .theme-toggle {
            background: var(--bg-card);
            color: var(--bg-secondary);
        }

        body.light-mode .back-btn:hover,
        body.light-mode .theme-toggle:hover {
            background: var(--border-color);
        }

        body.light-mode .nav-stat-label {
            color: var(--text-secondary);
        }

        body.light-mode .nav-stat-value {
            color: var(--accent);
        }

        body.light-mode .main-menu {
            background: linear-gradient(135deg, var(--success-light, #f0fdf4) 0%, var(--info-light, #dbeafe) 100%);
        }

        body.light-mode .menu-card {
            background: #ffffff;
            border: 2px solid var(--border-color);
            color: var(--bg-secondary);
        }

        body.light-mode .menu-card:hover {
            border-color: var(--accent);
            box-shadow: 0 10px 40px rgba(5, 150, 105, 0.2);
        }

        body.light-mode .progress-section {
            background: #ffffff;
        }

        body.light-mode .progress-bar-container {
            background: var(--bg-card);
        }

        body.light-mode .sidebar {
            background: #ffffff;
            border-right: 1px solid var(--border-color);
        }

        body.light-mode .sidebar h3 {
            color: var(--accent);
            border-bottom: 2px solid var(--border-color);
        }

        body.light-mode .sidebar-tab {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        body.light-mode .sidebar-tab.active {
            background: var(--accent);
            color: var(--text-primary);
            border-color: var(--accent);
        }

        body.light-mode .account-group {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }

        body.light-mode .account-group-header {
            background: #ffffff;
            color: var(--bg-secondary);
        }

        body.light-mode .account-group-header:hover {
            background: var(--bg-card);
        }

        body.light-mode .account-group-header.has-stars {
            background: rgba(5, 150, 105, 0.1);
            border-left: 3px solid var(--accent);
        }

        body.light-mode .account-subgroup {
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        body.light-mode .account-item:hover {
            background: var(--bg-card);
            border-left-color: var(--accent);
        }

        body.light-mode .account-item.starred {
            background: rgb(5 150 105 / 0.05);
        }

        body.light-mode .account-code {
            color: var(--accent);
        }

        body.light-mode .workspace {
            background: var(--bg-card);
        }

        body.light-mode .task-header {
            background: #ffffff;
            border: 1px solid var(--border-color);
        }

        body.light-mode .task-title {
            color: var(--accent);
        }

        body.light-mode .task-description {
            background: var(--bg-card);
            border-left: 4px solid var(--accent);
            color: var(--bg-secondary);
        }

        body.light-mode .balance-item {
            background: #ffffff;
            border: 1px solid var(--border-color);
        }

        body.light-mode .balance-label {
            color: var(--text-secondary);
        }

        body.light-mode .balance-value.debit {
            color: #3b82f6;
        }

        body.light-mode .balance-value.credit {
            color: #f59e0b;
        }

        body.light-mode .balance-value.balanced {
            color: var(--accent);
        }

        body.light-mode .balance-value.unbalanced {
            color: #ef4444;
        }

        body.light-mode .spreadsheet-container {
            background: #ffffff;
            border: 1px solid var(--border-color);
        }

        body.light-mode .excel-grid-wrapper {
            background: var(--bg-card);
        }

        body.light-mode .excel-table th {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        body.light-mode .excel-table td {
            border: 1px solid var(--border-color);
        }

        body.light-mode .excel-table td.row-number {
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        body.light-mode .excel-cell {
            color: var(--bg-secondary);
        }

        body.light-mode .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgb(5 150 105 / 0.05);
        }

        body.light-mode .excel-cell.readonly {
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        body.light-mode .btn-tertiary {
            background: var(--bg-card);
            color: var(--bg-secondary);
        }

        body.light-mode .btn-tertiary:hover {
            background: var(--border-color);
        }

        body.light-mode .hint-box {
            background: #ffffff;
            border-left: 4px solid #f59e0b;
        }

        body.light-mode .calculator {
            background: #ffffff;
            border: 1px solid var(--border-color);
        }

        body.light-mode .calc-display {
            background: var(--bg-card);
            color: var(--bg-secondary);
        }

        body.light-mode .calc-equation {
            color: var(--text-secondary);
        }

        body.light-mode .calc-btn {
            background: var(--bg-card);
            color: var(--bg-secondary);
        }

        body.light-mode .calc-btn:hover {
            background: var(--border-color);
        }

        body.light-mode .calc-btn.operator {
            background: var(--accent);
            color: var(--text-primary);
        }

        body.light-mode .calc-btn.equals {
            background: #3b82f6;
            color: var(--text-primary);
        }

        /* Task Selector */
        .task-selector-section {
            padding: 15px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .task-selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            max-height: 120px;
            overflow-y: auto;
        }

        .task-selector-item {
            background: var(--border-color);
            border: 2px solid var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9em;
        }

        .task-selector-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .task-selector-item.current {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .task-selector-item.completed {
            background: rgb(74 222 128 / 0.2);
            border-color: var(--accent);
        }

        .task-selector-item.completed::after {
            content: ' ‚úì';
            color: var(--accent);
        }

        /* Tutorial Modal */
        .tutorial-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .tutorial-modal.visible {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tutorial-content {
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .tutorial-content h2 {
            color: var(--accent);
            margin-bottom: 20px;
            font-size: 2em;
        }

        .tutorial-content h3 {
            color: var(--info);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .tutorial-content p {
            line-height: 1.8;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .tutorial-content ul, .tutorial-content ol {
            margin-left: 20px;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .tutorial-content code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent);
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .tutorial-example {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--info);
            margin: 15px 0;
        }

        .tutorial-close {
            background: var(--accent);
            border: none;
            color: var(--bg-primary);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            margin-top: 30px;
            transition: all 0.3s;
        }

        .tutorial-close:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }

        /* Floating Calculator */
        .floating-calculator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        .floating-calculator.visible {
            display: block;
        }

        .calculator {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            cursor: move;
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .calculator-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1em;
        }

        .calculator-close {
            background: var(--error);
            border: none;
            color: var(--text-primary);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            transition: all 0.2s;
        }

        .calculator-close:hover {
            background: #ef4444;
        }

        .calc-display {
            background: var(--bg-primary);
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            text-align: right;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 1.5em;
            min-height: 60px;
            color: var(--text-primary);
        }

        .calc-equation {
            font-size: 0.6em;
            color: var(--text-secondary);
            min-height: 20px;
            margin-bottom: 5px;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 15px;
            background: var(--border-color);
            border: none;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-btn:hover {
            background: var(--bg-tertiary);
        }

        .calc-btn.operator {
            background: var(--accent);
            color: var(--bg-primary);
            font-weight: bold;
        }

        .calc-btn.equals {
            background: var(--info);
            color: var(--text-primary);
            grid-column: span 2;
            font-weight: bold;
        }
    
    </style>

</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-left">
            <button class="back-btn" id="back-btn" onclick="handleBack()">üè† Forsiden</button>
            <button class="wiki-btn" onclick="window.location.href='wiki.html'">üìö Wiki</button>
            <button class="wiki-btn" onclick="showTutorial('bokforing')">üí° Bokf√∏ring</button>
            <button class="wiki-btn" onclick="showTutorial('excel')">üìä Excel</button>
            <span class="module-name">Modul: <strong>Bokf√∏ringsspill</strong></span>
        </div>
        <div class="nav-right">
            <div class="nav-stat">
                <span class="nav-stat-label">Oppgaver:</span>
                <span class="nav-stat-value" id="nav-tasks">0/0</span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-label">Fullf√∏rt:</span>
                <span class="nav-stat-value" id="nav-completed">0</span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-label">Poeng:</span>
                <span class="nav-stat-value" id="nav-score">0</span>
            </div>
            <button class="theme-toggle">üåô</button>
        </div>
    </div>

    <!-- Main Menu -->
    <div class="main-menu" id="main-menu">
        <h1>üìö Bokf√∏ringsspill</h1>
        <p>L√¶r bokf√∏ring gjennom praksis med Excel-lignende grids</p>
        
        <div class="menu-grid">
            <div class="menu-card" onclick="startGame('tutorial')">
                <div class="menu-card-icon">üéì</div>
                <h3>Tutorial</h3>
                <p>L√¶r grunnleggende bokf√∏ring trinn for trinn</p>
                <span class="difficulty-badge difficulty-easy">Ubegrenset liv</span>
            </div>
            
            <div class="menu-card" onclick="startGame('easy')">
                <div class="menu-card-icon">üå±</div>
                <h3>Lett</h3>
                <p>Enkle bokf√∏ringsoppgaver med hint tilgjengelig</p>
                <span class="difficulty-badge difficulty-easy">3 liv ‚Ä¢ 12 oppgaver</span>
            </div>
            
            <div class="menu-card" onclick="startGame('medium')">
                <div class="menu-card-icon">üí™</div>
                <h3>Middels</h3>
                <p>Moderate oppgaver med mer kompleksitet</p>
                <span class="difficulty-badge difficulty-medium">3 liv ‚Ä¢ 15 oppgaver</span>
            </div>
            
            <div class="menu-card" onclick="startGame('hard')">
                <div class="menu-card-icon">üî•</div>
                <h3>Vanskelig</h3>
                <p>Avanserte bokf√∏ringsscenarier</p>
                <span class="difficulty-badge difficulty-hard">3 liv ‚Ä¢ 19 oppgaver</span>
            </div>
            
            <div class="menu-card" onclick="startGame('challenge')">
                <div class="menu-card-icon">‚ö°</div>
                <h3>Utfordring</h3>
                <p>Ekspert-niv√• med tidsbegrensning</p>
                <span class="difficulty-badge difficulty-challenge">3 liv ‚Ä¢ Tidsbegrenset</span>
            </div>
        </div>
        
        <!-- Tilbake til forsiden -->
        <div style="margin-top: 30px; text-align: center;">
            <button class="back-btn" onclick="window.location.href='index.html'" style="padding: 14px 28px; font-size: 1.1em; background: var(--bg-tertiary); border: 1px solid var(--border-color);">
                üè† Tilbake til forsiden
            </button>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="game-container">
        <!-- Progress Bar -->
        <div class="progress-section">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
        </div>

        <!-- Task Selector -->
        <div class="task-selector-section">
            <div class="task-selector-grid" id="task-selector-grid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('accounts')">üìã Kontoer</button>
                </div>

                <!-- Accounts Tab -->
                <div id="tab-accounts" class="tab-content active">
                    <h3>üìä Kontoplan</h3>
                    <div class="account-list" id="account-list"></div>
                </div>
            </div>

            <!-- Workspace -->
            <div class="workspace">
                <!-- Task Header -->
                <div class="task-header">
                    <div class="task-title" id="task-title">Oppgave 1</div>
                    <div class="task-description" id="task-description">Velg en vanskelighetsgrad for √• starte</div>
                </div>

                <!-- Balance Display -->
                <div class="balance-display">
                    <div class="balance-item">
                        <div class="balance-label">Total Debet</div>
                        <div class="balance-value debit" id="total-debit">0</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">Total Kredit</div>
                        <div class="balance-value credit" id="total-credit">0</div>
                    </div>
                    <div class="balance-item">
                        <div class="balance-label">Balanse</div>
                        <div class="balance-value" id="balance-status">0</div>
                    </div>
                </div>

                <!-- Spreadsheet -->
                <div class="spreadsheet-container">
                    <div id="excel-grid"></div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn-primary" onclick="checkAnswer()">‚úì Sjekk svar</button>
                    <button class="btn btn-secondary" onclick="showHint()">üí° Hint</button>
                    <button class="btn btn-tertiary" onclick="addRow()">+ Legg til rad</button>
                    <button class="btn btn-tertiary" onclick="toggleCalculator()">üî¢ Kalkulator</button>
                    <button class="btn btn-danger" onclick="clearGrid()">üóëÔ∏è T√∏m</button>
                    <button class="btn btn-next" onclick="nextTask()">Neste ‚Üí</button>
                </div>

                <!-- Hint Box -->
                <div class="hint-box" id="hint-box"></div>
            </div>
        </div>
    </div>


    <!-- Tutorial Modal -->
    <div class="tutorial-modal" id="tutorial-modal">
        <div class="tutorial-content" id="tutorial-content">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Floating Calculator -->
    <div class="floating-calculator" id="floating-calculator">
        <div class="calculator" id="calculator-drag">
            <div class="calculator-header">
                <span class="calculator-title">üî¢ Kalkulator</span>
                <button class="calculator-close" onclick="toggleCalculator()">√ó</button>
            </div>
            <div class="calc-display">
                <div class="calc-equation" id="calc-equation"></div>
                <div id="calc-display">0</div>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn equals" onclick="calcEquals()">=</button>
                <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcClear()" style="grid-column: span 2; background: var(--error); color: var(--text-primary);">C</button>
                <button class="calc-btn" onclick="calcBackspace()" style="grid-column: span 2;">‚Üê</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal (first time) -->
    <div class="tutorial-modal" id="welcome-modal">
        <div class="tutorial-content">
            <h2>üëã Velkommen til Bokf√∏ringsspillet!</h2>
            
            <h3>üéÆ Slik fungerer det:</h3>
            <ul>
                <li>üìù Les oppgaven n√∏ye</li>
                <li>üî¢ Fyll inn riktige kontoer, debet og kredit</li>
                <li>‚öñÔ∏è Sjekk at debet = kredit (balansen skal v√¶re 0)</li>
                <li>‚úì Klikk "Sjekk svar" n√•r du er ferdig</li>
            </ul>
            
            <h3>üí° Trenger du hjelp?</h3>
            <p>I toppen av siden finner du:</p>
            <ul>
                <li><strong>üìö Wiki</strong> - Fullstendig oversikt over lover og regler</li>
                <li><strong>üí° Bokf√∏ring</strong> - Grunnleggende bokf√∏ringsprinsipper</li>
                <li><strong>üìä Excel</strong> - Slik bruker du regneark-funksjonene</li>
            </ul>
            
            <div style="background: rgb(59 130 246 / 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--info); margin: 20px 0;">
                <p><strong>üí° Tips:</strong> Dra kontoer fra venstre-panel direkte inn i gridet!</p>
            </div>
            
            <button class="tutorial-close" onclick="closeWelcome()">Start spillet! üöÄ</button>
            <label style="display: flex; align-items: center; justify-content: center; margin-top: 15px; cursor: pointer; color: var(--text-secondary);">
                <input type="checkbox" id="dont-show-again" style="margin-right: 8px;">
                <span>Ikke vis denne meldingen igjen</span>
            </label>
        </div>
    </div>

    <!-- Scripts -->
    <script>
/**
 * ExcelGrid - Reusable Excel-like spreadsheet component
 * Can be used across all AccountingQuest modules
 * 
 * Usage:
 * const grid = new ExcelGrid(containerId, options);
 * grid.loadData(rows);
 * grid.onCellChange((row, col, value) => { ... });
 */

class ExcelGrid {
    constructor(containerId, options = {}) {
        this.container = document.getElementById(containerId);
        this.options = {
            headers: options.headers || [],
            allowFormulas: options.allowFormulas !== false,
            allowCellSelection: options.allowCellSelection !== false,
            allowFillHandle: options.allowFillHandle !== false,
            showRowNumbers: options.showRowNumbers !== false,
            readonlyColumns: options.readonlyColumns || [],
            ...options
        };
        
        this.data = [];
        this.cells = new Map(); // Map of "row-col" -> cell element
        this.state = {
            selectingCell: false,
            selectingForCell: null,
            fillHandleActive: false,
            fillStartCell: null,
            fillHandleStarted: false
        };
        
        this.callbacks = {
            onChange: null,
            onValidate: null
        };
        
        this.recalcTimer = null;
        
        this.init();
    }
    
    init() {
        this.container.innerHTML = `
            <div class="excel-grid-wrapper">
                <table class="excel-table">
                    <thead id="${this.container.id}-thead"></thead>
                    <tbody id="${this.container.id}-tbody"></tbody>
                </table>
            </div>
        `;
        
        this.thead = document.getElementById(`${this.container.id}-thead`);
        this.tbody = document.getElementById(`${this.container.id}-tbody`);
        
        this.renderHeaders();
    }
    
    renderHeaders() {
        let headersHTML = '<tr>';
        
        if (this.options.showRowNumbers) {
            headersHTML += '<th class="row-number-header">#</th>';
        }
        
        this.options.headers.forEach(header => {
            headersHTML += `<th>${header}</th>`;
        });
        
        headersHTML += '</tr>';
        this.thead.innerHTML = headersHTML;
    }
    
    loadData(rows) {
        this.data = rows;
        this.tbody.innerHTML = '';
        this.cells.clear();
        
        rows.forEach((row, rowIndex) => {
            this.addRow(row, rowIndex);
        });
    }
    
    addRow(rowData, rowIndex) {
        const tr = document.createElement('tr');
        let cellHTML = '';
        
        // Row number
        if (this.options.showRowNumbers) {
            cellHTML += `<td class="row-number">${rowIndex + 1}</td>`;
        }
        
        // Data cells
        rowData.forEach((cellData, colIndex) => {
            const isReadonly = this.isColumnReadonly(colIndex) || cellData.readonly;
            const value = cellData.value !== undefined ? cellData.value : cellData;
            const cellId = `${rowIndex}-${colIndex}`;
            
            cellHTML += `
                <td>
                    <div class="cell-wrapper">
                        <input type="text"
                               class="excel-cell ${isReadonly ? 'readonly' : ''}"
                               value="${value}"
                               data-row="${rowIndex}"
                               data-col="${colIndex}"
                               data-cell-id="${cellId}"
                               ${isReadonly ? 'readonly' : ''}
                               placeholder="${isReadonly ? '' : '?'}">
                        ${!isReadonly ? '<div class="fill-handle"></div>' : ''}
                    </div>
                </td>
            `;
        });
        
        tr.innerHTML = cellHTML;
        this.tbody.appendChild(tr);
        
        // Attach event listeners to all cells in this row
        const allCells = tr.querySelectorAll('.excel-cell');
        allCells.forEach(cell => {
            const cellId = cell.dataset.cellId;
            this.cells.set(cellId, cell);
            
            // Attach full listeners to non-readonly cells
            if (!cell.classList.contains('readonly')) {
                this.attachCellListeners(cell);
            }
        });
    }
    
    attachCellListeners(cell) {
        // Keydown for navigation
        cell.addEventListener('keydown', (e) => this.handleKeydown(cell, e));
        
        // Focus - show formula
        cell.addEventListener('focus', () => {
            if (cell.dataset.formula) {
                cell.value = cell.dataset.formula;
            }
        });
        
        // Blur - evaluate formula
        cell.addEventListener('blur', () => {
            if (cell.value.trim().startsWith('=')) {
                this.evaluateFormula(cell);
            }
        });
        
        // Input - recalculate all formulas when a value changes
        cell.addEventListener('input', () => {
            // Trigger onChange callback
            if (this.callbacks.onChange) {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const value = cell.value;
                this.callbacks.onChange(row, col, value);
            }
            
            // Debounce to avoid too many recalculations
            if (this.recalcTimer) clearTimeout(this.recalcTimer);
            this.recalcTimer = setTimeout(() => {
                this.recalculateAll();
            }, 100);
        });
        
        // Click for cell selection in formulas
        cell.addEventListener('click', () => {
            if (this.state.selectingCell && cell !== this.state.selectingForCell) {
                this.selectCellForFormula(cell);
            }
        });
        
        // Fill handle (drag to copy)
        if (this.options.allowFillHandle) {
            // Add listener to the fill-handle div if it exists
            const fillHandle = cell.parentElement.querySelector('.fill-handle');
            if (fillHandle) {
                fillHandle.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.startFillHandle(cell);
                });
                fillHandle.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.startFillHandle(cell);
                }, { passive: false });
            }
        }
    }
    
    handleKeydown(cell, event) {
        const key = event.key;
        
        // Escape - end selection mode
        if (key === 'Escape' && this.state.selectingCell) {
            event.preventDefault();
            this.endCellSelection();
            return;
        }
        
        // Enter in selection mode
        if (key === 'Enter' && this.state.selectingCell) {
            event.preventDefault();
            if (cell === this.state.selectingForCell) {
                this.endCellSelection();
            } else {
                this.selectCellForFormula(cell);
            }
            return;
        }
        
        // Navigation keys
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter'].includes(key)) {
            event.preventDefault();
            
            // Evaluate on Enter
            if (key === 'Enter' && cell.value.trim().startsWith('=')) {
                this.evaluateFormula(cell);
            }
            
            this.navigate(cell, key, event.shiftKey);
            return;
        }
        
        // Start cell selection when typing =
        if (key === '=' && cell.value === '' && this.options.allowCellSelection) {
            setTimeout(() => this.startCellSelection(cell), 10);
        }
    }
    
    navigate(cell, key, shiftKey) {
        // cell.parentElement = .cell-wrapper
        // cell.parentElement.parentElement = <td>
        // cell.parentElement.parentElement.parentElement = <tr>
        const td = cell.parentElement.parentElement;
        const row = td.parentElement;
        const cellIndex = Array.from(row.children).indexOf(td);
        const rowIndex = Array.from(this.tbody.children).indexOf(row);
        
        let targetCell = null;
        
        switch(key) {
            case 'ArrowRight':
                targetCell = td.nextElementSibling?.querySelector('.excel-cell');
                break;
            case 'ArrowLeft':
                targetCell = td.previousElementSibling?.querySelector('.excel-cell');
                break;
            case 'ArrowDown':
            case 'Enter':
                const nextRow = row.nextElementSibling;
                if (nextRow) targetCell = nextRow.children[cellIndex]?.querySelector('.excel-cell');
                break;
            case 'ArrowUp':
                const prevRow = row.previousElementSibling;
                if (prevRow) targetCell = prevRow.children[cellIndex]?.querySelector('.excel-cell');
                break;
            case 'Tab':
                targetCell = shiftKey ?
                    td.previousElementSibling?.querySelector('.excel-cell') :
                    td.nextElementSibling?.querySelector('.excel-cell');
                break;
        }
        
        if (targetCell) targetCell.focus();
    }
    
    // Formula evaluation
    evaluateFormula(cell) {
        const value = cell.value.trim();
        if (!value.startsWith('=')) return;
        
        const formula = value.substring(1);
        
        // Check for incomplete formulas
        if (/[\+\-\*\/\(]$/.test(formula.trim())) {
            cell.title = 'Ufullstendig formel';
            return;
        }
        
        try {
            const result = this.calculateFormula(formula);
            
            if (isNaN(result) || !isFinite(result)) {
                cell.dataset.result = '0';
                cell.title = 'Ugyldig formel';
            } else {
                cell.dataset.result = result.toString();
                cell.dataset.formula = value;
                cell.value = result.toFixed(2);
                cell.title = `Formel: ${value}\nResultat: ${result.toFixed(2)}`;
                
                // Trigger onChange callback
                if (this.callbacks.onChange) {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    this.callbacks.onChange(row, col, result);
                }
                
                // Recalculate other formulas that might depend on this one
                setTimeout(() => this.recalculateAll(), 10);
            }
        } catch (e) {
            console.error('Formula error:', e);
            cell.dataset.result = '0';
            cell.title = 'Feil i formel';
        }
    }
    
    // Recalculate all formulas (when dependencies change)
    recalculateAll() {
        this.cells.forEach((cell, cellId) => {
            if (cell.dataset.formula) {
                // Re-evaluate this formula
                const formula = cell.dataset.formula.substring(1);
                try {
                    const result = this.calculateFormula(formula);
                    if (!isNaN(result) && isFinite(result)) {
                        cell.dataset.result = result.toString();
                        // Only update display if cell is not focused (not being edited)
                        if (document.activeElement !== cell) {
                            cell.value = result.toFixed(2);
                            cell.title = `Formel: ${cell.dataset.formula}\nResultat: ${result.toFixed(2)}`;
                        }
                    }
                } catch (e) {
                    console.error('Recalc error for', cellId, e);
                }
            }
        });
    }
    
    calculateFormula(formula) {
        // First, handle range functions like SUM(A1:C1), AVERAGE(A1:C1), etc.
        formula = this.expandRangeFunctions(formula);
        
        // Replace cell references (A1, B2, etc.) with values
        let processedFormula = formula.replace(/([A-Z]+)(\$?)(\d+)/gi, (match, col, lock, row) => {
            const value = this.getCellValue(col, parseInt(row) - 1);
            return `(${value})`;
        });
        
        // Replace functions
        processedFormula = processedFormula.replace(/ABS\(([^)]+)\)/gi, (match, expr) => {
            return `Math.abs(${expr})`;
        });
        
        processedFormula = processedFormula.replace(/√ó/g, '*').replace(/√∑/g, '/');
        
        return eval(processedFormula);
    }
    
    expandRangeFunctions(formula) {
        // Handle SUM(A1:C1) -> SUM(A1,B1,C1)
        formula = formula.replace(/SUM\(([A-Z]+\$?\d+):([A-Z]+\$?\d+)\)/gi, (match, start, end) => {
            const cells = this.expandRange(start, end);
            return `(${cells.join('+')})`;
        });
        
        // Handle AVERAGE(A1:C1) -> (A1+B1+C1)/3
        formula = formula.replace(/AVERAGE\(([A-Z]+\$?\d+):([A-Z]+\$?\d+)\)/gi, (match, start, end) => {
            const cells = this.expandRange(start, end);
            return `((${cells.join('+')}))/${cells.length})`;
        });
        
        // Handle MIN(A1:C1) -> Math.min(A1,B1,C1)
        formula = formula.replace(/MIN\(([A-Z]+\$?\d+):([A-Z]+\$?\d+)\)/gi, (match, start, end) => {
            const cells = this.expandRange(start, end);
            return `Math.min(${cells.join(',')})`;
        });
        
        // Handle MAX(A1:C1) -> Math.max(A1,B1,C1)
        formula = formula.replace(/MAX\(([A-Z]+\$?\d+):([A-Z]+\$?\d+)\)/gi, (match, start, end) => {
            const cells = this.expandRange(start, end);
            return `Math.max(${cells.join(',')})`;
        });
        
        return formula;
    }
    
    expandRange(startRef, endRef) {
        // Parse start and end references (e.g., A1, C3)
        const startMatch = startRef.match(/([A-Z]+)(\$?)(\d+)/i);
        const endMatch = endRef.match(/([A-Z]+)(\$?)(\d+)/i);
        
        if (!startMatch || !endMatch) return [];
        
        const startCol = startMatch[1].toUpperCase();
        const startRow = parseInt(startMatch[3]);
        const endCol = endMatch[1].toUpperCase();
        const endRow = parseInt(endMatch[3]);
        
        const startColCode = startCol.charCodeAt(0);
        const endColCode = endCol.charCodeAt(0);
        
        const cells = [];
        
        // Handle horizontal range (same row, different columns)
        if (startRow === endRow) {
            for (let col = startColCode; col <= endColCode; col++) {
                cells.push(String.fromCharCode(col) + startRow);
            }
        }
        // Handle vertical range (same column, different rows)
        else if (startCol === endCol) {
            for (let row = startRow; row <= endRow; row++) {
                cells.push(startCol + row);
            }
        }
        // Handle rectangular range (multiple rows and columns)
        else {
            for (let row = startRow; row <= endRow; row++) {
                for (let col = startColCode; col <= endColCode; col++) {
                    cells.push(String.fromCharCode(col) + row);
                }
            }
        }
        
        return cells;
    }
    
    getCellValue(colLetter, rowIndex) {
        const colIndex = colLetter.toUpperCase().charCodeAt(0) - 65; // A=0, B=1, etc
        const cellId = `${rowIndex}-${colIndex}`;
        const cell = this.cells.get(cellId);
        
        if (!cell) return 0;
        
        // If cell has evaluated result, use that
        if (cell.dataset.result !== undefined) {
            return parseFloat(cell.dataset.result);
        }
        
        // If cell contains formula, evaluate it recursively
        const value = cell.value.trim();
        if (value.startsWith('=')) {
            const formula = value.substring(1);
            return this.calculateFormula(formula);
        }
        
        // Parse as number
        return parseFloat(value.replace(/\s/g, '').replace(/,/g, '')) || 0;
    }
    
    // Cell selection for formulas
    startCellSelection(sourceCell) {
        this.state.selectingCell = true;
        this.state.selectingForCell = sourceCell;
        
        this.cells.forEach(cell => {
            if (cell !== sourceCell) {
                cell.classList.add('selecting-mode');
            }
        });
        
        this.showSelectionHint();
    }
    
    endCellSelection() {
        this.state.selectingCell = false;
        this.state.selectingForCell = null;
        
        this.cells.forEach(cell => {
            cell.classList.remove('selecting-mode', 'selected-for-formula');
        });
        
        this.hideSelectionHint();
    }
    
    selectCellForFormula(targetCell) {
        if (!this.state.selectingCell || !this.state.selectingForCell) return;
        
        const sourceCell = this.state.selectingForCell;
        const cellRef = this.getCellReference(targetCell);
        
        if (cellRef) {
            const cursorPos = sourceCell.selectionStart || sourceCell.value.length;
            const currentValue = sourceCell.value;
            sourceCell.value = currentValue.slice(0, cursorPos) + cellRef + currentValue.slice(cursorPos);
            
            targetCell.classList.add('selected-for-formula');
            setTimeout(() => targetCell.classList.remove('selected-for-formula'), 500);
        }
        
        setTimeout(() => {
            sourceCell.focus();
            sourceCell.setSelectionRange(sourceCell.value.length, sourceCell.value.length);
        }, 10);
    }
    
    getCellReference(cell) {
        const row = parseInt(cell.dataset.row) + 1; // 1-indexed for display
        const col = parseInt(cell.dataset.col);
        const colLetter = String.fromCharCode(65 + col); // 0=A, 1=B, etc
        return colLetter + row;
    }
    
    showSelectionHint() {
        const hint = document.createElement('div');
        hint.id = 'cell-selection-hint';
        hint.className = 'cell-selection-hint';
        hint.innerHTML = 'üéØ Klikk p√• celler for √• legge dem til formelen<br><small>Skriv +, -, *, / mellom ‚Ä¢ ESC for √• avslutte</small>';
        document.body.appendChild(hint);
    }
    
    hideSelectionHint() {
        const hint = document.getElementById('cell-selection-hint');
        if (hint) hint.remove();
    }
    
    // Fill handle (drag to copy formulas)
    handleFillStart(cell, e) {
        const rect = cell.getBoundingClientRect();
        const isBottomRight = (
            e.clientX > rect.right - 20 &&
            e.clientY > rect.bottom - 20
        );
        
        if (isBottomRight) {
            e.preventDefault();
            e.stopPropagation();
            this.startFillHandle(cell);
        }
    }
    
    handleFillStartTouch(cell, e) {
        const touch = e.touches[0];
        const rect = cell.getBoundingClientRect();
        const isBottomRight = (
            touch.clientX > rect.right - 25 &&
            touch.clientY > rect.bottom - 25
        );
        
        if (isBottomRight) {
            e.preventDefault();
            e.stopPropagation();
            this.startFillHandle(cell);
        }
    }
    
    startFillHandle(cell) {
        this.state.fillStartCell = cell;
        this.state.fillHandleStarted = false;
        
        document.addEventListener('mousemove', this.handleFillDrag.bind(this));
        document.addEventListener('mouseup', this.endFillHandle.bind(this));
        document.addEventListener('touchmove', this.handleFillDragTouch.bind(this), { passive: false });
        document.addEventListener('touchend', this.endFillHandle.bind(this));
    }
    
    handleFillDrag(e) {
        if (!this.state.fillStartCell) return;
        
        if (!this.state.fillHandleStarted) {
            this.state.fillHandleStarted = true;
            this.state.fillHandleActive = true;
            this.state.fillStartCell.classList.add('filling');
        }
        
        const target = document.elementFromPoint(e.clientX, e.clientY);
        if (target && target.classList.contains('excel-cell')) {
            this.highlightFillRange(target);
        }
    }
    
    handleFillDragTouch(e) {
        if (!this.state.fillStartCell) return;
        e.preventDefault();
        
        if (!this.state.fillHandleStarted) {
            this.state.fillHandleStarted = true;
            this.state.fillHandleActive = true;
            this.state.fillStartCell.classList.add('filling');
        }
        
        const touch = e.touches[0];
        const target = document.elementFromPoint(touch.clientX, touch.clientY);
        if (target && target.classList.contains('excel-cell')) {
            this.highlightFillRange(target);
        }
    }
    
    highlightFillRange(target) {
        const startCell = this.state.fillStartCell;
        const startRow = parseInt(startCell.dataset.row);
        const startCol = parseInt(startCell.dataset.col);
        const targetRow = parseInt(target.dataset.row);
        const targetCol = parseInt(target.dataset.col);
        
        // Clear previous highlighting
        this.cells.forEach(cell => {
            if (cell !== startCell) cell.classList.remove('filling');
        });
        
        // Highlight range - allow both vertical and horizontal
        if (targetRow === startRow && targetCol > startCol) {
            // Horizontal (right)
            for (let i = startCol + 1; i <= targetCol; i++) {
                const cellId = `${startRow}-${i}`;
                const cell = this.cells.get(cellId);
                if (cell && !cell.classList.contains('readonly')) {
                    cell.classList.add('filling');
                }
            }
        } else if (targetCol === startCol && targetRow > startRow) {
            // Vertical (down)
            for (let i = startRow + 1; i <= targetRow; i++) {
                const cellId = `${i}-${startCol}`;
                const cell = this.cells.get(cellId);
                if (cell && !cell.classList.contains('readonly')) {
                    cell.classList.add('filling');
                }
            }
        }
    }
    
    endFillHandle(e) {
        if (!this.state.fillStartCell) return;
        
        if (this.state.fillHandleStarted) {
            let clientX, clientY;
            
            if (e.type === 'touchend' && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else if (e.type === 'mouseup') {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            if (clientX !== undefined) {
                const target = document.elementFromPoint(clientX, clientY);
                if (target && target.classList.contains('excel-cell')) {
                    this.copyFormula(this.state.fillStartCell, target);
                }
            }
        }
        
        this.cleanupFillHandle();
    }
    
    copyFormula(startCell, endCell) {
        const startRow = parseInt(startCell.dataset.row);
        const startCol = parseInt(startCell.dataset.col);
        const endRow = parseInt(endCell.dataset.row);
        const endCol = parseInt(endCell.dataset.col);
        
        const sourceValue = startCell.value.trim();
        const sourceFormula = startCell.dataset.formula || sourceValue;
        
        // Determine direction
        if (endRow > startRow && endCol === startCol) {
            // Vertical (down)
            this.copyFormulaVertical(startCell, startRow, endRow, startCol, sourceFormula, sourceValue);
        } else if (endCol > startCol && endRow === startRow) {
            // Horizontal (right)
            this.copyFormulaHorizontal(startCell, startRow, startCol, endCol, sourceFormula, sourceValue);
        }
    }
    
    copyFormulaVertical(startCell, startRow, endRow, col, sourceFormula, sourceValue) {
        if (sourceFormula.startsWith('=')) {
            const formula = sourceFormula.substring(1);
            
            for (let i = startRow + 1; i <= endRow; i++) {
                const cellId = `${i}-${col}`;
                const cell = this.cells.get(cellId);
                
                if (cell && !cell.classList.contains('readonly')) {
                    const rowOffset = i - startRow;
                    const adjustedFormula = this.adjustFormulaForRow(formula, rowOffset);
                    
                    cell.value = '=' + adjustedFormula;
                    cell.dataset.formula = '=' + adjustedFormula;
                    this.evaluateFormula(cell);
                }
            }
        } else {
            // Copy plain value
            for (let i = startRow + 1; i <= endRow; i++) {
                const cellId = `${i}-${col}`;
                const cell = this.cells.get(cellId);
                
                if (cell && !cell.classList.contains('readonly')) {
                    cell.value = sourceValue;
                }
            }
        }
    }
    
    copyFormulaHorizontal(startCell, row, startCol, endCol, sourceFormula, sourceValue) {
        if (sourceFormula.startsWith('=')) {
            const formula = sourceFormula.substring(1);
            
            for (let i = startCol + 1; i <= endCol; i++) {
                const cellId = `${row}-${i}`;
                const cell = this.cells.get(cellId);
                
                if (cell && !cell.classList.contains('readonly')) {
                    const colOffset = i - startCol;
                    const adjustedFormula = this.adjustFormulaForColumn(formula, colOffset);
                    
                    cell.value = '=' + adjustedFormula;
                    cell.dataset.formula = '=' + adjustedFormula;
                    this.evaluateFormula(cell);
                }
            }
        } else {
            // Copy plain value
            for (let i = startCol + 1; i <= endCol; i++) {
                const cellId = `${row}-${i}`;
                const cell = this.cells.get(cellId);
                
                if (cell && !cell.classList.contains('readonly')) {
                    cell.value = sourceValue;
                }
            }
        }
    }
    
    adjustFormula(formula, rowOffset) {
        // Legacy - keep for backwards compatibility
        return this.adjustFormulaForRow(formula, rowOffset);
    }
    
    adjustFormulaForRow(formula, rowOffset) {
        // Adjust row numbers (vertical copy)
        // B$1 keeps row locked, $B1 keeps column locked
        return formula.replace(/(\$?)([A-Z]+)(\$?)(\d+)/gi, (match, colLock, col, rowLock, row) => {
            const newCol = colLock ? colLock + col : col;
            const newRow = rowLock ? row : (parseInt(row) + rowOffset).toString();
            return newCol + (rowLock ? '$' : '') + newRow;
        });
    }
    
    adjustFormulaForColumn(formula, colOffset) {
        // Adjust column letters (horizontal copy)
        // B$1 keeps row locked, $B1 keeps column locked
        return formula.replace(/(\$?)([A-Z]+)(\$?)(\d+)/gi, (match, colLock, col, rowLock, row) => {
            let newCol;
            if (colLock) {
                // Column is locked with $
                newCol = colLock + col;
            } else {
                // Adjust column letter
                const colCode = col.charCodeAt(0);
                newCol = String.fromCharCode(colCode + colOffset);
            }
            const newRow = rowLock ? '$' + row : row;
            return newCol + newRow;
        });
    }
    
    cleanupFillHandle() {
        this.cells.forEach(cell => cell.classList.remove('filling'));
        
        document.removeEventListener('mousemove', this.handleFillDrag);
        document.removeEventListener('mouseup', this.endFillHandle);
        document.removeEventListener('touchmove', this.handleFillDragTouch);
        document.removeEventListener('touchend', this.endFillHandle);
        
        this.state.fillHandleActive = false;
        this.state.fillStartCell = null;
        this.state.fillHandleStarted = false;
    }
    
    // Helper methods
    isColumnReadonly(colIndex) {
        return this.options.readonlyColumns.includes(colIndex);
    }
    
    // Public API
    onCellChange(callback) {
        this.callbacks.onChange = callback;
    }
    
    onValidate(callback) {
        this.callbacks.onValidate = callback;
    }
    
    getValue(row, col) {
        const cellId = `${row}-${col}`;
        const cell = this.cells.get(cellId);
        return cell ? this.getCellValue(String.fromCharCode(65 + col), row) : null;
    }
    
    setValue(row, col, value) {
        const cellId = `${row}-${col}`;
        const cell = this.cells.get(cellId);
        if (cell) {
            cell.value = value;
            if (value.toString().startsWith('=')) {
                this.evaluateFormula(cell);
            }
        }
    }
    
    getAllValues() {
        const values = [];
        this.data.forEach((row, rowIndex) => {
            const rowValues = [];
            row.forEach((cell, colIndex) => {
                const cellId = `${rowIndex}-${colIndex}`;
                const cellElement = this.cells.get(cellId);
                // Get raw value from cell, not parsed number
                rowValues.push(cellElement ? cellElement.value : '');
            });
            values.push(rowValues);
        });
        return values;
    }
    
    clear() {
        this.cells.forEach(cell => {
            if (!cell.classList.contains('readonly')) {
                cell.value = '';
                delete cell.dataset.formula;
                delete cell.dataset.result;
                cell.title = '';
            }
        });
    }
}

// Export for use in modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = ExcelGrid;
}
    </script>
    <script>
// Bokf√∏ringsspill - Game Logic

// Norwegian Chart of Accounts (simplified)
const accountGroups = {
    "EIENDELER": {
        "Anleggsmidler": ["1200", "1220", "1300", "1500", "1600", "1800", "1810", "1820"],
        "Oml√∏psmidler": ["1400", "1500", "1510", "1520", "1600", "1700", "1760", "1900", "1920"]
    },
    "GJELD OG EGENKAPITAL": {
        "Egenkapital": ["2000", "2050", "2100"],
        "Langsiktig gjeld": ["2200", "2220", "2230", "2310", "2320", "2350"],
        "Kortsiktig gjeld": ["2400", "2500", "2510", "2520", "2540", "2600", "2700", "2710", "2740", "2770", "2780", "2900", "2920", "2930", "2940", "2950"]
    },
    "INNTEKTER": {
        "Driftsinntekter": ["3000", "3100", "3200", "3400", "3700", "3900"],
        "Finansinntekter": ["8050", "8070", "8080", "8100"]
    },
    "KOSTNADER": {
        "Varekostnad": ["4000", "4100", "4300"],
        "L√∏nnskostnader": ["5000", "5090", "5180", "5400", "5410", "5430", "5900"],
        "Avskrivninger": ["6000", "6020", "6040", "6050"],
        "Andre driftskostnader": ["6100", "6300", "6340", "6700", "6800", "6900", "7000", "7100", "7140", "7300", "7320", "7400", "7500", "7700", "7770", "7800", "7830", "7850"],
        "Finanskostnader": ["8150", "8170", "8200"],
        "Skatt": ["8300", "8309", "8320"]
    }
};

const accountNames = {
    // BALANSEN - Klasse 1: Eiendeler
    // Anleggsmidler
    "1000": "Forskning og utvikling",
    "1070": "Utsatt skattefordel",
    "1100": "Bygninger",
    "1150": "Tomter",
    "1200": "Maskiner",
    "1230": "Biler",
    "1250": "Inventar og kontormaskiner",
    "1300": "Investeringer i datterselskaper",
    
    // Oml√∏psmidler
    "1400": "R√•varer/materialer",
    "1420": "Varer i arbeid",
    "1440": "Ferdigvarer",
    "1460": "Innkj√∏pte varer for videresalg",
    "1500": "Kundefordringer",
    "1510": "Utlegg mv.",
    "1530": "Opptjent, ikke fakturert driftsinntekt",
    "1570": "Andre kortsiktige fordringer",
    "1580": "Avsetning tap p√• fordringer",
    "1700": "Forskuddsbetalt leie",
    "1710": "Forskuddsbetalte renter",
    "1720": "Forskuddsbetalt forsikring",
    "1740": "Forskuddsbetalt l√∏nn",
    "1760": "P√•l√∏pte renteinntekter",
    "1810": "B√∏rsnoterte aksjer",
    "1820": "Andre aksjer",
    "1900": "Kontanter",
    "1920": "Bankinnskudd",
    "1950": "Bankinnskudd skattetrekk",
    
    // BALANSEN - Klasse 2: Egenkapital og gjeld
    // Egenkapital
    "2000": "Aksjekapital",
    "2020": "Overkurs",
    "2030": "Annen innskutt egenkapital",
    "2050": "Annen egenkapital",
    "2080": "Udekket tap",
    
    // Langsiktig gjeld
    "2120": "Utsatt skatt",
    "2220": "Gjeld til kredittinstitusjoner",
    "2240": "Pantel√•n",
    "2270": "Valutal√•n (langsiktig)",
    
    // Kortsiktig gjeld
    "2310": "Kortsiktige l√•n",
    "2330": "Valutal√•n (kortsiktig)",
    "2380": "Kassekreditt",
    "2400": "Leverand√∏rgjeld",
    "2500": "Betalbar skatt, ikke fastsatt",
    "2510": "Betalbar skatt, fastsatt",
    "2540": "Forskuddsskatt",
    "2600": "Skattetrekk",
    "2700": "Utg√•ende merverdiavgift",
    "2710": "Inng√•ende merverdiavgift",
    "2740": "Oppgj√∏rskonto merverdiavgift",
    "2770": "Skyldig arbeidsgiveravgift",
    "2780": "P√•l√∏pt arbeidsgiveravgift",
    "2800": "Avsatt utbytte",
    "2930": "P√•l√∏pt l√∏nn",
    "2940": "P√•l√∏pt feriepenger",
    "2950": "P√•l√∏pte renter",
    "2960": "Andre p√•l√∏pte kostnader",
    "2970": "Uopptjent inntekt",
    "2980": "Garantiavsetning",
    "2990": "Annen kortsiktig gjeld",
    
    // RESULTATREGNSKAPET - Klasse 3: Driftsinntekter
    "3000": "Salgsinntekt varer, avgiftspliktig",
    "3050": "Vederlagsinntekt, avgiftspliktig",
    "3100": "Salgsinntekt, avgiftsfri",
    "3510": "Opptjent garanti-/serviceinntekt",
    "3600": "Husleieinntekt",
    "3800": "Gevinst avgang anleggsmidler",
    
    // Klasse 4: Varekostnader
    "4000": "Innkj√∏p av r√•varer",
    "4090": "Beholdningsendring r√•varer",
    "4190": "Beholdningsendring varer i arbeid",
    "4290": "Beholdningsendring ferdigvarer",
    "4300": "Innkj√∏p varer for videresalg, h√∏y sats",
    "4360": "Frakt og toll vedr. varer for videresalg",
    "4390": "Beholdningsendring varer for videresalg",
    
    // Klasse 5: L√∏nnskostnader
    "5000": "L√∏nn",
    "5180": "Feriepenger",
    "5400": "Arbeidsgiveravgift",
    "5410": "Arbeidsgiveravgift p√• feriepenger",
    
    // Klasse 6 og 7: Andre driftskostnader
    "6000": "Avskrivning",
    "6010": "Avskrivning andre anleggsmidler",
    "6050": "Nedskrivning anleggsmidler",
    "6110": "Frakt- og transportutgifter",
    "6300": "Leie av lokaler",
    "6340": "Lys, str√∏m, varme",
    "6580": "Driftsmidler < kr 15 000",
    "6600": "Reparasjon/vedlikehold bygg",
    "6700": "Revisjons- og regnskapshonorar",
    "6800": "Kontorrekvisita",
    "6840": "Aviser og tidsskrifter",
    "6900": "Telefon og porto",
    "7000": "Bilkostnader",
    "7130": "Reisekostnader",
    "7320": "Reklamekostnader",
    "7350": "Representasjon, fradragsberettiget",
    "7360": "Representasjon, ikke fradragsberettiget",
    "7500": "Forsikringer",
    "7550": "Garantikostnader",
    "7560": "Servicekostnader",
    "7790": "Andre driftskostnader",
    "7800": "Tap ved avgang anleggsmidler",
    "7830": "Tap p√• fordringer",
    "7910": "Ukurante varer",
    
    // Klasse 8: Finansinntekter, finanskostnader, skatt
    "8050": "Renteinntekt",
    "8060": "Valutagevinst",
    "8070": "Annen finansinntekt",
    "8080": "Verdi√∏kning b√∏rsnoterte aksjer og lignende",
    "8100": "Verdireduksjon b√∏rsnoterte aksjer og lignende",
    "8150": "Rentekostnad",
    "8160": "Valutatap",
    "8170": "Annen finanskostnad",
    "8300": "Betalbar skatt",
    "8309": "Betalbar skatt, for mye/lite avsatt tidligere √•r p√• ordin√¶rt resultat",
    "8320": "Endring utsatt skatt/skattefordel",
    "8800": "√Örsresultat",
    "8920": "Avsatt utbytte",
    "8960": "Overf√∏ring annen egenkapital",
    "8990": "Udekket tap"
};

// Generate random amounts for tasks
function generateRandomAmount(min, max, step = 100) {
    const range = (max - min) / step;
    return min + (Math.floor(Math.random() * (range + 1)) * step);
}

function generateTaskWithRandomAmounts(template) {
    const task = JSON.parse(JSON.stringify(template)); // Deep clone
    
    // Randomize amounts in description
    task.description = task.description.replace(/kr [\d\s]+/g, (match) => {
        const amount = parseInt(match.replace(/[^\d]/g, ''));
        const newAmount = generateRandomAmount(amount * 0.8, amount * 1.2, 100);
        return `kr ${newAmount.toLocaleString('no-NO')}`;
    });
    
    // Randomize amounts in solution
    task.solution.forEach(entry => {
        if (entry.debit > 0) {
            entry.debit = generateRandomAmount(entry.debit * 0.8, entry.debit * 1.2, 100);
        }
        if (entry.credit > 0) {
            entry.credit = generateRandomAmount(entry.credit * 0.8, entry.credit * 1.2, 100);
        }
    });
    
    return task;
}

// Task templates (will be randomized on game start)
const taskTemplates = [
    {
        description: "Kj√∏per varer for kr 10 000 + mva 25% = kr 12 500 p√• kreditt. Bokf√∏r kj√∏pet.",
        solution: [
            { account: "4000", debit: 10000, credit: 0 },
            { account: "2710", debit: 2500, credit: 0 },
            { account: "2400", debit: 0, credit: 12500 }
        ],
        hint: "Varekostnad og inng√•ende mva debiteres. Leverand√∏rgjeld krediteres.",
        relevantAccounts: ["4000", "2710", "2400", "2700", "3000"],
        difficulty: 'easy',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Selger varer for kr 20 000 + mva 25% = kr 25 000 p√• faktura. Bokf√∏r salget.",
        solution: [
            { account: "1500", debit: 25000, credit: 0 },
            { account: "3000", debit: 0, credit: 20000 },
            { account: "2700", debit: 0, credit: 5000 }
        ],
        hint: "Kundefordring debiteres. Salgsinntekt og utg√•ende mva krediteres.",
        relevantAccounts: ["1500", "3000", "2700", "1920", "4000"],
        difficulty: 'easy',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Mottar betaling fra kunde p√• kr 15 000. Bokf√∏r innbetalingen.",
        solution: [
            { account: "1920", debit: 15000, credit: 0 },
            { account: "1500", debit: 0, credit: 15000 }
        ],
        hint: "Bankinnskudd √∏ker (debet), kundefordring reduseres (kredit).",
        relevantAccounts: ["1920", "1500", "1900", "3000"],
        difficulty: 'easy',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Betaler leverand√∏r kr 8 000. Bokf√∏r betalingen.",
        solution: [
            { account: "2400", debit: 8000, credit: 0 },
            { account: "1920", debit: 0, credit: 8000 }
        ],
        hint: "Leverand√∏rgjeld reduseres (debet), bankinnskudd reduseres (kredit).",
        relevantAccounts: ["2400", "1920", "1900", "4000"],
        difficulty: 'easy',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Betaler l√∏nn kr 30 000. Trekker skattetrekk kr 7 500. Nettoutbetaling = kr 22 500. Bokf√∏r l√∏nnskj√∏ringen.",
        solution: [
            { account: "5000", debit: 30000, credit: 0 },
            { account: "2510", debit: 0, credit: 7500 },
            { account: "1920", debit: 0, credit: 22500 }
        ],
        hint: "L√∏nn debiteres, skattetrekk og nettoutbetaling krediteres.",
        relevantAccounts: ["5000", "2510", "1920", "2520", "2600"],
        difficulty: 'medium',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Beregner arbeidsgiveravgift 14,1% av l√∏nn kr 30 000 = kr 4 230. Bokf√∏r AGA.",
        solution: [
            { account: "5400", debit: 4230, credit: 0 },
            { account: "2520", debit: 0, credit: 4230 }
        ],
        hint: "Arbeidsgiveravgift (kostnad) debiteres, skyldig AGA (gjeld) krediteres.",
        relevantAccounts: ["5400", "2520", "2600", "2780", "5000"],
        difficulty: 'medium',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Kj√∏per kontorm√∏bler for kr 15 000 + mva = kr 18 750 kontant. Bokf√∏r kj√∏pet.",
        solution: [
            { account: "1500", debit: 15000, credit: 0 },
            { account: "2710", debit: 3750, credit: 0 },
            { account: "1920", debit: 0, credit: 18750 }
        ],
        hint: "Maskiner og inventar debiteres, inng√•ende mva debiteres, bank krediteres.",
        relevantAccounts: ["1500", "2710", "1920", "1300", "6000"],
        difficulty: 'medium',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Avskriver maskiner med kr 5 000 for √•ret. Bokf√∏r avskrivningen.",
        solution: [
            { account: "6020", debit: 5000, credit: 0 },
            { account: "1500", debit: 0, credit: 5000 }
        ],
        hint: "Avskrivning (kostnad) debiteres, maskiner (eiendel) krediteres.",
        relevantAccounts: ["6020", "1500", "6000", "1300"],
        difficulty: 'medium',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Tar opp l√•n i bank p√• kr 100 000. Bokf√∏r l√•net.",
        solution: [
            { account: "1920", debit: 100000, credit: 0 },
            { account: "2220", debit: 0, credit: 100000 }
        ],
        hint: "Bankinnskudd √∏ker (debet), gjeld til kredittinstitusjon √∏ker (kredit).",
        relevantAccounts: ["1920", "2220", "2200", "2230", "2310"],
        difficulty: 'medium',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Eier skyter inn kr 50 000 i aksjekapital. Bokf√∏r emisjonen.",
        solution: [
            { account: "1920", debit: 50000, credit: 0 },
            { account: "2000", debit: 0, credit: 50000 }
        ],
        hint: "Bankinnskudd √∏ker (debet), aksjekapital √∏ker (kredit).",
        relevantAccounts: ["1920", "2000", "2050", "2100", "1760"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Mottar renteinntekt fra bank kr 1 500. Bokf√∏r renteinntekten.",
        solution: [
            { account: "1920", debit: 1500, credit: 0 },
            { account: "8050", debit: 0, credit: 1500 }
        ],
        hint: "Bankinnskudd √∏ker (debet), renteinntekt (kredit).",
        relevantAccounts: ["1920", "1900", "8050", "8070", "3000", "1760"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Betaler renter p√• l√•n, kr 3 000. Bokf√∏r rentekostnaden.",
        solution: [
            { account: "8150", debit: 3000, credit: 0 },
            { account: "1920", debit: 0, credit: 3000 }
        ],
        hint: "Rentekostnad debiteres, bankinnskudd krediteres.",
        relevantAccounts: ["8150", "8170", "2950", "1920", "2220", "2310"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Beregner betalbar skatt p√• kr 45 000. Bokf√∏r skattekostnaden.",
        solution: [
            { account: "8300", debit: 45000, credit: 0 },
            { account: "2500", debit: 0, credit: 45000 }
        ],
        hint: "Betalbar skatt (kostnad) debiteres, betalbar skatt (gjeld) krediteres.",
        relevantAccounts: ["8300", "8309", "8320", "2500", "2510", "2540", "2120"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Skal betale mva til staten. Utg√•ende mva kr 25 000, inng√•ende mva kr 8 000. Oppgj√∏r = 25 000 - 8 000 = kr 17 000. Bokf√∏r oppgj√∏ret.",
        solution: [
            { account: "2700", debit: 25000, credit: 0 },
            { account: "2710", debit: 0, credit: 8000 },
            { account: "2740", debit: 0, credit: 17000 }
        ],
        hint: "Utg√•ende mva debiteres, inng√•ende mva krediteres, differansen til oppgj√∏rskonto.",
        relevantAccounts: ["2700", "2710", "2740", "1920"],
        difficulty: 'hard',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Betaler mva-oppgj√∏ret p√• kr 17 000 til staten. Bokf√∏r betalingen.",
        solution: [
            { account: "2740", debit: 17000, credit: 0 },
            { account: "1920", debit: 0, credit: 17000 }
        ],
        hint: "Oppgj√∏rskonto mva debiteres, bankinnskudd krediteres.",
        relevantAccounts: ["2740", "2700", "2710", "1920"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "F√•r tilbake mva fra staten. Utg√•ende mva kr 5 000, inng√•ende mva kr 12 000. Tilgode = 12 000 - 5 000 = kr 7 000. Bokf√∏r oppgj√∏ret og mottak av penger.",
        solution: [
            { account: "2700", debit: 5000, credit: 0 },
            { account: "2710", debit: 0, credit: 12000 },
            { account: "1920", debit: 7000, credit: 0 }
        ],
        hint: "Utg√•ende mva debiteres, inng√•ende mva krediteres, differansen mottas p√• bank (debet).",
        relevantAccounts: ["2700", "2710", "2740", "1920"],
        difficulty: 'hard',
        prefillEasy: { rows: 3 }
    },
    {
        description: "Avsetter feriepenger p√• 12% av √•rets l√∏nn kr 480 000. Feriepenger = kr 57 600. Bokf√∏r avsetningen.",
        solution: [
            { account: "5180", debit: 57600, credit: 0 },
            { account: "2940", debit: 0, credit: 57600 }
        ],
        hint: "Feriepenger (kostnad) debiteres, p√•l√∏pt feriepenger (gjeld) krediteres.",
        relevantAccounts: ["5180", "5000", "2940", "2930", "1920"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Beregner arbeidsgiveravgift p√• feriepenger: 57 600 √ó 14,1% = kr 8 122. Bokf√∏r AGA p√• feriepenger.",
        solution: [
            { account: "5410", debit: 8122, credit: 0 },
            { account: "2780", debit: 0, credit: 8122 }
        ],
        hint: "AGA p√• feriepenger debiteres, p√•l√∏pt AGA krediteres.",
        relevantAccounts: ["5410", "5400", "2780", "2770", "1920"],
        difficulty: 'hard',
        prefillEasy: { rows: 2 }
    },
    {
        description: "Selger aksjer for kr 150 000 som ble kj√∏pt for kr 120 000. Bokf√∏r salget.",
        solution: [
            { account: "1920", debit: 150000, credit: 0 },
            { account: "1810", debit: 0, credit: 120000 },
            { account: "8080", debit: 0, credit: 30000 }
        ],
        hint: "Bankinnskudd debiteres med salgspris, aksjer krediteres med kostpris, verdi√∏kning krediteres.",
        relevantAccounts: ["1920", "1810", "1820", "8080", "8100"],
        difficulty: 'hard',
        prefillEasy: { rows: 3 }
    }
];

// Generate tasks from templates with randomized amounts
// Generate tasks - TEMPORARILY DISABLED RANDOMIZATION TO ENSURE MATH IS CORRECT
const tasks = taskTemplates.map(template => JSON.parse(JSON.stringify(template)));
// const tasks = taskTemplates.map(template => generateTaskWithRandomAmounts(template));

// Game state
let gameState = {
    mode: 'normal',
    difficulty: 'mixed',
    currentTask: 0,
    score: 0,
    lives: 3,
    maxLives: 3,
    correctCount: 0,
    incorrectCount: 0,
    tutorialStep: 0,
    lockDamage: 0,
    taskList: []
};

// Calculator state
let calcState = {
    display: '0',
    equation: '',
    result: null
};

// ExcelGrid instance
let grid = null;

// Initialize
function init() {
    loadAccountList();
    loadProgress();
}

// Tab switching
function switchTab(tabName) {
    document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    event.target.classList.add('active');
    document.getElementById('tab-' + tabName).classList.add('active');
}

function loadAccountList() {
    const accountList = document.getElementById('account-list');
    if (!accountList) return;
    
    accountList.innerHTML = '';
    
    const currentTask = gameState.taskList[gameState.currentTask];
    const relevantAccounts = currentTask ? currentTask.relevantAccounts : [];
    const showStars = gameState.mode === 'tutorial' || gameState.mode === 'easy';
    
    for (const [mainGroup, subGroups] of Object.entries(accountGroups)) {
        const mainGroupDiv = document.createElement('div');
        mainGroupDiv.className = 'account-group';
        
        // Check if this main group has any relevant accounts
        let hasRelevantAccounts = false;
        for (const accountCodes of Object.values(subGroups)) {
            if (accountCodes.some(code => relevantAccounts.includes(code))) {
                hasRelevantAccounts = true;
                break;
            }
        }
        
        const mainHeader = document.createElement('div');
        mainHeader.className = 'account-group-header collapsed' + (hasRelevantAccounts && showStars ? ' has-stars' : '');
        mainHeader.innerHTML = `
            <span>${hasRelevantAccounts && showStars ? '‚≠ê ' : ''}${mainGroup}</span>
            <span class="chevron">‚ñº</span>
        `;
        
        const mainItemsDiv = document.createElement('div');
        mainItemsDiv.className = 'account-group-items';  // √ÖPEN som standard!
        
        mainHeader.onclick = () => {
            mainHeader.classList.toggle('collapsed');
            mainItemsDiv.classList.toggle('collapsed');
        };
        
        for (const [subGroup, accountCodes] of Object.entries(subGroups)) {
            const subGroupDiv = document.createElement('div');
            subGroupDiv.className = 'account-subgroup';
            subGroupDiv.textContent = subGroup;
            
            mainItemsDiv.appendChild(subGroupDiv);
            
            accountCodes.forEach(code => {
                const accountDiv = document.createElement('div');
                const isRelevant = relevantAccounts.includes(code);
                
                accountDiv.className = 'account-item' + (isRelevant ? ' starred' : '');
                accountDiv.draggable = true;
                accountDiv.innerHTML = `
                    <span><span class="account-code">${code}</span> ${accountNames[code] || 'Ukjent konto'}</span>
                    ${isRelevant && showStars ? '<span class="account-star">‚≠ê</span>' : ''}
                `;
                
                accountDiv.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', code);
                    accountDiv.classList.add('dragging');
                });
                
                accountDiv.addEventListener('dragend', () => {
                    accountDiv.classList.remove('dragging');
                });
                
                mainItemsDiv.appendChild(accountDiv);
            });
        }
        
        mainGroupDiv.appendChild(mainHeader);
        mainGroupDiv.appendChild(mainItemsDiv);
        accountList.appendChild(mainGroupDiv);
    }
}

function startGame(mode) {
    gameState.mode = mode;
    gameState.currentTask = 0;
    gameState.score = 0;
    gameState.correctCount = 0;
    gameState.incorrectCount = 0;
    
    // Set lives based on mode
    if (mode === 'tutorial') {
        gameState.lives = 999;
        gameState.maxLives = 999;
    } else {
        gameState.lives = 3;
        gameState.maxLives = 3;
    }
    
    // Filter tasks by difficulty
    if (mode === 'tutorial') {
        // Tutorial: Only easy tasks
        gameState.taskList = tasks.filter(t => t.difficulty === 'easy').slice(0, 5);
    } else if (mode === 'easy') {
        // Easy: Only easy tasks
        gameState.taskList = tasks.filter(t => t.difficulty === 'easy');
    } else if (mode === 'medium') {
        // Medium: Easy and medium tasks
        gameState.taskList = tasks.filter(t => t.difficulty === 'easy' || t.difficulty === 'medium');
    } else if (mode === 'hard') {
        // Hard: All tasks
        gameState.taskList = [...tasks];
    } else if (mode === 'challenge') {
        // Challenge: All tasks, harder ones weighted more
        gameState.taskList = [
            ...tasks.filter(t => t.difficulty === 'medium'),
            ...tasks.filter(t => t.difficulty === 'hard'),
            ...tasks.filter(t => t.difficulty === 'hard') // Duplicate hard tasks
        ];
    }
    
    // Shuffle tasks
    gameState.taskList.sort(() => Math.random() - 0.5);
    
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('game-container').style.display = 'block';
    
    // Oppdater tilbake-knapp tekst
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        backBtn.innerHTML = '‚Üê Tilbake til meny';
    }
    
    initExcelGrid();
    loadTask();
    updateUI();
    
    // Show welcome modal if first time
    showWelcomeIfFirstTime();
}

function initExcelGrid() {
    grid = new ExcelGrid('excel-grid', {
        headers: ['Konto', 'Debet', 'Kredit'],
        showRowNumbers: true,
        allowFormulas: true,
        allowCellSelection: true,
        allowFillHandle: true,
        readonlyColumns: []
    });
    
    // Add initial rows
    const initialRows = [
        ['', '', ''],
        ['', '', ''],
        ['', '', '']
    ];
    
    grid.loadData(initialRows);
    
    // Setup drag-and-drop for account cells (column 0)
    setupDragDrop();
    
    // Listen for changes
    grid.onCellChange((row, col, value) => {
        updateBalance();
    });
}

function setupDragDrop() {
    // Get all account cells (column 0)
    const accountCells = document.querySelectorAll('.excel-cell[data-col="0"]');
    
    accountCells.forEach(cell => {
        cell.classList.add('account-cell');
        
        cell.addEventListener('dragover', (e) => {
            e.preventDefault();
            cell.classList.add('drag-over');
        });
        
        cell.addEventListener('dragleave', () => {
            cell.classList.remove('drag-over');
        });
        
        cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            
            const accountCode = e.dataTransfer.getData('text/plain');
            if (accountCode) {
                cell.value = accountCode;
                updateBalance();
                
                // Visual feedback
                cell.style.background = 'rgb(74 222 128 / 0.3)';
                setTimeout(() => {
                    cell.style.background = '';
                }, 500);
            }
        });
    });
}

function loadTask() {
    const task = gameState.taskList[gameState.currentTask];
    if (!task) return;
    
    document.getElementById('task-title').textContent = `Oppgave ${gameState.currentTask + 1}: ${task.description.split('.')[0]}`;
    document.getElementById('task-description').textContent = task.description;
    
    // Clear grid
    grid.clear();
    
    // Prefill if in tutorial or easy mode
    if ((gameState.mode === 'tutorial' || gameState.mode === 'easy') && task.prefillEasy) {
        // Prefill just the right number of empty rows
        const rows = [];
        for (let i = 0; i < (task.prefillEasy.rows || 3); i++) {
            rows.push(['', '', '']);
        }
        grid.loadData(rows);
        setupDragDrop();
    }
    
    loadAccountList();
    updateBalance();
    document.getElementById('hint-box').classList.remove('visible');
}

function updateUI() {
    // Update top nav
    document.getElementById('nav-tasks').textContent = `${gameState.currentTask + 1}/${gameState.taskList.length}`;
    document.getElementById('nav-completed').textContent = gameState.correctCount;
    document.getElementById('nav-score').textContent = gameState.score;
    
    // Update progress bar
    const progress = Math.round((gameState.currentTask / gameState.taskList.length) * 100);
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
}

function updateBalance() {
    let totalDebit = 0;
    let totalCredit = 0;
    
    // Get all values from grid
    const allValues = grid.getAllValues();
    
    allValues.forEach(row => {
        const debit = parseFloat(row[1]) || 0;
        const credit = parseFloat(row[2]) || 0;
        totalDebit += debit;
        totalCredit += credit;
    });
    
    document.getElementById('total-debit').textContent = totalDebit.toFixed(2);
    document.getElementById('total-credit').textContent = totalCredit.toFixed(2);
    
    const balance = totalDebit - totalCredit;
    const balanceEl = document.getElementById('balance-status');
    balanceEl.textContent = balance.toFixed(2);
    
    if (Math.abs(balance) < 0.01) {
        balanceEl.className = 'balance-value balanced';
    } else {
        balanceEl.className = 'balance-value unbalanced';
    }
}

function addRow() {
    const currentData = grid.getAllValues();
    currentData.push(['', '', '']);
    grid.loadData(currentData);
    setupDragDrop();
}

function clearGrid() {
    grid.clear();
    updateBalance();
}

function checkAnswer() {
    console.log('=== checkAnswer called ===');
    const task = gameState.taskList[gameState.currentTask];
    if (!task) {
        console.log('ERROR: No task found!');
        return;
    }
    
    console.log('Current task:', task);
    
    const userAnswer = grid.getAllValues();
    console.log('User answer (all rows):', userAnswer);
    
    // Filter out empty rows
    const filledRows = userAnswer.filter(row => 
        row[0] && (row[1] || row[2])
    );
    
    console.log('Filled rows:', filledRows);
    
    // Check if balanced
    let totalDebit = 0;
    let totalCredit = 0;
    filledRows.forEach(row => {
        totalDebit += parseFloat(row[1]) || 0;
        totalCredit += parseFloat(row[2]) || 0;
    });
    
    if (Math.abs(totalDebit - totalCredit) > 0.01) {
        showFeedback('‚ùå Posteringen balanserer ikke! Debet og kredit m√• v√¶re like.', 'error');
        if (gameState.mode !== 'tutorial') {
            gameState.lives--;
            if (gameState.lives <= 0) {
                gameOver();
                return;
            }
        }
        updateUI();
        return;
    }
    
    // Check if all required accounts are present
    const userAccounts = filledRows.map(row => ({
        account: row[0],
        debit: parseFloat(row[1]) || 0,
        credit: parseFloat(row[2]) || 0
    }));
    
    console.log('User accounts:', JSON.stringify(userAccounts, null, 2));
    console.log('Expected solution:', JSON.stringify(task.solution, null, 2));
    
    const isCorrect = validateSolution(userAccounts, task.solution);
    console.log('Is correct?', isCorrect);
    
    if (isCorrect) {
        console.log('‚úÖ CORRECT!');
        gameState.correctCount++;
        gameState.score += 100;
        showFeedback('‚úÖ Riktig! Godt jobbet!', 'success');
        
        setTimeout(() => {
            nextTask();
        }, 1500);
    } else {
        console.log('‚ùå INCORRECT');
        console.log('Detailed comparison:');
        console.log('User has', userAccounts.length, 'entries, solution expects', task.solution.length);
        userAccounts.forEach((ua, i) => {
            if (task.solution[i]) {
                const sol = task.solution[i];
                console.log(`Row ${i+1}:`, {
                    userAccount: ua.account, 
                    expectedAccount: sol.account,
                    match: ua.account === sol.account,
                    userDebit: ua.debit,
                    expectedDebit: sol.debit,
                    userCredit: ua.credit,
                    expectedCredit: sol.credit
                });
            }
        });
        gameState.incorrectCount++;
        showFeedback('‚ùå Ikke helt riktig. Sjekk kontoer og bel√∏p.', 'error');
        
        if (gameState.mode !== 'tutorial') {
            gameState.lives--;
            if (gameState.lives <= 0) {
                gameOver();
                return;
            }
        }
    }
    
    updateUI();
}

function validateSolution(userAnswer, solution) {
    if (userAnswer.length !== solution.length) return false;
    
    // Create sorted arrays for comparison
    const userSorted = userAnswer.slice().sort((a, b) => String(a.account).localeCompare(String(b.account)));
    const solutionSorted = solution.slice().sort((a, b) => String(a.account).localeCompare(String(b.account)));
    
    for (let i = 0; i < userSorted.length; i++) {
        const user = userSorted[i];
        const sol = solutionSorted[i];
        
        if (user.account !== sol.account) return false;
        if (Math.abs(user.debit - sol.debit) > 0.01) return false;
        if (Math.abs(user.credit - sol.credit) > 0.01) return false;
    }
    
    return true;
}

function showFeedback(message, type) {
    // Could add a feedback notification here
    alert(message);
}

function showHint() {
    const task = gameState.taskList[gameState.currentTask];
    if (!task) return;
    
    const hintBox = document.getElementById('hint-box');
    hintBox.innerHTML = `<strong>üí° Hint:</strong> ${task.hint}`;
    hintBox.classList.add('visible');
}

function nextTask() {
    gameState.currentTask++;
    
    if (gameState.currentTask >= gameState.taskList.length) {
        gameComplete();
    } else {
        loadTask();
        updateUI();
    }
}

function gameOver() {
    alert(`Game Over! Du fikk ${gameState.correctCount} riktige av ${gameState.currentTask + 1} oppgaver.`);
    backToMenu();
}

function gameComplete() {
    alert(`Gratulerer! Du fullf√∏rte alle oppgavene!\n\nRiktige: ${gameState.correctCount}\nFeil: ${gameState.incorrectCount}\nPoeng: ${gameState.score}`);
    backToMenu();
}

function handleBack() {
    const mainMenu = document.getElementById('main-menu');
    const gameContainer = document.getElementById('game-container');
    
    // Sjekk om vi er i spillet eller p√• hovedmenyen
    if (gameContainer && gameContainer.style.display !== 'none' && 
        mainMenu && mainMenu.style.display === 'none') {
        // Vi er i spillet - g√• tilbake til hovedmenyen
        backToMenu();
    } else {
        // Vi er p√• hovedmenyen - g√• til forsiden
        window.location.href = 'index.html';
    }
}

function backToMenu() {
    document.getElementById('game-container').style.display = 'none';
    document.getElementById('main-menu').style.display = 'flex';
    
    // Oppdater tilbake-knapp tekst
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        backBtn.innerHTML = 'üè† Forsiden';
    }
}

function loadProgress() {
    // Load from localStorage if needed
}

function saveProgress() {
    // Save to localStorage if needed
}

// Calculator functions
function calcInput(value) {
    if (calcState.display === '0') {
        calcState.display = value;
    } else {
        calcState.display += value;
    }
    calcState.equation = calcState.display;
    document.getElementById('calc-display').textContent = calcState.display;
    document.getElementById('calc-equation').textContent = calcState.equation;
}

function calcEquals() {
    try {
        calcState.result = eval(calcState.display);
        calcState.display = calcState.result.toString();
        document.getElementById('calc-display').textContent = calcState.display;
    } catch (e) {
        document.getElementById('calc-display').textContent = 'Error';
    }
}

function calcClear() {
    calcState.display = '0';
    calcState.equation = '';
    calcState.result = null;
    document.getElementById('calc-display').textContent = '0';
    document.getElementById('calc-equation').textContent = '';
}

function calcBackspace() {
    calcState.display = calcState.display.slice(0, -1) || '0';
    document.getElementById('calc-display').textContent = calcState.display;
}

// Initialize on load
document.addEventListener('DOMContentLoaded', init);
    
    // Theme toggle functionality
    document.querySelector('.theme-toggle').addEventListener('click', function() {
        document.body.classList.toggle('light-mode');
        this.textContent = document.body.classList.contains('light-mode') ? '‚òÄÔ∏è' : 'üåô';
    });

// ========== NEW FEATURES V3 ==========

// Task Selector Functions
function renderTaskSelector() {
    const grid = document.getElementById('task-selector-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    gameState.taskList.forEach((task, index) => {
        const item = document.createElement('div');
        item.className = 'task-selector-item';
        
        if (index === gameState.currentTask) {
            item.classList.add('current');
        }
        
        if (index < gameState.currentTask) {
            item.classList.add('completed');
        }
        
        item.textContent = `${index + 1}`;
        item.onclick = () => jumpToTask(index);
        
        grid.appendChild(item);
    });
}

function jumpToTask(index) {
    if (index < 0 || index >= gameState.taskList.length) return;
    if (index > gameState.currentTask) {
        alert('Du m√• fullf√∏re de forrige oppgavene f√∏rst!');
        return;
    }
    
    gameState.currentTask = index;
    loadTask();
    updateUI();
    renderTaskSelector();
}

// Tutorial Functions
function showTutorial(type) {
    const modal = document.getElementById('tutorial-modal');
    const content = document.getElementById('tutorial-content');
    
    if (type === 'bokforing') {
        content.innerHTML = `
            <h2>üìö Bokf√∏rings-tutorial</h2>
            
            <h3>Hva er bokf√∏ring?</h3>
            <p>Bokf√∏ring er systematisk registrering av alle √∏konomiske hendelser i en virksomhet. Hver hendelse registreres som en <strong>postering</strong> med:</p>
            <ul>
                <li><strong>Konto</strong>: Hvilket type transaksjon (f.eks. 1920 Bankinnskudd)</li>
                <li><strong>Debet</strong>: Venstre side (√∏kning i eiendeler, reduksjon i gjeld)</li>
                <li><strong>Kredit</strong>: H√∏yre side (reduksjon i eiendeler, √∏kning i gjeld)</li>
            </ul>
            
            <h3>Grunnprinsippet</h3>
            <p><strong>Debet = Kredit</strong> - Dette m√• alltid balansere!</p>
            
            <div class="tutorial-example">
                <p><strong>Eksempel: Kj√∏per varer for 10 000 kr p√• faktura</strong></p>
                <p>Debet: 4300 Innkj√∏p varer for videresalg - 10 000 kr</p>
                <p>Kredit: 2400 Leverand√∏rgjeld - 10 000 kr</p>
                <p><em>Resultat: Vi har f√•tt varer (kostnad √∏ker) og skylder leverand√∏ren (gjeld √∏ker)</em></p>
            </div>
            
            <h3>Kontotyper</h3>
            <ul>
                <li><strong>Klasse 1</strong>: Eiendeler (hva vi eier)</li>
                <li><strong>Klasse 2</strong>: Egenkapital og gjeld (hvordan det er finansiert)</li>
                <li><strong>Klasse 3</strong>: Inntekter (hva vi tjener)</li>
                <li><strong>Klasse 4-7</strong>: Kostnader (hva vi bruker)</li>
                <li><strong>Klasse 8</strong>: Finans og skatt</li>
            </ul>
            
            <h3>Tips for spillet</h3>
            <ul>
                <li>Les oppgaven n√∏ye - hvilke kontoer p√•virkes?</li>
                <li>Tenk: Hva √∏ker? Hva minker?</li>
                <li>Sjekk at debet = kredit f√∏r du sender inn</li>
                <li>Bruk hint hvis du st√•r fast!</li>
                <li>Dra kontoer fra sidepanelet direkte inn i gridet</li>
            </ul>
            
            <button class="tutorial-close" onclick="closeTutorial()">Forst√•tt!</button>
        `;
    } else if (type === 'excel') {
        content.innerHTML = `
            <h2>üìä Excel-tutorial</h2>
            
            <h3>Navigering</h3>
            <ul>
                <li><strong>Tab</strong>: G√• til neste celle ‚Üí</li>
                <li><strong>Shift+Tab</strong>: G√• til forrige celle ‚Üê</li>
                <li><strong>Enter</strong>: G√• til celle under ‚Üì</li>
                <li><strong>Piltaster</strong>: Naviger i alle retninger</li>
            </ul>
            
            <h3>Formler</h3>
            <p>Start alltid med <code>=</code> for √• lage en formel:</p>
            
            <div class="tutorial-example">
                <p><strong>Enkle formler:</strong></p>
                <p><code>=B1+C1</code> - Legge sammen to celler</p>
                <p><code>=B1*2</code> - Multiplisere med 2</p>
                <p><code>=B1-C1</code> - Subtraksjon</p>
                <p><code>=B1/C1</code> - Divisjon</p>
            </div>
            
            <div class="tutorial-example">
                <p><strong>Funksjoner:</strong></p>
                <p><code>=SUM(B1:B10)</code> - Summere alle celler fra B1 til B10</p>
                <p><code>=AVERAGE(B1:B5)</code> - Gjennomsnitt</p>
                <p><code>=MIN(B1:B10)</code> - Minste verdi</p>
                <p><code>=MAX(B1:B10)</code> - St√∏rste verdi</p>
                <p><code>=ABS(B1)</code> - Absoluttverdi</p>
            </div>
            
            <h3>Fill Handle üü¢</h3>
            <p>Den gr√∏nne sirkelen i nederste h√∏yre hj√∏rne av en celle:</p>
            <ol>
                <li>Skriv en formel (f.eks. <code>=B1+C1</code>)</li>
                <li>Trykk Enter for √• evaluere</li>
                <li>Klikk og dra den gr√∏nne sirkelen üü¢</li>
                <li>Formelen kopieres og justeres automatisk!</li>
            </ol>
            
            <h3>$ L√•sing</h3>
            <p>L√•s celler som ikke skal endres ved kopiering:</p>
            <ul>
                <li><code>=$B1</code> - L√•s kolonne B</li>
                <li><code>=B$1</code> - L√•s rad 1</li>
                <li><code>=$B$1</code> - L√•s b√•de kolonne og rad</li>
            </ul>
            
            <h3>Drag-and-Drop</h3>
            <p>Dra kontoer fra sidepanelet direkte inn i Konto-kolonnen!</p>
            
            <h3>Kalkulator</h3>
            <p>Klikk p√• üî¢ Kalkulator-knappen for √• √•pne en flytende kalkulator som du kan dra rundt p√• skjermen!</p>
            
            <button class="tutorial-close" onclick="closeTutorial()">Forst√•tt!</button>
        `;
    }
    
    modal.classList.add('visible');
}

function closeTutorial() {
    document.getElementById('tutorial-modal').classList.remove('visible');
}

// Welcome modal functions
function closeWelcome() {
    const modal = document.getElementById('welcome-modal');
    const dontShowAgain = document.getElementById('dont-show-again').checked;
    
    if (dontShowAgain) {
        localStorage.setItem('bokforing_welcome_shown', 'true');
    }
    
    modal.classList.remove('visible');
}

function showWelcomeIfFirstTime() {
    const hasSeenWelcome = localStorage.getItem('bokforing_welcome_shown');
    if (!hasSeenWelcome) {
        document.getElementById('welcome-modal').classList.add('visible');
    }
}

// Floating Calculator Functions
let calcValue = '0';
let calcOperator = null;
let calcPrevValue = null;
let calcEquation = '';

function toggleCalculator() {
    const calc = document.getElementById('floating-calculator');
    calc.classList.toggle('visible');
}

function calcInput(value) {
    const display = document.getElementById('calc-display');
    const equation = document.getElementById('calc-equation');
    
    if (['+', '-', '*', '/'].includes(value)) {
        if (calcValue !== '0') {
            calcPrevValue = parseFloat(calcValue);
            calcOperator = value;
            calcEquation = calcValue + ' ' + value + ' ';
            equation.textContent = calcEquation;
            calcValue = '0';
        }
    } else {
        if (calcValue === '0') {
            calcValue = value;
        } else {
            calcValue += value;
        }
    }
    
    display.textContent = calcValue;
}

function calcEquals() {
    const display = document.getElementById('calc-display');
    const equation = document.getElementById('calc-equation');
    
    if (calcOperator && calcPrevValue !== null) {
        const currentValue = parseFloat(calcValue);
        let result;
        
        switch (calcOperator) {
            case '+': result = calcPrevValue + currentValue; break;
            case '-': result = calcPrevValue - currentValue; break;
            case '*': result = calcPrevValue * currentValue; break;
            case '/': result = calcPrevValue / currentValue; break;
        }
        
        calcEquation += calcValue + ' = ' + result;
        equation.textContent = calcEquation;
        display.textContent = result;
        calcValue = result.toString();
        calcOperator = null;
        calcPrevValue = null;
    }
}

function calcClear() {
    calcValue = '0';
    calcOperator = null;
    calcPrevValue = null;
    calcEquation = '';
    document.getElementById('calc-display').textContent = '0';
    document.getElementById('calc-equation').textContent = '';
}

function calcBackspace() {
    if (calcValue.length > 1) {
        calcValue = calcValue.slice(0, -1);
    } else {
        calcValue = '0';
    }
    document.getElementById('calc-display').textContent = calcValue;
}

// Make calculator draggable
let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

const dragElement = document.getElementById('calculator-drag');
if (dragElement) {
    dragElement.addEventListener('mousedown', dragStart);
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', dragEnd);
}

function dragStart(e) {
    if (e.target.classList.contains('calc-btn') || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
    isDragging = true;
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        
        const calc = document.getElementById('floating-calculator');
        calc.style.transform = `translate(${currentX}px, ${currentY}px)`;
    }
}

function dragEnd(e) {
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
}

// Update existing functions to call renderTaskSelector
const originalLoadTask = loadTask;
loadTask = function() {
    originalLoadTask();
    renderTaskSelector();
};

const originalUpdateUI = updateUI;
updateUI = function() {
    originalUpdateUI();
    renderTaskSelector();
};

console.log('‚úì Bokf√∏ringsspill v3.0 loaded with all features!');
    
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        if (typeof ThemeManager !== 'undefined') {
            ThemeManager.init();
        }
    </script>
</body>
</html>
