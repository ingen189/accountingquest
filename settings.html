<!DOCTYPE html>
<html lang="no" data-theme="dark" data-accent="green">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innstillinger - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <meta name="theme-color" content="#0f1419">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* Accent colors */
        [data-accent="green"] { --accent: #4ade80; --accent-hover: #22c55e; --accent-glow: rgba(74, 222, 128, 0.3); }
        [data-accent="blue"] { --accent: #3b82f6; --accent-hover: #2563eb; --accent-glow: rgba(59, 130, 246, 0.3); }
        [data-accent="purple"] { --accent: #a855f7; --accent-hover: #9333ea; --accent-glow: rgba(168, 85, 247, 0.3); }
        [data-accent="pink"] { --accent: #ec4899; --accent-hover: #db2777; --accent-glow: rgba(236, 72, 153, 0.3); }
        [data-accent="orange"] { --accent: #f59e0b; --accent-hover: #d97706; --accent-glow: rgba(245, 158, 11, 0.3); }
        [data-accent="cyan"] { --accent: #06b6d4; --accent-hover: #0891b2; --accent-glow: rgba(6, 182, 212, 0.3); }
        [data-accent="red"] { --accent: #ef4444; --accent-hover: #dc2626; --accent-glow: rgba(239, 68, 68, 0.3); }
        [data-accent="yellow"] { --accent: #eab308; --accent-hover: #ca8a04; --accent-glow: rgba(234, 179, 8, 0.3); }
        [data-accent="teal"] { --accent: #14b8a6; --accent-hover: #0d9488; --accent-glow: rgba(20, 184, 166, 0.3); }
        [data-accent="indigo"] { --accent: #6366f1; --accent-hover: #4f46e5; --accent-glow: rgba(99, 102, 241, 0.3); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background var(--transition-normal), color var(--transition-normal);
            line-height: 1.6;
        }

        a { color: var(--accent); text-decoration: none; }

        /* Header */
        .aq-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .aq-header-left, .aq-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .aq-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .aq-logo-icon { font-size: 1.8em; }

        .aq-logo-text {
            font-size: 1.4em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .aq-module-name {
            color: var(--accent);
            font-size: 0.9em;
            font-weight: 600;
        }

        /* Buttons */
        .aq-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            text-decoration: none;
        }

        .aq-btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .aq-btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .aq-btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .aq-btn-secondary:hover {
            background: var(--border-light);
            transform: translateY(-2px);
        }

        .aq-btn-danger {
            background: var(--error);
            color: white;
        }

        .aq-btn-danger:hover {
            background: #dc2626;
        }

        /* Badges */
        .aq-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: var(--radius-full);
            font-size: 0.8em;
            font-weight: 600;
        }

        .aq-badge-primary { background: var(--accent); color: var(--bg-primary); }
        .aq-badge-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .aq-badge-success { background: var(--success); color: white; }
        .aq-badge-info { background: var(--info); color: white; }

        /* Progress */
        .aq-progress {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            height: 10px;
            overflow: hidden;
        }

        .aq-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }

        /* Settings */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .settings-title {
            font-size: 2em;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: var(--accent);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
        }

        .settings-section p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        /* Theme grid */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-card {
            background: var(--bg-tertiary);
            border: 3px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .theme-card:hover {
            border-color: var(--border-light);
            transform: translateY(-3px);
        }

        .theme-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .theme-preview {
            width: 100%;
            height: 50px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
        }

        .theme-preview-dark { background: linear-gradient(135deg, #0f1419, #1a1f26); }
        .theme-preview-light { background: linear-gradient(135deg, #f5f5f0, #fafaf8); }
        .theme-preview-cream { background: linear-gradient(135deg, #f9f6f1, #fffcf7); }
        .theme-preview-dark-blue { background: linear-gradient(135deg, #0a192f, #112240); }
        .theme-preview-midnight { background: linear-gradient(135deg, #000000, #0a0a0a); }
        .theme-preview-charcoal { background: linear-gradient(135deg, #1a1a1a, #242424); }
        .theme-preview-slate { background: linear-gradient(135deg, #0f172a, #1e293b); }
        .theme-preview-forest { background: linear-gradient(135deg, #0c1a14, #142b1f); }
        .theme-preview-purple-night { background: linear-gradient(135deg, #13111c, #1c1829); }

        .theme-name {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-primary);
        }

        /* Accent grid */
        .accent-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .accent-btn {
            width: 45px;
            height: 45px;
            border-radius: var(--radius-md);
            border: 3px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
        }

        .accent-btn:hover {
            transform: scale(1.15);
            border-color: var(--border-light);
        }

        .accent-btn.active {
            border-color: white;
            box-shadow: 0 0 15px currentColor;
            transform: scale(1.1);
        }

        .accent-btn.active::after {
            content: '‚úì';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            color: white;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .accent-green { background: #4ade80; }
        .accent-blue { background: #3b82f6; }
        .accent-purple { background: #a855f7; }
        .accent-pink { background: #ec4899; }
        .accent-orange { background: #f59e0b; }
        .accent-cyan { background: #06b6d4; }
        .accent-red { background: #ef4444; }
        .accent-yellow { background: #eab308; }
        .accent-teal { background: #14b8a6; }
        .accent-indigo { background: #6366f1; }

        /* Preview section */
        .preview-section {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 20px;
        }

        .preview-section h4 {
            margin-bottom: 15px;
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .preview-components {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        /* Storage info */
        .storage-info {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 15px;
        }

        .storage-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .storage-item:last-child { border-bottom: none; }

        .storage-item span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        .data-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        /* Account section styles */
        .account-info {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 20px;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .account-row:last-child { border-bottom: none; }

        .account-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .account-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .account-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        /* Password form */
        .password-form {
            display: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-top: 15px;
        }

        .password-form.show { display: block; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .message {
            padding: 12px;
            border-radius: var(--radius-md);
            margin-bottom: 15px;
            display: none;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #fca5a5;
            display: block;
        }

        .message.success {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid #4ade80;
            color: #4ade80;
            display: block;
        }

        .guest-notice {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: var(--radius-md);
            padding: 20px;
            text-align: center;
        }

        .guest-notice p {
            color: #f59e0b;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .theme-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .settings-container {
                padding: 15px;
            }
            .account-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="aq-header">
        <div class="aq-header-left">
            <a href="index.html" class="aq-logo">
                <span class="aq-logo-icon">üìö</span>
                <span class="aq-logo-text">AccountingQuest</span>
            </a>
            <span class="aq-module-name">‚öôÔ∏è Innstillinger</span>
        </div>
        <div class="aq-header-right">
            <a href="index.html" class="aq-btn aq-btn-secondary">‚Üê Tilbake</a>
        </div>
    </header>
    
    <div class="settings-container">
        <h1 class="settings-title">‚öôÔ∏è Innstillinger</h1>

        <!-- Konto (dynamisk) -->
        <section class="settings-section" id="account-section">
            <h3>üë§ Konto</h3>
            
            <!-- Gjest-visning -->
            <div id="guest-view" class="guest-notice" style="display: none;">
                <p>‚ö†Ô∏è Du er ikke logget inn. Opprett en konto for √• lagre fremgangen din i skyen.</p>
                <a href="auth.html" class="aq-btn aq-btn-primary">Logg inn / Registrer</a>
            </div>
            
            <!-- Bruker-visning -->
            <div id="user-view" style="display: none;">
                <div class="account-info">
                    <div class="account-row">
                        <span class="account-label">E-post</span>
                        <span class="account-value" id="user-email">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">Brukernavn</span>
                        <span class="account-value" id="user-name">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">Rolle</span>
                        <span class="account-value" id="user-role">-</span>
                    </div>
                    <div class="account-row">
                        <span class="account-label">Innloggingsmetode</span>
                        <span class="account-value" id="user-provider">-</span>
                    </div>
                </div>

                <div class="account-actions">
                    <button class="aq-btn aq-btn-secondary" id="change-password-btn" onclick="togglePasswordForm()">
                        üîë Bytt passord
                    </button>
                    <button class="aq-btn aq-btn-danger" onclick="doLogout()">
                        üö™ Logg ut
                    </button>
                </div>

                <!-- Bytt passord form -->
                <div class="password-form" id="password-form">
                    <div id="password-message"></div>
                    <div class="form-group">
                        <label>N√•v√¶rende passord</label>
                        <input type="password" id="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>Nytt passord (min 6 tegn)</label>
                        <input type="password" id="new-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-group">
                        <label>Bekreft nytt passord</label>
                        <input type="password" id="confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <div class="form-buttons">
                        <button class="aq-btn aq-btn-primary" onclick="changePassword()">Lagre nytt passord</button>
                        <button class="aq-btn aq-btn-secondary" onclick="togglePasswordForm()">Avbryt</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Tema -->
        <section class="settings-section">
            <h3>üé® Tema</h3>
            <p>Velg utseendet som passer deg best.</p>
            
            <div class="theme-grid" id="theme-grid">
                <div class="theme-card" data-theme="dark">
                    <div class="theme-preview theme-preview-dark"></div>
                    <div class="theme-name">üåô M√∏rk</div>
                </div>
                <div class="theme-card" data-theme="light">
                    <div class="theme-preview theme-preview-light"></div>
                    <div class="theme-name">‚òÄÔ∏è Lys</div>
                </div>
                <div class="theme-card" data-theme="cream">
                    <div class="theme-preview theme-preview-cream"></div>
                    <div class="theme-name">üç¶ Krem</div>
                </div>
                <div class="theme-card" data-theme="dark-blue">
                    <div class="theme-preview theme-preview-dark-blue"></div>
                    <div class="theme-name">üåä Navy</div>
                </div>
                <div class="theme-card" data-theme="midnight">
                    <div class="theme-preview theme-preview-midnight"></div>
                    <div class="theme-name">üåë Svart</div>
                </div>
                <div class="theme-card" data-theme="charcoal">
                    <div class="theme-preview theme-preview-charcoal"></div>
                    <div class="theme-name">‚¨õ Kull</div>
                </div>
                <div class="theme-card" data-theme="slate">
                    <div class="theme-preview theme-preview-slate"></div>
                    <div class="theme-name">üî∑ Skifer</div>
                </div>
                <div class="theme-card" data-theme="forest">
                    <div class="theme-preview theme-preview-forest"></div>
                    <div class="theme-name">üå≤ Skog</div>
                </div>
                <div class="theme-card" data-theme="purple-night">
                    <div class="theme-preview theme-preview-purple-night"></div>
                    <div class="theme-name">üîÆ Lilla</div>
                </div>
            </div>
        </section>
        
        <!-- Accent-farge -->
        <section class="settings-section">
            <h3>‚ú® Accent-farge</h3>
            <p>Velg din favorittfarge for knapper og uthevinger.</p>
            
            <div class="accent-grid" id="accent-grid">
                <button class="accent-btn accent-green" data-accent="green" title="Gr√∏nn"></button>
                <button class="accent-btn accent-blue" data-accent="blue" title="Bl√•"></button>
                <button class="accent-btn accent-purple" data-accent="purple" title="Lilla"></button>
                <button class="accent-btn accent-pink" data-accent="pink" title="Rosa"></button>
                <button class="accent-btn accent-orange" data-accent="orange" title="Oransje"></button>
                <button class="accent-btn accent-cyan" data-accent="cyan" title="Cyan"></button>
                <button class="accent-btn accent-red" data-accent="red" title="R√∏d"></button>
                <button class="accent-btn accent-yellow" data-accent="yellow" title="Gul"></button>
                <button class="accent-btn accent-teal" data-accent="teal" title="Teal"></button>
                <button class="accent-btn accent-indigo" data-accent="indigo" title="Indigo"></button>
            </div>
            
            <!-- Preview -->
            <div class="preview-section">
                <h4>Forh√•ndsvisning:</h4>
                <div class="preview-components">
                    <button class="aq-btn aq-btn-primary">Prim√¶r-knapp</button>
                    <button class="aq-btn aq-btn-secondary">Sekund√¶r</button>
                    <span class="aq-badge aq-badge-primary">Badge</span>
                    <div class="aq-progress" style="width: 150px;">
                        <div class="aq-progress-bar" style="width: 70%;"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Brukerdata -->
        <section class="settings-section">
            <h3>üíæ Data</h3>
            
            <div class="storage-info">
                <div class="storage-item">
                    <span>Bokf√∏ring fremgang</span>
                    <span id="bokforing-count">0 oppgaver</span>
                </div>
                <div class="storage-item">
                    <span>Quiz fremgang</span>
                    <span id="quiz-count">0 kategorier</span>
                </div>
                <div class="storage-item">
                    <span>Egne quizzer</span>
                    <span id="custom-quiz-count">0 quizzer</span>
                </div>
                <div class="storage-item">
                    <span>Totalt lagret</span>
                    <span id="total-storage">0 KB</span>
                </div>
            </div>
            
            <div class="data-actions">
                <button class="aq-btn aq-btn-secondary" onclick="exportData()">
                    üì• Eksporter data
                </button>
                <button class="aq-btn aq-btn-secondary" onclick="document.getElementById('import-file').click()">
                    üì§ Importer data
                </button>
                <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="aq-btn aq-btn-danger" onclick="confirmResetData()">
                    üóëÔ∏è Nullstill alt
                </button>
            </div>
        </section>
        
        <!-- Om -->
        <section class="settings-section">
            <h3>‚ÑπÔ∏è Om AccountingQuest</h3>
            <p>
                AccountingQuest er en gamifisert l√¶ringsplattform for norsk bokf√∏ring og regnskap.
                Plattformen er designet for √• gj√∏re det lettere √• l√¶re regnskapsf√∏ring gjennom
                interaktive oppgaver basert p√• norske lover og standarder.
            </p>
            <div class="badges-row">
                <span class="aq-badge aq-badge-secondary">Versjon 2.0</span>
                <span class="aq-badge aq-badge-info">Firebase-st√∏tte</span>
                <span class="aq-badge aq-badge-success">Multiplayer</span>
            </div>
        </section>
    </div>
    
    <script>
        // ========== FIREBASE ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "525417361926",
            appId: "1:525417361926:web:ec9b737f82af9b21700987"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let currentUser = null;

        // ========== AUTH STATE ==========
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            
            if (user && !user.isAnonymous) {
                // Logged in
                document.getElementById('guest-view').style.display = 'none';
                document.getElementById('user-view').style.display = 'block';
                
                // Email
                document.getElementById('user-email').textContent = user.email || '-';
                
                // Provider
                const providers = user.providerData.map(p => {
                    if (p.providerId === 'password') return 'E-post/Passord';
                    if (p.providerId === 'google.com') return 'Google';
                    return p.providerId;
                });
                document.getElementById('user-provider').textContent = providers.join(', ') || '-';
                
                // Hide password change for Google-only users
                const hasPasswordProvider = user.providerData.some(p => p.providerId === 'password');
                document.getElementById('change-password-btn').style.display = hasPasswordProvider ? 'inline-flex' : 'none';
                
                // Get user data from database
                try {
                    const snap = await db.ref('users/' + user.uid).once('value');
                    const data = snap.val();
                    if (data) {
                        document.getElementById('user-name').textContent = data.username || user.displayName || '-';
                        document.getElementById('user-role').textContent = data.role === 'teacher' ? 'üë®‚Äçüè´ L√¶rer' : 'üéì Student';
                    }
                } catch (e) {
                    console.error('Error fetching user data:', e);
                }
                
            } else {
                // Guest or not logged in
                document.getElementById('guest-view').style.display = 'block';
                document.getElementById('user-view').style.display = 'none';
            }
        });

        // ========== PASSWORD FUNCTIONS ==========
        function togglePasswordForm() {
            const form = document.getElementById('password-form');
            form.classList.toggle('show');
            
            // Clear form
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-message').innerHTML = '';
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const msgEl = document.getElementById('password-message');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Fyll inn alle feltene';
                return;
            }

            if (newPassword.length < 6) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Nytt passord m√• v√¶re minst 6 tegn';
                return;
            }

            if (newPassword !== confirmPassword) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Passordene stemmer ikke overens';
                return;
            }

            try {
                // Re-authenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    currentPassword
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Update password
                await currentUser.updatePassword(newPassword);
                
                msgEl.className = 'message success';
                msgEl.textContent = '‚úÖ Passordet er oppdatert!';
                
                // Clear form after 2 seconds
                setTimeout(() => {
                    togglePasswordForm();
                }, 2000);
                
            } catch (error) {
                console.error('Password change error:', error);
                let errorMsg = 'En feil oppstod';
                
                if (error.code === 'auth/wrong-password') {
                    errorMsg = 'N√•v√¶rende passord er feil';
                } else if (error.code === 'auth/weak-password') {
                    errorMsg = 'Nytt passord er for svakt';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMsg = 'Logg inn p√• nytt og pr√∏v igjen';
                }
                
                msgEl.className = 'message error';
                msgEl.textContent = errorMsg;
            }
        }

        function doLogout() {
            if (confirm('Er du sikker p√• at du vil logge ut?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                });
            }
        }

        // ========== THEME MANAGER ==========
        var ThemeManager = (function() {
            var themes = ['dark', 'light', 'cream', 'dark-blue', 'midnight', 'charcoal', 'slate', 'forest', 'purple-night'];
            var accents = ['green', 'blue', 'purple', 'pink', 'orange', 'cyan', 'red', 'yellow', 'teal', 'indigo'];
            var THEME_KEY = 'aq_theme';
            var ACCENT_KEY = 'aq_accent';

            function init() {
                var savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
                var savedAccent = localStorage.getItem(ACCENT_KEY) || 'green';
                setTheme(savedTheme);
                setAccent(savedAccent);
            }

            function setTheme(theme) {
                if (!themes.includes(theme)) theme = 'dark';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem(THEME_KEY, theme);
            }

            function setAccent(accent) {
                if (!accents.includes(accent)) accent = 'green';
                document.documentElement.setAttribute('data-accent', accent);
                localStorage.setItem(ACCENT_KEY, accent);
            }

            function getTheme() {
                return document.documentElement.getAttribute('data-theme') || 'dark';
            }

            function getAccent() {
                return document.documentElement.getAttribute('data-accent') || 'green';
            }

            init();

            return { setTheme: setTheme, setAccent: setAccent, getTheme: getTheme, getAccent: getAccent };
        })();

        // ========== UI INITIALIZATION ==========
        function initUI() {
            var currentTheme = ThemeManager.getTheme();
            var currentAccent = ThemeManager.getAccent();

            document.querySelectorAll('.theme-card').forEach(function(card) {
                card.classList.toggle('active', card.dataset.theme === currentTheme);
            });

            document.querySelectorAll('.accent-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.accent === currentAccent);
            });
        }

        // Theme click handlers
        document.querySelectorAll('.theme-card').forEach(function(card) {
            card.addEventListener('click', function() {
                ThemeManager.setTheme(this.dataset.theme);
                initUI();
            });
        });

        // Accent click handlers
        document.querySelectorAll('.accent-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                ThemeManager.setAccent(this.dataset.accent);
                initUI();
            });
        });

        // ========== STORAGE INFO ==========
        function updateStorageInfo() {
            try {
                var bokforing = JSON.parse(localStorage.getItem('bokforingProgress') || '{}');
                document.getElementById('bokforing-count').textContent = Object.keys(bokforing).length + ' oppgaver';
            } catch(e) {
                document.getElementById('bokforing-count').textContent = '0 oppgaver';
            }

            try {
                var quiz = JSON.parse(localStorage.getItem('quizProgress') || '{}');
                document.getElementById('quiz-count').textContent = Object.keys(quiz).length + ' kategorier';
            } catch(e) {
                document.getElementById('quiz-count').textContent = '0 kategorier';
            }

            try {
                var custom = JSON.parse(localStorage.getItem('aq_my_quizzes') || '[]');
                document.getElementById('custom-quiz-count').textContent = custom.length + ' quizzer';
            } catch(e) {
                document.getElementById('custom-quiz-count').textContent = '0 quizzer';
            }

            var total = 0;
            for (var key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += (localStorage.getItem(key) || '').length;
                }
            }
            document.getElementById('total-storage').textContent = (total / 1024).toFixed(1) + ' KB';
        }

        // ========== DATA FUNCTIONS ==========
        function exportData() {
            var data = {
                exportDate: new Date().toISOString(),
                version: '2.0',
                theme: ThemeManager.getTheme(),
                accent: ThemeManager.getAccent(),
                progress: {}
            };

            var keysToExport = ['bokforingProgress', 'quizProgress', 'analyseProgress', 'caseProgress', 'hjernetrimProgress', 'aq_my_quizzes'];
            keysToExport.forEach(function(key) {
                var value = localStorage.getItem(key);
                if (value) {
                    try { data.progress[key] = JSON.parse(value); }
                    catch(e) { data.progress[key] = value; }
                }
            });

            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'accountingquest-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (!data.progress) { alert('Ugyldig backup-fil'); return; }

                    Object.keys(data.progress).forEach(function(key) {
                        var value = data.progress[key];
                        localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
                    });

                    if (data.theme) ThemeManager.setTheme(data.theme);
                    if (data.accent) ThemeManager.setAccent(data.accent);

                    alert('Data importert!');
                    updateStorageInfo();
                    initUI();
                } catch(err) {
                    alert('Feil ved import: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function confirmResetData() {
            if (confirm('‚ö†Ô∏è Er du sikker p√• at du vil slette ALL fremgang?\n\nDette kan ikke angres!')) {
                if (confirm('Siste sjanse! Klikk OK for √• slette alt.')) {
                    var keysToDelete = [];
                    for (var key in localStorage) {
                        if (key.startsWith('aq_') || key.includes('Progress') || key.includes('quiz')) {
                            keysToDelete.push(key);
                        }
                    }
                    keysToDelete.forEach(function(key) { localStorage.removeItem(key); });
                    alert('All data er slettet.');
                    updateStorageInfo();
                }
            }
        }

        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', function() {
            initUI();
            updateStorageInfo();
        });
    </script>
    
    <!-- Theme Manager (external backup) -->
    <script src="js/theme-manager.js"></script>
</body>
</html>
