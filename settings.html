<!DOCTYPE html>
<html lang="no" data-theme="dark" data-accent="green">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innstillinger - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öôÔ∏è</text></svg>">
    <meta name="theme-color" content="#0f1419">
    <link rel="stylesheet" href="css/main.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <!-- Avatar Builder (optional - falls back to emoji if not found) -->
    <link rel="stylesheet" href="css/avatar-builder.css" onerror="this.remove()">
    <script src="js/avatar-builder.js" onerror="window.AvatarBuilder=null;"></script>
    
    <style>
        /* ========== THEME VARIABLES ========== */
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #2d3748;
            --bg-card: #1e2530;
            --text-primary: #e0e0e0;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --border-color: #2d3748;
            --accent: #4ade80;
            --accent-hover: #22c55e;
            --accent-glow: rgba(74, 222, 128, 0.3);
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --purple: #a855f7;
            --pink: #ec4899;
            --gold: #fbbf24;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 15px;
            --radius-full: 50px;
            --space-xs: 5px;
            --space-sm: 10px;
            --space-md: 15px;
            --space-lg: 20px;
            --space-xl: 30px;
            --transition-fast: 0.15s ease;
        }

        /* Light theme */
        [data-theme="light"] {
            --bg-primary: #f5f5f0;
            --bg-secondary: #fafaf8;
            --bg-tertiary: #eaeae5;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #e5e5e0;
        }

        [data-theme="cream"] {
            --bg-primary: #f9f6f1;
            --bg-secondary: #fffcf7;
            --bg-tertiary: #f0ebe3;
            --bg-card: #fffef9;
            --text-primary: #2d2a26;
            --text-secondary: #5c5650;
            --border-color: #e8e4dc;
        }

        [data-theme="dark-blue"] {
            --bg-primary: #0a192f;
            --bg-secondary: #112240;
            --bg-tertiary: #1d3461;
            --bg-card: #172a46;
            --text-primary: #ccd6f6;
            --text-secondary: #8892b0;
            --border-color: #1d3461;
        }

        [data-theme="midnight"] {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #171717;
            --bg-card: #0f0f0f;
            --text-primary: #fafafa;
            --text-secondary: #a3a3a3;
            --border-color: #262626;
        }

        [data-theme="charcoal"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #242424;
            --bg-tertiary: #333333;
            --bg-card: #2a2a2a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #3d3d3d;
        }

        [data-theme="slate"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        [data-theme="forest"] {
            --bg-primary: #0c1a14;
            --bg-secondary: #142b1f;
            --bg-tertiary: #1f3d2b;
            --bg-card: #183225;
            --text-primary: #d4e8dc;
            --text-secondary: #8fb89e;
            --border-color: #1f3d2b;
        }

        [data-theme="purple-night"] {
            --bg-primary: #13111c;
            --bg-secondary: #1c1829;
            --bg-tertiary: #2d2640;
            --bg-card: #211d30;
            --text-primary: #e8e4f0;
            --text-secondary: #a39bb8;
            --border-color: #2d2640;
        }

        /* Accent colors */
        [data-accent="green"] { --accent: #4ade80; --accent-hover: #22c55e; --accent-glow: rgba(74, 222, 128, 0.3); }
        [data-accent="blue"] { --accent: #3b82f6; --accent-hover: #2563eb; --accent-glow: rgba(59, 130, 246, 0.3); }
        [data-accent="purple"] { --accent: #a855f7; --accent-hover: #9333ea; --accent-glow: rgba(168, 85, 247, 0.3); }
        [data-accent="pink"] { --accent: #ec4899; --accent-hover: #db2777; --accent-glow: rgba(236, 72, 153, 0.3); }
        [data-accent="orange"] { --accent: #f59e0b; --accent-hover: #d97706; --accent-glow: rgba(245, 158, 11, 0.3); }
        [data-accent="cyan"] { --accent: #06b6d4; --accent-hover: #0891b2; --accent-glow: rgba(6, 182, 212, 0.3); }
        [data-accent="red"] { --accent: #ef4444; --accent-hover: #dc2626; --accent-glow: rgba(239, 68, 68, 0.3); }
        [data-accent="yellow"] { --accent: #eab308; --accent-hover: #ca8a04; --accent-glow: rgba(234, 179, 8, 0.3); }
        [data-accent="teal"] { --accent: #14b8a6; --accent-hover: #0d9488; --accent-glow: rgba(20, 184, 166, 0.3); }
        [data-accent="indigo"] { --accent: #6366f1; --accent-hover: #4f46e5; --accent-glow: rgba(99, 102, 241, 0.3); }

        /* ========== BASE ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }

        /* ========== HEADER ========== */
        .aq-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .aq-header-left, .aq-header-right { display: flex; align-items: center; gap: 15px; }

        /* ========== LAYOUT ========== */
        .app-layout { display: flex; min-height: calc(100vh - 60px); }

        .sidebar-panel {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header { 
            padding: var(--space-lg); 
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }
        .sidebar-title { 
            font-weight: 700; 
            color: var(--accent);
            font-size: 1.1em;
        }
        .sidebar-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: var(--space-sm); 
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: 12px var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-size: 0.95em;
        }
        .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: var(--bg-primary); font-weight: 600; }
        .nav-item .nav-icon { font-size: 1.2em; width: 28px; text-align: center; }

        /* Mobile bottom nav */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 8px;
            z-index: 100;
        }
        .mobile-nav-inner {
            display: flex;
            justify-content: space-around;
            max-width: 500px;
            margin: 0 auto;
        }
        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 0.7em;
        }
        .mobile-nav-btn:hover { background: var(--bg-tertiary); }
        .mobile-nav-btn.active { color: var(--accent); }
        .mobile-nav-btn .icon { font-size: 1.5em; }

        .workspace { flex: 1; overflow-y: auto; padding: var(--space-xl); background: var(--bg-primary); }
        .settings-container { max-width: 800px; margin: 0 auto; }

        /* ========== SECTIONS ========== */
        .settings-view { display: none; }
        .settings-view.active { display: block; }

        .settings-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--border-color);
        }

        .settings-section-title {
            color: var(--accent);
            font-size: 1.1em;
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child { border-bottom: none; }

        .setting-label { flex: 1; }
        .setting-label strong { display: block; margin-bottom: 4px; color: var(--text-primary); }
        .setting-label small { color: var(--text-secondary); font-size: 0.85em; }

        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: 10px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .btn:hover { border-color: var(--accent); transform: translateY(-1px); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); }
        .btn-danger { background: var(--error); border-color: var(--error); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .btn-group { display: flex; gap: var(--space-sm); flex-wrap: wrap; margin-top: var(--space-md); }

        /* ========== TOGGLE ========== */
        .toggle {
            position: relative;
            width: 54px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .toggle.active { background: var(--accent); }
        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle.active::after { transform: translateX(26px); }

        /* ========== INPUTS ========== */
        .setting-input, .setting-select {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 1em;
        }
        .setting-input { width: 200px; }
        .setting-select { min-width: 150px; cursor: pointer; }
        .setting-input:focus, .setting-select:focus { outline: none; border-color: var(--accent); }

        /* ========== PROFILE CARD ========== */
        .profile-card {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            padding: var(--space-lg);
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-lg);
        }

        .profile-avatar-wrapper { position: relative; }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            position: relative;
            overflow: hidden;
            border: 3px solid var(--accent);
        }

        .avatar-accessory {
            position: absolute;
            font-size: 1.5em;
        }
        .avatar-accessory.hair { top: -5px; }
        .avatar-accessory.glasses { top: 30%; }
        .avatar-accessory.beard { bottom: 10%; }

        .profile-level-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            background: var(--gold);
            color: #1a1a1a;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            border: 2px solid var(--bg-tertiary);
        }

        .profile-info { flex: 1; }
        .profile-info h2 { color: var(--text-primary); margin-bottom: 4px; }
        .profile-title { color: var(--gold); font-size: 0.9em; margin-bottom: 8px; }
        .profile-info p { color: var(--text-secondary); font-size: 0.9em; }

        /* ========== XP BAR ========== */
        .xp-bar-container { margin-top: var(--space-sm); }
        .xp-bar-label { display: flex; justify-content: space-between; font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px; }
        .xp-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--gold));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ========== STATS GRID ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--space-md);
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            text-align: center;
        }
        .stat-value { font-size: 1.6em; font-weight: bold; color: var(--accent); }
        .stat-label { color: var(--text-secondary); font-size: 0.8em; margin-top: 4px; }

        /* ========== AVATAR BUILDER ========== */
        .avatar-builder {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            background: var(--bg-primary);
            border-radius: 50%;
            margin: 0 auto var(--space-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
            position: relative;
            border: 4px solid var(--accent);
        }

        .customization-row {
            margin-bottom: var(--space-md);
        }
        .customization-row label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: var(--space-xs);
        }

        .option-grid {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .option-btn {
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            position: relative;
        }
        .option-btn:hover { border-color: var(--accent); transform: scale(1.05); }
        .option-btn.active { border-color: var(--accent); background: rgba(74, 222, 128, 0.2); }
        .option-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .option-btn.locked::after {
            content: 'üîí';
            position: absolute;
            bottom: -2px;
            right: -2px;
            font-size: 0.6em;
        }

        /* ========== THEME GRID ========== */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--space-md);
        }

        .theme-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }
        .theme-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .theme-card.active { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

        .theme-preview {
            width: 100%;
            height: 40px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
        }
        .theme-card span { font-size: 0.85em; color: var(--text-secondary); }

        /* ========== ACCENT COLORS ========== */
        .accent-grid { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
        
        .accent-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .accent-btn:hover { transform: scale(1.15); }
        .accent-btn.active { border-color: white; box-shadow: 0 0 10px currentColor; }

        /* ========== BACKGROUND GRID ========== */
        .background-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: var(--space-sm);
        }

        .bg-option {
            aspect-ratio: 16/9;
            border-radius: var(--radius-md);
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            position: relative;
        }
        .bg-option:hover { border-color: var(--accent); }
        .bg-option.active { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }
        .bg-option.locked { opacity: 0.4; }
        .bg-option.locked::after {
            content: 'üîí';
            position: absolute;
            font-size: 0.8em;
        }

        /* ========== ACHIEVEMENTS ========== */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-md);
        }

        .achievement-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all var(--transition-fast);
        }
        .achievement-card.unlocked { border-color: var(--gold); }
        .achievement-card.locked { opacity: 0.5; }
        .achievement-card .icon { font-size: 2em; margin-bottom: var(--space-sm); }
        .achievement-card .name { font-weight: 600; font-size: 0.9em; margin-bottom: 4px; }
        .achievement-card .desc { font-size: 0.75em; color: var(--text-secondary); }
        .achievement-card .reward { font-size: 0.7em; color: var(--gold); margin-top: var(--space-xs); }

        /* ========== UNLOCKS SHOWCASE ========== */
        .unlocks-section {
            margin-top: var(--space-lg);
        }

        .unlock-category {
            margin-bottom: var(--space-md);
        }
        .unlock-category h4 {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .unlock-items {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .unlock-item {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-sm);
            font-size: 1.5em;
            opacity: 0.3;
        }
        .unlock-item.unlocked {
            opacity: 1;
            border-color: var(--accent);
        }

        /* ========== LEVEL PROGRESS ========== */
        .level-section {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-card));
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--gold);
        }

        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .level-display {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .level-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--gold);
        }

        .level-info h3 { color: var(--text-primary); }
        .level-info p { color: var(--text-secondary); font-size: 0.9em; }

        .level-rewards {
            display: flex;
            gap: var(--space-sm);
        }

        .next-reward {
            background: var(--bg-primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .next-reward .icon { font-size: 1.2em; }

        /* ========== DANGER ZONE ========== */
        .danger-zone {
            border: 2px solid var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        .danger-zone .settings-section-title { color: var(--error); }

        /* ========== TOAST ========== */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--accent);
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            display: none;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }
        .toast.show { display: flex; align-items: center; gap: var(--space-sm); }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========== CLASSROOM ========== */
        .classroom-join {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
        }

        .code-input-group {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
            margin: var(--space-lg) 0;
        }

        .code-digit {
            width: 50px;
            height: 60px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent);
        }
        .code-digit:focus { border-color: var(--accent); outline: none; }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .sidebar-panel { display: none; }
            .mobile-nav { display: block; }
            .workspace { padding: var(--space-md); padding-bottom: 100px; }
            .profile-card { flex-direction: column; text-align: center; }
            .setting-item { flex-direction: column; align-items: flex-start; gap: var(--space-md); }
            .setting-input, .setting-select { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="aq-header">
        <div class="aq-header-left">
            <a href="index.html" class="btn" style="padding: 8px 16px;">‚Üê Hjem</a>
            <span style="color: var(--accent); font-weight: 600;">‚öôÔ∏è Innstillinger</span>
        </div>
        <div class="aq-header-right">
            <span id="auth-status" style="color: var(--text-secondary); font-size: 0.9em;">Laster...</span>
        </div>
    </header>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar-panel">
            <div class="sidebar-header">
                <span class="sidebar-title">‚öôÔ∏è Innstillinger</span>
            </div>
            <div class="sidebar-content">
                <div class="nav-item active" data-section="profile">
                    <span class="nav-icon">üë§</span> Profil & Avatar
                </div>
                <div class="nav-item" data-section="progression">
                    <span class="nav-icon">üéÆ</span> Progresjon
                </div>
                <div class="nav-item" data-section="appearance">
                    <span class="nav-icon">üé®</span> Utseende
                </div>
                <div class="nav-item" data-section="game">
                    <span class="nav-icon">‚öôÔ∏è</span> Spillinnstillinger
                </div>
                <div class="nav-item" data-section="data">
                    <span class="nav-icon">üíæ</span> Data & Lagring
                </div>
                <div class="nav-item" data-section="account">
                    <span class="nav-icon">üîê</span> Konto
                </div>
            </div>
        </aside>

        <!-- Workspace -->
        <main class="workspace">
            <div class="settings-container">
                
                <!-- ==================== PROFILE SECTION ==================== -->
                <div id="section-profile" class="settings-view active">
                    <!-- Profile Card -->
                    <div class="profile-card">
                        <div class="profile-avatar-wrapper">
                            <div class="profile-avatar" id="profile-avatar">
                                <span id="avatar-face">üòä</span>
                                <span class="avatar-accessory hair" id="avatar-hair"></span>
                                <span class="avatar-accessory glasses" id="avatar-glasses"></span>
                                <span class="avatar-accessory beard" id="avatar-beard"></span>
                            </div>
                            <div class="profile-level-badge" id="profile-level">1</div>
                        </div>
                        <div class="profile-info">
                            <h2 id="profile-name">Gjest</h2>
                            <p class="profile-title" id="profile-title-display">üå± Nybegynner</p>
                            <p id="profile-email">Ikke logget inn</p>
                            <div class="xp-bar-container">
                                <div class="xp-bar-label">
                                    <span><span id="current-xp">0</span> XP</span>
                                    <span><span id="next-level-xp">100</span> XP til neste level</span>
                                </div>
                                <div class="xp-bar">
                                    <div class="xp-bar-fill" id="xp-bar-fill" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Username -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">‚úèÔ∏è Brukernavn</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Ditt navn</strong>
                                <small>Vises p√• leaderboards og i klasserom</small>
                            </div>
                            <input type="text" class="setting-input" id="username" placeholder="Skriv navn..." onchange="saveProfile()">
                        </div>
                    </div>

                    <!-- Avatar Builder -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üé≠ Avatar Builder</h3>
                        
                        <div class="avatar-builder" id="avatar-builder-container">
                            <!-- Rendered by AvatarBuilder.renderBuilder() or fallback emoji system -->
                        </div>
                        
                        <!-- Fallback emoji-based builder if images not available -->
                        <div class="avatar-builder-fallback" id="avatar-builder-fallback" style="display:none;">
                            <div class="avatar-preview" id="avatar-preview">
                                <span id="preview-face">üòä</span>
                            </div>

                            <!-- Face -->
                            <div class="customization-row">
                                <label>Ansikt</label>
                                <div class="option-grid" id="face-options">
                                    <button class="option-btn active" data-type="face" data-value="üòä">üòä</button>
                                    <button class="option-btn" data-type="face" data-value="üòé">üòé</button>
                                    <button class="option-btn" data-type="face" data-value="ü§ì">ü§ì</button>
                                    <button class="option-btn" data-type="face" data-value="üòÑ">üòÑ</button>
                                    <button class="option-btn locked" data-type="face" data-value="ü¶Å" data-unlock="level-10">ü¶Å</button>
                                    <button class="option-btn locked" data-type="face" data-value="üê∫" data-unlock="level-20">üê∫</button>
                                    <button class="option-btn locked" data-type="face" data-value="ü¶ä" data-unlock="level-30">ü¶ä</button>
                                    <button class="option-btn locked" data-type="face" data-value="üê≤" data-unlock="level-50">üê≤</button>
                                </div>
                            </div>

                            <!-- Hair -->
                            <div class="customization-row">
                                <label>Hodeplagg</label>
                                <div class="option-grid" id="hair-options">
                                    <button class="option-btn active" data-type="hair" data-value="">‚ùå</button>
                                    <button class="option-btn" data-type="hair" data-value="üëí">üëí</button>
                                    <button class="option-btn" data-type="hair" data-value="üé©">üé©</button>
                                    <button class="option-btn" data-type="hair" data-value="üß¢">üß¢</button>
                                    <button class="option-btn locked" data-type="hair" data-value="üëë" data-unlock="achievement-king">üëë</button>
                                    <button class="option-btn locked" data-type="hair" data-value="üéì" data-unlock="level-25">üéì</button>
                                </div>
                            </div>

                            <!-- Accessories -->
                            <div class="customization-row">
                                <label>Tilbeh√∏r</label>
                                <div class="option-grid" id="accessory-options">
                                    <button class="option-btn active" data-type="accessory" data-value="">‚ùå</button>
                                    <button class="option-btn" data-type="accessory" data-value="üëì">üëì</button>
                                    <button class="option-btn" data-type="accessory" data-value="üï∂Ô∏è">üï∂Ô∏è</button>
                                    <button class="option-btn locked" data-type="accessory" data-value="üßê" data-unlock="level-15">üßê</button>
                                </div>
                            </div>
                        </div>
                        
                        <p style="color: var(--text-muted); font-size: 0.8em; margin-top: var(--space-md); text-align: center;">
                            üîí L√•s opp flere ved √• levle opp eller fullf√∏re achievements
                        </p>
                    </div>

                    <!-- Title Selection -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üè∑Ô∏è Tittel</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Velg tittel</strong>
                                <small>Vises under navnet ditt</small>
                            </div>
                            <select class="setting-select" id="title-select" onchange="updateTitle()">
                                <option value="nybegynner">üå± Nybegynner</option>
                                <option value="laerling">üìö L√¶rling</option>
                                <option value="student" disabled>üéì Student (Level 10)</option>
                                <option value="regnskapsforer" disabled>üìä Regnskapsf√∏rer (Level 25)</option>
                                <option value="revisor" disabled>üîç Revisor (Level 40)</option>
                                <option value="okonom" disabled>üíº √òkonom (Level 60)</option>
                                <option value="cfo" disabled>üèÜ CFO (Level 80)</option>
                                <option value="mester" disabled>üëë Mester (Level 100)</option>
                                <option value="perfectionist" disabled>‚≠ê Perfeksjonist (Achievement)</option>
                                <option value="speedrunner" disabled>‚ö° Speedrunner (Achievement)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ==================== PROGRESSION SECTION ==================== -->
                <div id="section-progression" class="settings-view">
                    <!-- Level Display -->
                    <div class="level-section">
                        <div class="level-header">
                            <div class="level-display">
                                <div class="level-number" id="big-level">1</div>
                                <div class="level-info">
                                    <h3>Level <span id="level-text">1</span> av 100</h3>
                                    <p><span id="total-xp">0</span> total XP</p>
                                </div>
                            </div>
                            <div class="level-rewards">
                                <div class="next-reward">
                                    <span class="icon">üéÅ</span>
                                    <span>Level 5: Ny bakgrunn</span>
                                </div>
                            </div>
                        </div>
                        <div class="xp-bar" style="height: 12px;">
                            <div class="xp-bar-fill" id="big-xp-bar" style="width: 0%"></div>
                        </div>
                        <p style="text-align: center; margin-top: var(--space-sm); color: var(--text-secondary); font-size: 0.9em;">
                            <span id="xp-to-next">100</span> XP til level <span id="next-level-num">2</span>
                        </p>
                    </div>

                    <!-- Stats -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üìä Statistikk</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-completed">0</div>
                                <div class="stat-label">Oppgaver fullf√∏rt</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-correct">0%</div>
                                <div class="stat-label">Riktig</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-streak">0</div>
                                <div class="stat-label">üî• Streak</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-time">0h</div>
                                <div class="stat-label">Spilletid</div>
                            </div>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üèÜ Achievements</h3>
                        <div class="achievements-grid" id="achievements-grid">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Unlocks Showcase -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üéÅ Oppl√•ste bel√∏nninger</h3>
                        <div class="unlocks-section">
                            <div class="unlock-category">
                                <h4>Ansikter (4/8)</h4>
                                <div class="unlock-items" id="unlock-faces">
                                    <div class="unlock-item unlocked">üòä</div>
                                    <div class="unlock-item unlocked">üòé</div>
                                    <div class="unlock-item unlocked">ü§ì</div>
                                    <div class="unlock-item unlocked">üòÑ</div>
                                    <div class="unlock-item">ü¶Å</div>
                                    <div class="unlock-item">üê∫</div>
                                    <div class="unlock-item">ü¶ä</div>
                                    <div class="unlock-item">üê≤</div>
                                </div>
                            </div>
                            <div class="unlock-category">
                                <h4>Hodeplagg (3/5)</h4>
                                <div class="unlock-items" id="unlock-hats">
                                    <div class="unlock-item unlocked">üëí</div>
                                    <div class="unlock-item unlocked">üé©</div>
                                    <div class="unlock-item unlocked">üß¢</div>
                                    <div class="unlock-item">üëë</div>
                                    <div class="unlock-item">üéì</div>
                                </div>
                            </div>
                            <div class="unlock-category">
                                <h4>Titler (2/10)</h4>
                                <div class="unlock-items" id="unlock-titles">
                                    <div class="unlock-item unlocked">üå±</div>
                                    <div class="unlock-item unlocked">üìö</div>
                                    <div class="unlock-item">üéì</div>
                                    <div class="unlock-item">üìä</div>
                                    <div class="unlock-item">üîç</div>
                                    <div class="unlock-item">üíº</div>
                                    <div class="unlock-item">üèÜ</div>
                                    <div class="unlock-item">üëë</div>
                                </div>
                            </div>
                            <div class="unlock-category">
                                <h4>Bakgrunner (1/6)</h4>
                                <div class="unlock-items" id="unlock-backgrounds">
                                    <div class="unlock-item unlocked">üåô</div>
                                    <div class="unlock-item">üåÖ</div>
                                    <div class="unlock-item">üåä</div>
                                    <div class="unlock-item">üå≤</div>
                                    <div class="unlock-item">üèîÔ∏è</div>
                                    <div class="unlock-item">üåå</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== APPEARANCE SECTION ==================== -->
                <div id="section-appearance" class="settings-view">
                    <!-- Theme -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üé® Tema</h3>
                        <div class="theme-grid">
                            <div class="theme-card" data-theme="dark">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #0f1419, #1a1f26);"></div>
                                <span>üåô M√∏rk</span>
                            </div>
                            <div class="theme-card" data-theme="light">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #f5f5f0, #fafaf8);"></div>
                                <span>‚òÄÔ∏è Lys</span>
                            </div>
                            <div class="theme-card" data-theme="cream">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #f9f6f1, #fffcf7);"></div>
                                <span>üç¶ Krem</span>
                            </div>
                            <div class="theme-card" data-theme="dark-blue">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #0a192f, #112240);"></div>
                                <span>üåä Navy</span>
                            </div>
                            <div class="theme-card" data-theme="midnight">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #000000, #0a0a0a);"></div>
                                <span>üåë Midnight</span>
                            </div>
                            <div class="theme-card" data-theme="charcoal">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #1a1a1a, #242424);"></div>
                                <span>‚¨õ Charcoal</span>
                            </div>
                            <div class="theme-card" data-theme="slate">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #0f172a, #1e293b);"></div>
                                <span>ü™® Slate</span>
                            </div>
                            <div class="theme-card" data-theme="forest">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #0c1a14, #142b1f);"></div>
                                <span>üå≤ Forest</span>
                            </div>
                            <div class="theme-card" data-theme="purple-night">
                                <div class="theme-preview" style="background: linear-gradient(135deg, #13111c, #1c1829);"></div>
                                <span>üíú Purple</span>
                            </div>
                        </div>
                    </div>

                    <!-- Accent Color -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">‚ú® Aksentfarge</h3>
                        <div class="accent-grid">
                            <button class="accent-btn" data-accent="green" style="background: #4ade80;"></button>
                            <button class="accent-btn" data-accent="blue" style="background: #3b82f6;"></button>
                            <button class="accent-btn" data-accent="purple" style="background: #a855f7;"></button>
                            <button class="accent-btn" data-accent="pink" style="background: #ec4899;"></button>
                            <button class="accent-btn" data-accent="orange" style="background: #f59e0b;"></button>
                            <button class="accent-btn" data-accent="cyan" style="background: #06b6d4;"></button>
                            <button class="accent-btn" data-accent="red" style="background: #ef4444;"></button>
                            <button class="accent-btn" data-accent="yellow" style="background: #eab308;"></button>
                            <button class="accent-btn" data-accent="teal" style="background: #14b8a6;"></button>
                            <button class="accent-btn" data-accent="indigo" style="background: #6366f1;"></button>
                        </div>
                    </div>

                    <!-- Background -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üñºÔ∏è Bakgrunn</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: var(--space-md);">
                            L√•s opp flere bakgrunner ved √• levle opp eller fullf√∏re achievements!
                        </p>
                        <div class="background-grid" id="background-grid">
                            <div class="bg-option active" data-bg="default" style="background: var(--bg-primary);">
                                <span>üåô</span>
                            </div>
                            <div class="bg-option locked" data-bg="gradient1" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <span>üîí</span>
                            </div>
                            <div class="bg-option locked" data-bg="gradient2" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <span>üîí</span>
                            </div>
                            <div class="bg-option locked" data-bg="gradient3" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
                                <span>üîí</span>
                            </div>
                            <div class="bg-option locked" data-bg="gradient4" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                                <span>üîí</span>
                            </div>
                            <div class="bg-option locked" data-bg="stars" style="background: #0a0a0a;">
                                <span>üîí</span>
                            </div>
                        </div>
                    </div>

                    <!-- Font Size -->
                    <div class="settings-section">
                        <h3 class="settings-section-title">üî§ Tekstst√∏rrelse</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Skriftst√∏rrelse</strong>
                                <small>Juster for bedre lesbarhet</small>
                            </div>
                            <select class="setting-select" id="fontsize" onchange="changeFontSize(this.value)">
                                <option value="small">Liten</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Stor</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ==================== GAME SETTINGS SECTION ==================== -->
                <div id="section-game" class="settings-view">
                    <div class="settings-section">
                        <h3 class="settings-section-title">üîä Lyd</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Lydeffekter</strong>
                                <small>Lyd ved riktig/feil svar</small>
                            </div>
                            <div class="toggle" id="toggle-sounds" onclick="toggleSetting('sounds')"></div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Bakgrunnsmusikk</strong>
                                <small>Avslappende musikk under spill</small>
                            </div>
                            <div class="toggle" id="toggle-music" onclick="toggleSetting('music')"></div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Volum</strong>
                            </div>
                            <input type="range" min="0" max="100" value="50" id="volume" style="width: 150px;" onchange="updateVolume(this.value)">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-section-title">üí° Hjelpemidler</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Vis hints</strong>
                                <small>Tillat bruk av hint-knappen</small>
                            </div>
                            <div class="toggle active" id="toggle-hints" onclick="toggleSetting('hints')"></div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Vis forklaringer</strong>
                                <small>Detaljert forklaring etter hvert svar</small>
                            </div>
                            <div class="toggle active" id="toggle-explanations" onclick="toggleSetting('explanations')"></div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Animasjoner</strong>
                                <small>Visuelle effekter og overganger</small>
                            </div>
                            <div class="toggle active" id="toggle-animations" onclick="toggleSetting('animations')"></div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-section-title">‚è±Ô∏è Timer & Vanskelighet</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Standard tidsbegrensning</strong>
                                <small>Sekunder per sp√∏rsm√•l (0 = ubegrenset)</small>
                            </div>
                            <select class="setting-select" id="quiz-timer" onchange="updateSetting('quizTimer', this.value)">
                                <option value="0">Ingen</option>
                                <option value="15">15 sek</option>
                                <option value="30" selected>30 sek</option>
                                <option value="60">60 sek</option>
                                <option value="120">2 min</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Standard vanskelighetsgrad</strong>
                                <small>P√•virker hvilke oppgaver du f√•r</small>
                            </div>
                            <select class="setting-select" id="difficulty" onchange="updateSetting('difficulty', this.value)">
                                <option value="easy">Lett</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Vanskelig</option>
                                <option value="expert">Ekspert</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-section-title">‚å®Ô∏è Snarveier</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Tastatursnareveier</strong>
                                <small>1-4 for svar, Enter for bekreft</small>
                            </div>
                            <div class="toggle active" id="toggle-shortcuts" onclick="toggleSetting('shortcuts')"></div>
                        </div>
                    </div>
                </div>

                <!-- ==================== DATA SECTION ==================== -->
                <div id="section-data" class="settings-view">
                    <div class="settings-section">
                        <h3 class="settings-section-title">üíæ Lagring</h3>
                        <div class="stats-grid" style="margin-bottom: var(--space-lg);">
                            <div class="stat-card">
                                <div class="stat-value" id="storage-size">0 KB</div>
                                <div class="stat-label">Brukt lagring</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="modules-count">0</div>
                                <div class="stat-label">Moduler</div>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn" onclick="exportData()">üì§ Eksporter data</button>
                            <button class="btn" onclick="importData()">üì• Importer data</button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-section-title">‚òÅÔ∏è Skylagring</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Synkroniser med sky</strong>
                                <small>Krever innlogging. Lagrer fremgang p√• tvers av enheter.</small>
                            </div>
                            <div class="toggle" id="toggle-sync" onclick="toggleSetting('sync')"></div>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.85em; margin-top: var(--space-sm);">
                            Sist synkronisert: <span id="last-sync">Aldri</span>
                        </p>
                    </div>

                    <div class="settings-section danger-zone">
                        <h3 class="settings-section-title">‚ö†Ô∏è Faresone</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Nullstill fremgang</strong>
                                <small>Slett all lokal fremgangsdata</small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="resetProgress()">Nullstill</button>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <strong>Slett all data</strong>
                                <small>Fjern ALL lokal data permanent</small>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="clearAllData()">Slett alt</button>
                        </div>
                    </div>
                </div>

                <!-- ==================== ACCOUNT SECTION ==================== -->
                <div id="section-account" class="settings-view">
                    <div class="settings-section">
                        <h3 class="settings-section-title">üîê Konto</h3>
                        <div id="auth-section">
                            <div id="auth-loading" style="text-align: center; padding: var(--space-lg);">
                                <p>üîÑ Sjekker innloggingsstatus...</p>
                            </div>
                            <div id="auth-logged-out" style="display: none;">
                                <p style="color: var(--text-secondary); margin-bottom: var(--space-lg);">
                                    Logg inn for √• synkronisere fremgang og delta i klasserom.
                                </p>
                                <div class="btn-group">
                                    <a href="auth.html" class="btn btn-primary">üîë Logg inn</a>
                                    <a href="auth.html?mode=register" class="btn">üìù Registrer deg</a>
                                </div>
                            </div>
                            <div id="auth-logged-in" style="display: none;">
                                <div class="setting-item">
                                    <div class="setting-label">
                                        <strong>Innlogget som</strong>
                                        <small id="user-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="660414130d031426031e070b160a034805090b">[email&#160;protected]</a></small>
                                    </div>
                                    <button class="btn btn-sm" onclick="signOut()">Logg ut</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h3 class="settings-section-title">üè´ Klasserom</h3>
                        <div class="classroom-join">
                            <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">
                                Har du en klassekode fra l√¶reren din?
                            </p>
                            <div class="code-input-group">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                                <input type="text" class="code-digit" maxlength="1" inputmode="numeric">
                            </div>
                            <p id="code-error" style="color: var(--error); display: none; margin-bottom: var(--space-md);">
                                Ugyldig kode. Sjekk at du har skrevet riktig.
                            </p>
                            <button class="btn btn-primary" onclick="joinClassroom()">Bli med i klasserom</button>
                        </div>

                        <div id="my-classrooms" style="margin-top: var(--space-lg);">
                            <h4 style="color: var(--text-secondary); margin-bottom: var(--space-sm);">Mine klasserom</h4>
                            <p style="color: var(--text-muted); font-size: 0.9em;">Du er ikke med i noen klasserom enn√•.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <button class="mobile-nav-btn active" data-section="profile">
                <span class="icon">üë§</span>
                <span>Profil</span>
            </button>
            <button class="mobile-nav-btn" data-section="progression">
                <span class="icon">üéÆ</span>
                <span>Level</span>
            </button>
            <button class="mobile-nav-btn" data-section="appearance">
                <span class="icon">üé®</span>
                <span>Tema</span>
            </button>
            <button class="mobile-nav-btn" data-section="game">
                <span class="icon">‚öôÔ∏è</span>
                <span>Spill</span>
            </button>
            <button class="mobile-nav-btn" data-section="account">
                <span class="icon">üîê</span>
                <span>Konto</span>
            </button>
        </div>
    </nav>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-icon">‚úÖ</span>
        <span id="toast-message">Lagret!</span>
    </div>

    <!-- Theme Manager -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="js/theme-manager.js"></script>

    <script>
        // ==================== STATE ====================
        var settings = {
            sounds: false,
            music: false,
            hints: true,
            explanations: true,
            animations: true,
            shortcuts: true,
            sync: false,
            volume: 50,
            fontsize: 'medium',
            quizTimer: 30,
            difficulty: 'medium'
        };

        var playerData = {
            level: 1,
            xp: 0,
            totalXp: 0,
            username: '',
            avatar: { face: 'üòä', hair: '', accessory: '' },
            title: 'nybegynner',
            unlockedItems: {
                faces: ['üòä', 'üòé', 'ü§ì', 'üòÑ'],
                hairs: ['', 'üëí', 'üé©'],
                accessories: [''],
                titles: ['nybegynner', 'laerling'],
                backgrounds: ['default']
            },
            achievements: []
        };

        // XP required per level (level 1-100)
        var XP_PER_LEVEL = 100;
        var MAX_LEVEL = 100;

        // ==================== ACHIEVEMENTS ====================
        var ACHIEVEMENTS = [
            { id: 'first_question', name: 'F√∏rste steg', desc: 'Fullf√∏r din f√∏rste oppgave', icon: 'üéØ', reward: '50 XP', xpReward: 50 },
            { id: 'streak_7', name: 'Uke-streak', desc: '7 dager p√• rad', icon: 'üî•', reward: 'Tilbeh√∏r: üòà', unlock: 'accessory-devil' },
            { id: 'streak_30', name: 'M√•ned-streak', desc: '30 dager p√• rad', icon: 'üí™', reward: '500 XP', xpReward: 500 },
            { id: 'perfect_10', name: 'Perfeksjonist', desc: '10 oppgaver p√• rad uten feil', icon: '‚≠ê', reward: 'Tittel: Perfeksjonist', unlock: 'title-perfectionist' },
            { id: 'speed_demon', name: 'Speedrunner', desc: 'Fullf√∏r 5 oppgaver under 10 sek hver', icon: '‚ö°', reward: 'Tittel: Speedrunner', unlock: 'title-speedrunner' },
            { id: 'bokforing_master', name: 'Bokf√∏ringsmester', desc: 'Fullf√∏r alle bokf√∏ringsoppgaver', icon: 'üìö', reward: '300 XP', xpReward: 300 },
            { id: 'finance_guru', name: 'Finansguru', desc: 'Fullf√∏r alle corporate finance oppgaver', icon: 'üìä', reward: 'Ansikt: ü¶Å', unlock: 'face-lion' },
            { id: 'completionist', name: 'Kompletist', desc: 'Fullf√∏r alle oppgaver i spillet', icon: 'üëë', reward: 'Hodeplagg: üëë', unlock: 'hat-crown' },
            { id: 'early_bird', name: 'Morgenfugl', desc: 'Spill f√∏r kl. 07:00', icon: 'üåÖ', reward: 'Bakgrunn', unlock: 'bg-sunrise' },
            { id: 'night_owl', name: 'Nattugla', desc: 'Spill etter kl. 23:00', icon: 'ü¶â', reward: 'Bakgrunn', unlock: 'bg-stars' }
        ];

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            loadPlayerData();
            initUI();
            initTheme();
            initAuth();
            initAvatarBuilder();
            setupEventListeners();
            renderAchievements();
            calculateStorage();
        });

        // ==================== AVATAR BUILDER ====================
        function initAvatarBuilder() {
            // Check if AvatarBuilder with images is available
            if (typeof AvatarBuilder !== 'undefined' && AvatarBuilder !== null) {
                try {
                    AvatarBuilder.init({
                        basePath: 'assets/avatar/',
                        level: playerData.level,
                        achievements: playerData.achievements
                    });
                    
                    AvatarBuilder.renderBuilder('avatar-builder-container', {
                        previewId: 'avatar-live-preview',
                        onSelect: function(result) {
                            if (result.locked) {
                                showToast('üîí ' + result.unlockText, 'üîí');
                            } else {
                                updateProfileAvatar();
                                showToast('Avatar oppdatert!');
                            }
                        }
                    });
                    
                    console.log('[Settings] AvatarBuilder initialized with images');
                    return;
                } catch (e) {
                    console.warn('[Settings] AvatarBuilder failed, using emoji fallback:', e);
                }
            }
            
            // Fallback to emoji system
            document.getElementById('avatar-builder-container').style.display = 'none';
            document.getElementById('avatar-builder-fallback').style.display = 'block';
            console.log('[Settings] Using emoji avatar fallback');
        }
        
        function updateProfileAvatar() {
            // Update profile card avatar
            if (typeof AvatarBuilder !== 'undefined' && AvatarBuilder !== null) {
                AvatarBuilder.render('profile-avatar', 100);
            }
        }

        function loadSettings() {
            var saved = localStorage.getItem('aq_settings');
            if (saved) {
                settings = Object.assign(settings, JSON.parse(saved));
            }
        }

        function loadPlayerData() {
            var saved = localStorage.getItem('aq_player');
            if (saved) {
                playerData = Object.assign(playerData, JSON.parse(saved));
            }
            // Also load username from legacy storage
            playerData.username = playerData.username || localStorage.getItem('aq_username') || '';
        }

        function saveSettings() {
            localStorage.setItem('aq_settings', JSON.stringify(settings));
            showToast('Lagret!');
        }

        function savePlayerData() {
            localStorage.setItem('aq_player', JSON.stringify(playerData));
        }

        // ==================== UI ====================
        function initUI() {
            // Apply settings to toggles
            ['sounds', 'music', 'hints', 'explanations', 'animations', 'shortcuts', 'sync'].forEach(function(key) {
                var toggle = document.getElementById('toggle-' + key);
                if (toggle) toggle.classList.toggle('active', settings[key]);
            });

            // Apply selects
            document.getElementById('username').value = playerData.username;
            document.getElementById('volume').value = settings.volume;
            document.getElementById('fontsize').value = settings.fontsize;
            document.getElementById('quiz-timer').value = settings.quizTimer;
            document.getElementById('difficulty').value = settings.difficulty;

            // Update profile display
            updateProfileDisplay();
            updateLevelDisplay();
            updateAvatarPreview();
            loadStats();
        }

        function initTheme() {
            var currentTheme = localStorage.getItem('aq_theme') || 'dark';
            var currentAccent = localStorage.getItem('aq_accent') || 'green';

            document.documentElement.setAttribute('data-theme', currentTheme);
            document.documentElement.setAttribute('data-accent', currentAccent);

            // Mark active theme/accent
            document.querySelectorAll('.theme-card').forEach(function(card) {
                card.classList.toggle('active', card.dataset.theme === currentTheme);
            });
            document.querySelectorAll('.accent-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.accent === currentAccent);
            });
        }

        function setupEventListeners() {
            // Theme cards
            document.querySelectorAll('.theme-card').forEach(function(card) {
                card.addEventListener('click', function() {
                    var theme = this.dataset.theme;
                    document.documentElement.setAttribute('data-theme', theme);
                    localStorage.setItem('aq_theme', theme);
                    document.querySelectorAll('.theme-card').forEach(function(c) { c.classList.remove('active'); });
                    this.classList.add('active');
                    showToast('Tema endret!');
                });
            });

            // Accent buttons
            document.querySelectorAll('.accent-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var accent = this.dataset.accent;
                    document.documentElement.setAttribute('data-accent', accent);
                    localStorage.setItem('aq_accent', accent);
                    document.querySelectorAll('.accent-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    showToast('Farge endret!');
                });
            });

            // Avatar options
            document.querySelectorAll('.option-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('locked')) {
                        showToast('üîí L√•s opp ved ' + (this.dataset.unlock || '√• levle opp'), 'üîí');
                        return;
                    }
                    var type = this.dataset.type;
                    var value = this.dataset.value;
                    
                    // Update selection
                    this.parentElement.querySelectorAll('.option-btn').forEach(function(b) { b.classList.remove('active'); });
                    this.classList.add('active');
                    
                    // Update avatar
                    playerData.avatar[type] = value;
                    savePlayerData();
                    updateAvatarPreview();
                    updateProfileDisplay();
                });
            });

            // Sidebar nav
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    showSection(this.dataset.section);
                });
            });

            // Mobile nav
            document.querySelectorAll('.mobile-nav-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    showSection(this.dataset.section);
                });
            });

            // Code input
            document.querySelectorAll('.code-digit').forEach(function(input, index) {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    if (this.value && index < 5) {
                        document.querySelectorAll('.code-digit')[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && index > 0) {
                        document.querySelectorAll('.code-digit')[index - 1].focus();
                    }
                });
            });
        }

        // ==================== SECTIONS ====================
        function showSection(section) {
            // Update sidebar
            document.querySelectorAll('.nav-item').forEach(function(n) { 
                n.classList.toggle('active', n.dataset.section === section);
            });

            // Update mobile nav
            document.querySelectorAll('.mobile-nav-btn').forEach(function(b) { 
                b.classList.toggle('active', b.dataset.section === section);
            });

            // Show section
            document.querySelectorAll('.settings-view').forEach(function(v) { v.classList.remove('active'); });
            var sectionEl = document.getElementById('section-' + section);
            if (sectionEl) sectionEl.classList.add('active');
        }

        // ==================== PROFILE ====================
        function updateProfileDisplay() {
            document.getElementById('profile-name').textContent = playerData.username || 'Gjest';
            document.getElementById('profile-level').textContent = playerData.level;
            
            var titles = {
                'nybegynner': 'üå± Nybegynner',
                'laerling': 'üìö L√¶rling',
                'student': 'üéì Student',
                'regnskapsforer': 'üìä Regnskapsf√∏rer',
                'revisor': 'üîç Revisor',
                'okonom': 'üíº √òkonom',
                'cfo': 'üèÜ CFO',
                'mester': 'üëë Mester'
            };
            document.getElementById('profile-title-display').textContent = titles[playerData.title] || titles.nybegynner;
        }

        function updateAvatarPreview() {
            var face = playerData.avatar.face || 'üòä';
            document.getElementById('avatar-face').textContent = face;
            document.getElementById('preview-face').textContent = face;
            document.getElementById('avatar-hair').textContent = playerData.avatar.hair || '';
            document.getElementById('avatar-glasses').textContent = playerData.avatar.accessory || '';
        }

        function saveProfile() {
            var username = document.getElementById('username').value.trim();
            if (username) {
                playerData.username = username;
                localStorage.setItem('aq_username', username);
                savePlayerData();
                updateProfileDisplay();
                showToast('Profil lagret!');
            }
        }

        function updateTitle() {
            var title = document.getElementById('title-select').value;
            playerData.title = title;
            savePlayerData();
            updateProfileDisplay();
        }

        // ==================== LEVEL SYSTEM ====================
        function updateLevelDisplay() {
            var level = playerData.level;
            var xpInLevel = playerData.xp;
            var xpNeeded = getXpForLevel(level);
            var percent = Math.min(100, (xpInLevel / xpNeeded) * 100);

            document.getElementById('profile-level').textContent = level;
            document.getElementById('big-level').textContent = level;
            document.getElementById('level-text').textContent = level;
            document.getElementById('current-xp').textContent = xpInLevel;
            document.getElementById('total-xp').textContent = playerData.totalXp;
            document.getElementById('next-level-xp').textContent = xpNeeded - xpInLevel;
            document.getElementById('xp-to-next').textContent = xpNeeded - xpInLevel;
            document.getElementById('next-level-num').textContent = Math.min(level + 1, MAX_LEVEL);

            document.getElementById('xp-bar-fill').style.width = percent + '%';
            document.getElementById('big-xp-bar').style.width = percent + '%';
        }

        function getXpForLevel(level) {
            // Progressive XP: 100, 150, 200, 250... per level
            return 100 + (level - 1) * 50;
        }

        function addXp(amount) {
            playerData.xp += amount;
            playerData.totalXp += amount;

            // Check for level up
            while (playerData.xp >= getXpForLevel(playerData.level) && playerData.level < MAX_LEVEL) {
                playerData.xp -= getXpForLevel(playerData.level);
                playerData.level++;
                onLevelUp(playerData.level);
            }

            savePlayerData();
            updateLevelDisplay();
        }

        function onLevelUp(newLevel) {
            showToast('üéâ Level ' + newLevel + '!', 'üéâ');
            
            // Unlock rewards
            var rewards = {
                5: { type: 'background', item: 'gradient1' },
                10: { type: 'face', item: 'ü¶Å' },
                15: { type: 'accessory', item: 'üßê' },
                20: { type: 'face', item: 'üê∫' },
                25: { type: 'title', item: 'student' },
                30: { type: 'face', item: 'ü¶ä' },
                40: { type: 'title', item: 'revisor' },
                50: { type: 'face', item: 'üê≤' },
                60: { type: 'title', item: 'okonom' },
                80: { type: 'title', item: 'cfo' },
                100: { type: 'title', item: 'mester' }
            };

            if (rewards[newLevel]) {
                unlockItem(rewards[newLevel].type, rewards[newLevel].item);
            }
        }

        function unlockItem(type, item) {
            var key = type + 's'; // faces, hairs, etc.
            if (playerData.unlockedItems[key] && !playerData.unlockedItems[key].includes(item)) {
                playerData.unlockedItems[key].push(item);
                savePlayerData();
                showToast('üéÅ Ny ' + type + ' l√•st opp: ' + item, 'üéÅ');
            }
        }

        // ==================== ACHIEVEMENTS ====================
        function renderAchievements() {
            var grid = document.getElementById('achievements-grid');
            grid.innerHTML = ACHIEVEMENTS.map(function(ach) {
                var unlocked = playerData.achievements.includes(ach.id);
                return '<div class="achievement-card ' + (unlocked ? 'unlocked' : 'locked') + '">' +
                    '<div class="icon">' + ach.icon + '</div>' +
                    '<div class="name">' + ach.name + '</div>' +
                    '<div class="desc">' + ach.desc + '</div>' +
                    '<div class="reward">' + ach.reward + '</div>' +
                '</div>';
            }).join('');
        }

        // ==================== SETTINGS ====================
        function toggleSetting(key) {
            settings[key] = !settings[key];
            var toggle = document.getElementById('toggle-' + key);
            if (toggle) toggle.classList.toggle('active', settings[key]);
            saveSettings();
        }

        function updateSetting(key, value) {
            settings[key] = value;
            saveSettings();
        }

        function updateVolume(value) {
            settings.volume = parseInt(value);
            saveSettings();
        }

        function changeFontSize(size) {
            settings.fontsize = size;
            document.documentElement.style.fontSize = { 'small': '14px', 'medium': '16px', 'large': '18px' }[size];
            saveSettings();
        }

        // ==================== STATS ====================
        function loadStats() {
            var totalCompleted = 0;
            var totalCorrect = 0;
            var totalAttempts = 0;

            ['grunnleggende', 'corporate_finance', 'matte_okonomi'].forEach(function(module) {
                var progress = localStorage.getItem('aq_progress_' + module);
                if (progress) {
                    var data = JSON.parse(progress);
                    totalCompleted += data.completed || 0;
                    totalCorrect += data.correct || 0;
                    totalAttempts += data.attempts || 0;
                }
            });

            document.getElementById('stat-completed').textContent = totalCompleted;
            document.getElementById('stat-correct').textContent = totalAttempts > 0 ? Math.round(totalCorrect / totalAttempts * 100) + '%' : '0%';
            document.getElementById('stat-streak').textContent = localStorage.getItem('aq_streak') || 0;
            document.getElementById('stat-time').textContent = Math.round((parseInt(localStorage.getItem('aq_playtime') || 0)) / 3600) + 'h';
        }

        function calculateStorage() {
            var total = 0;
            var moduleCount = 0;
            for (var key in localStorage) {
                if (key.startsWith('aq_')) {
                    total += (localStorage[key] || '').length * 2;
                    if (key.includes('progress_')) moduleCount++;
                }
            }
            document.getElementById('storage-size').textContent = (total / 1024).toFixed(1) + ' KB';
            document.getElementById('modules-count').textContent = moduleCount;
        }

        // ==================== DATA ====================
        function exportData() {
            var data = { settings: settings, player: playerData };
            for (var key in localStorage) {
                if (key.startsWith('aq_')) data[key] = localStorage[key];
            }
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'accountingquest-backup-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            showToast('Data eksportert!');
        }

        function importData() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        var data = JSON.parse(event.target.result);
                        Object.keys(data).forEach(function(key) {
                            if (key.startsWith('aq_')) localStorage.setItem(key, data[key]);
                        });
                        if (data.settings) settings = data.settings;
                        if (data.player) playerData = data.player;
                        saveSettings();
                        savePlayerData();
                        showToast('Data importert!');
                        location.reload();
                    } catch (err) {
                        alert('Kunne ikke lese filen: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function resetProgress() {
            if (!confirm('Er du sikker? All fremgang vil bli slettet.')) return;
            ['grunnleggende', 'corporate_finance', 'matte_okonomi', 'quiz'].forEach(function(m) {
                localStorage.removeItem('aq_progress_' + m);
            });
            localStorage.removeItem('aq_streak');
            localStorage.removeItem('aq_xp');
            showToast('Fremgang nullstilt');
            loadStats();
        }

        function clearAllData() {
            if (!confirm('ADVARSEL: All data vil bli permanent slettet!')) return;
            if (!confirm('Er du HELT sikker?')) return;
            Object.keys(localStorage).filter(function(k) { return k.startsWith('aq_'); }).forEach(function(k) {
                localStorage.removeItem(k);
            });
            showToast('All data slettet');
            location.reload();
        }

        // ==================== AUTH ====================
        function initAuth() {
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged(function(user) {
                    document.getElementById('auth-loading').style.display = 'none';
                    if (user) {
                        document.getElementById('auth-logged-in').style.display = 'block';
                        document.getElementById('auth-logged-out').style.display = 'none';
                        document.getElementById('user-email').textContent = user.email;
                        document.getElementById('profile-email').textContent = user.email;
                        document.getElementById('auth-status').textContent = '‚úì Innlogget';
                    } else {
                        document.getElementById('auth-logged-in').style.display = 'none';
                        document.getElementById('auth-logged-out').style.display = 'block';
                        document.getElementById('auth-status').textContent = 'Ikke innlogget';
                    }
                });
            } else {
                document.getElementById('auth-loading').innerHTML = '<p style="color: var(--warning);">Firebase ikke tilgjengelig</p>';
            }
        }

        function signOut() {
            if (firebase && firebase.auth) {
                firebase.auth().signOut().then(function() {
                    showToast('Logget ut');
                    location.reload();
                });
            }
        }

        function joinClassroom() {
            var code = Array.from(document.querySelectorAll('.code-digit')).map(function(i) { return i.value; }).join('');
            if (code.length !== 6) {
                document.getElementById('code-error').style.display = 'block';
                document.getElementById('code-error').textContent = 'Koden m√• v√¶re 6 siffer';
                return;
            }
            // API call would go here
            showToast('Kobler til klasserom...', 'üîÑ');
        }

        // ==================== TOAST ====================
        function showToast(message, icon) {
            var toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = message;
         