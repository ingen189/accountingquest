<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Finance - AccountingQuest</title>
    
    <!-- Felles stilark -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ==================== CORPORATE FINANCE - REDESIGNED ==================== */
        
        /* === LAYOUT: Sidebar + Main Content === */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        /* === LEFT SIDEBAR - Topic Navigation === */
        .topic-sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }
        
        .sidebar-header h2 {
            color: var(--accent);
            font-size: 1.3em;
            margin-bottom: var(--space-xs);
        }
        
        .sidebar-header p {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .topic-list {
            flex: 1;
            padding: var(--space-md);
        }
        
        .topic-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            overflow: hidden;
        }
        
        .topic-item:hover {
            border-color: var(--accent);
        }
        
        .topic-item.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .topic-item-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
        }
        
        .topic-item-icon {
            font-size: 1.5em;
        }
        
        .topic-item-info {
            flex: 1;
        }
        
        .topic-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }
        
        .topic-item-count {
            font-size: 0.8em;
            color: var(--accent);
        }
        
        /* Topic item clickable */
        .topic-item {
            cursor: pointer;
        }
        
        .topic-item:hover {
            border-color: var(--accent);
            transform: translateX(3px);
        }
        
        .topic-item.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.15);
        }
        
        /* Difficulty filter in sidebar during game */
        .difficulty-filter {
            padding: var(--space-md);
            border-top: 1px solid var(--border-color);
            display: none;
        }
        
        .difficulty-filter.visible {
            display: block;
        }
        
        .difficulty-filter h4 {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: var(--space-sm);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .difficulty-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }
        
        .diff-filter-btn {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .diff-filter-btn:hover {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .diff-filter-btn.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.2);
        }
        
        .diff-filter-btn .diff-icon {
            font-size: 1.1em;
        }
        
        .diff-filter-btn .diff-label {
            flex: 1;
        }
        
        .diff-filter-btn .diff-count {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85em;
        }
        
        /* === MAIN CONTENT AREA === */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Progress Bar */
        .progress-section {
            padding: var(--space-md) var(--space-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .progress-bar-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            height: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            transition: width var(--transition-slow);
            min-width: 40px;
        }
        
        /* Question Selector */
        .question-selector {
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        
        .question-selector.visible {
            display: block;
        }
        
        .question-selector-grid {
            display: flex;
            gap: var(--space-xs);
            flex-wrap: wrap;
        }
        
        .question-selector-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 36px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .question-selector-item:hover {
            border-color: var(--accent);
        }
        
        .question-selector-item.current {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .question-selector-item.completed {
            background: rgba(74, 222, 128, 0.2);
            border-color: var(--accent);
        }
        
        .question-selector-item.completed::after {
            content: ' ‚úì';
            color: var(--accent);
        }
        
        /* Workspace Container */
        .workspace-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Formula Sidebar */
        .formula-sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .formula-sidebar-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: var(--space-xs);
        }
        
        .formula-tab {
            flex: 1;
            padding: var(--space-sm);
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85em;
            transition: all var(--transition-fast);
        }
        
        .formula-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .formula-content {
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
        }
        
        .formula-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .formula-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
        }
        
        .formula-name {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .formula-equation {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .formula-description {
            color: var(--text-secondary);
            font-size: 0.75em;
        }
        
        /* Question Workspace */
        .workspace {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-2xl);
            height: 100%;
        }
        
        .welcome-screen h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-md);
        }
        
        .welcome-screen p {
            color: var(--text-secondary);
            font-size: 1.1em;
            max-width: 500px;
        }
        
        .welcome-arrow {
            font-size: 3em;
            color: var(--accent);
            margin-top: var(--space-lg);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-10px); }
        }
        
        /* Game View */
        .game-view {
            display: none;
        }
        
        .game-view.visible {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            height: 100%;
        }
        
        /* Question Header */
        .question-header {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border-left: 4px solid var(--accent);
        }
        
        .question-number {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .question-title {
            color: var(--accent);
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .question-text {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .question-badges {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .badge-topic {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-secondary);
        }
        
        .badge-type {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }
        
        /* Data Display */
        .data-display {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
        }
        
        .data-display h4 {
            color: var(--warning);
            margin-bottom: var(--space-md);
            font-size: 1em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .data-table td {
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
        }
        
        /* Options Container */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .option-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .option-item:hover {
            border-color: var(--accent);
        }
        
        .option-item.selected {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .option-item.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
        }
        
        .option-item.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.15);
        }
        
        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .option-item.selected .option-letter {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .option-item.correct .option-letter {
            background: var(--success);
            color: white;
        }
        
        .option-item.incorrect .option-letter {
            background: var(--error);
            color: white;
        }
        
        /* Input Fields */
        .input-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-group label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .input-group input {
            padding: 12px var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
            font-size: 1em;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .input-group input.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }
        
        .input-group input.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }
        
        /* ==================== EXCEL GRID ==================== */
        .excel-grid-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .excel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
        }
        
        .excel-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .excel-hint {
            color: var(--text-secondary);
            font-size: 0.8em;
        }
        
        .excel-grid-wrapper {
            overflow-x: auto;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
            min-width: 500px;
        }
        
        .excel-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .excel-table th.row-header {
            width: 160px;
            text-align: left;
            padding-left: 15px;
        }
        
        .excel-table td {
            border: 1px solid var(--border-color);
            padding: 0;
            min-width: 100px;
        }
        
        .excel-table td.row-label {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 10px 15px;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .excel-cell {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 10px 12px;
            font-size: 0.9em;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
            transition: all var(--transition-fast);
        }
        
        .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgba(74, 222, 128, 0.05);
            z-index: 5;
        }
        
        .excel-cell:hover:not(:focus):not(.readonly) {
            background: rgba(255,255,255,0.03);
        }
        
        .excel-cell.readonly {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: default;
        }
        
        .excel-cell.correct {
            background: rgba(34, 197, 94, 0.2) !important;
            color: var(--success);
        }
        
        .excel-cell.incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
            color: var(--error);
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            padding-top: var(--space-md);
        }
        
        /* Hint & Explanation Boxes */
        .hint-box, .explanation-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: none;
            overflow: hidden;
        }
        
        .hint-box.visible, .explanation-box.visible {
            display: block;
        }
        
        .hint-box {
            border: 2px solid var(--warning);
        }
        
        .explanation-box {
            border: 2px solid var(--success);
        }
        
        .hint-header, .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-tertiary);
        }
        
        .hint-content, .explanation-content {
            padding: var(--space-md);
        }
        
        .hint-close, .explanation-close {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }
        
        .hint-close:hover, .explanation-close:hover {
            background: var(--bg-primary);
        }
        
        /* Result Modal */
        .result-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .result-modal.visible {
            display: flex;
        }
        
        .result-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }
        
        .result-icon {
            font-size: 3.5em;
            margin-bottom: var(--space-md);
        }
        
        .result-title {
            font-size: 1.6em;
            margin-bottom: var(--space-sm);
        }
        
        .result-title.success { color: var(--success); }
        .result-title.error { color: var(--error); }
        
        .result-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin: var(--space-lg) 0;
        }
        
        .result-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent);
        }
        
        .result-stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        /* Calculator */
        .floating-calculator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 500;
            display: none;
        }
        
        .floating-calculator.visible {
            display: block;
        }
        
        .calculator {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            width: 260px;
        }
        
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
            cursor: move;
        }
        
        .calculator-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .calculator-close {
            background: var(--error);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .calc-display {
            background: var(--bg-primary);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            text-align: right;
        }
        
        .calc-equation {
            color: var(--text-secondary);
            font-size: 0.8em;
            min-height: 18px;
        }
        
        .calc-result {
            color: var(--text-primary);
            font-size: 1.4em;
            font-family: 'Consolas', monospace;
        }
        
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }
        
        .calc-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .calc-btn:hover {
            background: var(--border-light);
        }
        
        .calc-btn.operator {
            background: var(--accent-secondary);
            color: white;
        }
        
        .calc-btn.equals {
            background: var(--accent);
            color: var(--bg-primary);
            grid-column: span 2;
        }
        
        .calc-btn.function {
            background: #a855f7;
            color: white;
            font-size: 0.85em;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .formula-sidebar {
                width: 240px;
            }
            
            .topic-sidebar {
                width: 260px;
            }
        }
        
        @media (max-width: 1024px) {
            .app-layout {
                flex-direction: column;
            }
            
            .topic-sidebar {
                width: 100%;
                max-height: none;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .topic-list {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--space-sm);
            }
            
            .formula-sidebar {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .workspace {
                padding: var(--space-md);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls .aq-btn {
                width: 100%;
            }
            
            .welcome-screen h1 {
                font-size: 1.8em;
            }
            
            .welcome-arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="aq-header">
        <div class="aq-header-left">
            <a href="index.html" class="aq-btn aq-btn-ghost">‚Üê Tilbake</a>
            <span style="color: var(--text-secondary);">Modul: <strong style="color: var(--accent);">Corporate Finance</strong></span>
        </div>
        <div class="aq-header-right">
            <div class="aq-stat">
                <span class="aq-stat-label">Sp√∏rsm√•l:</span>
                <span class="aq-stat-value" id="nav-progress">-</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Riktige:</span>
                <span class="aq-stat-value" id="nav-correct">0</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Poeng:</span>
                <span class="aq-stat-value" id="nav-score">0</span>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Left Sidebar - Topic Navigation -->
        <aside class="topic-sidebar">
            <div class="sidebar-header">
                <h2>üìä Velg tema</h2>
                <p>Klikk for √• starte</p>
            </div>
            <div class="topic-list" id="topic-list">
                <!-- Topics will be rendered here -->
            </div>
            
            <!-- Difficulty filter - shows when in game -->
            <div class="difficulty-filter" id="difficulty-filter">
                <h4>Filtrer vanskelighetsgrad</h4>
                <div class="difficulty-buttons">
                    <button class="diff-filter-btn active" onclick="filterByDifficulty('all')">
                        <span class="diff-icon">üìö</span>
                        <span class="diff-label">Alle</span>
                        <span class="diff-count" id="diff-count-all">-</span>
                    </button>
                    <button class="diff-filter-btn" onclick="filterByDifficulty('easy')">
                        <span class="diff-icon">üå±</span>
                        <span class="diff-label">Lett</span>
                        <span class="diff-count" id="diff-count-easy">-</span>
                    </button>
                    <button class="diff-filter-btn" onclick="filterByDifficulty('medium')">
                        <span class="diff-icon">üí™</span>
                        <span class="diff-label">Middels</span>
                        <span class="diff-count" id="diff-count-medium">-</span>
                    </button>
                    <button class="diff-filter-btn" onclick="filterByDifficulty('hard')">
                        <span class="diff-icon">üî•</span>
                        <span class="diff-label">Vanskelig</span>
                        <span class="diff-count" id="diff-count-hard">-</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="main-area">
            <!-- Progress Bar -->
            <div class="progress-section" id="progress-section" style="display: none;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
                </div>
            </div>
            
            <!-- Question Selector -->
            <div class="question-selector" id="question-selector-section">
                <div class="question-selector-grid" id="question-selector"></div>
            </div>
            
            <!-- Workspace Container -->
            <div class="workspace-container">
                <!-- Formula Sidebar -->
                <aside class="formula-sidebar" id="formula-sidebar">
                    <div class="formula-sidebar-header">
                        <button class="formula-tab active" onclick="switchFormulaTab('formulas')">üìê Formler</button>
                        <button class="formula-tab" onclick="switchFormulaTab('data')">üìä Data</button>
                    </div>
                    <div class="formula-content">
                        <div id="formula-list-container">
                            <div class="formula-list" id="formula-list"></div>
                        </div>
                        <div id="variable-list-container" style="display: none;">
                            <div id="variable-list"></div>
                        </div>
                    </div>
                </aside>
                
                <!-- Main Workspace -->
                <main class="workspace" id="workspace">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcome-screen">
                        <h1>Corporate Finance</h1>
                        <p>Mestre investering, verdivurdering og finansiell analyse. Velg et tema fra menyen til venstre for √• starte.</p>
                        <div class="welcome-arrow">‚Üê</div>
                    </div>
                    
                    <!-- Game View -->
                    <div class="game-view" id="game-view">
                        <div class="question-header">
                            <div class="question-number" id="question-number">Sp√∏rsm√•l 1 av 10</div>
                            <div class="question-title" id="question-title">Laster...</div>
                            <div class="question-text" id="question-text"></div>
                            <div class="question-badges" id="question-badges"></div>
                        </div>
                        
                        <div class="data-display" id="data-display" style="display: none;">
                            <h4>üìã Oppgavedata</h4>
                            <table class="data-table" id="data-table"><tbody></tbody></table>
                        </div>
                        
                        <div class="options-container" id="options-container" style="display: none;"></div>
                        <div class="input-fields" id="input-fields" style="display: none;"></div>
                        
                        <div class="excel-grid-container" id="excel-grid-container" style="display: none;">
                            <div class="excel-header-row">
                                <span class="excel-title">üìä Beregningstabell</span>
                                <span class="excel-hint">Fyll inn de tomme cellene</span>
                            </div>
                            <div class="excel-grid-wrapper">
                                <table class="excel-table" id="excel-table">
                                    <thead id="excel-thead"></thead>
                                    <tbody id="excel-tbody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="aq-btn aq-btn-primary" onclick="checkAnswer()" id="btn-check">‚úì Sjekk svar</button>
                            <button class="aq-btn aq-btn-warning" onclick="showHint()" id="btn-hint">üí° Hint</button>
                            <button class="aq-btn aq-btn-info" onclick="toggleExplanation()" id="btn-explanation" style="display: none;">üìñ Vis forklaring</button>
                            <button class="aq-btn aq-btn-ghost" onclick="toggleCalculator()">üî¢ Kalkulator</button>
                            <button class="aq-btn aq-btn-secondary" onclick="nextQuestion()" id="btn-next" style="display: none;">Neste ‚Üí</button>
                        </div>
                        
                        <div class="hint-box" id="hint-box">
                            <div class="hint-header">
                                <span style="color: var(--warning);" id="hint-level">üí° Hint 1 av 3</span>
                                <button class="hint-close" onclick="closeHint()">√ó</button>
                            </div>
                            <div class="hint-content">
                                <p id="hint-text"></p>
                            </div>
                        </div>
                        
                        <div class="explanation-box" id="explanation-box">
                            <div class="explanation-header">
                                <span style="color: var(--success);">üìñ Forklaring</span>
                                <button class="explanation-close" onclick="closeExplanation()">√ó</button>
                            </div>
                            <div class="explanation-content">
                                <div id="explanation-main"></div>
                                <div id="explanation-formula" style="display: none; background: var(--bg-tertiary); padding: var(--space-md); border-radius: var(--radius-sm); margin-top: var(--space-md); font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-icon" id="result-icon">üéâ</div>
            <h2 class="result-title" id="result-title">Gratulerer!</h2>
            <p class="result-message" id="result-message">Du har fullf√∏rt alle sp√∏rsm√•lene!</p>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="result-correct">0</div>
                    <div class="result-stat-label">Riktige</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-total">0</div>
                    <div class="result-stat-label">Totalt</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-percent">0%</div>
                    <div class="result-stat-label">Score</div>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-sm); justify-content: center;">
                <button class="aq-btn aq-btn-primary" onclick="restartGame()">üîÑ Pr√∏v igjen</button>
                <button class="aq-btn aq-btn-ghost" onclick="backToWelcome()">‚Üê Velg nytt tema</button>
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="floating-calculator" id="floating-calculator">
        <div class="calculator" id="calculator-drag">
            <div class="calculator-header">
                <span class="calculator-title">üî¢ Kalkulator</span>
                <button class="calculator-close" onclick="toggleCalculator()">√ó</button>
            </div>
            <div class="calc-display">
                <div class="calc-equation" id="calc-equation"></div>
                <div class="calc-result" id="calc-result">0</div>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn function" onclick="calcFunction('pv')">PV</button>
                <button class="calc-btn function" onclick="calcFunction('fv')">FV</button>
                <button class="calc-btn function" onclick="calcFunction('sqrt')">‚àö</button>
                <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcClear()">C</button>
                <button class="calc-btn operator" onclick="calcInput('^')">^</button>
                <button class="calc-btn equals" onclick="calcEquals()">=</button>
                <button class="calc-btn" onclick="calcInput('(')">(</button>
                <button class="calc-btn" onclick="calcInput(')')">)</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    
    <script>
        // ==================== TOPIC CONFIGURATION ====================
        var topics = [
            { id: 'npv', name: 'NPV & IRR', icon: 'üí∞', desc: 'Net Present Value, IRR, Payback' },
            { id: 'bonds', name: 'Obligasjoner', icon: 'üìú', desc: 'YTM, kuponger, premium/discount' },
            { id: 'stocks', name: 'Aksjer & Dividender', icon: 'üìà', desc: 'DDM, Gordon Growth' },
            { id: 'wacc', name: 'WACC & Kapitalstruktur', icon: '‚öñÔ∏è', desc: 'Cost of capital, tax shield' },
            { id: 'portfolio', name: 'Portef√∏lje & Risiko', icon: 'üìä', desc: 'Beta, CAPM' },
            { id: 'annuity', name: 'Annuiteter & L√•n', icon: 'üîÑ', desc: 'Annuity, amortisering' },
            { id: 'forex', name: 'Valuta & Hedging', icon: 'üí±', desc: 'Spot/forward, valutarisiko' },
            { id: 'options', name: 'Opsjoner', icon: 'üéØ', desc: 'Call/put, hedging' },
            { id: 'mixed', name: 'Blandet Quiz', icon: 'üé≤', desc: 'Alle temaer' }
        ];
        
        var formulas = {
            npv: [
                { name: 'NPV', equation: 'NPV = Œ£ CF‚Çú / (1+r)·µó', description: 'Sum av n√•verdier' },
                { name: 'PV Factor', equation: 'PVF = 1 / (1+r)‚Åø', description: 'Diskonteringsfaktor' },
                { name: 'IRR', equation: 'NPV = 0', description: 'Renten som gir NPV = 0' },
                { name: 'Payback', equation: 'Tid til CF = I‚ÇÄ', description: 'Tilbakebetalingstid' }
            ],
            bonds: [
                { name: 'Bond Price', equation: 'P = Œ£ C/(1+r)·µó + FV/(1+r)‚Åø', description: 'PV av kuponger + p√•lydende' },
                { name: 'Current Yield', equation: 'CY = C / P', description: '√Örlig kupong / Pris' }
            ],
            stocks: [
                { name: 'DDM', equation: 'P‚ÇÄ = D‚ÇÅ / (r - g)', description: 'Gordon Growth Model' },
                { name: 'Required Return', equation: 'r = D‚ÇÅ/P‚ÇÄ + g', description: 'Dividend yield + growth' }
            ],
            wacc: [
                { name: 'WACC', equation: 'WACC = w‚ÇëR‚Çë + w·µàR·µà(1-T)', description: 'Vektet kapitalkostnad' },
                { name: 'CAPM', equation: 'R‚Çë = Rf + Œ≤(Rm - Rf)', description: 'Cost of equity' }
            ],
            portfolio: [
                { name: 'Expected Return', equation: 'E(R) = Œ£ p·µ¢R·µ¢', description: 'Forventet avkastning' },
                { name: 'Portfolio Beta', equation: 'Œ≤‚Çö = Œ£ w·µ¢Œ≤·µ¢', description: 'Vektet beta' }
            ],
            annuity: [
                { name: 'PV Annuity', equation: 'PV = PMT √ó [(1-(1+r)‚Åª‚Åø)/r]', description: 'N√•verdi av annuitet' },
                { name: 'FV Annuity', equation: 'FV = PMT √ó [(1+r)‚Åø-1)/r]', description: 'Sluttverdi av annuitet' }
            ],
            forex: [
                { name: 'Forward Premium', equation: '(F-S)/S √ó 100', description: 'Premium/discount' },
                { name: 'IRP', equation: 'F/S = (1+r·µà)/(1+r·∂†)', description: 'Interest Rate Parity' }
            ],
            options: [
                { name: 'Call Payoff', equation: 'max(S-K, 0)', description: 'Gevinst ved forfall' },
                { name: 'Put Payoff', equation: 'max(K-S, 0)', description: 'Gevinst ved forfall' }
            ]
        };
        
        // ==================== GAME STATE ====================
        var gameState = {
            currentTopic: null,
            currentDifficulty: null,
            questions: [],
            currentIndex: 0,
            currentQuestion: null,
            selectedAnswer: null,
            answeredCorrectly: false,
            hintsUsed: 0,
            score: 0,
            correctCount: 0,
            answered: [],
            questionCounts: {}
        };
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            renderTopicSidebar();
            
            if (typeof firebase !== 'undefined') {
                // Firebase config - adjust path as needed
                var firebaseConfig = {
                    apiKey: "AIzaSyDmLjTJPexLM2PkDHLHhO0KLVozxaEB9JM",
                    authDomain: "accountingquest-multiplayer.firebaseapp.com",
                    databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "accountingquest-multiplayer",
                    storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                    messagingSenderId: "1042365043389",
                    appId: "1:1042365043389:web:a9f933aef3d5c3f6c37edc"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                loadQuestionCounts();
            }
            
            setupCalculatorDrag();
        });
        
        // ==================== TOPIC SIDEBAR ====================
        function renderTopicSidebar() {
            var html = '';
            topics.forEach(function(topic) {
                html += '<div class="topic-item" id="topic-' + topic.id + '" onclick="startGame(\'' + topic.id + '\')">';
                html += '<div class="topic-item-header">';
                html += '<span class="topic-item-icon">' + topic.icon + '</span>';
                html += '<div class="topic-item-info">';
                html += '<div class="topic-item-name">' + topic.name + '</div>';
                html += '<div class="topic-item-count" id="count-' + topic.id + '">Laster...</div>';
                html += '</div>';
                html += '</div>';
                html += '</div>';
            });
            document.getElementById('topic-list').innerHTML = html;
        }
        
        function setActiveTopic(topicId) {
            document.querySelectorAll('.topic-item').forEach(function(el) {
                el.classList.remove('active');
            });
            var item = document.getElementById('topic-' + topicId);
            if (item) item.classList.add('active');
        }
        
        function loadQuestionCounts() {
            var db = firebase.database();
            var basePath = 'questions/corporate_finance';
            
            topics.forEach(function(topic) {
                if (topic.id === 'mixed') {
                    // Mixed counts all questions
                    db.ref(basePath).once('value').then(function(snap) {
                        var total = 0;
                        snap.forEach(function(topicSnap) {
                            topicSnap.forEach(function(diffSnap) {
                                diffSnap.forEach(function(qSnap) {
                                    total++;
                                });
                            });
                        });
                        document.getElementById('count-mixed').textContent = total + ' oppgaver';
                    }).catch(function() {
                        document.getElementById('count-mixed').textContent = '? oppgaver';
                    });
                } else {
                    db.ref(basePath + '/' + topic.id).once('value').then(function(snap) {
                        var total = 0;
                        snap.forEach(function(diffSnap) {
                            diffSnap.forEach(function(qSnap) {
                                total++;
                            });
                        });
                        document.getElementById('count-' + topic.id).textContent = total + ' oppgaver';
                        gameState.questionCounts[topic.id] = total;
                    }).catch(function() {
                        document.getElementById('count-' + topic.id).textContent = '? oppgaver';
                    });
                }
            });
        }
        
        // ==================== GAME LOGIC ====================
        function startGame(topicId) {
            gameState.currentTopic = topicId;
            gameState.currentDifficulty = 'all';
            gameState.score = 0;
            gameState.correctCount = 0;
            gameState.currentIndex = 0;
            gameState.answered = [];
            gameState.allQuestions = []; // Store all questions for filtering
            
            setActiveTopic(topicId);
            
            document.getElementById('nav-score').textContent = '0';
            document.getElementById('nav-correct').textContent = '0';
            
            loadQuestions().then(function() {
                if (gameState.allQuestions.length === 0) {
                    alert('Ingen sp√∏rsm√•l funnet for dette temaet.');
                    return;
                }
                
                // Show difficulty filter
                document.getElementById('difficulty-filter').classList.add('visible');
                updateDifficultyCounts();
                
                // Show game UI
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('game-view').classList.add('visible');
                document.getElementById('progress-section').style.display = 'block';
                document.getElementById('question-selector-section').classList.add('visible');
                
                loadFormulas();
                renderQuestionSelector();
                loadQuestion(0);
            });
        }
        
        function updateDifficultyCounts() {
            var counts = { all: 0, easy: 0, medium: 0, hard: 0 };
            
            gameState.allQuestions.forEach(function(q) {
                counts.all++;
                var diff = q.difficulty || 'medium';
                if (counts[diff] !== undefined) counts[diff]++;
            });
            
            document.getElementById('diff-count-all').textContent = counts.all;
            document.getElementById('diff-count-easy').textContent = counts.easy;
            document.getElementById('diff-count-medium').textContent = counts.medium;
            document.getElementById('diff-count-hard').textContent = counts.hard;
        }
        
        function filterByDifficulty(difficulty) {
            gameState.currentDifficulty = difficulty;
            
            // Update active button
            document.querySelectorAll('.diff-filter-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.closest('.diff-filter-btn').classList.add('active');
            
            // Filter questions
            var filtered;
            if (difficulty === 'all') {
                filtered = gameState.allQuestions.slice();
            } else {
                filtered = gameState.allQuestions.filter(function(q) {
                    return q.difficulty === difficulty;
                });
            }
            
            if (filtered.length === 0) {
                alert('Ingen sp√∏rsm√•l med denne vanskelighetsgraden.');
                return;
            }
            
            // Reset game with filtered questions
            gameState.questions = shuffleArray(filtered).slice(0, 10);
            gameState.currentIndex = 0;
            gameState.answered = [];
            gameState.score = 0;
            gameState.correctCount = 0;
            
            document.getElementById('nav-score').textContent = '0';
            document.getElementById('nav-correct').textContent = '0';
            
            renderQuestionSelector();
            loadQuestion(0);
        }
        
        function loadQuestions() {
            return new Promise(function(resolve) {
                var db = firebase.database();
                var questions = [];
                var basePath = 'questions/corporate_finance';
                
                if (gameState.currentTopic === 'mixed') {
                    // Load from all topics
                    db.ref(basePath).once('value').then(function(snap) {
                        snap.forEach(function(topicSnap) {
                            var topicKey = topicSnap.key;
                            topicSnap.forEach(function(diffSnap) {
                                diffSnap.forEach(function(qSnap) {
                                    var q = qSnap.val();
                                    q.id = qSnap.key;
                                    q.topic = topicKey;
                                    q.difficulty = diffSnap.key;
                                    questions.push(q);
                                });
                            });
                        });
                        
                        // Store all questions for filtering
                        gameState.allQuestions = questions;
                        gameState.questions = shuffleArray(questions).slice(0, 10);
                        resolve();
                    }).catch(function(err) {
                        console.error('Error loading questions:', err);
                        resolve();
                    });
                } else {
                    // Load all questions from specific topic (all difficulties)
                    db.ref(basePath + '/' + gameState.currentTopic).once('value').then(function(snap) {
                        snap.forEach(function(diffSnap) {
                            diffSnap.forEach(function(qSnap) {
                                var q = qSnap.val();
                                q.id = qSnap.key;
                                q.topic = gameState.currentTopic;
                                q.difficulty = diffSnap.key;
                                questions.push(q);
                            });
                        });
                        
                        // Store all questions for filtering
                        gameState.allQuestions = questions;
                        gameState.questions = shuffleArray(questions).slice(0, 10);
                        resolve();
                    }).catch(function(err) {
                        console.error('Error loading questions:', err);
                        resolve();
                    });
                }
            });
        }
        
        function renderQuestionSelector() {
            var html = '';
            for (var i = 0; i < gameState.questions.length; i++) {
                var cls = 'question-selector-item';
                if (i === gameState.currentIndex) cls += ' current';
                if (gameState.answered[i]) cls += ' completed';
                html += '<div class="' + cls + '" onclick="loadQuestion(' + i + ')">' + (i + 1) + '</div>';
            }
            document.getElementById('question-selector').innerHTML = html;
            
            var pct = Math.round((gameState.answered.filter(Boolean).length / gameState.questions.length) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-bar').textContent = pct + '%';
            document.getElementById('nav-progress').textContent = (gameState.currentIndex + 1) + '/' + gameState.questions.length;
        }
        
        function loadQuestion(idx) {
            gameState.currentIndex = idx;
            gameState.currentQuestion = gameState.questions[idx];
            gameState.selectedAnswer = null;
            gameState.answeredCorrectly = false;
            gameState.hintsUsed = 0;
            
            var q = gameState.currentQuestion;
            
            document.getElementById('question-number').textContent = 'Sp√∏rsm√•l ' + (idx + 1) + ' av ' + gameState.questions.length;
            document.getElementById('question-title').textContent = q.title || 'Oppgave';
            document.getElementById('question-text').textContent = q.question || q.description || '';
            document.getElementById('question-badges').innerHTML = 
                '<span class="badge badge-topic">' + q.topic + '</span>' +
                '<span class="badge badge-type">' + (q.type || 'calculation') + '</span>';
            
            // Reset UI
            document.getElementById('hint-box').classList.remove('visible');
            document.getElementById('explanation-box').classList.remove('visible');
            document.getElementById('btn-check').style.display = 'inline-flex';
            document.getElementById('btn-check').disabled = false;
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-explanation').style.display = 'none';
            document.getElementById('btn-hint').disabled = false;
            
            renderQuestionContent(q);
            renderQuestionSelector();
            renderVariables(q);
        }
        
        function renderQuestionContent(q) {
            // Hide all containers
            document.getElementById('options-container').style.display = 'none';
            document.getElementById('input-fields').style.display = 'none';
            document.getElementById('data-display').style.display = 'none';
            document.getElementById('excel-grid-container').style.display = 'none';
            
            // Show data table if exists
            if (q.data) {
                renderDataTable(q.data);
            }
            
            // Render based on type
            if (q.type === 'multiple_choice' || q.type === 'mc') {
                renderMultipleChoice(q);
            } else if (q.type === 'true_false') {
                renderTrueFalse(q);
            } else if (q.type === 'excel_grid') {
                renderExcelGrid(q);
            } else {
                // Default: calculation with input fields
                renderCalculation(q);
            }
        }
        
        function renderDataTable(data) {
            document.getElementById('data-display').style.display = 'block';
            var tbl = '';
            
            Object.keys(data).forEach(function(k) {
                var v = data[k];
                
                if (Array.isArray(v) && v.length > 0 && typeof v[0] === 'object') {
                    var headers = Object.keys(v[0]);
                    tbl += '<tr><th colspan="2" style="color: var(--accent); padding-top: 15px;">' + formatLabel(k) + '</th></tr>';
                    tbl += '<tr>';
                    headers.forEach(function(h) {
                        tbl += '<td style="font-weight: bold; color: var(--text-secondary);">' + formatLabel(h) + '</td>';
                    });
                    tbl += '</tr>';
                    v.forEach(function(item) {
                        tbl += '<tr>';
                        headers.forEach(function(h) {
                            var val = item[h];
                            tbl += '<td>' + (typeof val === 'number' ? formatNumber(val) : val) + '</td>';
                        });
                        tbl += '</tr>';
                    });
                } else if (Array.isArray(v)) {
                    tbl += '<tr><th>' + formatLabel(k) + '</th><td>' + v.join(', ') + '</td></tr>';
                } else if (typeof v === 'object' && v !== null) {
                    tbl += '<tr><th colspan="2" style="color: var(--accent);">' + formatLabel(k) + '</th></tr>';
                    Object.keys(v).forEach(function(subKey) {
                        if (typeof v[subKey] !== 'object') {
                            tbl += '<tr><th style="padding-left: 20px;">' + formatLabel(subKey) + '</th><td>' + formatNumber(v[subKey]) + '</td></tr>';
                        }
                    });
                } else {
                    tbl += '<tr><th>' + formatLabel(k) + '</th><td>' + formatNumber(v) + '</td></tr>';
                }
            });
            
            document.getElementById('data-table').querySelector('tbody').innerHTML = tbl;
        }
        
        function renderMultipleChoice(q) {
            var container = document.getElementById('options-container');
            container.style.display = 'flex';
            var opts = q.options || [];
            var html = '';
            opts.forEach(function(o, i) {
                var id = o.id || i.toString();
                var text = typeof o === 'string' ? o : o.text;
                html += '<div class="option-item" data-id="' + id + '" onclick="selectOption(\'' + id + '\')">';
                html += '<div class="option-letter">' + String.fromCharCode(65 + i) + '</div>';
                html += '<div class="option-text">' + text + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }
        
        function renderTrueFalse(q) {
            var container = document.getElementById('options-container');
            container.style.display = 'flex';
            container.innerHTML = 
                '<div class="option-item" data-id="true" onclick="selectOption(\'true\')">' +
                '<div class="option-letter">A</div><div class="option-text">Sant</div></div>' +
                '<div class="option-item" data-id="false" onclick="selectOption(\'false\')">' +
                '<div class="option-letter">B</div><div class="option-text">Usant</div></div>';
        }
        
        function renderCalculation(q) {
            document.getElementById('input-fields').style.display = 'grid';
            var fields = q.input_fields || [{ id: 'answer', label: 'Svar', unit: '' }];
            var html = '';
            fields.forEach(function(f) {
                html += '<div class="input-group">';
                html += '<label>' + f.label + (f.unit ? ' (' + f.unit + ')' : '') + '</label>';
                html += '<input type="text" id="input-' + f.id + '" placeholder="0">';
                html += '</div>';
            });
            document.getElementById('input-fields').innerHTML = html;
        }
        
        function renderExcelGrid(q) {
            document.getElementById('excel-grid-container').style.display = 'block';
            
            var grid = q.grid || q.excel_grid;
            if (!grid) {
                // Auto-generate from data and input_fields
                grid = generateGridFromQuestion(q);
            }
            
            var thead = document.getElementById('excel-thead');
            var tbody = document.getElementById('excel-tbody');
            
            // Build header
            var headerHtml = '<tr><th class="row-header">' + (grid.rowHeader || 'Parameter') + '</th>';
            (grid.columns || ['Verdi']).forEach(function(col) {
                headerHtml += '<th>' + col + '</th>';
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            
            // Build body
            var bodyHtml = '';
            (grid.rows || []).forEach(function(row, rowIndex) {
                bodyHtml += '<tr>';
                bodyHtml += '<td class="row-label">' + row.label + '</td>';
                
                (row.cells || []).forEach(function(cell, colIndex) {
                    var cellId = 'cell-' + rowIndex + '-' + colIndex;
                    var isReadonly = cell.readonly || cell.type === 'given';
                    var value = cell.value !== undefined ? cell.value : '';
                    
                    if (isReadonly) {
                        bodyHtml += '<td><input type="text" class="excel-cell readonly" id="' + cellId + '" value="' + formatNumber(value) + '" readonly></td>';
                    } else {
                        bodyHtml += '<td><input type="text" class="excel-cell" id="' + cellId + '" data-row="' + rowIndex + '" data-col="' + colIndex + '" data-field="' + (cell.id || '') + '" placeholder="?"></td>';
                    }
                });
                
                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
            
            gameState.currentGrid = grid;
        }
        
        function generateGridFromQuestion(q) {
            var rows = [];
            
            // Add data rows as readonly
            if (q.data) {
                Object.keys(q.data).forEach(function(key) {
                    var val = q.data[key];
                    if (typeof val === 'number' || typeof val === 'string') {
                        rows.push({
                            label: formatLabel(key),
                            cells: [{ value: val, readonly: true, type: 'given' }]
                        });
                    }
                });
            }
            
            // Add input fields as editable
            var fields = q.input_fields || [{ id: 'answer', label: 'Svar' }];
            fields.forEach(function(f) {
                rows.push({
                    label: f.label + (f.unit ? ' (' + f.unit + ')' : ''),
                    cells: [{ id: f.id, placeholder: '?' }]
                });
            });
            
            return {
                rowHeader: 'Parameter',
                columns: ['Verdi'],
                rows: rows
            };
        }
        
        function renderVariables(q) {
            var container = document.getElementById('variable-list');
            if (!q.data) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Ingen tilleggsdata</p>';
                return;
            }
            
            var html = '<div class="formula-list">';
            Object.keys(q.data).forEach(function(k) {
                var v = q.data[k];
                if (typeof v !== 'object' || Array.isArray(v)) {
                    html += '<div class="formula-item">';
                    html += '<div class="formula-name">' + formatLabel(k) + '</div>';
                    html += '<div class="formula-equation">' + (Array.isArray(v) ? v.join(', ') : formatNumber(v)) + '</div>';
                    html += '</div>';
                }
            });
            container.innerHTML = html + '</div>';
        }
        
        function loadFormulas() {
            var list = formulas[gameState.currentTopic] || formulas.npv;
            if (gameState.currentTopic === 'mixed') {
                list = [];
                Object.keys(formulas).forEach(function(t) {
                    list = list.concat(formulas[t].slice(0, 2));
                });
            }
            
            var html = '';
            list.forEach(function(f) {
                html += '<div class="formula-item">';
                html += '<div class="formula-name">' + f.name + '</div>';
                html += '<div class="formula-equation">' + f.equation + '</div>';
                html += '<div class="formula-description">' + f.description + '</div>';
                html += '</div>';
            });
            document.getElementById('formula-list').innerHTML = html;
        }
        
        // ==================== ANSWER CHECKING ====================
        function selectOption(id) {
            if (gameState.answeredCorrectly) return;
            gameState.selectedAnswer = id;
            document.querySelectorAll('.option-item').forEach(function(el) {
                el.classList.toggle('selected', el.dataset.id === id);
            });
        }
        
        function checkAnswer() {
            var q = gameState.currentQuestion;
            
            document.getElementById('btn-check').disabled = true;
            document.getElementById('btn-check').textContent = '‚è≥ Sjekker...';
            
            // Fetch solution from Firebase
            var solutionPath = 'solutions/corporate_finance/' + q.id;
            
            firebase.database().ref(solutionPath).once('value')
                .then(function(snapshot) {
                    var solution = snapshot.val();
                    
                    if (!solution) {
                        // Fallback: check using local data if available
                        var correct = checkWithLocalData(q);
                        if (correct !== null) {
                            if (correct) handleCorrect(); else handleIncorrect();
                        } else {
                            alert('Kunne ikke finne fasit for dette sp√∏rsm√•let.');
                        }
                        resetCheckButton();
                        return;
                    }
                    
                    var correct;
                    if (q.type === 'multiple_choice' || q.type === 'mc') {
                        correct = checkMCWithSolution(solution);
                    } else if (q.type === 'true_false') {
                        correct = checkTrueFalseWithSolution(solution);
                    } else if (q.type === 'excel_grid') {
                        correct = checkExcelGridWithSolution(solution);
                    } else {
                        correct = checkCalcWithSolution(solution);
                    }
                    
                    gameState.currentSolution = solution;
                    
                    if (correct === null) {
                        resetCheckButton();
                        return;
                    }
                    
                    if (correct) handleCorrect(); else handleIncorrect();
                    resetCheckButton();
                })
                .catch(function(error) {
                    console.error('Solution fetch error:', error);
                    alert('Feil ved henting av fasit.');
                    resetCheckButton();
                });
        }
        
        function resetCheckButton() {
            document.getElementById('btn-check').disabled = false;
            document.getElementById('btn-check').textContent = '‚úì Sjekk svar';
        }
        
        function checkWithLocalData(q) {
            // Try to check using data embedded in question
            if (q.correct !== undefined) {
                if (q.type === 'multiple_choice' || q.type === 'mc') {
                    if (!gameState.selectedAnswer) { alert('Velg et svar!'); return null; }
                    var correctId = q.correct.toString();
                    document.querySelectorAll('.option-item').forEach(function(el) {
                        if (el.dataset.id === correctId) el.classList.add('correct');
                        else if (el.dataset.id === gameState.selectedAnswer) el.classList.add('incorrect');
                    });
                    return gameState.selectedAnswer === correctId;
                }
            }
            return null;
        }
        
        function checkMCWithSolution(solution) {
            if (!gameState.selectedAnswer) { alert('Velg et svar!'); return null; }
            var correctId = solution.correct.toString();
            document.querySelectorAll('.option-item').forEach(function(el) {
                if (el.dataset.id === correctId) el.classList.add('correct');
                else if (el.dataset.id === gameState.selectedAnswer) el.classList.add('incorrect');
            });
            return gameState.selectedAnswer === correctId;
        }
        
        function checkTrueFalseWithSolution(solution) {
            if (!gameState.selectedAnswer) { alert('Velg et svar!'); return null; }
            var correctId = solution.correct.toString();
            document.querySelectorAll('.option-item').forEach(function(el) {
                if (el.dataset.id === correctId) el.classList.add('correct');
                else if (el.dataset.id === gameState.selectedAnswer) el.classList.add('incorrect');
            });
            return gameState.selectedAnswer === correctId;
        }
        
        function checkCalcWithSolution(solution) {
            var q = gameState.currentQuestion;
            var fields = q.input_fields || [{ id: 'answer' }];
            var ok = true;
            var correctValues = solution.correct || solution;
            
            fields.forEach(function(f) {
                var inp = document.getElementById('input-' + f.id);
                if (!inp) return;
                
                var user = parseFloat(inp.value.replace(/\s/g, '').replace(',', '.'));
                var corr = typeof correctValues === 'object' ? correctValues[f.id] : correctValues;
                var tol = solution.tolerance || 1;
                
                if (typeof corr === 'number') {
                    var isOk = Math.abs(user - corr) <= tol;
                    inp.classList.remove('correct', 'incorrect');
                    inp.classList.add(isOk ? 'correct' : 'incorrect');
                    if (!isOk) ok = false;
                }
            });
            return ok;
        }
        
        function checkExcelGridWithSolution(solution) {
            var correctCells = solution.correct || {};
            var ok = true;
            var tolerance = solution.tolerance || 0.01;
            
            document.querySelectorAll('#excel-tbody input:not(.readonly)').forEach(function(inp) {
                var row = inp.dataset.row;
                var col = inp.dataset.col;
                var field = inp.dataset.field;
                
                // Try different key formats
                var keys = [row + ',' + col, field, 'cell-' + row + '-' + col];
                var corr = null;
                
                keys.forEach(function(key) {
                    if (key && correctCells[key] !== undefined) {
                        corr = correctCells[key];
                    }
                });
                
                if (corr !== null) {
                    var user = parseFloat(inp.value.replace(/\s/g, '').replace(',', '.'));
                    var corrNum = parseFloat(corr);
                    
                    if (!isNaN(user) && !isNaN(corrNum)) {
                        var isOk = Math.abs(user - corrNum) <= Math.abs(corrNum * tolerance) + 0.01;
                        inp.classList.remove('correct', 'incorrect');
                        inp.classList.add(isOk ? 'correct' : 'incorrect');
                        if (!isOk) ok = false;
                    }
                }
            });
            
            return ok;
        }
        
        function handleCorrect() {
            gameState.answeredCorrectly = true;
            gameState.answered[gameState.currentIndex] = true;
            gameState.correctCount++;
            gameState.score += Math.max(100 - gameState.hintsUsed * 25, 25);
            
            document.getElementById('nav-score').textContent = gameState.score;
            document.getElementById('nav-correct').textContent = gameState.correctCount;
            
            document.getElementById('btn-explanation').style.display = 'inline-flex';
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-hint').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            
            renderQuestionSelector();
            
            if (gameState.answered.filter(Boolean).length === gameState.questions.length) {
                setTimeout(showResults, 1500);
            }
        }
        
        function handleIncorrect() {
            if (gameState.hintsUsed === 0) showHint();
            document.getElementById('btn-explanation').style.display = 'inline-flex';
        }
        
        // ==================== HINTS & EXPLANATIONS ====================
        function showHint() {
            var q = gameState.currentQuestion;
            
            document.getElementById('hint-text').textContent = 'Laster hint...';
            document.getElementById('hint-box').classList.add('visible');
            
            var hintPath = 'solutions/corporate_finance/' + q.id + '/hints/' + gameState.hintsUsed;
            
            firebase.database().ref(hintPath).once('value')
                .then(function(snapshot) {
                    var hint = snapshot.val();
                    
                    if (!hint) {
                        document.getElementById('hint-text').textContent = 'Ingen flere hints tilgjengelig.';
                        document.getElementById('btn-hint').disabled = true;
                        return;
                    }
                    
                    var hintText = typeof hint === 'string' ? hint : hint.text;
                    document.getElementById('hint-level').textContent = 'üí° Hint ' + (gameState.hintsUsed + 1);
                    document.getElementById('hint-text').textContent = hintText;
                    gameState.hintsUsed++;
                })
                .catch(function(error) {
                    document.getElementById('hint-text').textContent = 'Kunne ikke laste hint.';
                });
        }
        
        function closeHint() {
            document.getElementById('hint-box').classList.remove('visible');
        }
        
        function toggleExplanation() {
            var box = document.getElementById('explanation-box');
            if (box.classList.contains('visible')) {
                closeExplanation();
            } else {
                showExplanation();
            }
        }
        
        function showExplanation() {
            var q = gameState.currentQuestion;
            
            document.getElementById('explanation-main').innerHTML = '<em>Laster forklaring...</em>';
            document.getElementById('explanation-box').classList.add('visible');
            document.getElementById('btn-explanation').textContent = 'üìñ Skjul forklaring';
            
            var solutionPath = 'solutions/corporate_finance/' + q.id;
            
            firebase.database().ref(solutionPath).once('value')
                .then(function(snapshot) {
                    var solution = snapshot.val();
                    
                    if (!solution || !solution.explanation) {
                        document.getElementById('explanation-main').innerHTML = '<em>Ingen forklaring tilgjengelig.</em>';
                        return;
                    }
                    
                    document.getElementById('explanation-main').innerHTML = formatExplanation(solution.explanation);
                    
                    var formulaBox = document.getElementById('explanation-formula');
                    if (solution.formula) {
                        formulaBox.textContent = solution.formula;
                        formulaBox.style.display = 'block';
                    } else {
                        formulaBox.style.display = 'none';
                    }
                })
                .catch(function(error) {
                    document.getElementById('explanation-main').innerHTML = '<em style="color: var(--error);">Kunne ikke laste forklaring.</em>';
                });
        }
        
        function formatExplanation(text) {
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\n\n/g, '</p><p style="margin: 0.75em 0;">');
            text = text.replace(/\n/g, '<br>');
            return '<p style="margin: 0;">' + text + '</p>';
        }
        
        function closeExplanation() {
            document.getElementById('explanation-box').classList.remove('visible');
            document.getElementById('btn-explanation').textContent = 'üìñ Vis forklaring';
        }
        
        // ==================== NAVIGATION ====================
        function nextQuestion() {
            var next = gameState.currentIndex + 1;
            while (next < gameState.questions.length && gameState.answered[next]) next++;
            if (next >= gameState.questions.length) {
                for (var i = 0; i < gameState.questions.length; i++) {
                    if (!gameState.answered[i]) { next = i; break; }
                }
            }
            if (next < gameState.questions.length) {
                loadQuestion(next);
            } else {
                showResults();
            }
        }
        
        function showResults() {
            var pct = Math.round((gameState.correctCount / gameState.questions.length) * 100);
            document.getElementById('result-correct').textContent = gameState.correctCount;
            document.getElementById('result-total').textContent = gameState.questions.length;
            document.getElementById('result-percent').textContent = pct + '%';
            document.getElementById('result-icon').textContent = pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üìö';
            document.getElementById('result-title').textContent = pct >= 80 ? 'Fantastisk!' : pct >= 50 ? 'Bra jobbet!' : 'Fortsett √• √∏ve';
            document.getElementById('result-title').className = 'result-title ' + (pct >= 50 ? 'success' : 'error');
            document.getElementById('result-message').textContent = pct >= 80 ? 'Du har mestret dette!' : pct >= 50 ? 'God innsats!' : 'Les teorien og pr√∏v igjen.';
            document.getElementById('result-modal').classList.add('visible');
        }
        
        function restartGame() {
            document.getElementById('result-modal').classList.remove('visible');
            startGame(gameState.currentTopic, gameState.currentDifficulty);
        }
        
        function backToWelcome() {
            document.getElementById('result-modal').classList.remove('visible');
            document.getElementById('game-view').classList.remove('visible');
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('question-selector-section').classList.remove('visible');
            document.getElementById('difficulty-filter').classList.remove('visible');
            
            // Remove active state from topics
            document.querySelectorAll('.topic-item').forEach(function(el) {
                el.classList.remove('active');
            });
            
            gameState.questions = [];
            gameState.allQuestions = [];
            gameState.currentQuestion = null;
        }
        
        // ==================== UI HELPERS ====================
        function switchFormulaTab(tab) {
            document.querySelectorAll('.formula-tab').forEach(function(t) {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tab === 'formulas') {
                document.getElementById('formula-list-container').style.display = 'block';
                document.getElementById('variable-list-container').style.display = 'none';
            } else {
                document.getElementById('formula-list-container').style.display = 'none';
                document.getElementById('variable-list-container').style.display = 'block';
            }
        }
        
        // ==================== CALCULATOR ====================
        var calcState = { equation: '', display: '0' };
        
        function toggleCalculator() {
            document.getElementById('floating-calculator').classList.toggle('visible');
        }
        
        function calcInput(v) {
            calcState.display = calcState.display === '0' && v !== '.' ? v : calcState.display + v;
            updateCalcDisplay();
        }
        
        function calcClear() {
            calcState.display = '0';
            calcState.equation = '';
            updateCalcDisplay();
        }
        
        function calcEquals() {
            try {
                var expr = calcState.display.replace(/√ó/g, '*').replace(/‚àí/g, '-').replace(/\^/g, '**');
                var r = eval(expr);
                calcState.equation = calcState.display + ' =';
                calcState.display = Math.round(r * 10000) / 10000 + '';
            } catch (e) {
                calcState.display = 'Error';
            }
            updateCalcDisplay();
        }
        
        function calcFunction(fn) {
            var v = parseFloat(calcState.display) || 0;
            if (fn === 'sqrt') {
                calcState.display = Math.round(Math.sqrt(v) * 10000) / 10000 + '';
            } else if (fn === 'pv' || fn === 'fv') {
                var r = parseFloat(prompt('Rente (f.eks. 0.10):'));
                var n = parseFloat(prompt('Perioder:'));
                if (!isNaN(r) && !isNaN(n)) {
                    calcState.display = Math.round((fn === 'pv' ? 1 / Math.pow(1 + r, n) : Math.pow(1 + r, n)) * 10000) / 10000 + '';
                }
            }
            updateCalcDisplay();
        }
        
        function updateCalcDisplay() {
            document.getElementById('calc-equation').textContent = calcState.equation;
            document.getElementById('calc-result').textContent = calcState.display;
        }
        
        function setupCalculatorDrag() {
            var calc = document.getElementById('calculator-drag');
            var cont = document.getElementById('floating-calculator');
            var drag = false, ox, oy;
            
            calc.querySelector('.calculator-header').onmousedown = function(e) {
                if (e.target.tagName !== 'BUTTON') {
                    drag = true;
                    ox = e.clientX - cont.offsetLeft;
                    oy = e.clientY - cont.offsetTop;
                }
            };
            
            document.onmousemove = function(e) {
                if (drag) {
                    cont.style.left = (e.clientX - ox) + 'px';
                    cont.style.top = (e.clientY - oy) + 'px';
                    cont.style.right = 'auto';
                    cont.style.bottom = 'auto';
                }
            };
            
            document.onmouseup = function() { drag = false; };
        }
        
        // ==================== UTILITIES ====================
        function shuffleArray(a) {
            var b = a.slice();
            for (var i = b.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = b[i];
                b[i] = b[j];
                b[j] = t;
            }
            return b;
        }
        
        function formatNumber(n) {
            if (typeof n === 'number') {
                return n.toLocaleString('nb-NO');
            }
            return n;
        }
        
        function formatLabel(k) {
            return k.replace(/_/g, ' ')
                    .replace(/([A-Z])/g, ' $1')
                    .replace(/^./, function(s) { return s.toUpperCase(); });
        }
    </script>
</body>
</html>
