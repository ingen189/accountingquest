<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Finance - AccountingQuest</title>
    
    <!-- Felles stilark -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ==================== CORPORATE FINANCE SPECIFIC STYLES ==================== */
        /* Bruker variabler fra main.css */

        /* ==================== EXCEL GRID STYLES ==================== */
        .excel-grid-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            box-shadow: var(--shadow-md);
            margin: var(--space-md) 0;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
            min-width: 600px;
        }

        .excel-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .excel-table th.row-header {
            width: 180px;
            text-align: left;
            padding-left: 15px;
        }

        .excel-table td {
            border: 1px solid var(--border-color);
            padding: 0;
            min-width: 100px;
        }

        .excel-table td.row-label {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 12px 15px;
            font-weight: 500;
        }

        .excel-cell {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 12px;
            font-size: 0.95em;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
            transition: all var(--transition-fast);
        }

        .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgba(74, 222, 128, 0.05);
            z-index: 5;
        }

        .excel-cell:hover:not(:focus):not(.readonly) {
            background: rgba(255,255,255,0.03);
        }

        .excel-cell.readonly {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .excel-cell.correct {
            background: rgba(34, 197, 94, 0.2) !important;
            color: var(--success);
        }

        .excel-cell.incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
            color: var(--error);
        }

        .excel-cell.formula {
            color: var(--accent);
        }

        /* Excel Grid Header Row */
        .excel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .excel-title {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.95em;
        }

        .excel-hint {
            color: var(--text-secondary);
            font-size: 0.8em;
        }

        /* Topic Grid */
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            max-width: 1400px;
            width: 100%;
            margin-bottom: var(--space-2xl);
        }

        .topic-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            cursor: pointer;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .topic-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            transform: scaleX(0);
            transition: transform var(--transition-normal);
        }

        .topic-card:hover::before {
            transform: scaleX(1);
        }

        .topic-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: var(--shadow-accent);
        }

        .topic-icon {
            font-size: 2.5em;
            margin-bottom: var(--space-md);
        }

        .topic-card h3 {
            color: var(--accent);
            margin-bottom: var(--space-sm);
            font-size: 1.3em;
        }

        .topic-card p {
            color: var(--text-secondary);
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: var(--space-md);
        }

        .topic-stats {
            display: flex;
            gap: var(--space-md);
            font-size: 0.85em;
        }

        .topic-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .topic-stat-value {
            color: var(--accent);
            font-weight: bold;
        }

        /* Difficulty Section */
        .difficulty-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 800px;
            width: 100%;
            display: none;
        }

        .difficulty-section.visible {
            display: block;
        }

        .difficulty-section h2 {
            color: var(--accent);
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .difficulty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--space-md);
        }

        .difficulty-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .difficulty-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
        }

        .difficulty-icon {
            font-size: 2em;
            margin-bottom: var(--space-sm);
        }

        .difficulty-card h4 {
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .difficulty-card p {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        /* Main Menu */
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-2xl) var(--space-lg);
            min-height: calc(100vh - 60px);
        }

        .main-menu h1 {
            font-size: 3em;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }

        .main-menu > p {
            font-size: 1.2em;
            color: var(--text-secondary);
            margin-bottom: var(--space-2xl);
            text-align: center;
        }

        /* Game Container */
        .game-container {
            display: none;
            flex-direction: column;
            min-height: calc(100vh - 60px);
        }

        .game-container.visible {
            display: flex;
        }

        /* Progress Section */
        .progress-section {
            padding: var(--space-md) var(--space-xl);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .progress-bar-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            transition: width var(--transition-slow);
            min-width: 40px;
        }

        /* Question Selector */
        .question-selector {
            padding: var(--space-md) var(--space-xl);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .question-selector-grid {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .question-selector-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 8px 15px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 40px;
            text-align: center;
        }

        .question-selector-item:hover {
            border-color: var(--accent);
        }

        .question-selector-item.current {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }

        .question-selector-item.completed {
            background: rgba(74, 222, 128, 0.2);
            border-color: var(--accent);
        }

        .question-selector-item.completed::after {
            content: ' ‚úì';
            color: var(--accent);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .sidebar-tab:hover {
            background: var(--bg-tertiary);
        }

        .sidebar-tab.active {
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }

        .tab-content {
            display: none;
            padding: var(--space-md);
            overflow-y: auto;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            color: var(--accent);
            margin-bottom: var(--space-md);
        }

        /* Formula List */
        .formula-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .formula-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: 12px;
        }

        .formula-name {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 5px;
        }

        .formula-equation {
            font-family: 'Consolas', monospace;
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .formula-description {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        /* Workspace */
        .workspace {
            flex: 1;
            padding: var(--space-xl);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* Question Header */
        .question-header {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border-left: 4px solid var(--accent);
        }

        .question-number {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .question-title {
            color: var(--accent);
            font-size: 1.4em;
            margin-bottom: var(--space-sm);
        }

        .question-text {
            color: var(--text-primary);
            line-height: 1.7;
        }

        .question-badges {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .badge-topic {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-secondary);
        }

        .badge-type {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        /* Data Display */
        .data-display {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
        }

        .data-display h4 {
            color: var(--warning);
            margin-bottom: var(--space-md);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-secondary);
        }

        .data-table td {
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
        }

        /* Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .option-item:hover {
            border-color: var(--accent);
        }

        .option-item.selected {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }

        .option-item.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }

        .option-item.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .option-letter {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .option-item.selected .option-letter {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .option-item.correct .option-letter {
            background: var(--success);
            color: white;
        }

        .option-item.incorrect .option-letter {
            background: var(--error);
            color: white;
        }

        /* Input Fields */
        .input-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            color: var(--text-secondary);
        }

        .input-group input {
            padding: 12px var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .input-group input.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }

        .input-group input.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Hint & Explanation Boxes */
        .hint-box, .explanation-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 0;
            display: none;
            margin-top: var(--space-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .hint-box.visible, .explanation-box.visible {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hint-box {
            border: 2px solid var(--warning);
        }

        .hint-header, .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border);
        }

        .hint-header {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.05));
        }

        .hint-close, .explanation-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .hint-close:hover, .explanation-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .hint-content {
            padding: var(--space-lg);
            display: flex;
            gap: var(--space-md);
            align-items: flex-start;
        }

        .hint-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .hint-content p {
            margin: 0;
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .hint-footer {
            padding: var(--space-md) var(--space-lg);
            border-top: 1px solid var(--border);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: flex-end;
        }

        .hint-level {
            color: var(--warning);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .explanation-box {
            border: 2px solid var(--success);
        }

        .explanation-header {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15), rgba(40, 167, 69, 0.05));
        }

        .explanation-header h4 {
            color: var(--success);
            margin: 0;
            font-size: 1.1rem;
        }

        .explanation-content {
            padding: var(--space-lg);
        }

        .explanation-section {
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .explanation-formula {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
            margin: var(--space-md) 0;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 1.1rem;
            text-align: center;
            border-left: 3px solid var(--accent);
            display: none;
        }

        .explanation-formula.visible {
            display: block;
        }

        .explanation-steps {
            margin-top: var(--space-md);
        }

        .explanation-steps table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-sm) 0;
            font-size: 0.95rem;
        }

        .explanation-steps th, .explanation-steps td {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border);
            text-align: left;
        }

        .explanation-steps th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        .aq-btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .aq-btn-info:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
            transform: translateY(-1px);
        }

        .aq-btn-sm {
            padding: var(--space-xs) var(--space-md);
            font-size: 0.9rem;
        }

        /* Result Modal */
        .result-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .result-modal.visible {
            display: flex;
        }

        .result-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .result-icon {
            font-size: 4em;
            margin-bottom: var(--space-lg);
        }

        .result-title {
            font-size: 1.8em;
            margin-bottom: var(--space-md);
        }

        .result-title.success { color: var(--success); }
        .result-title.error { color: var(--error); }

        .result-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin-bottom: var(--space-xl);
        }

        .result-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }

        .result-stat-label {
            color: var(--text-secondary);
        }

        /* Calculator */
        .floating-calculator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 500;
            display: none;
        }

        .floating-calculator.visible {
            display: block;
        }

        .calculator {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            width: 280px;
            cursor: move;
        }

        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .calculator-title {
            color: var(--accent);
            font-weight: bold;
        }

        .calculator-close {
            background: var(--error);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
        }

        .calc-display {
            background: var(--bg-primary);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            text-align: right;
            font-family: 'Consolas', monospace;
        }

        .calc-equation {
            color: var(--text-secondary);
            font-size: 0.85em;
            min-height: 20px;
        }

        .calc-result {
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .calc-btn {
            padding: 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1.1em;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .calc-btn:hover {
            background: var(--border-light);
        }

        .calc-btn.operator {
            background: var(--accent-secondary);
            color: white;
        }

        .calc-btn.equals {
            background: var(--accent);
            color: var(--bg-primary);
            grid-column: span 2;
        }

        .calc-btn.function {
            background: #a855f7;
            color: white;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        @media (max-width: 768px) {
            .main-menu h1 {
                font-size: 2em;
            }

            .topic-grid {
                grid-template-columns: 1fr;
            }

            .workspace {
                padding: var(--space-md);
            }

            .controls {
                flex-direction: column;
            }

            .controls .aq-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="aq-header">
        <div class="aq-header-left">
            <button class="aq-btn aq-btn-ghost" onclick="goBack()">‚Üê Tilbake</button>
            <button class="aq-btn aq-btn-ghost" onclick="window.location.href='wiki.html'">üìö Wiki</button>
            <span style="color: var(--text-secondary);">Modul: <strong style="color: var(--accent);">Corporate Finance</strong></span>
        </div>
        <div class="aq-header-right">
            <div class="aq-stat">
                <span class="aq-stat-label">Sp√∏rsm√•l:</span>
                <span class="aq-stat-value" id="nav-progress">0/0</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Riktige:</span>
                <span class="aq-stat-value" id="nav-correct">0</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Poeng:</span>
                <span class="aq-stat-value" id="nav-score">0</span>
            </div>
        </div>
    </header>

    <!-- Main Menu -->
    <div class="main-menu" id="main-menu">
        <h1>üìä Corporate Finance</h1>
        <p>Mestre investering, verdivurdering og finansiell analyse</p>

        <div class="topic-grid" id="topic-grid">
            <div class="topic-card" onclick="selectTopic('npv')">
                <div class="topic-icon">üí∞</div>
                <h3>NPV & IRR</h3>
                <p>Net Present Value, Internal Rate of Return, Payback Period</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-npv">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('bonds')">
                <div class="topic-icon">üìú</div>
                <h3>Obligasjoner</h3>
                <p>Verdivurdering, YTM, kuponger, premium/discount</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-bonds">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('stocks')">
                <div class="topic-icon">üìà</div>
                <h3>Aksjer & Dividender</h3>
                <p>Dividend Discount Model, Gordon Growth</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-stocks">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('wacc')">
                <div class="topic-icon">‚öñÔ∏è</div>
                <h3>WACC & Kapitalstruktur</h3>
                <p>Weighted Average Cost of Capital, tax shield</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-wacc">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('portfolio')">
                <div class="topic-icon">üìä</div>
                <h3>Portef√∏lje & Risiko</h3>
                <p>Beta, CAPM, forventet avkastning</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-portfolio">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('annuity')">
                <div class="topic-icon">üîÑ</div>
                <h3>Annuiteter & L√•n</h3>
                <p>Ordinary annuity, annuity due, amortisering</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-annuity">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('forex')">
                <div class="topic-icon">üí±</div>
                <h3>Valuta & Hedging</h3>
                <p>Spot/forward rates, valutarisiko</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-forex">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('options')">
                <div class="topic-icon">üéØ</div>
                <h3>Opsjoner</h3>
                <p>Call/put, protective put, hedging</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value" id="count-options">0</span> oppgaver</div>
                </div>
            </div>

            <div class="topic-card" onclick="selectTopic('mixed')">
                <div class="topic-icon">üé≤</div>
                <h3>Blandet Quiz</h3>
                <p>Tilfeldige sp√∏rsm√•l fra alle temaer</p>
                <div class="topic-stats">
                    <div class="topic-stat">üìù <span class="topic-stat-value">‚àû</span> oppgaver</div>
                </div>
            </div>
        </div>

        <div class="difficulty-section" id="difficulty-section">
            <h2>Velg vanskelighetsgrad for <span id="selected-topic-name">NPV</span></h2>
            <div class="difficulty-grid">
                <div class="difficulty-card" onclick="startGame('easy')">
                    <div class="difficulty-icon">üå±</div>
                    <h4>Lett</h4>
                    <p>Grunnleggende konsepter</p>
                    <span class="aq-badge aq-badge-easy">Hints tilgjengelig</span>
                </div>
                <div class="difficulty-card" onclick="startGame('medium')">
                    <div class="difficulty-icon">üí™</div>
                    <h4>Middels</h4>
                    <p>Standard eksamensoppgaver</p>
                    <span class="aq-badge aq-badge-medium">Noen hints</span>
                </div>
                <div class="difficulty-card" onclick="startGame('hard')">
                    <div class="difficulty-icon">üî•</div>
                    <h4>Vanskelig</h4>
                    <p>Avanserte beregninger</p>
                    <span class="aq-badge aq-badge-hard">Ingen hints</span>
                </div>
                <div class="difficulty-card" onclick="startGame('challenge')">
                    <div class="difficulty-icon">‚ö°</div>
                    <h4>Utfordring</h4>
                    <p>Ekspertniv√•</p>
                    <span class="aq-badge aq-badge-expert">Tidsbegrenset</span>
                </div>
            </div>
            <div style="text-align: center; margin-top: var(--space-lg);">
                <button class="aq-btn aq-btn-ghost" onclick="backToTopics()">‚Üê Velg annet tema</button>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="game-container">
        <div class="progress-section">
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
            </div>
        </div>

        <div class="question-selector">
            <div class="question-selector-grid" id="question-selector"></div>
        </div>

        <div class="main-content">
            <aside class="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('formulas')">üìê Formler</button>
                    <button class="sidebar-tab" onclick="switchTab('variables')">üìä Data</button>
                </div>
                <div id="tab-formulas" class="tab-content active">
                    <h3>üìê Nyttige formler</h3>
                    <div class="formula-list" id="formula-list"></div>
                </div>
                <div id="tab-variables" class="tab-content">
                    <h3>üìä Oppgavedata</h3>
                    <div id="variable-list"></div>
                </div>
            </aside>

            <main class="workspace">
                <div class="question-header">
                    <div class="question-number" id="question-number">Sp√∏rsm√•l 1 av 10</div>
                    <div class="question-title" id="question-title">Laster...</div>
                    <div class="question-text" id="question-text"></div>
                    <div class="question-badges" id="question-badges"></div>
                </div>

                <div class="data-display" id="data-display" style="display: none;">
                    <h4>üìã Oppgavedata</h4>
                    <table class="data-table" id="data-table"><tbody></tbody></table>
                </div>

                <div class="options-container" id="options-container" style="display: none;"></div>
                <div class="input-fields" id="input-fields" style="display: none;"></div>
                <div class="excel-grid-container" id="excel-grid-container" style="display: none;">
                    <div class="excel-header-row">
                        <span class="excel-title">üìä Beregningstabell</span>
                        <span class="excel-hint">Fyll inn de tomme cellene</span>
                    </div>
                    <div class="excel-grid-wrapper">
                        <table class="excel-table" id="excel-table">
                            <thead id="excel-thead"></thead>
                            <tbody id="excel-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="controls">
                    <button class="aq-btn aq-btn-primary" onclick="checkAnswer()" id="btn-check">‚úì Sjekk svar</button>
                    <button class="aq-btn aq-btn-warning" onclick="showHint()" id="btn-hint">üí° Hint</button>
                    <button class="aq-btn aq-btn-info" onclick="toggleExplanation()" id="btn-explanation" style="display: none;">üìñ Vis forklaring</button>
                    <button class="aq-btn aq-btn-ghost" onclick="toggleCalculator()">üî¢ Kalkulator</button>
                    <button class="aq-btn aq-btn-secondary" onclick="nextQuestion()" id="btn-next" style="display: none;">Neste ‚Üí</button>
                </div>

                <div class="hint-box" id="hint-box">
                    <div class="hint-header">
                        <div class="hint-level" id="hint-level">Hint 1 av 3</div>
                        <button class="hint-close" onclick="closeHint()">√ó</button>
                    </div>
                    <div class="hint-content">
                        <div class="hint-icon" id="hint-icon">üí°</div>
                        <p id="hint-text"></p>
                    </div>
                    <div class="hint-footer" id="hint-footer">
                        <button class="aq-btn aq-btn-sm aq-btn-warning" onclick="showHint()" id="btn-next-hint">Neste hint ‚Üí</button>
                    </div>
                </div>

                <div class="explanation-box" id="explanation-box">
                    <div class="explanation-header">
                        <h4>üìñ Forklaring</h4>
                        <button class="explanation-close" onclick="closeExplanation()">√ó</button>
                    </div>
                    <div class="explanation-content" id="explanation-content">
                        <div class="explanation-section" id="explanation-main"></div>
                        <div class="explanation-formula" id="explanation-formula"></div>
                        <div class="explanation-steps" id="explanation-steps"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-icon" id="result-icon">üéâ</div>
            <h2 class="result-title" id="result-title">Gratulerer!</h2>
            <p class="result-message" id="result-message">Du har fullf√∏rt alle sp√∏rsm√•lene!</p>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="result-correct">0</div>
                    <div class="result-stat-label">Riktige</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-total">0</div>
                    <div class="result-stat-label">Totalt</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-percent">0%</div>
                    <div class="result-stat-label">Score</div>
                </div>
            </div>
            <div class="controls" style="justify-content: center;">
                <button class="aq-btn aq-btn-primary" onclick="restartGame()">üîÑ Pr√∏v igjen</button>
                <button class="aq-btn aq-btn-ghost" onclick="backToMenu()">‚Üê Tilbake</button>
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="floating-calculator" id="floating-calculator">
        <div class="calculator" id="calculator-drag">
            <div class="calculator-header">
                <span class="calculator-title">üî¢ Finanskalkulator</span>
                <button class="calculator-close" onclick="toggleCalculator()">√ó</button>
            </div>
            <div class="calc-display">
                <div class="calc-equation" id="calc-equation"></div>
                <div class="calc-result" id="calc-result">0</div>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn function" onclick="calcFunction('pv')">PV</button>
                <button class="calc-btn function" onclick="calcFunction('fv')">FV</button>
                <button class="calc-btn function" onclick="calcFunction('sqrt')">‚àö</button>
                <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcClear()">C</button>
                <button class="calc-btn operator" onclick="calcInput('^')">^</button>
                <button class="calc-btn equals" onclick="calcEquals()">=</button>
                <button class="calc-btn" onclick="calcInput('(')">(</button>
                <button class="calc-btn" onclick="calcInput(')')">)</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/question-service.js"></script>
    <script src="js/theme-manager.js"></script>
    
    <script>
        // Game State
        var gameState = {
            currentTopic: null,
            currentDifficulty: null,
            questions: [],
            currentIndex: 0,
            currentQuestion: null,
            currentGrid: null,
            selectedAnswer: null,
            answeredCorrectly: false,
            hintsUsed: 0,
            score: 0,
            correctCount: 0,
            answered: []
        };

        // Formulas
        var formulas = {
            npv: [
                { name: 'NPV', equation: 'NPV = Œ£ CF‚Çú / (1+r)·µó', description: 'Sum av n√•verdier' },
                { name: 'PV Factor', equation: 'PVF = 1 / (1+r)‚Åø', description: 'Diskonteringsfaktor' },
                { name: 'IRR', equation: 'NPV = 0', description: 'Renten som gir NPV = 0' },
                { name: 'PI', equation: 'PI = PV(CF) / I‚ÇÄ', description: 'Profitability Index' }
            ],
            bonds: [
                { name: 'Bond Price', equation: 'P = Œ£ C/(1+r)·µó + FV/(1+r)‚Åø', description: 'PV av kuponger + p√•lydende' },
                { name: 'Current Yield', equation: 'CY = C / P', description: '√Örlig kupong / Pris' }
            ],
            stocks: [
                { name: 'DDM', equation: 'P‚ÇÄ = D‚ÇÅ / (r - g)', description: 'Gordon Growth Model' },
                { name: 'Required Return', equation: 'r = D‚ÇÅ/P‚ÇÄ + g', description: 'Dividend yield + growth' }
            ],
            wacc: [
                { name: 'WACC', equation: 'WACC = w‚ÇëR‚Çë + w·µàR·µà(1-T)', description: 'Vektet kapitalkostnad' },
                { name: 'CAPM', equation: 'R‚Çë = Rf + Œ≤(Rm - Rf)', description: 'Cost of equity' }
            ],
            portfolio: [
                { name: 'Expected Return', equation: 'E(R) = Œ£ p·µ¢R·µ¢', description: 'Forventet avkastning' },
                { name: 'Beta', equation: 'Œ≤‚Çö = Œ£ w·µ¢Œ≤·µ¢', description: 'Portef√∏lje beta' }
            ],
            annuity: [
                { name: 'PV Annuity', equation: 'PV = PMT √ó [(1-(1+r)‚Åª‚Åø)/r]', description: 'N√•verdi av annuitet' }
            ],
            forex: [
                { name: 'Forward Premium', equation: '(F-S)/S √ó 100', description: 'Premium/discount' }
            ],
            options: [
                { name: 'Call Payoff', equation: 'max(S-K, 0)', description: 'Gevinst ved forfall' },
                { name: 'Put Payoff', equation: 'max(K-S, 0)', description: 'Gevinst ved forfall' }
            ]
        };

        // Init
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof FirebaseConfig !== 'undefined') {
                FirebaseConfig.init().then(loadQuestionCounts).catch(loadFromSeedData);
            }
            setupCalculatorDrag();
        });

        function loadQuestionCounts() {
            ['npv','bonds','stocks','wacc','portfolio','annuity','forex','options'].forEach(function(topic) {
                if (typeof QuestionService !== 'undefined') {
                    QuestionService.getQuestionsByModule('corporate_finance', topic).then(function(q) {
                        var el = document.getElementById('count-' + topic);
                        if (el) el.textContent = q.length;
                    }).catch(function() { loadSeedCount(topic); });
                }
            });
        }

        function loadSeedCount(topic) {
            if (typeof CorporateFinanceSeedData !== 'undefined') {
                var counts = CorporateFinanceSeedData.countByTopic();
                var el = document.getElementById('count-' + topic);
                if (el) el.textContent = counts[topic] || 0;
            }
        }

        function loadFromSeedData() {
            if (typeof CorporateFinanceSeedData !== 'undefined') {
                var counts = CorporateFinanceSeedData.countByTopic();
                Object.keys(counts).forEach(function(t) {
                    var el = document.getElementById('count-' + t);
                    if (el) el.textContent = counts[t];
                });
            }
        }

        // Navigation
        function goBack() {
            if (gameState.currentQuestion) {
                if (confirm('Avslutte? Fremgang g√•r tapt.')) backToMenu();
            } else if (document.getElementById('difficulty-section').classList.contains('visible')) {
                backToTopics();
            } else {
                window.location.href = 'index.html';
            }
        }

        function backToMenu() {
            document.getElementById('main-menu').style.display = 'flex';
            document.getElementById('game-container').classList.remove('visible');
            document.getElementById('result-modal').classList.remove('visible');
            document.getElementById('difficulty-section').classList.remove('visible');
            document.getElementById('topic-grid').style.display = 'grid';
            gameState.currentQuestion = null;
            gameState.questions = [];
        }

        function backToTopics() {
            document.getElementById('difficulty-section').classList.remove('visible');
            document.getElementById('topic-grid').style.display = 'grid';
        }

        // Topic Selection
        function selectTopic(topic) {
            gameState.currentTopic = topic;
            document.getElementById('topic-grid').style.display = 'none';
            document.getElementById('difficulty-section').classList.add('visible');
            var names = { npv:'NPV & IRR', bonds:'Obligasjoner', stocks:'Aksjer', wacc:'WACC', portfolio:'Portef√∏lje', annuity:'Annuiteter', forex:'Valuta', options:'Opsjoner', mixed:'Blandet' };
            document.getElementById('selected-topic-name').textContent = names[topic] || topic;
        }

        function startGame(difficulty) {
            gameState.currentDifficulty = difficulty;
            gameState.score = 0;
            gameState.correctCount = 0;
            gameState.currentIndex = 0;
            gameState.answered = [];
            document.getElementById('nav-score').textContent = '0';
            document.getElementById('nav-correct').textContent = '0';

            loadQuestions().then(function() {
                if (gameState.questions.length === 0) {
                    alert('Ingen sp√∏rsm√•l funnet.');
                    return;
                }
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game-container').classList.add('visible');
                loadFormulas();
                renderQuestionSelector();
                loadQuestion(0);
            });
        }

        function loadQuestions() {
            return new Promise(function(resolve) {
                if (typeof QuestionService !== 'undefined') {
                    var topicFilter = gameState.currentTopic === 'mixed' ? null : gameState.currentTopic;
                    QuestionService.getQuestionsByModule('corporate_finance', topicFilter, gameState.currentDifficulty).then(function(q) {
                        gameState.questions = q.length > 0 ? shuffleArray(q).slice(0,10) : [];
                        if (gameState.questions.length === 0) loadQuestionsFromSeed();
                        resolve();
                    }).catch(function() { loadQuestionsFromSeed(); resolve(); });
                } else {
                    loadQuestionsFromSeed();
                    resolve();
                }
            });
        }

        function loadQuestionsFromSeed() {
            if (typeof CorporateFinanceSeedData === 'undefined') { gameState.questions = []; return; }
            var all = CorporateFinanceSeedData.getAllQuestions();
            var filtered = gameState.currentTopic !== 'mixed' ? all.filter(function(q) { return q.topic === gameState.currentTopic; }) : all;
            if (gameState.currentDifficulty !== 'challenge') {
                filtered = filtered.filter(function(q) { return q.difficulty === gameState.currentDifficulty || (!q.difficulty && gameState.currentDifficulty === 'medium'); });
            }
            gameState.questions = shuffleArray(filtered).slice(0,10);
        }

        // Rendering
        function renderQuestionSelector() {
            var html = '';
            for (var i = 0; i < gameState.questions.length; i++) {
                var cls = 'question-selector-item' + (i === gameState.currentIndex ? ' current' : '') + (gameState.answered[i] ? ' completed' : '');
                html += '<div class="' + cls + '" onclick="loadQuestion(' + i + ')">' + (i+1) + '</div>';
            }
            document.getElementById('question-selector').innerHTML = html;
            var pct = Math.round((gameState.answered.filter(Boolean).length / gameState.questions.length) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-bar').textContent = pct + '%';
            document.getElementById('nav-progress').textContent = (gameState.currentIndex+1) + '/' + gameState.questions.length;
        }

        function loadQuestion(idx) {
            gameState.currentIndex = idx;
            gameState.currentQuestion = gameState.questions[idx];
            gameState.currentGrid = null;
            gameState.selectedAnswer = null;
            gameState.answeredCorrectly = false;
            gameState.hintsUsed = 0;
            var q = gameState.currentQuestion;

            document.getElementById('question-number').textContent = 'Sp√∏rsm√•l ' + (idx+1) + ' av ' + gameState.questions.length;
            document.getElementById('question-title').textContent = q.title || 'Oppgave';
            document.getElementById('question-text').textContent = q.question || q.description || '';
            document.getElementById('question-badges').innerHTML = '<span class="badge badge-topic">' + q.topic + '</span><span class="badge badge-type">' + q.type + '</span>';

            document.getElementById('hint-box').classList.remove('visible');
            document.getElementById('explanation-box').classList.remove('visible');
            document.getElementById('btn-check').style.display = 'inline-flex';
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-hint').disabled = false;

            renderQuestionContent(q);
            renderQuestionSelector();
            renderVariables(q);
        }

        function renderQuestionContent(q) {
            document.getElementById('options-container').style.display = 'none';
            document.getElementById('input-fields').style.display = 'none';
            document.getElementById('data-display').style.display = 'none';
            document.getElementById('excel-grid-container').style.display = 'none';

            // Show data table for ALL question types if data exists
            if (q.data) {
                renderDataTable(q.data);
            }

            if (q.type === 'multiple_choice' || q.type === 'true_false') {
                renderMultipleChoice(q);
            } else if (q.type === 'excel_grid') {
                renderExcelGrid(q);
            } else {
                renderCalculation(q);
            }
        }

        function renderDataTable(data) {
            document.getElementById('data-display').style.display = 'block';
            var tbl = '';
            
            Object.keys(data).forEach(function(k) {
                var v = data[k];
                
                // Handle arrays of objects (like assets with beta)
                if (Array.isArray(v) && v.length > 0 && typeof v[0] === 'object') {
                    // Create a sub-table for array data
                    var headers = Object.keys(v[0]);
                    tbl += '<tr><th colspan="2" style="color: var(--accent); padding-top: 15px;">' + formatLabel(k) + '</th></tr>';
                    
                    // Header row
                    tbl += '<tr>';
                    headers.forEach(function(h) {
                        tbl += '<td style="font-weight: bold; color: var(--text-secondary);">' + formatLabel(h) + '</td>';
                    });
                    tbl += '</tr>';
                    
                    // Data rows
                    v.forEach(function(item) {
                        tbl += '<tr>';
                        headers.forEach(function(h) {
                            var val = item[h];
                            tbl += '<td>' + (typeof val === 'number' ? formatNumber(val) : val) + '</td>';
                        });
                        tbl += '</tr>';
                    });
                }
                // Handle simple arrays
                else if (Array.isArray(v)) {
                    tbl += '<tr><th>' + formatLabel(k) + '</th><td>' + v.join(', ') + '</td></tr>';
                }
                // Handle nested objects (like projects)
                else if (typeof v === 'object' && v !== null) {
                    tbl += '<tr><th colspan="2" style="color: var(--accent); padding-top: 15px;">' + formatLabel(k) + '</th></tr>';
                    Object.keys(v).forEach(function(subKey) {
                        var subVal = v[subKey];
                        if (typeof subVal !== 'object') {
                            tbl += '<tr><th style="padding-left: 20px;">' + formatLabel(subKey) + '</th><td>' + (typeof subVal === 'number' ? formatNumber(subVal) : subVal) + '</td></tr>';
                        }
                    });
                }
                // Handle simple values
                else {
                    tbl += '<tr><th>' + formatLabel(k) + '</th><td>' + (typeof v === 'number' ? formatNumber(v) : v) + '</td></tr>';
                }
            });
            
            document.getElementById('data-table').querySelector('tbody').innerHTML = tbl;
        }

        function renderMultipleChoice(q) {
            var container = document.getElementById('options-container');
            container.style.display = 'flex';
            var opts = q.options || (q.type === 'true_false' ? [{id:'true',text:'Sant'},{id:'false',text:'Usant'}] : []);
            var html = '';
            opts.forEach(function(o,i) {
                html += '<div class="option-item" data-id="' + o.id + '" onclick="selectOption(\'' + o.id + '\')"><div class="option-letter">' + String.fromCharCode(65+i) + '</div><div class="option-text">' + o.text + '</div></div>';
            });
            container.innerHTML = html;
        }

        function renderCalculation(q) {
            document.getElementById('input-fields').style.display = 'grid';
            var fields = q.input_fields || [{id:'answer',label:'Svar',unit:''}];
            var html = '';
            fields.forEach(function(f) {
                html += '<div class="input-group"><label>' + f.label + '</label><input type="text" id="input-' + f.id + '" placeholder="0">' + (f.unit ? '<span class="unit">' + f.unit + '</span>' : '') + '</div>';
            });
            document.getElementById('input-fields').innerHTML = html;
        }

        // ==================== EXCEL GRID RENDERING ====================
        
        function renderExcelGrid(q) {
            document.getElementById('excel-grid-container').style.display = 'block';
            
            var grid = q.grid || q.excel_grid;
            if (!grid) {
                // Auto-generate grid from input_fields
                grid = generateGridFromFields(q);
            }
            
            var thead = document.getElementById('excel-thead');
            var tbody = document.getElementById('excel-tbody');
            
            // Build header
            var headerHtml = '<tr><th class="row-header">' + (grid.rowHeader || 'Beskrivelse') + '</th>';
            (grid.columns || ['Verdi']).forEach(function(col) {
                headerHtml += '<th>' + col + '</th>';
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;
            
            // Build body
            var bodyHtml = '';
            (grid.rows || []).forEach(function(row, rowIndex) {
                bodyHtml += '<tr>';
                bodyHtml += '<td class="row-label">' + row.label + '</td>';
                
                (row.cells || []).forEach(function(cell, colIndex) {
                    var cellId = 'cell-' + rowIndex + '-' + colIndex;
                    var isReadonly = cell.readonly || cell.type === 'given';
                    var value = cell.value !== undefined ? cell.value : '';
                    
                    if (isReadonly) {
                        bodyHtml += '<td><input type="text" class="excel-cell readonly" id="' + cellId + '" value="' + formatNumber(value) + '" readonly></td>';
                    } else {
                        bodyHtml += '<td><input type="text" class="excel-cell" id="' + cellId + '" data-row="' + rowIndex + '" data-col="' + colIndex + '" placeholder="' + (cell.placeholder || '0') + '"></td>';
                    }
                });
                
                bodyHtml += '</tr>';
            });
            tbody.innerHTML = bodyHtml;
            
            // Store grid config for validation
            gameState.currentGrid = grid;
        }
        
        function generateGridFromFields(q) {
            // Auto-generate a simple grid from input_fields
            var fields = q.input_fields || [];
            var rows = [];
            
            // Add data rows if available
            if (q.data) {
                Object.keys(q.data).forEach(function(key) {
                    var val = q.data[key];
                    if (typeof val === 'number' || typeof val === 'string') {
                        rows.push({
                            label: formatLabel(key),
                            cells: [{ value: val, readonly: true, type: 'given' }]
                        });
                    }
                });
            }
            
            // Add input fields as editable rows
            fields.forEach(function(f) {
                rows.push({
                    label: f.label + (f.unit ? ' (' + f.unit + ')' : ''),
                    cells: [{ id: f.id, placeholder: '0' }]
                });
            });
            
            return {
                rowHeader: 'Parameter',
                columns: ['Verdi'],
                rows: rows
            };
        }
        
        function checkExcelGrid() {
            var q = gameState.currentQuestion;
            var grid = gameState.currentGrid;
            var allCorrect = true;
            
            if (!grid || !grid.rows) {
                return checkCalc(); // Fallback
            }
            
            grid.rows.forEach(function(row, rowIndex) {
                (row.cells || []).forEach(function(cell, colIndex) {
                    if (cell.readonly || cell.type === 'given') return;
                    
                    var cellId = 'cell-' + rowIndex + '-' + colIndex;
                    var input = document.getElementById(cellId);
                    if (!input) return;
                    
                    var userValue = parseFloat(input.value.replace(/\s/g, '').replace(',', '.'));
                    var correctValue = cell.answer !== undefined ? cell.answer : (q.solution && q.solution[cell.id]);
                    var tolerance = q.solution && q.solution.tolerance || 1;
                    
                    if (typeof correctValue === 'number') {
                        var isCorrect = Math.abs(userValue - correctValue) <= tolerance;
                        input.classList.remove('correct', 'incorrect');
                        input.classList.add(isCorrect ? 'correct' : 'incorrect');
                        if (!isCorrect) allCorrect = false;
                    }
                });
            });
            
            return allCorrect;
        }

        function renderVariables(q) {
            var container = document.getElementById('variable-list');
            if (!q.data) { container.innerHTML = '<p style="color:var(--text-secondary)">Ingen data</p>'; return; }
            var html = '<div class="formula-list">';
            
            Object.keys(q.data).forEach(function(k) {
                var v = q.data[k];
                
                // Handle arrays of objects
                if (Array.isArray(v) && v.length > 0 && typeof v[0] === 'object') {
                    html += '<div class="formula-item"><div class="formula-name">' + formatLabel(k) + '</div>';
                    v.forEach(function(item) {
                        var itemStr = Object.keys(item).map(function(ik) {
                            return formatLabel(ik) + ': ' + item[ik];
                        }).join(', ');
                        html += '<div class="formula-equation" style="font-size: 0.85em; margin-bottom: 3px;">' + itemStr + '</div>';
                    });
                    html += '</div>';
                }
                // Handle simple arrays
                else if (Array.isArray(v)) {
                    html += '<div class="formula-item"><div class="formula-name">' + formatLabel(k) + '</div><div class="formula-equation">' + v.join(', ') + '</div></div>';
                }
                // Handle simple values
                else if (typeof v !== 'object') {
                    html += '<div class="formula-item"><div class="formula-name">' + formatLabel(k) + '</div><div class="formula-equation">' + (typeof v === 'number' ? formatNumber(v) : v) + '</div></div>';
                }
            });
            container.innerHTML = html + '</div>';
        }

        // Answer handling
        function selectOption(id) {
            if (gameState.answeredCorrectly) return;
            gameState.selectedAnswer = id;
            document.querySelectorAll('.option-item').forEach(function(el) {
                el.classList.toggle('selected', el.dataset.id === id);
            });
        }

        function checkAnswer() {
            var q = gameState.currentQuestion;
            var module = q.module || 'corporate_finance';
            
            // Disable check button while loading
            document.getElementById('btn-check').disabled = true;
            document.getElementById('btn-check').textContent = '‚è≥ Sjekker...';
            
            // Hent fasit fra Firebase
            var solutionPath = 'solutions/' + module + '/' + q.id;
            
            firebase.database().ref(solutionPath).once('value')
                .then(function(snapshot) {
                    var solution = snapshot.val();
                    
                    if (!solution) {
                        alert('Kunne ikke finne fasit for dette sp√∏rsm√•let.');
                        document.getElementById('btn-check').disabled = false;
                        document.getElementById('btn-check').textContent = '‚úì Sjekk svar';
                        return;
                    }
                    
                    var correct;
                    
                    if (q.type === 'multiple_choice' || q.type === 'true_false') {
                        correct = checkMCWithSolution(solution);
                    } else if (q.type === 'excel_grid') {
                        correct = checkExcelGridWithSolution(solution);
                    } else {
                        correct = checkCalcWithSolution(solution);
                    }
                    
                    // Cache solution for explanation
                    gameState.currentSolution = solution;
                    
                    if (correct) handleCorrect(); else handleIncorrect();
                    
                    document.getElementById('btn-check').disabled = false;
                    document.getElementById('btn-check').textContent = '‚úì Sjekk svar';
                })
                .catch(function(error) {
                    console.error('Solution fetch error:', error);
                    alert('Feil ved henting av fasit: ' + error.message);
                    document.getElementById('btn-check').disabled = false;
                    document.getElementById('btn-check').textContent = '‚úì Sjekk svar';
                });
        }

        function checkMCWithSolution(solution) {
            if (!gameState.selectedAnswer) { alert('Velg et svar!'); return null; }
            var q = gameState.currentQuestion;
            var correctId = q.type === 'true_false' ? solution.correct.toString() : solution.correct;
            document.querySelectorAll('.option-item').forEach(function(el) {
                if (el.dataset.id === correctId) el.classList.add('correct');
                else if (el.dataset.id === gameState.selectedAnswer) el.classList.add('incorrect');
            });
            return gameState.selectedAnswer === correctId;
        }

        function checkCalcWithSolution(solution) {
            var q = gameState.currentQuestion;
            var fields = q.input_fields || [{id:'answer'}];
            var ok = true;
            
            // Sjekk om solution.correct er et objekt med flere felter
            var correctValues = solution.correct || solution;
            
            fields.forEach(function(f) {
                var inp = document.getElementById('input-' + f.id);
                if (!inp) return;
                var user = parseFloat(inp.value.replace(/\s/g,'').replace(',','.'));
                var corr = correctValues[f.id] || correctValues;
                var tol = solution.tolerance || 1;
                if (typeof corr === 'number') {
                    var isOk = Math.abs(user - corr) <= tol;
                    inp.classList.add(isOk ? 'correct' : 'incorrect');
                    if (!isOk) ok = false;
                }
            });
            return ok;
        }

        function checkExcelGridWithSolution(solution) {
            // Bruk eksisterende excel grid check men med solution fra Firebase
            var correctCells = solution.correct || {};
            var ok = true;
            var tolerance = solution.tolerance || 0.01;
            
            document.querySelectorAll('#excel-tbody input').forEach(function(inp) {
                var row = inp.dataset.row;
                var col = inp.dataset.col;
                var key = row + ',' + col;
                
                if (correctCells[key] !== undefined) {
                    var user = parseFloat(inp.value.replace(/\s/g,'').replace(',','.'));
                    var corr = parseFloat(correctCells[key]);
                    
                    if (!isNaN(user) && !isNaN(corr)) {
                        var isOk = Math.abs(user - corr) <= Math.abs(corr * tolerance) + 0.01;
                        inp.classList.add(isOk ? 'correct' : 'incorrect');
                        if (!isOk) ok = false;
                    }
                }
            });
            
            return ok;
        }

        function handleCorrect() {
            gameState.answeredCorrectly = true;
            gameState.answered[gameState.currentIndex] = true;
            gameState.correctCount++;
            gameState.score += Math.max(100 - gameState.hintsUsed * 25, 25);
            document.getElementById('nav-score').textContent = gameState.score;
            document.getElementById('nav-correct').textContent = gameState.correctCount;
            
            // Show explanation button instead of auto-showing
            document.getElementById('btn-explanation').style.display = 'inline-flex';
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-hint').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            
            renderQuestionSelector();
            if (gameState.answered.filter(Boolean).length === gameState.questions.length) setTimeout(showResults, 1500);
        }

        function handleIncorrect() {
            // Show first hint automatically on first wrong answer
            if (gameState.hintsUsed === 0) showHint();
            
            // Show explanation button after wrong answer too
            document.getElementById('btn-explanation').style.display = 'inline-flex';
        }

        // ==================== SECURE HINT/EXPLANATION FETCHING ====================
        // Hints og forklaringer hentes ON-DEMAND fra Firebase solutions/
        // Dette forhindrer juksing via DevTools
        
        function showHint() {
            var q = gameState.currentQuestion;
            var module = q.module || 'corporate_finance';
            
            // Vis loading state
            document.getElementById('hint-text').textContent = 'Laster hint...';
            document.getElementById('hint-box').classList.add('visible');
            
            // Hent hint fra Firebase
            var hintPath = 'solutions/' + module + '/' + q.id + '/hints/' + gameState.hintsUsed;
            
            firebase.database().ref(hintPath).once('value')
                .then(function(snapshot) {
                    var hint = snapshot.val();
                    
                    if (!hint) {
                        document.getElementById('hint-text').textContent = 'Ingen flere hints tilgjengelig.';
                        document.getElementById('btn-hint').disabled = true;
                        document.getElementById('btn-next-hint').style.display = 'none';
                        return;
                    }
                    
                    var hintText = typeof hint === 'string' ? hint : hint.text;
                    var level = gameState.hintsUsed + 1;
                    
                    // Hent totalt antall hints for √• vise "X av Y"
                    firebase.database().ref('solutions/' + module + '/' + q.id + '/hints').once('value')
                        .then(function(allHintsSnap) {
                            var allHints = allHintsSnap.val() || [];
                            var totalHints = Array.isArray(allHints) ? allHints.length : Object.keys(allHints).length;
                            
                            // Update UI
                            document.getElementById('hint-level').textContent = 'Hint ' + level + ' av ' + totalHints;
                            
                            var icons = ['üí°', 'üìê', '‚úÖ'];
                            document.getElementById('hint-icon').textContent = icons[Math.min(gameState.hintsUsed, 2)];
                            document.getElementById('hint-text').textContent = hintText;
                            
                            gameState.hintsUsed++;
                            
                            // Update next hint button
                            if (gameState.hintsUsed >= totalHints) {
                                document.getElementById('btn-hint').disabled = true;
                                document.getElementById('btn-next-hint').style.display = 'none';
                            } else {
                                document.getElementById('btn-next-hint').textContent = 'Neste hint (' + (gameState.hintsUsed + 1) + '/' + totalHints + ') ‚Üí';
                                document.getElementById('btn-next-hint').style.display = 'inline-flex';
                            }
                        });
                })
                .catch(function(error) {
                    console.error('Hint fetch error:', error);
                    document.getElementById('hint-text').textContent = 'Kunne ikke laste hint. Pr√∏v igjen.';
                });
        }

        function closeHint() {
            document.getElementById('hint-box').classList.remove('visible');
        }

        function toggleExplanation() {
            var box = document.getElementById('explanation-box');
            if (box.classList.contains('visible')) {
                closeExplanation();
            } else {
                showExplanation();
            }
        }

        function closeExplanation() {
            document.getElementById('explanation-box').classList.remove('visible');
            document.getElementById('btn-explanation').textContent = 'üìñ Vis forklaring';
        }

        function showExplanation() {
            var q = gameState.currentQuestion;
            var module = q.module || 'corporate_finance';
            
            // Vis loading state
            document.getElementById('explanation-main').innerHTML = '<em>Laster forklaring...</em>';
            document.getElementById('explanation-box').classList.add('visible');
            document.getElementById('btn-explanation').textContent = 'üìñ Skjul forklaring';
            
            // Hent forklaring fra Firebase
            var solutionPath = 'solutions/' + module + '/' + q.id;
            
            firebase.database().ref(solutionPath).once('value')
                .then(function(snapshot) {
                    var solution = snapshot.val();
                    
                    if (!solution || !solution.explanation) {
                        document.getElementById('explanation-main').innerHTML = '<em>Ingen forklaring tilgjengelig for dette sp√∏rsm√•let.</em>';
                        return;
                    }
                    
                    // Format explanation
                    var mainText = formatExplanation(solution.explanation);
                    document.getElementById('explanation-main').innerHTML = mainText;
                    
                    // Show formula if available
                    var formulaBox = document.getElementById('explanation-formula');
                    if (solution.formula) {
                        formulaBox.textContent = solution.formula;
                        formulaBox.classList.add('visible');
                    } else {
                        formulaBox.classList.remove('visible');
                    }
                    
                    // Show learning objectives if available
                    if (solution.learning_objectives && solution.learning_objectives.length > 0) {
                        var objHtml = '<div style="margin-top: 1em; padding-top: 1em; border-top: 1px solid var(--border);">';
                        objHtml += '<strong style="color: var(--accent);">üéØ L√¶ringsm√•l:</strong><ul style="margin: 0.5em 0 0 1.5em;">';
                        solution.learning_objectives.forEach(function(obj) {
                            objHtml += '<li>' + obj + '</li>';
                        });
                        objHtml += '</ul></div>';
                        document.getElementById('explanation-main').innerHTML += objHtml;
                    }
                })
                .catch(function(error) {
                    console.error('Explanation fetch error:', error);
                    document.getElementById('explanation-main').innerHTML = '<em style="color: var(--error);">Kunne ikke laste forklaring. Pr√∏v igjen.</em>';
                });
        }

        function formatExplanation(text) {
            // Convert **bold** to <strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Convert markdown-style headers
            text = text.replace(/^### (.+)$/gm, '<h5 style="color: var(--accent); margin: 1em 0 0.5em;">$1</h5>');
            text = text.replace(/^## (.+)$/gm, '<h4 style="color: var(--success); margin: 1em 0 0.5em;">$1</h4>');
            
            // Convert bullet points
            text = text.replace(/^‚Ä¢ (.+)$/gm, '<div style="padding-left: 1em; margin: 0.25em 0;">‚Ä¢ $1</div>');
            text = text.replace(/^- (.+)$/gm, '<div style="padding-left: 1em; margin: 0.25em 0;">‚Ä¢ $1</div>');
            
            // Convert simple tables (|...|...|)
            if (text.includes('|')) {
                text = text.replace(/\|(.+)\|/g, function(match) {
                    var cells = match.split('|').filter(c => c.trim());
                    if (cells.length > 0) {
                        return '<tr>' + cells.map(c => '<td style="padding: 4px 8px; border: 1px solid var(--border);">' + c.trim() + '</td>').join('') + '</tr>';
                    }
                    return match;
                });
                
                // Wrap consecutive table rows in table tags
                text = text.replace(/(<tr>.*?<\/tr>\n?)+/g, '<table style="border-collapse: collapse; margin: 0.5em 0; font-size: 0.9em;">$&</table>');
            }
            
            // Convert newlines to breaks
            text = text.replace(/\n\n/g, '</p><p style="margin: 0.75em 0;">');
            text = text.replace(/\n/g, '<br>');
            
            // Wrap in paragraph
            text = '<p style="margin: 0;">' + text + '</p>';
            
            // Highlight checkmark results
            text = text.replace(/‚úÖ/g, '<span style="color: var(--success);">‚úÖ</span>');
            text = text.replace(/‚ùå/g, '<span style="color: var(--error);">‚ùå</span>');
            
            return text;
        }

        function nextQuestion() {
            var next = gameState.currentIndex + 1;
            while (next < gameState.questions.length && gameState.answered[next]) next++;
            if (next >= gameState.questions.length) for (var i = 0; i < gameState.questions.length; i++) if (!gameState.answered[i]) { next = i; break; }
            if (next < gameState.questions.length) loadQuestion(next); else showResults();
        }

        function showResults() {
            var pct = Math.round((gameState.correctCount / gameState.questions.length) * 100);
            document.getElementById('result-correct').textContent = gameState.correctCount;
            document.getElementById('result-total').textContent = gameState.questions.length;
            document.getElementById('result-percent').textContent = pct + '%';
            document.getElementById('result-icon').textContent = pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üìö';
            document.getElementById('result-title').textContent = pct >= 80 ? 'Fantastisk!' : pct >= 50 ? 'Bra jobbet!' : 'Fortsett √• √∏ve';
            document.getElementById('result-title').className = 'result-title ' + (pct >= 50 ? 'success' : 'error');
            document.getElementById('result-message').textContent = pct >= 80 ? 'Du har mestret dette!' : pct >= 50 ? 'Fortsett √• √∏ve!' : 'Les teorien og pr√∏v igjen.';
            document.getElementById('result-modal').classList.add('visible');
        }

        function restartGame() {
            document.getElementById('result-modal').classList.remove('visible');
            startGame(gameState.currentDifficulty);
        }

        // Formulas
        function loadFormulas() {
            var list = formulas[gameState.currentTopic] || formulas.npv;
            if (gameState.currentTopic === 'mixed') { list = []; Object.keys(formulas).forEach(function(t) { list = list.concat(formulas[t]); }); }
            var html = '';
            list.forEach(function(f) {
                html += '<div class="formula-item"><div class="formula-name">' + f.name + '</div><div class="formula-equation">' + f.equation + '</div><div class="formula-description">' + f.description + '</div></div>';
            });
            document.getElementById('formula-list').innerHTML = html;
        }

        function switchTab(name) {
            document.querySelectorAll('.sidebar-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
            event.target.classList.add('active');
            document.getElementById('tab-' + name).classList.add('active');
        }

        // Calculator
        var calcState = { equation: '', display: '0' };
        function toggleCalculator() { document.getElementById('floating-calculator').classList.toggle('visible'); }
        function calcInput(v) { calcState.display = calcState.display === '0' && v !== '.' ? v : calcState.display + v; updateCalcDisplay(); }
        function calcClear() { calcState.display = '0'; calcState.equation = ''; updateCalcDisplay(); }
        function calcEquals() {
            try {
                var r = eval(calcState.display.replace(/√ó/g,'*').replace(/‚àí/g,'-').replace(/\^/g,'**'));
                calcState.equation = calcState.display + ' =';
                calcState.display = Math.round(r * 10000) / 10000 + '';
            } catch(e) { calcState.display = 'Error'; }
            updateCalcDisplay();
        }
        function calcFunction(fn) {
            var v = parseFloat(calcState.display) || 0;
            if (fn === 'sqrt') calcState.display = Math.round(Math.sqrt(v) * 10000) / 10000 + '';
            else if (fn === 'pv' || fn === 'fv') {
                var r = parseFloat(prompt('Rente (f.eks. 0.10):')), n = parseFloat(prompt('Perioder:'));
                if (!isNaN(r) && !isNaN(n)) calcState.display = Math.round((fn === 'pv' ? 1/Math.pow(1+r,n) : Math.pow(1+r,n)) * 10000) / 10000 + '';
            }
            updateCalcDisplay();
        }
        function updateCalcDisplay() {
            document.getElementById('calc-equation').textContent = calcState.equation;
            document.getElementById('calc-result').textContent = calcState.display;
        }
        function setupCalculatorDrag() {
            var calc = document.getElementById('calculator-drag'), cont = document.getElementById('floating-calculator'), drag = false, ox, oy;
            calc.onmousedown = function(e) { if (e.target.tagName !== 'BUTTON') { drag = true; ox = e.clientX - cont.offsetLeft; oy = e.clientY - cont.offsetTop; } };
            document.onmousemove = function(e) { if (drag) { cont.style.left = (e.clientX - ox) + 'px'; cont.style.top = (e.clientY - oy) + 'px'; cont.style.right = 'auto'; cont.style.bottom = 'auto'; } };
            document.onmouseup = function() { drag = false; };
        }

        // Utils
        function shuffleArray(a) { var b = a.slice(); for (var i = b.length - 1; i > 0; i--) { var j = Math.floor(Math.random() * (i + 1)); var t = b[i]; b[i] = b[j]; b[j] = t; } return b; }
        function formatNumber(n) { return typeof n === 'number' ? n.toLocaleString('nb-NO') : n; }
        function formatLabel(k) { return k.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, function(s) { return s.toUpperCase(); }); }
    </script>
</body>
</html>
