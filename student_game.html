<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spill - AccountingQuest</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow: hidden;
        }
        .game-container { display: flex; flex-direction: column; height: 100vh; }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #4ade80;
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-avatar { font-size: 2em; }
        .player-name { font-weight: bold; font-size: 1.2em; }
        .score-display { font-size: 1.5em; color: #4ade80; font-weight: bold; }
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }

        /* Waiting Screen */
        .waiting-screen { text-align: center; display: none; }
        .waiting-screen.show { display: block; }
        .waiting-icon { font-size: 5em; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .waiting-text { font-size: 1.5em; color: #9ca3af; }

        /* Question Screen */
        .question-screen { display: none; }
        .question-screen.show { display: block; }
        .question-display {
            background: rgba(45, 45, 45, 0.8);
            border: 3px solid #4ade80;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
        }
        .question-number { font-size: 1.2em; color: #9ca3af; margin-bottom: 20px; }
        .question-text { font-size: 2em; color: #e0e0e0; margin-bottom: 30px; line-height: 1.4; }
        .timer-display { font-size: 3em; color: #4ade80; font-weight: bold; }
        .timer-display.warning { color: #f59e0b; animation: pulse 0.5s infinite; }
        .timer-display.danger { color: #ef4444; }
        .answers-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        .answer-btn {
            background: #2d2d2d;
            border: 4px solid #404040;
            border-radius: 20px;
            padding: 40px 20px;
            font-size: 1.3em;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .answer-btn:hover:not(:disabled) { transform: scale(1.05); }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .answer-btn.answer-a { border-color: #ef4444; }
        .answer-btn.answer-a:hover:not(:disabled) { background: #ef4444; }
        .answer-btn.answer-b { border-color: #3b82f6; }
        .answer-btn.answer-b:hover:not(:disabled) { background: #3b82f6; }
        .answer-btn.answer-c { border-color: #f59e0b; }
        .answer-btn.answer-c:hover:not(:disabled) { background: #f59e0b; }
        .answer-btn.answer-d { border-color: #22c55e; }
        .answer-btn.answer-d:hover:not(:disabled) { background: #22c55e; }
        .answer-btn.selected { transform: scale(1.05); box-shadow: 0 0 40px rgba(74, 222, 128, 0.5); }
        .answer-btn.answer-a.selected { background: #ef4444; }
        .answer-btn.answer-b.selected { background: #3b82f6; }
        .answer-btn.answer-c.selected { background: #f59e0b; }
        .answer-btn.answer-d.selected { background: #22c55e; }
        .answer-label { font-size: 1.8em; font-weight: bold; margin-bottom: 15px; }
        .answer-text { font-size: 1.1em; }

        /* Feedback Screen */
        .feedback-screen { display: none; text-align: center; padding: 40px; }
        .feedback-screen.show { display: block; }
        .feedback-icon { font-size: 8em; margin-bottom: 30px; }
        .feedback-text { font-size: 2em; margin-bottom: 20px; }
        .feedback-text.correct { color: #4ade80; }
        .feedback-text.incorrect { color: #ef4444; }
        .points-earned { font-size: 3em; color: #4ade80; font-weight: bold; margin: 20px 0; }

        /* Results Screen */
        .results-screen { display: none; text-align: center; padding: 40px 20px; }
        .results-screen.show { display: block; }
        .final-score { background: #2d2d2d; border: 3px solid #4ade80; border-radius: 20px; padding: 40px; max-width: 500px; margin: 0 auto; }
        .trophy-icon { font-size: 5em; margin-bottom: 20px; }
        .final-score-title { font-size: 1.5em; color: #9ca3af; margin-bottom: 10px; }
        .final-score-value { font-size: 4em; color: #4ade80; font-weight: bold; }
        .rank-display { font-size: 1.3em; color: #f59e0b; margin-top: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .stat-box { background: #404040; padding: 20px; border-radius: 10px; }
        .stat-value { font-size: 2em; color: #4ade80; font-weight: bold; }
        .stat-label { color: #9ca3af; margin-top: 5px; }

        @media (max-width: 768px) {
            .answers-container { grid-template-columns: 1fr; }
            .question-text { font-size: 1.5em; }
            .answer-btn { padding: 30px 15px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="player-info">
                <div class="player-avatar" id="player-avatar">üòä</div>
                <div class="player-name" id="player-name">Spiller</div>
            </div>
            <div class="score-display">Poeng: <span id="score">0</span></div>
        </div>

        <div class="game-content">
            <!-- Waiting Screen -->
            <div class="waiting-screen show" id="waiting-screen">
                <div class="waiting-icon">‚è≥</div>
                <div class="waiting-text">Venter p√• neste sp√∏rsm√•l...</div>
            </div>

            <!-- Question Screen -->
            <div class="question-screen" id="question-screen">
                <div class="question-display">
                    <div class="question-number" id="question-number">Sp√∏rsm√•l 1</div>
                    <div class="question-text" id="question-text">Sp√∏rsm√•l lastes...</div>
                    <div class="timer-display" id="timer">30</div>
                </div>

                <div class="answers-container" id="answers-container">
                    <!-- Answers will be loaded here -->
                </div>
            </div>

            <!-- Feedback Screen -->
            <div class="feedback-screen" id="feedback-screen">
                <div class="feedback-icon" id="feedback-icon">‚úÖ</div>
                <div class="feedback-text" id="feedback-text">Riktig!</div>
                <div class="points-earned" id="points-earned">+750</div>
            </div>

            <!-- Results Screen -->
            <div class="results-screen" id="results-screen">
                <div class="final-score">
                    <div class="trophy-icon">üèÜ</div>
                    <div class="final-score-title">Din totale poengsum:</div>
                    <div class="final-score-value" id="final-score">0</div>
                    <div class="rank-display" id="rank-display">Gratulerer!</div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="correct-count">0</div>
                            <div class="stat-label">Riktige svar</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="accuracy">0%</div>
                            <div class="stat-label">N√∏yaktighet</div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button onclick="window.location.href='multiplayer_index.html'" 
                            style="background: #4ade80; color: #1e1e1e; border: none; padding: 15px 40px; border-radius: 10px; font-size: 1.1em; cursor: pointer;">
                        ‚Üê Tilbake til meny
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        var firebaseConfig = {
            apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
            authDomain: "accountingquest-multiplayer.firebaseapp.com",
            databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "accountingquest-multiplayer",
            storageBucket: "accountingquest-multiplayer.firebasestorage.app",
            messagingSenderId: "525417361926",
            appId: "1:525417361926:web:ec9b737f82af9b21700987"
        };
        
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();
        console.log('üî• Firebase initialized');

        // Game State
        var gameState = {
            pin: '',
            playerId: '',
            playerName: '',
            playerAvatar: 'üòä',
            score: 0,
            currentQuestionIndex: -1,
            timeLeft: 0,
            timer: null,
            correctCount: 0,
            totalQuestions: 0,
            hasAnswered: false
        };

        function init() {
            var urlParams = new URLSearchParams(window.location.search);
            gameState.pin = urlParams.get('pin');
            gameState.playerName = urlParams.get('name');
            gameState.playerId = urlParams.get('id');

            if (!gameState.pin || !gameState.playerName) {
                alert('Ugyldig spillinformasjon');
                window.location.href = 'student_join.html';
                return;
            }

            // Get player info from Firebase
            db.ref('games/' + gameState.pin + '/players/' + gameState.playerId).once('value')
                .then(function(snapshot) {
                    var player = snapshot.val();
                    if (player) {
                        gameState.playerAvatar = player.avatar || 'üòä';
                        document.getElementById('player-avatar').textContent = gameState.playerAvatar;
                        document.getElementById('player-name').textContent = gameState.playerName;
                    }
                });

            // Listen for question changes
            listenForQuestions();
            
            // Listen for game status
            listenForGameStatus();
        }

        function listenForQuestions() {
            db.ref('games/' + gameState.pin + '/currentQuestion').on('value', function(snapshot) {
                var questionData = snapshot.val();
                
                if (questionData && questionData.index !== gameState.currentQuestionIndex) {
                    loadQuestion(questionData);
                }
            });
        }

        function listenForGameStatus() {
            db.ref('games/' + gameState.pin + '/status').on('value', function(snapshot) {
                var status = snapshot.val();
                if (status === 'finished') {
                    showResults();
                }
            });
        }

        function loadQuestion(questionData) {
            gameState.currentQuestionIndex = questionData.index;
            gameState.totalQuestions = Math.max(gameState.totalQuestions, questionData.index + 1);
            gameState.hasAnswered = false;

            // Hide other screens, show question
            hideAllScreens();
            document.getElementById('question-screen').classList.add('show');

            // Update UI
            document.getElementById('question-number').textContent = 'Sp√∏rsm√•l ' + (questionData.index + 1);
            document.getElementById('question-text').textContent = questionData.text;

            // Load answers
            var container = document.getElementById('answers-container');
            var labels = ['A', 'B', 'C', 'D'];
            var classes = ['answer-a', 'answer-b', 'answer-c', 'answer-d'];
            
            var html = '';
            questionData.answers.forEach(function(answer, i) {
                html += '<button class="answer-btn ' + classes[i] + '" onclick="selectAnswer(' + i + ')">' +
                    '<div class="answer-label">' + labels[i] + '</div>' +
                    '<div class="answer-text">' + answer + '</div>' +
                '</button>';
            });
            container.innerHTML = html;

            // Start timer (estimate based on server time)
            startTimer(30); // Default 30 seconds
        }

        function startTimer(duration) {
            gameState.timeLeft = duration;
            var timerEl = document.getElementById('timer');
            timerEl.textContent = gameState.timeLeft;
            timerEl.className = 'timer-display';

            if (gameState.timer) {
                clearInterval(gameState.timer);
            }

            gameState.timer = setInterval(function() {
                gameState.timeLeft--;
                timerEl.textContent = Math.max(0, gameState.timeLeft);

                if (gameState.timeLeft <= 10) {
                    timerEl.classList.add('warning');
                }
                if (gameState.timeLeft <= 5) {
                    timerEl.classList.add('danger');
                }

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    // Disable buttons if time runs out
                    document.querySelectorAll('.answer-btn').forEach(function(btn) {
                        btn.disabled = true;
                    });
                    
                    if (!gameState.hasAnswered) {
                        showFeedback(false, 0);
                    }
                }
            }, 1000);
        }

        function selectAnswer(answerIndex) {
            if (gameState.hasAnswered) return;
            gameState.hasAnswered = true;

            clearInterval(gameState.timer);

            // Disable all buttons
            document.querySelectorAll('.answer-btn').forEach(function(btn) {
                btn.disabled = true;
            });

            // Highlight selected answer
            document.querySelectorAll('.answer-btn')[answerIndex].classList.add('selected');

            // Calculate points
            var timeBonus = Math.max(0, gameState.timeLeft);
            var points = 500 + Math.floor((timeBonus / 30) * 500);

            // Save answer to Firebase
            db.ref('games/' + gameState.pin + '/answers/' + gameState.playerId).set({
                questionIndex: gameState.currentQuestionIndex,
                answer: answerIndex,
                timeLeft: gameState.timeLeft,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            // Show feedback after short delay
            setTimeout(function() {
                // For now, assume all answers are correct for demo
                // In real implementation, you'd check against correct answer
                gameState.score += points;
                gameState.correctCount++;
                document.getElementById('score').textContent = gameState.score;
                showFeedback(true, points);
            }, 500);
        }

        function showFeedback(isCorrect, points) {
            hideAllScreens();
            document.getElementById('feedback-screen').classList.add('show');

            if (isCorrect) {
                document.getElementById('feedback-icon').textContent = '‚úÖ';
                document.getElementById('feedback-text').textContent = 'Riktig svar!';
                document.getElementById('feedback-text').className = 'feedback-text correct';
                document.getElementById('points-earned').textContent = '+' + points;
                document.getElementById('points-earned').style.display = 'block';
            } else {
                document.getElementById('feedback-icon').textContent = '‚ùå';
                document.getElementById('feedback-text').textContent = 'Tiden gikk ut!';
                document.getElementById('feedback-text').className = 'feedback-text incorrect';
                document.getElementById('points-earned').style.display = 'none';
            }

            // Return to waiting screen after delay
            setTimeout(function() {
                hideAllScreens();
                document.getElementById('waiting-screen').classList.add('show');
            }, 2000);
        }

        function showResults() {
            clearInterval(gameState.timer);
            hideAllScreens();
            document.getElementById('results-screen').classList.add('show');

            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('correct-count').textContent = gameState.correctCount;
            
            var accuracy = gameState.totalQuestions > 0 ? 
                Math.round((gameState.correctCount / gameState.totalQuestions) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';

            // Get rank from Firebase
            db.ref('games/' + gameState.pin + '/players').orderByChild('score').once('value')
                .then(function(snapshot) {
                    var players = [];
                    snapshot.forEach(function(child) {
                        players.push({ id: child.key, ...child.val() });
                    });
                    players.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
                    
                    var rank = players.findIndex(function(p) { return p.id === gameState.playerId; }) + 1;
                    if (rank === 1) {
                        document.getElementById('rank-display').textContent = 'ü•á Du vant!';
                    } else if (rank === 2) {
                        document.getElementById('rank-display').textContent = 'ü•à Andreplass!';
                    } else if (rank === 3) {
                        document.getElementById('rank-display').textContent = 'ü•â Tredjeplass!';
                    } else {
                        document.getElementById('rank-display').textContent = 'Du kom p√• ' + rank + '. plass';
                    }
                });
        }

        function hideAllScreens() {
            document.getElementById('waiting-screen').classList.remove('show');
            document.getElementById('question-screen').classList.remove('show');
            document.getElementById('feedback-screen').classList.remove('show');
            document.getElementById('results-screen').classList.remove('show');
        }

        // Initialize
        window.onload = init;
    </script>
</body>
</html>
