<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spill - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéÆ</text></svg>">
    <meta name="theme-color" content="#0f1419">

    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ===== PAGE SPECIFIC STYLES ===== */

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .game-container { display: flex; flex-direction: column; min-height: 100vh; }
        .header {
            background: rgba(0,0,0,0.3);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--accent);
        }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-avatar { font-size: 2em; }
        .player-name { font-weight: bold; font-size: 1.2em; }
        .score-display { font-size: 1.5em; color: var(--accent); font-weight: bold; }
        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        /* Waiting Screen */
        .screen { display: none; }
        .screen.show { display: block; }
        .waiting-screen { text-align: center; }
        .waiting-icon { font-size: 5em; margin-bottom: 20px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .waiting-text { font-size: 1.5em; color: var(--text-secondary); }

        /* Question Display */
        .question-display {
            background: rgba(45, 45, 45, 0.8);
            border: 3px solid var(--accent);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
        }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .question-number { font-size: 1.1em; color: var(--text-secondary); }
        .question-type-badge {
            background: var(--accent);
            color: #1a1a2e;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .question-text { font-size: 1.6em; color: var(--text-primary); line-height: 1.4; }
        .timer-display { font-size: 3em; color: var(--accent); font-weight: bold; margin-top: 15px; }
        .timer-display.warning { color: var(--warning); animation: pulse 0.5s infinite; }
        .timer-display.danger { color: var(--error); }

        /* Multiple Choice / True False Buttons */
        .answers-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .answers-container.single-column { grid-template-columns: 1fr; max-width: 600px; }
        
        .answer-btn {
            background: var(--bg-secondary);
            border: 4px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 30px 20px;
            font-size: 1.2em;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        .answer-btn:hover:not(:disabled) { transform: scale(1.03); }
        .answer-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .answer-btn.answer-a { border-color: var(--error); }
        .answer-btn.answer-a:hover:not(:disabled), .answer-btn.answer-a.selected { background: var(--error); }
        .answer-btn.answer-b { border-color: var(--info); }
        .answer-btn.answer-b:hover:not(:disabled), .answer-btn.answer-b.selected { background: var(--info); }
        .answer-btn.answer-c { border-color: var(--warning); }
        .answer-btn.answer-c:hover:not(:disabled), .answer-btn.answer-c.selected { background: var(--warning); }
        .answer-btn.answer-d { border-color: var(--accent-hover); }
        .answer-btn.answer-d:hover:not(:disabled), .answer-btn.answer-d.selected { background: var(--accent-hover); }
        .answer-btn.selected { transform: scale(1.03); box-shadow: 0 0 30px rgba(74, 222, 128, 0.4); }
        .answer-label { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; }
        .answer-text { font-size: 1em; }

        /* Multiple Select (checkboxes) */
        .checkbox-container { max-width: 700px; margin: 0 auto; }
        .checkbox-item {
            background: var(--bg-secondary);
            border: 3px solid var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .checkbox-item:hover { border-color: var(--accent); }
        .checkbox-item.selected { border-color: var(--accent); background: rgba(74, 222, 128, 0.15); }
        .checkbox-item input[type="checkbox"] { width: 25px; height: 25px; cursor: pointer; }
        .checkbox-item label { flex: 1; cursor: pointer; font-size: 1.1em; }

        /* True/False */
        .tf-container { display: flex; gap: 30px; justify-content: center; max-width: 600px; margin: 0 auto; }
        .tf-btn {
            flex: 1;
            padding: 50px 30px;
            border-radius: 20px;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border: 4px solid;
        }
        .tf-btn.true { background: var(--bg-secondary); border-color: var(--accent-hover); color: var(--accent-hover); }
        .tf-btn.true:hover, .tf-btn.true.selected { background: var(--accent-hover); color: white; }
        .tf-btn.false { background: var(--bg-secondary); border-color: var(--error); color: var(--error); }
        .tf-btn.false:hover, .tf-btn.false.selected { background: var(--error); color: white; }

        /* Drag and Drop */
        .dd-container { max-width: 900px; margin: 0 auto; }
        .dd-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .dd-category {
            background: #1a1a2e;
            border: 3px dashed var(--bg-tertiary);
            border-radius: 15px;
            min-height: 150px;
            padding: 15px;
        }
        .dd-category.drag-over { border-color: var(--accent); background: rgba(74, 222, 128, 0.1); }
        .dd-category-title {
            text-align: center;
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-tertiary);
        }
        .dd-category-items { min-height: 80px; }
        .dd-items-pool {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .dd-item {
            background: var(--bg-tertiary);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 12px 20px;
            cursor: grab;
            transition: all 0.2s;
            font-size: 1em;
        }
        .dd-item:hover { border-color: var(--accent); }
        .dd-item.dragging { opacity: 0.5; cursor: grabbing; }
        .dd-item.placed { background: var(--accent); color: #1a1a2e; border-color: var(--accent); }

        /* Bokf√∏ring */
        .bokforing-container { max-width: 800px; margin: 0 auto; }
        .bokforing-scenario {
            background: #1a1a2e;
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.1em;
            line-height: 1.6;
        }
        .bokforing-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
        }
        .bokforing-table th {
            background: #1a1a2e;
            padding: 15px;
            text-align: left;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
        }
        .bokforing-table th:nth-child(3),
        .bokforing-table th:nth-child(4) { text-align: right; }
        .bokforing-table td { padding: 10px 15px; border-bottom: 1px solid var(--bg-tertiary); }
        .bokforing-table input {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 2px solid var(--bg-tertiary);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 1em;
        }
        .bokforing-table input:focus { outline: none; border-color: var(--accent); }
        .bokforing-table input[type="number"] { text-align: right; }
        .add-row-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px dashed #555;
            padding: 15px;
            width: 100%;
            margin-top: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        .add-row-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Analyse */
        .analyse-container { max-width: 700px; margin: 0 auto; }
        .analyse-data {
            background: #1a1a2e;
            border: 2px solid var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .analyse-data h4 { color: var(--accent); margin-bottom: 15px; }
        .analyse-data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .analyse-data-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 5px;
        }
        .analyse-data-item span:last-child { color: var(--accent); font-weight: bold; }
        .analyse-input-group {
            text-align: center;
            padding: 20px;
        }
        .analyse-input-group label { display: block; margin-bottom: 10px; font-size: 1.2em; }
        .analyse-input {
            width: 200px;
            padding: 15px;
            font-size: 1.5em;
            text-align: center;
            background: #1a1a2e;
            border: 3px solid var(--accent);
            border-radius: 10px;
            color: var(--text-primary);
        }

        /* Submit Button */
        .submit-container { text-align: center; margin-top: 25px; }
        .submit-btn {
            background: var(--accent);
            color: #1a1a2e;
            border: none;
            padding: 20px 60px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .submit-btn:hover { background: var(--accent-hover); transform: scale(1.05); }
        .submit-btn:disabled { background: #555; cursor: not-allowed; transform: none; }

        /* Feedback Screen */
        .feedback-screen { text-align: center; padding: 40px; }
        .feedback-icon { font-size: 6em; margin-bottom: 20px; }
        .feedback-text { font-size: 2em; margin-bottom: 15px; }
        .feedback-points { font-size: 3em; color: var(--accent); font-weight: bold; }
        .feedback-correct { color: var(--accent-hover); }
        .feedback-wrong { color: var(--error); }

        /* Results Screen */
        .results-screen { text-align: center; padding: 30px; }
        .results-title { font-size: 2.5em; color: var(--accent); margin-bottom: 30px; }
        .results-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto 30px;
        }
        .stat-box {
            background: var(--bg-secondary);
            border: 2px solid var(--bg-tertiary);
            border-radius: 15px;
            padding: 25px;
        }
        .stat-value { font-size: 2.5em; color: var(--accent); font-weight: bold; }
        .stat-label { color: var(--text-secondary); margin-top: 10px; }
        .rank-display {
            font-size: 4em;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .answers-container { grid-template-columns: 1fr; }
            .tf-container { flex-direction: column; }
            .dd-categories { grid-template-columns: 1fr; }
            .results-stats { grid-template-columns: 1fr; }
            .question-text { font-size: 1.3em; }
            .answer-btn { padding: 20px 15px; }
        }
    
    </style>

</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="player-info">
                <div class="player-avatar" id="player-avatar">üòä</div>
                <div class="player-name" id="player-name">Spiller</div>
            </div>
            <div class="score-display">
                <span id="score">0</span> poeng
            </div>
        </div>

        <div class="game-content">
            <!-- Waiting Screen -->
            <div class="screen waiting-screen show" id="waiting-screen">
                <div class="waiting-icon">‚è≥</div>
                <div class="waiting-text">Venter p√• at l√¶reren skal starte...</div>
            </div>

            <!-- Question Screen -->
            <div class="screen question-screen" id="question-screen">
                <div class="question-display">
                    <div class="question-header">
                        <div class="question-number" id="question-number">Sp√∏rsm√•l 1</div>
                        <div class="question-type-badge" id="question-type-badge">Quiz</div>
                    </div>
                    <div class="question-text" id="question-text">Sp√∏rsm√•let vises her...</div>
                    <div class="timer-display" id="timer">30</div>
                </div>

                <!-- Answer area - changes based on type -->
                <div id="answer-area"></div>

                <!-- Submit button for types that need it -->
                <div class="submit-container" id="submit-container" style="display: none;">
                    <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">‚úì Send svar</button>
                </div>
            </div>

            <!-- Feedback Screen -->
            <div class="screen feedback-screen" id="feedback-screen">
                <div class="feedback-icon" id="feedback-icon">‚úÖ</div>
                <div class="feedback-text" id="feedback-text">Riktig!</div>
                <div class="feedback-points" id="feedback-points">+500</div>
            </div>

            <!-- Results Screen -->
            <div class="screen results-screen" id="results-screen">
                <h1 class="results-title">üéâ Ferdig!</h1>
                <div class="results-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="final-score">0</div>
                        <div class="stat-label">Poeng</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">Riktige</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">N√∏yaktighet</div>
                    </div>
                </div>
                <div class="rank-display" id="rank-display">üèÜ</div>
                <p style="color: var(--text-secondary); font-size: 1.2em;" id="rank-text">Din plassering</p>
                
                <button onclick="window.location.href='student_join.html'" style="
                    margin-top: 30px;
                    background: var(--accent);
                    color: var(--bg-primary);
                    border: none;
                    padding: 15px 40px;
                    border-radius: 10px;
                    font-size: 1.2em;
                    font-weight: bold;
                    cursor: pointer;
                    transition: all 0.3s;
                " onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent)'">
                    ‚Üê Tilbake til lobby
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        var gameState = {
            pin: '',
            playerId: '',
            playerName: '',
            playerAvatar: 'üòä',
            score: 0,
            currentQuestionIndex: -1,
            currentQuestion: null,
            timeLeft: 0,
            timer: null,
            correctCount: 0,
            totalQuestions: 0,
            hasAnswered: false,
            questionStartTime: 0,
            timePerQuestion: 30,
            selectedAnswer: null,
            selectedAnswers: [], // For multiple select
            dragDropAnswers: {}, // For drag and drop
            bokforingAnswers: [], // For bokf√∏ring
            analyseAnswer: '' // For analyse
        };

        // Question type labels
        var typeLabels = {
            multiple_choice: 'üîò Flervalg',
            multiple_select: '‚òëÔ∏è Velg flere',
            true_false: '‚úÖ Sant/Usant',
            paragraph: 'üìú Paragraf',
            drag_drop: 'üéØ Dra & Slipp',
            bokforing: 'üìä Bokf√∏ring',
            analyse: 'üìà Analyse'
        };

        function init() {
            console.log('üöÄ Initializing student game...');
            
            var urlParams = new URLSearchParams(window.location.search);
            gameState.pin = urlParams.get('pin');
            gameState.playerName = urlParams.get('name');
            gameState.playerId = urlParams.get('id');

            console.log('üìå Game PIN:', gameState.pin);
            console.log('üë§ Player:', gameState.playerName, '(ID:', gameState.playerId + ')');

            if (!gameState.pin || !gameState.playerName) {
                alert('Ugyldig spillinformasjon');
                window.location.href = 'student_join.html';
                return;
            }

            // ‚≠ê CRITICAL: Authenticate with Firebase first!
            console.log('üîê Authenticating with Firebase...');
            firebase.auth().signInAnonymously()
                .then(function() {
                    console.log('‚úÖ Firebase authentication successful!');
                    console.log('üë§ User ID:', firebase.auth().currentUser.uid);
                    
                    // Now that we're authenticated, set up the game
                    setupGame();
                })
                .catch(function(error) {
                    console.error('üî• Firebase authentication error:', error);
                    alert('Kunne ikke koble til spillet: ' + error.message);
                });
        }

        function setupGame() {
            console.log('‚öôÔ∏è  Setting up game...');
            
            // Get player info and restore score from Firebase
            db.ref('games/' + gameState.pin + '/players/' + gameState.playerId).once('value')
                .then(function(snapshot) {
                    console.log('üì• Player data received:', snapshot.val());
                    var player = snapshot.val();
                    if (player) {
                        gameState.playerAvatar = player.avatar || 'üòä';
                        gameState.score = player.score || 0;
                        gameState.correctCount = player.correctCount || 0;
                        document.getElementById('player-avatar').textContent = gameState.playerAvatar;
                        document.getElementById('player-name').textContent = gameState.playerName;
                        document.getElementById('score').textContent = gameState.score;
                    }
                })
                .catch(function(error) {
                    console.error('üî• Error fetching player data:', error);
                });

            // Get time per question from quiz settings
            db.ref('games/' + gameState.pin + '/quiz/timePerQuestion').once('value')
                .then(function(snapshot) {
                    gameState.timePerQuestion = snapshot.val() || 30;
                    console.log('‚è±Ô∏è  Time per question:', gameState.timePerQuestion);
                })
                .catch(function(error) {
                    console.error('üî• Error fetching time setting:', error);
                });

            // Listen for question changes
            listenForQuestions();
            
            // Listen for game status
            listenForGameStatus();
            
            console.log('‚úÖ Game setup complete! Ready for questions.');
        }

        function listenForQuestions() {
            console.log('üîä Listening for questions on game:', gameState.pin);
            
            db.ref('games/' + gameState.pin + '/currentQuestion').on('value', function(snapshot) {
                var questionData = snapshot.val();
                console.log('üì© Received question data:', questionData);
                console.log('üìä Current question index:', gameState.currentQuestionIndex);
                
                if (questionData) {
                    console.log('‚úÖ Question data exists, index:', questionData.index);
                    
                    if (questionData.index !== gameState.currentQuestionIndex) {
                        console.log('üöÄ Loading new question:', questionData.index);
                        loadQuestion(questionData);
                    } else {
                        console.log('‚è≠Ô∏è  Same question index, skipping');
                    }
                } else {
                    console.log('‚ùå No question data received');
                }
            }, function(error) {
                console.error('üî• Firebase error:', error);
                alert('Feil ved lytting til sp√∏rsm√•l: ' + error.message);
            });
        }

        function listenForGameStatus() {
            db.ref('games/' + gameState.pin + '/status').on('value', function(snapshot) {
                var status = snapshot.val();
                console.log('üéÆ Game status changed to:', status);
                
                if (status === 'playing') {
                    console.log('‚ñ∂Ô∏è  Game started! Ready for questions.');
                    // Game has started - waiting screen will be hidden when first question arrives
                } else if (status === 'finished') {
                    console.log('üèÅ Game finished! Showing results.');
                    showResults();
                }
            });
        }

        function hideAllScreens() {
            console.log('üôà Hiding all screens');
            document.querySelectorAll('.screen').forEach(function(s) {
                s.classList.remove('show');
            });
        }

        function loadQuestion(questionData) {
            console.log('üìù loadQuestion called with:', questionData);
            gameState.currentQuestionIndex = questionData.index;
            gameState.currentQuestion = questionData;
            gameState.totalQuestions = Math.max(gameState.totalQuestions, questionData.index + 1);
            gameState.questionStartTime = questionData.startedAt || Date.now();
            gameState.selectedAnswer = null;
            gameState.selectedAnswers = [];
            gameState.dragDropAnswers = {};
            gameState.bokforingAnswers = [];
            gameState.analyseAnswer = '';

            // Check if already answered this question
            console.log('üîç Checking if already answered question', questionData.index);
            db.ref('games/' + gameState.pin + '/answers/' + gameState.playerId).once('value')
                .then(function(snapshot) {
                    console.log('‚úÖ Answer check completed');
                    var existingAnswer = snapshot.val();
                    if (existingAnswer && existingAnswer.questionIndex === questionData.index) {
                        console.log('‚è≠Ô∏è  Already answered this question, showing waiting screen');
                        gameState.hasAnswered = true;
                        hideAllScreens();
                        document.getElementById('waiting-screen').classList.add('show');
                        document.querySelector('#waiting-screen .waiting-text').textContent = 'Du har allerede svart. Venter p√• neste sp√∏rsm√•l...';
                        return;
                    }

                    console.log('üÜï New question, showing question screen');
                    gameState.hasAnswered = false;
                    console.log('üéØ Showing question screen');
                    hideAllScreens();
                    document.getElementById('question-screen').classList.add('show');
                    console.log('‚úÖ Question screen should now be visible');

                    // Update question info
                    document.getElementById('question-number').textContent = 'Sp√∏rsm√•l ' + (questionData.index + 1);
                    document.getElementById('question-text').textContent = questionData.text;
                    
                    var questionType = questionData.type || 'multiple_choice';
                    document.getElementById('question-type-badge').textContent = typeLabels[questionType] || 'üìù Quiz';

                    // Build answer UI based on type
                    buildAnswerUI(questionData);

                    // Calculate remaining time
                    var elapsed = Math.floor((Date.now() - gameState.questionStartTime) / 1000);
                    var remaining = Math.max(0, gameState.timePerQuestion - elapsed);
                    
                    if (remaining <= 0) {
                        disableAllInputs();
                        showFeedback(false, 0);
                    } else {
                        startTimer(remaining);
                    }
                })
                .catch(function(error) {
                    console.error('üî• Error checking answers:', error);
                    alert('Feil ved lasting av sp√∏rsm√•l: ' + error.message);
                });
        }

        function buildAnswerUI(questionData) {
            var container = document.getElementById('answer-area');
            var submitContainer = document.getElementById('submit-container');
            var type = questionData.type || 'multiple_choice';

            submitContainer.style.display = 'none';

            switch(type) {
                case 'multiple_choice':
                    container.innerHTML = buildMultipleChoiceUI(questionData);
                    break;
                case 'multiple_select':
                    container.innerHTML = buildMultipleSelectUI(questionData);
                    submitContainer.style.display = 'block';
                    break;
                case 'true_false':
                    container.innerHTML = buildTrueFalseUI(questionData);
                    break;
                case 'paragraph':
                    container.innerHTML = buildParagraphUI(questionData);
                    submitContainer.style.display = 'block';
                    break;
                case 'drag_drop':
                    container.innerHTML = buildDragDropUI(questionData);
                    submitContainer.style.display = 'block';
                    initDragDrop();
                    break;
                case 'bokforing':
                    container.innerHTML = buildBokforingUI(questionData);
                    submitContainer.style.display = 'block';
                    break;
                case 'analyse':
                    container.innerHTML = buildAnalyseUI(questionData);
                    submitContainer.style.display = 'block';
                    break;
                default:
                    container.innerHTML = buildMultipleChoiceUI(questionData);
            }
        }

        // Multiple Choice UI
        function buildMultipleChoiceUI(q) {
            var labels = ['A', 'B', 'C', 'D', 'E', 'F'];
            var classes = ['answer-a', 'answer-b', 'answer-c', 'answer-d', 'answer-a', 'answer-b'];
            var answers = q.answers || [];
            
            // Shuffle if needed
            if (q.shuffle) {
                answers = shuffleArray(answers.slice());
            }
            
            var html = '<div class="answers-container">';
            answers.forEach(function(answer, i) {
                html += '<button class="answer-btn ' + classes[i % classes.length] + '" onclick="selectMCAnswer(' + i + ', this)">' +
                    '<div class="answer-label">' + labels[i] + '</div>' +
                    '<div class="answer-text">' + answer + '</div>' +
                '</button>';
            });
            html += '</div>';
            return html;
        }

        // Multiple Select UI
        function buildMultipleSelectUI(q) {
            var answers = q.answers || q.options || [];
            
            var html = '<div class="checkbox-container">';
            answers.forEach(function(answer, i) {
                var text = typeof answer === 'object' ? answer.text : answer;
                html += '<div class="checkbox-item" onclick="toggleCheckbox(' + i + ', this)">' +
                    '<input type="checkbox" id="cb-' + i + '" data-index="' + i + '">' +
                    '<label for="cb-' + i + '">' + text + '</label>' +
                '</div>';
            });
            html += '</div>';
            return html;
        }

        // True/False UI
        function buildTrueFalseUI(q) {
            return '<div class="tf-container">' +
                '<button class="tf-btn true" onclick="selectTFAnswer(true, this)">‚úÖ SANT</button>' +
                '<button class="tf-btn false" onclick="selectTFAnswer(false, this)">‚ùå USANT</button>' +
            '</div>';
        }

        // Paragraph UI
        function buildParagraphUI(q) {
            return '<div class="analyse-container">' +
                '<div class="analyse-data">' +
                    '<h4>üìú Lovhenvisning: ' + (q.paragraphRef || 'Ukjent') + '</h4>' +
                    '<p style="color: var(--text-secondary);">Skriv inn n√∏kkelordene du forbinder med denne paragrafen.</p>' +
                '</div>' +
                '<div class="analyse-input-group">' +
                    '<label>Ditt svar:</label>' +
                    '<input type="text" class="analyse-input" id="paragraph-input" placeholder="Skriv n√∏kkelord..." style="width: 100%;">' +
                '</div>' +
            '</div>';
        }

        // Drag & Drop UI
        function buildDragDropUI(q) {
            var categories = q.categories || [];
            var items = q.items || [];
            
            // Shuffle items
            if (q.shuffle !== false) {
                items = shuffleArray(items.slice());
            }
            
            var html = '<div class="dd-container">';
            
            // Categories
            html += '<div class="dd-categories">';
            categories.forEach(function(cat, i) {
                html += '<div class="dd-category" data-category="' + cat + '" ondrop="dropItem(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">' +
                    '<div class="dd-category-title">' + cat + '</div>' +
                    '<div class="dd-category-items" id="cat-items-' + i + '"></div>' +
                '</div>';
            });
            html += '</div>';
            
            // Items pool
            html += '<div class="dd-items-pool" id="items-pool" ondrop="dropItem(event)" ondragover="allowDrop(event)">';
            items.forEach(function(item, i) {
                var text = typeof item === 'object' ? item.text : item;
                html += '<div class="dd-item" draggable="true" data-item="' + text + '" id="dd-item-' + i + '" ondragstart="dragStart(event)">' + text + '</div>';
            });
            html += '</div>';
            
            html += '</div>';
            return html;
        }

        // Bokf√∏ring UI
        function buildBokforingUI(q) {
            var html = '<div class="bokforing-container">';
            
            // Scenario
            if (q.scenario) {
                html += '<div class="bokforing-scenario"><strong>üìÑ Bilag:</strong> ' + q.scenario + '</div>';
            }
            
            // Table
            html += '<table class="bokforing-table">' +
                '<thead><tr>' +
                    '<th>#</th>' +
                    '<th>Konto</th>' +
                    '<th>Debet</th>' +
                    '<th>Kredit</th>' +
                '</tr></thead>' +
                '<tbody id="bokforing-rows">';
            
            // Pre-fill rows if specified
            var numRows = (q.postings && q.postings.length) || 3;
            for (var i = 0; i < numRows; i++) {
                html += buildBokforingRow(i + 1, q.prefill ? q.postings[i] : null);
            }
            
            html += '</tbody></table>';
            html += '<button type="button" class="add-row-btn" onclick="addBokforingRow()">+ Legg til rad</button>';
            html += '</div>';
            
            return html;
        }

        function buildBokforingRow(num, prefill) {
            var kontoVal = prefill ? prefill.konto : '';
            var kontoDisabled = prefill ? 'readonly style="background:#333;"' : '';
            
            return '<tr class="bokforing-row">' +
                '<td>' + num + '</td>' +
                '<td><input type="text" class="bok-konto" placeholder="Kontonr" value="' + kontoVal + '" ' + kontoDisabled + '></td>' +
                '<td><input type="number" class="bok-debet" placeholder="0"></td>' +
                '<td><input type="number" class="bok-kredit" placeholder="0"></td>' +
            '</tr>';
        }

        function addBokforingRow() {
            var tbody = document.getElementById('bokforing-rows');
            var rowNum = tbody.children.length + 1;
            var tr = document.createElement('tr');
            tr.className = 'bokforing-row';
            tr.innerHTML = '<td>' + rowNum + '</td>' +
                '<td><input type="text" class="bok-konto" placeholder="Kontonr"></td>' +
                '<td><input type="number" class="bok-debet" placeholder="0"></td>' +
                '<td><input type="number" class="bok-kredit" placeholder="0"></td>';
            tbody.appendChild(tr);
        }

        // Analyse UI
        function buildAnalyseUI(q) {
            var data = q.data || {};
            
            var html = '<div class="analyse-container">';
            
            // Show data
            html += '<div class="analyse-data">' +
                '<h4>üìä Regnskapsdata:</h4>' +
                '<div class="analyse-data-grid">';
            
            if (data.omsetning) html += '<div class="analyse-data-item"><span>Omsetning:</span><span>kr ' + formatNumber(data.omsetning) + '</span></div>';
            if (data.resultat) html += '<div class="analyse-data-item"><span>Resultat:</span><span>kr ' + formatNumber(data.resultat) + '</span></div>';
            if (data.eiendeler) html += '<div class="analyse-data-item"><span>Eiendeler:</span><span>kr ' + formatNumber(data.eiendeler) + '</span></div>';
            if (data.gjeld) html += '<div class="analyse-data-item"><span>Gjeld:</span><span>kr ' + formatNumber(data.gjeld) + '</span></div>';
            if (data.egenkapital) html += '<div class="analyse-data-item"><span>Egenkapital:</span><span>kr ' + formatNumber(data.egenkapital) + '</span></div>';
            
            html += '</div></div>';
            
            // Input
            html += '<div class="analyse-input-group">' +
                '<label>Ditt svar:</label>' +
                '<input type="text" class="analyse-input" id="analyse-input" placeholder="F.eks. 15% eller 2.5">' +
            '</div>';
            
            html += '</div>';
            return html;
        }

        // Answer selection handlers
        function selectMCAnswer(index, btn) {
            if (gameState.hasAnswered) return;
            gameState.hasAnswered = true;
            gameState.selectedAnswer = index;
            
            clearInterval(gameState.timer);
            
            document.querySelectorAll('.answer-btn').forEach(function(b) { b.disabled = true; });
            btn.classList.add('selected');
            
            submitAnswerToFirebase('multiple_choice', index);
        }

        function selectTFAnswer(value, btn) {
            if (gameState.hasAnswered) return;
            gameState.hasAnswered = true;
            gameState.selectedAnswer = value;
            
            clearInterval(gameState.timer);
            
            document.querySelectorAll('.tf-btn').forEach(function(b) { b.disabled = true; });
            btn.classList.add('selected');
            
            submitAnswerToFirebase('true_false', value);
        }

        function toggleCheckbox(index, item) {
            if (gameState.hasAnswered) return;
            
            var cb = item.querySelector('input[type="checkbox"]');
            cb.checked = !cb.checked;
            item.classList.toggle('selected', cb.checked);
            
            if (cb.checked) {
                if (!gameState.selectedAnswers.includes(index)) {
                    gameState.selectedAnswers.push(index);
                }
            } else {
                gameState.selectedAnswers = gameState.selectedAnswers.filter(function(i) { return i !== index; });
            }
        }

        // Drag & Drop handlers
        function initDragDrop() {
            // Touch support for mobile
            document.querySelectorAll('.dd-item').forEach(function(item) {
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd, { passive: false });
            });
        }

        var draggedItem = null;
        var touchItem = null;

        function dragStart(e) {
            draggedItem = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.item);
            setTimeout(function() { e.target.classList.add('dragging'); }, 0);
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function dragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function dropItem(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (draggedItem) {
                var itemsContainer = e.currentTarget.querySelector('.dd-category-items') || e.currentTarget;
                itemsContainer.appendChild(draggedItem);
                draggedItem.classList.remove('dragging');
                
                // Track placement
                var category = e.currentTarget.dataset.category || 'pool';
                gameState.dragDropAnswers[draggedItem.dataset.item] = category;
                
                if (category !== 'pool') {
                    draggedItem.classList.add('placed');
                } else {
                    draggedItem.classList.remove('placed');
                }
                
                draggedItem = null;
            }
        }

        // Touch handlers for mobile drag & drop
        function handleTouchStart(e) {
            touchItem = e.target;
            touchItem.classList.add('dragging');
        }

        function handleTouchMove(e) {
            if (!touchItem) return;
            e.preventDefault();
            
            var touch = e.touches[0];
            touchItem.style.position = 'fixed';
            touchItem.style.left = (touch.clientX - 50) + 'px';
            touchItem.style.top = (touch.clientY - 20) + 'px';
            touchItem.style.zIndex = '1000';
        }

        function handleTouchEnd(e) {
            if (!touchItem) return;
            
            var touch = e.changedTouches[0];
            touchItem.style.position = '';
            touchItem.style.left = '';
            touchItem.style.top = '';
            touchItem.style.zIndex = '';
            touchItem.classList.remove('dragging');
            
            // Find drop target
            var dropTarget = document.elementFromPoint(touch.clientX, touch.clientY);
            var category = dropTarget ? dropTarget.closest('.dd-category') : null;
            
            if (category) {
                var itemsContainer = category.querySelector('.dd-category-items');
                itemsContainer.appendChild(touchItem);
                gameState.dragDropAnswers[touchItem.dataset.item] = category.dataset.category;
                touchItem.classList.add('placed');
            }
            
            touchItem = null;
        }

        // Submit answer
        function submitAnswer() {
            if (gameState.hasAnswered) return;
            gameState.hasAnswered = true;
            clearInterval(gameState.timer);
            disableAllInputs();
            
            var type = gameState.currentQuestion.type || 'multiple_choice';
            var answer;
            
            switch(type) {
                case 'multiple_select':
                    answer = gameState.selectedAnswers;
                    break;
                case 'paragraph':
                    answer = document.getElementById('paragraph-input').value;
                    break;
                case 'drag_drop':
                    answer = gameState.dragDropAnswers;
                    break;
                case 'bokforing':
                    answer = collectBokforingAnswers();
                    break;
                case 'analyse':
                    answer = document.getElementById('analyse-input').value;
                    break;
                default:
                    answer = gameState.selectedAnswer;
            }
            
            submitAnswerToFirebase(type, answer);
        }

        function collectBokforingAnswers() {
            var answers = [];
            document.querySelectorAll('.bokforing-row').forEach(function(row) {
                var konto = row.querySelector('.bok-konto').value;
                var debet = parseFloat(row.querySelector('.bok-debet').value) || 0;
                var kredit = parseFloat(row.querySelector('.bok-kredit').value) || 0;
                
                if (konto || debet || kredit) {
                    answers.push({ konto: konto, debet: debet, kredit: kredit });
                }
            });
            return answers;
        }

        function submitAnswerToFirebase(type, answer) {
            var elapsed = Math.floor((Date.now() - gameState.questionStartTime) / 1000);
            var timeLeft = Math.max(0, gameState.timePerQuestion - elapsed);
            
            // Calculate points
            var basePoints = gameState.currentQuestion.points || 200;
            var timeBonus = Math.floor((timeLeft / gameState.timePerQuestion) * (basePoints / 2));
            var points = basePoints / 2 + timeBonus; // Half points base, half for speed
            
            // For now, assume correct (real validation would be server-side)
            var isCorrect = true; // TODO: Add proper validation
            
            if (isCorrect) {
                gameState.score += Math.round(points);
                gameState.correctCount++;
            }
            
            // Save to Firebase
            db.ref('games/' + gameState.pin + '/answers/' + gameState.playerId).set({
                questionIndex: gameState.currentQuestionIndex,
                type: type,
                answer: answer,
                timeLeft: timeLeft,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Update player score
            db.ref('games/' + gameState.pin + '/players/' + gameState.playerId).update({
                score: gameState.score,
                correctCount: gameState.correctCount
            });
            
            document.getElementById('score').textContent = gameState.score;
            
            setTimeout(function() {
                showFeedback(isCorrect, Math.round(points));
            }, 500);
        }

        function disableAllInputs() {
            document.querySelectorAll('button, input').forEach(function(el) {
                el.disabled = true;
            });
        }

        function startTimer(duration) {
            gameState.timeLeft = duration;
            var timerEl = document.getElementById('timer');
            timerEl.textContent = gameState.timeLeft;
            timerEl.className = 'timer-display';

            if (gameState.timer) clearInterval(gameState.timer);

            gameState.timer = setInterval(function() {
                gameState.timeLeft--;
                timerEl.textContent = gameState.timeLeft;

                if (gameState.timeLeft <= 10) timerEl.classList.add('warning');
                if (gameState.timeLeft <= 5) timerEl.classList.add('danger');

                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    if (!gameState.hasAnswered) {
                        gameState.hasAnswered = true;
                        disableAllInputs();
                        showFeedback(false, 0);
                    }
                }
            }, 1000);
        }

        function showFeedback(correct, points) {
            hideAllScreens();
            document.getElementById('feedback-screen').classList.add('show');
            
            var icon = document.getElementById('feedback-icon');
            var text = document.getElementById('feedback-text');
            var pointsEl = document.getElementById('feedback-points');
            
            if (correct && points > 0) {
                icon.textContent = '‚úÖ';
                text.textContent = 'Bra jobbet!';
                text.className = 'feedback-text feedback-correct';
                pointsEl.textContent = '+' + points;
                pointsEl.style.color = 'var(--accent-hover)';
            } else {
                icon.textContent = '‚è±Ô∏è';
                text.textContent = points === 0 ? 'Tiden er ute!' : 'Svaret er registrert';
                text.className = 'feedback-text';
                pointsEl.textContent = '+' + points;
                pointsEl.style.color = 'var(--warning)';
            }
            
            // Return to waiting after delay
            setTimeout(function() {
                hideAllScreens();
                document.getElementById('waiting-screen').classList.add('show');
                document.querySelector('#waiting-screen .waiting-text').textContent = 'Venter p√• neste sp√∏rsm√•l...';
            }, 2500);
        }

        function showResults() {
            clearInterval(gameState.timer);
            hideAllScreens();
            document.getElementById('results-screen').classList.add('show');
            
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('correct-count').textContent = gameState.correctCount;
            
            var accuracy = gameState.totalQuestions > 0 
                ? Math.round((gameState.correctCount / gameState.totalQuestions) * 100) 
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            // Get ranking
            db.ref('games/' + gameState.pin + '/players').orderByChild('score').once('value')
                .then(function(snapshot) {
                    var players = [];
                    snapshot.forEach(function(child) {
                        players.push({ id: child.key, ...child.val() });
                    });
                    players.reverse(); // Highest first
                    
                    var rank = players.findIndex(function(p) { return p.id === gameState.playerId; }) + 1;
                    
                    var medals = ['ü•á', 'ü•à', 'ü•â'];
                    document.getElementById('rank-display').textContent = medals[rank - 1] || 'üèÖ';
                    document.getElementById('rank-text').textContent = rank + '. plass av ' + players.length;
                });
        }

        // Utility functions
        function shuffleArray(array) {
            for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
            }
            return array;
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Initialize - will be called by Firebase init callback
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Initialization -->
    <script>
        // Wait for Firebase to load
        (function initFirebase() {
            var attempts = 0;
            var maxAttempts = 50;
            
            function tryInit() {
                attempts++;
                
                if (typeof firebase === 'undefined') {
                    if (attempts < maxAttempts) {
                        setTimeout(tryInit, 100);
                    } else {
                        console.error('‚ùå Firebase not loaded after 5 seconds');
                        alert('Firebase kunne ikke lastes. Sjekk internettforbindelsen.');
                    }
                    return;
                }
                
                // Initialize Firebase
                var firebaseConfig = {
                    apiKey: "AIzaSyAPuacYOSf4Hv-h36yA5Hav67SlpIFMIIQ",
                    authDomain: "accountingquest-multiplayer.firebaseapp.com",
                    databaseURL: "https://accountingquest-multiplayer-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "accountingquest-multiplayer",
                    storageBucket: "accountingquest-multiplayer.firebasestorage.app",
                    messagingSenderId: "525417361926",
                    appId: "1:525417361926:web:ec9b737f82af9b21700987"
                };
                
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                    console.log('‚úÖ Firebase initialized');
                }
                
                window.db = firebase.database();
                console.log('‚úÖ Database ready');
                
                // Now that Firebase is ready, initialize the game
                console.log('üöÄ Starting student game initialization...');
                if (typeof init === 'function') {
                    init();
                } else {
                    console.error('‚ùå init() function not found!');
                }
            }
            
            tryInit();
        })();
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        // Initialize theme after DOM loads
        if (typeof ThemeManager !== 'undefined' && ThemeManager.init) {
            ThemeManager.init();
        }
    </script>
</body>
</html>
