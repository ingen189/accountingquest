<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grunnleggende Regnskap - AccountingQuest</title>
    
    <!-- Felles stilark -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ==================== LAYOUT ==================== */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        /* === ICON MENU (leftmost) === */
        .icon-menu {
            width: 60px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--space-sm) 0;
            gap: var(--space-xs);
        }
        
        .icon-btn {
            width: 46px;
            height: 46px;
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            position: relative;
        }
        
        .icon-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .icon-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .icon-btn-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--error);
            color: white;
            font-size: 0.5em;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .icon-menu-divider {
            width: 30px;
            height: 1px;
            background: var(--border-color);
            margin: var(--space-sm) 0;
        }
        
        /* === SIDEBAR PANEL === */
        .sidebar-panel {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-title {
            font-weight: 600;
            color: var(--accent);
            font-size: 1em;
        }
        
        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .sidebar-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }
        
        /* Sidebar views */
        .sidebar-view {
            display: none;
        }
        
        .sidebar-view.active {
            display: block;
        }
        
        /* === TOPICS VIEW === */
        .topic-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
            padding: var(--space-sm) var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .topic-item:hover {
            border-color: var(--accent);
        }
        
        .topic-item.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.15);
        }
        
        .topic-item-icon {
            font-size: 1.3em;
        }
        
        .topic-item-info {
            flex: 1;
        }
        
        .topic-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .topic-item-count {
            font-size: 0.75em;
            color: var(--accent);
        }
        
        /* === DIFFICULTY VIEW === */
        .diff-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
        }
        
        .diff-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }
        
        .diff-card:hover {
            border-color: var(--accent);
        }
        
        .diff-card.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.2);
        }
        
        .diff-card-icon {
            font-size: 1.8em;
            margin-bottom: var(--space-xs);
        }
        
        .diff-card-name {
            font-weight: 600;
            font-size: 0.9em;
            color: var(--text-primary);
        }
        
        .diff-card-count {
            font-size: 0.8em;
            color: var(--accent);
            margin-top: 2px;
        }
        
        /* === FORMULAS VIEW === */
        .formula-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .formula-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
        }
        
        .formula-name {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .formula-equation {
            font-family: 'Consolas', 'Monaco', monospace;
            color: var(--text-primary);
            background: var(--bg-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .formula-description {
            color: var(--text-secondary);
            font-size: 0.75em;
        }
        
        /* === DATA VIEW === */
        .data-item {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--space-sm);
            margin-bottom: var(--space-xs);
        }
        
        .data-label {
            color: var(--text-secondary);
            font-size: 0.8em;
            margin-bottom: 2px;
        }
        
        .data-value {
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
            font-size: 0.95em;
        }
        
        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Progress Bar */
        .progress-section {
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        
        .progress-section.visible {
            display: block;
        }
        
        .progress-bar-container {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            height: 16px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7em;
            font-weight: bold;
            transition: width var(--transition-slow);
            min-width: 30px;
        }
        
        /* Question Selector */
        .question-selector {
            padding: var(--space-sm) var(--space-lg);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: none;
        }
        
        .question-selector.visible {
            display: block;
        }
        
        .question-selector-grid {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .question-selector-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 5px 10px;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 32px;
            text-align: center;
            font-size: 0.85em;
        }
        
        .question-selector-item:hover {
            border-color: var(--accent);
        }
        
        .question-selector-item.current {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .question-selector-item.completed {
            background: rgba(74, 222, 128, 0.2);
            border-color: var(--accent);
        }
        
        /* Workspace */
        .workspace {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-2xl);
            height: 100%;
        }
        
        .welcome-screen h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-md);
        }
        
        .welcome-screen p {
            color: var(--text-secondary);
            font-size: 1.1em;
            max-width: 500px;
            margin-bottom: var(--space-lg);
        }
        
        .welcome-hint {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--accent);
            font-size: 1em;
        }
        
        .welcome-hint-icon {
            font-size: 1.5em;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-5px); }
        }
        
        /* Game View */
        .game-view {
            display: none;
        }
        
        .game-view.visible {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        /* Question Header */
        .question-header {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border-left: 4px solid var(--accent);
        }
        
        .question-number {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-bottom: 4px;
        }
        
        .question-title {
            color: var(--accent);
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: var(--space-sm);
        }
        
        .question-text {
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .question-badges {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        
        .badge-topic {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-secondary);
        }
        
        .badge-type {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }
        
        .badge-diff {
            background: rgba(74, 222, 128, 0.2);
            color: var(--accent);
        }
        
        /* Data Display */
        .data-display {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
        }
        
        .data-display h4 {
            color: var(--warning);
            margin-bottom: var(--space-md);
            font-size: 1em;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            color: var(--text-secondary);
            font-size: 0.85em;
        }
        
        .data-table td {
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
        }
        
        /* Options Container */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .option-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .option-item:hover {
            border-color: var(--accent);
        }
        
        .option-item.selected {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .option-item.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
        }
        
        .option-item.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.15);
        }
        
        .option-letter {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        
        .option-item.selected .option-letter {
            background: var(--accent);
            color: var(--bg-primary);
        }
        
        .option-item.correct .option-letter {
            background: var(--success);
            color: white;
        }
        
        .option-item.incorrect .option-letter {
            background: var(--error);
            color: white;
        }
        
        /* Input Fields */
        .input-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-group label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .input-group input {
            padding: 12px var(--space-md);
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: 'Consolas', monospace;
            font-size: 1em;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .input-group input.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
        }
        
        .input-group input.incorrect {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }
        
        /* Excel Grid */
        .excel-grid-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .excel-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
        }
        
        .excel-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .excel-hint {
            color: var(--text-secondary);
            font-size: 0.8em;
        }
        
        .excel-grid-wrapper {
            overflow-x: auto;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
            min-width: 400px;
        }
        
        .excel-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .excel-table td {
            border: 1px solid var(--border-color);
            padding: 0;
            min-width: 100px;
        }
        
        .excel-table td.row-label {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 10px 15px;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .excel-cell {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 10px 12px;
            font-size: 0.9em;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
        }
        
        .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgba(74, 222, 128, 0.05);
        }
        
        .excel-cell.readonly {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        
        .excel-cell.correct {
            background: rgba(34, 197, 94, 0.2) !important;
            color: var(--success);
        }
        
        .excel-cell.incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
            color: var(--error);
        }
        
        /* Cell Wrapper for fill handle */
        .cell-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 38px;
            display: block;
        }
        
        /* Fill Handle - gr√∏nn dra-prikk */
        .fill-handle {
            position: absolute;
            right: 2px;
            bottom: 2px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border: 2px solid var(--bg-secondary);
            border-radius: 2px;
            cursor: crosshair;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.15s, transform 0.15s;
        }
        
        .cell-wrapper:hover .fill-handle,
        .excel-cell:focus ~ .fill-handle {
            opacity: 1;
        }
        
        .fill-handle:hover {
            transform: scale(1.3);
            background: #5ef090;
            box-shadow: 0 0 6px rgba(74, 222, 128, 0.6);
        }
        
        /* Fill source and filling states */
        .excel-cell.fill-source {
            outline: 2px solid var(--accent) !important;
            background: rgba(74, 222, 128, 0.15) !important;
        }
        
        .excel-cell.filling {
            background: rgba(74, 222, 128, 0.25) !important;
            outline: 1px dashed var(--accent);
        }
        
        /* Drag over state */
        .excel-cell.drag-over {
            outline: 2px dashed var(--accent) !important;
            background: rgba(74, 222, 128, 0.15) !important;
        }
        
        .excel-cell.correct-dropped {
            animation: dropPulse 0.5s ease;
        }
        
        @keyframes dropPulse {
            0% { background: rgba(74, 222, 128, 0.4); }
            100% { background: transparent; }
        }
        
        /* Formula selection mode */
        .excel-cell.selecting-mode {
            cursor: cell;
        }
        
        .excel-cell.selecting-mode:hover {
            background: rgba(59, 130, 246, 0.15) !important;
            outline: 2px solid #3b82f6;
        }
        
        .excel-cell.selected-for-formula {
            outline: 3px solid #3b82f6 !important;
            background: rgba(59, 130, 246, 0.2) !important;
            animation: cellPulse 0.3s ease;
        }
        
        @keyframes cellPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8); }
        }
        
        /* Sum row */
        .sum-row td {
            background: var(--bg-tertiary) !important;
            border-top: 2px solid var(--accent);
        }
        
        /* Remove number spinners */
        .excel-cell::-webkit-outer-spin-button,
        .excel-cell::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .excel-cell[type="number"] {
            -moz-appearance: textfield;
        }
        
        /* Account List Panel */
        .account-search {
            padding: var(--space-sm);
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 5;
        }
        
        .account-search input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .account-search input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .account-list {
            padding: var(--space-sm);
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .account-group {
            margin-bottom: var(--space-md);
        }
        
        .account-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            color: var(--accent);
            margin-bottom: var(--space-xs);
        }
        
        .account-group-header:hover {
            background: var(--bg-card);
        }
        
        .account-group-items {
            display: none;
            padding-left: var(--space-sm);
        }
        
        .account-group.expanded .account-group-items {
            display: block;
        }
        
        .account-group-header .toggle-icon {
            transition: transform 0.2s;
        }
        
        .account-group.expanded .toggle-icon {
            transform: rotate(90deg);
        }
        
        .account-item {
            display: flex;
            align-items: center;
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-xs);
            cursor: grab;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .account-item:hover {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .account-item:active {
            cursor: grabbing;
        }
        
        .account-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .account-item .account-code {
            font-family: 'Consolas', monospace;
            font-weight: 600;
            color: var(--accent);
            margin-right: var(--space-sm);
        }
        
        .account-item .account-name {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        .excel-cell.drag-over {
            background: rgba(74, 222, 128, 0.2) !important;
            border: 2px dashed var(--accent) !important;
        }
        
        .excel-cell.account-dropped {
            animation: accountDrop 0.3s ease;
        }
        
        @keyframes accountDrop {
            0% { background: rgba(74, 222, 128, 0.4); }
            100% { background: transparent; }
        }
        
        /* Glowing effect for accounts button */
        @keyframes glowPulse {
            0%, 100% { 
                box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent), 0 0 15px var(--accent);
            }
            50% { 
                box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 30px var(--accent), 0 0 40px var(--accent);
            }
        }
        
        .icon-btn.glow-hint {
            animation: glowPulse 1.5s ease-in-out infinite;
            border-color: var(--accent) !important;
            position: relative;
        }
        
        .icon-btn.glow-hint::after {
            content: 'Bruk kontoene!';
            position: absolute;
            left: 70px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--accent);
            color: var(--bg-primary);
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.75em;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            animation: tooltipFade 1.5s ease-in-out infinite;
            pointer-events: none;
        }
        
        .icon-btn.glow-hint::before {
            content: '';
            position: absolute;
            left: 62px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: var(--accent);
            opacity: 0;
            animation: tooltipFade 1.5s ease-in-out infinite;
            pointer-events: none;
        }
        
        @keyframes tooltipFade {
            0%, 40%, 100% { opacity: 0; }
            50%, 90% { opacity: 1; }
        }

        /* True/False Buttons */
        .tf-container {
            display: flex;
            gap: var(--space-md);
        }
        
        .tf-btn {
            flex: 1;
            padding: var(--space-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .tf-btn:hover {
            border-color: var(--accent);
        }
        
        .tf-btn.selected {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .tf-btn.correct {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.15);
        }
        
        .tf-btn.incorrect {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.15);
        }
        
        /* Drag & Drop */
        .dnd-container {
            display: flex;
            gap: var(--space-lg);
            flex-wrap: wrap;
        }
        
        .dnd-source {
            flex: 1;
            min-width: 200px;
        }
        
        .dnd-source-title {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: var(--space-sm);
        }
        
        .dnd-targets {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }
        
        .dnd-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-xs);
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }
        
        .dnd-item:active {
            cursor: grabbing;
        }
        
        .dnd-item:hover {
            border-color: var(--accent);
        }
        
        .dnd-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }
        
        .dnd-target {
            background: var(--bg-tertiary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            min-height: 80px;
        }
        
        .dnd-target.drag-over {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
        
        .dnd-target.correct {
            border-color: var(--success);
            border-style: solid;
            background: rgba(34, 197, 94, 0.1);
        }
        
        .dnd-target.incorrect {
            border-color: var(--error);
            border-style: solid;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .dnd-target-label {
            font-weight: 600;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }
        
        .dnd-target-items {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            min-height: 40px;
        }
        
        .dnd-target .dnd-item {
            margin-bottom: 0;
        }
        
        /* Journal Entry (Bilagsf√∏ring) */
        .journal-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-md);
        }
        
        .balance-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }
        
        .balance-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            padding: var(--space-md);
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .balance-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .balance-value {
            font-size: 1.4em;
            font-weight: bold;
            font-family: 'Consolas', monospace;
        }
        
        .balance-value.debit { color: var(--info); }
        .balance-value.credit { color: var(--warning); }
        .balance-value.balanced { color: var(--success); }
        .balance-value.unbalanced { color: var(--error); }
        
        .journal-grid-wrapper {
            overflow-x: auto;
        }
        
        .journal-grid-wrapper .excel-cell.account-cell {
            text-align: left;
        }
        
        .journal-grid-wrapper .excel-cell.drag-over {
            background: rgba(74, 222, 128, 0.2) !important;
            outline: 2px dashed var(--accent) !important;
        }
        
        /* Controls */
        .controls {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            padding-top: var(--space-md);
        }
        
        /* Hint & Explanation Boxes */
        .hint-box, .explanation-box {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: none;
            overflow: hidden;
        }
        
        .hint-box.visible, .explanation-box.visible {
            display: block;
        }
        
        .hint-box {
            border: 2px solid var(--warning);
        }
        
        .explanation-box {
            border: 2px solid var(--success);
        }
        
        .hint-header, .explanation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            background: var(--bg-tertiary);
        }
        
        .hint-content, .explanation-content {
            padding: var(--space-md);
        }
        
        .hint-close, .explanation-close {
            background: none;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            color: var(--text-secondary);
        }
        
        /* Result Modal */
        .result-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .result-modal.visible {
            display: flex;
        }
        
        .result-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .result-icon {
            font-size: 3em;
            margin-bottom: var(--space-md);
        }
        
        .result-title {
            font-size: 1.5em;
            margin-bottom: var(--space-sm);
        }
        
        .result-title.success { color: var(--success); }
        .result-title.error { color: var(--error); }
        
        .result-stats {
            display: flex;
            justify-content: center;
            gap: var(--space-xl);
            margin: var(--space-lg) 0;
        }
        
        .result-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent);
        }
        
        .result-stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
        }
        
        /* Calculator */
        .floating-calculator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 500;
            display: none;
        }
        
        .floating-calculator.visible {
            display: block;
        }
        
        /* Kontoplan Modal */
        .kontoplan-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .kontoplan-modal.visible {
            display: flex;
        }
        
        .kontoplan-content {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }
        
        .kontoplan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-color);
        }
        
        .kontoplan-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .kontoplan-close {
            background: var(--error);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.1em;
        }
        
        .kontoplan-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: var(--space-sm);
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .kontoplan-tab {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .kontoplan-tab:hover {
            background: var(--bg-hover);
        }
        
        .kontoplan-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .kontoplan-body {
            padding: var(--space-md);
            overflow-y: auto;
            flex: 1;
        }
        
        .konto-gruppe {
            margin-bottom: var(--space-md);
        }
        
        .konto-gruppe-title {
            color: var(--accent);
            font-weight: 600;
            margin-bottom: var(--space-xs);
            font-size: 0.95em;
        }
        
        .konto-item {
            display: flex;
            padding: 6px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.85em;
        }
        
        .konto-item:nth-child(even) {
            background: var(--bg-primary);
        }
        
        .konto-nummer {
            color: var(--warning);
            font-weight: 600;
            width: 60px;
            flex-shrink: 0;
        }
        
        .konto-navn {
            color: var(--text-primary);
        }
        
        @media (max-width: 600px) {
            .kontoplan-tabs {
                gap: 2px;
            }
            .kontoplan-tab {
                padding: 6px 8px;
                font-size: 0.75em;
            }
        }
        
        .calculator {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            box-shadow: var(--shadow-lg);
            width: 260px;
            user-select: none;
        }
        
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
            cursor: grab;
        }
        
        .calculator-header:active {
            cursor: grabbing;
        }
        
        .calculator-title {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .calculator-close {
            background: var(--error);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calculator-close:hover {
            background: #dc2626;
        }
        
        .calc-display {
            background: var(--bg-primary);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-sm);
            text-align: right;
        }
        
        .calc-equation {
            color: var(--text-secondary);
            font-size: 0.75em;
            min-height: 16px;
        }
        
        .calc-result {
            color: var(--text-primary);
            font-size: 1.3em;
            font-family: 'Consolas', monospace;
        }
        
        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        
        .calc-btn {
            padding: 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1em;
            cursor: pointer;
        }
        
        .calc-btn:hover {
            background: var(--border-light);
        }
        
        .calc-btn.operator {
            background: var(--accent-secondary);
            color: white;
        }
        
        .calc-btn.equals {
            background: var(--accent);
            color: var(--bg-primary);
            grid-column: span 2;
        }
        
        .calc-btn.function {
            background: #a855f7;
            color: white;
            font-size: 0.85em;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .icon-menu {
                width: 50px;
            }
            
            .icon-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
            }
            
            .sidebar-panel {
                width: 240px;
            }
            
            .workspace {
                padding: var(--space-md);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls .aq-btn {
                width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            .sidebar-panel {
                position: fixed;
                left: 50px;
                top: 60px;
                bottom: 0;
                z-index: 100;
                display: none;
            }
            
            .sidebar-panel.mobile-visible {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="aq-header">
        <div class="aq-header-left">
            <a href="index.html" class="aq-btn aq-btn-ghost">‚Üê Tilbake</a>
            <span style="color: var(--text-secondary);">Modul: <strong style="color: var(--accent);">Grunnleggende Regnskap</strong></span>
        </div>
        <div class="aq-header-right">
            <div class="aq-stat">
                <span class="aq-stat-label">Sp√∏rsm√•l:</span>
                <span class="aq-stat-value" id="nav-progress">-</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Riktige:</span>
                <span class="aq-stat-value" id="nav-correct">0</span>
            </div>
            <div class="aq-stat">
                <span class="aq-stat-label">Poeng:</span>
                <span class="aq-stat-value" id="nav-score">0</span>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Icon Menu -->
        <nav class="icon-menu">
            <button class="icon-btn active" id="btn-topics" onclick="showSidebarView('topics')" title="Temaer">
                üìö
            </button>
            <button class="icon-btn" id="btn-difficulty" onclick="showSidebarView('difficulty')" title="Vanskelighetsgrad">
                üéØ
            </button>
            <div class="icon-menu-divider"></div>
            <button class="icon-btn" id="btn-formulas" onclick="showSidebarView('formulas')" title="Formler">
                üìê
            </button>
            <button class="icon-btn" id="btn-data" onclick="showSidebarView('data')" title="Data">
                üìä
            </button>
            <button class="icon-btn" id="btn-accounts" onclick="showSidebarView('accounts')" title="Kontoer">
                üìã
            </button>
            <div class="icon-menu-divider"></div>
            <button class="icon-btn" onclick="toggleCalculator()" title="Kalkulator">
                üî¢
            </button>
        </nav>
        
        <!-- Sidebar Panel -->
        <aside class="sidebar-panel" id="sidebar-panel">
            <div class="sidebar-header">
                <span class="sidebar-title" id="sidebar-title">Velg tema</span>
            </div>
            
            <div class="sidebar-content">
                <!-- Topics View -->
                <div class="sidebar-view active" id="view-topics">
                    <div id="topic-list"></div>
                </div>
                
                <!-- Difficulty View -->
                <div class="sidebar-view" id="view-difficulty">
                    <div class="diff-grid" id="difficulty-grid">
                        <div class="diff-card active" onclick="filterByDifficulty('all')">
                            <div class="diff-card-icon">üìö</div>
                            <div class="diff-card-name">Alle</div>
                            <div class="diff-card-count" id="diff-count-all">-</div>
                        </div>
                        <div class="diff-card" onclick="filterByDifficulty('easy')">
                            <div class="diff-card-icon">üå±</div>
                            <div class="diff-card-name">Lett</div>
                            <div class="diff-card-count" id="diff-count-easy">-</div>
                        </div>
                        <div class="diff-card" onclick="filterByDifficulty('medium')">
                            <div class="diff-card-icon">üí™</div>
                            <div class="diff-card-name">Middels</div>
                            <div class="diff-card-count" id="diff-count-medium">-</div>
                        </div>
                        <div class="diff-card" onclick="filterByDifficulty('hard')">
                            <div class="diff-card-icon">üî•</div>
                            <div class="diff-card-name">Vanskelig</div>
                            <div class="diff-card-count" id="diff-count-hard">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Formulas View -->
                <div class="sidebar-view" id="view-formulas">
                    <div class="formula-list" id="formula-list"></div>
                </div>
                
                <!-- Data View -->
                <div class="sidebar-view" id="view-data">
                    <div id="variable-list">
                        <p style="color: var(--text-secondary); text-align: center; padding: var(--space-lg);">
                            Velg et tema og start en oppgave for √• se data.
                        </p>
                    </div>
                </div>
                
                <!-- Accounts View (for T-konto drag & drop) -->
                <div class="sidebar-view" id="view-accounts">
                    <div class="account-search">
                        <input type="text" id="account-search" placeholder="üîç S√∏k konto..." oninput="filterAccounts(this.value)">
                    </div>
                    <div class="account-list" id="account-list">
                        <!-- Accounts will be populated here -->
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Progress Bar -->
            <div class="progress-section" id="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
                </div>
            </div>
            
            <!-- Question Selector -->
            <div class="question-selector" id="question-selector-section">
                <div class="question-selector-grid" id="question-selector"></div>
            </div>
            
            <!-- Workspace -->
            <main class="workspace">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcome-screen">
                    <h1>Grunnleggende Regnskap</h1>
                    <p>Mestre bokf√∏ring, regnskapsloven og norske regnskapsprinsipper.</p>
                    <div class="welcome-hint">
                        <span class="welcome-hint-icon">‚Üê</span>
                        <span>Velg et tema fra menyen for √• starte</span>
                    </div>
                </div>
                
                <!-- Game View -->
                <div class="game-view" id="game-view">
                    <div class="question-header">
                        <div class="question-number" id="question-number">Sp√∏rsm√•l 1 av 10</div>
                        <div class="question-title" id="question-title">Laster...</div>
                        <div class="question-text" id="question-text"></div>
                        <div class="question-badges" id="question-badges"></div>
                    </div>
                    
                    <div class="data-display" id="data-display" style="display: none;">
                        <h4>üìã Oppgavedata</h4>
                        <table class="data-table" id="data-table"><tbody></tbody></table>
                    </div>
                    
                    <div class="options-container" id="options-container" style="display: none;"></div>
                    <div class="input-fields" id="input-fields" style="display: none;"></div>
                    
                    <!-- True/False Container -->
                    <div class="tf-container" id="tf-container" style="display: none;">
                        <button class="tf-btn" data-value="true" onclick="selectTF(true)">‚úì Sant</button>
                        <button class="tf-btn" data-value="false" onclick="selectTF(false)">‚úó Usant</button>
                    </div>
                    
                    <!-- Drag & Drop Container -->
                    <div class="dnd-container" id="dnd-container" style="display: none;">
                        <div class="dnd-source" id="dnd-source">
                            <div class="dnd-source-title">Dra elementene til riktig kategori:</div>
                            <div class="dnd-items" id="dnd-items"></div>
                        </div>
                        <div class="dnd-targets" id="dnd-targets"></div>
                    </div>
                    
                    <!-- Journal Entry Container (Bilagsf√∏ring) -->
                    <div class="journal-container" id="journal-container" style="display: none;">
                        <div class="balance-display" id="balance-display">
                            <div class="balance-item">
                                <div class="balance-label">Sum Debet</div>
                                <div class="balance-value debit" id="sum-debit">0</div>
                            </div>
                            <div class="balance-item">
                                <div class="balance-label">Sum Kredit</div>
                                <div class="balance-value credit" id="sum-credit">0</div>
                            </div>
                            <div class="balance-item">
                                <div class="balance-label">Differanse</div>
                                <div class="balance-value" id="balance-diff">0</div>
                            </div>
                        </div>
                        <div class="journal-grid-wrapper">
                            <table class="excel-table" id="journal-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th style="width: 100px;">Konto</th>
                                        <th>Kontonavn</th>
                                        <th style="width: 120px;">Debet</th>
                                        <th style="width: 120px;">Kredit</th>
                                    </tr>
                                </thead>
                                <tbody id="journal-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="excel-grid-container" id="excel-grid-container" style="display: none;">
                        <div class="excel-header-row">
                            <span class="excel-title">üìä Beregningstabell</span>
                            <span class="excel-hint">Fyll inn de tomme cellene</span>
                        </div>
                        <div class="excel-grid-wrapper">
                            <table class="excel-table">
                                <thead id="excel-thead"></thead>
                                <tbody id="excel-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="controls">
                        <button class="aq-btn aq-btn-primary" onclick="checkAnswer()" id="btn-check">‚úì Sjekk svar</button>
                        <button class="aq-btn aq-btn-warning" onclick="showHint()" id="btn-hint">üí° Hint</button>
                        <button class="aq-btn aq-btn-secondary" onclick="toggleCalculator()">üî¢ Kalkulator</button>
                        <button class="aq-btn aq-btn-secondary" onclick="toggleKontoplan()">üìã Kontoplan</button>
                        <button class="aq-btn aq-btn-info" onclick="toggleExplanation()" id="btn-explanation" style="display: none;">üìñ Forklaring</button>
                        <button class="aq-btn aq-btn-accent" onclick="nextQuestion()" id="btn-next" style="display: none;">Neste ‚Üí</button>
                    </div>
                    
                    <div class="hint-box" id="hint-box">
                        <div class="hint-header">
                            <span style="color: var(--warning);" id="hint-level">üí° Hint</span>
                            <button class="hint-close" onclick="closeHint()">√ó</button>
                        </div>
                        <div class="hint-content">
                            <p id="hint-text"></p>
                        </div>
                    </div>
                    
                    <div class="explanation-box" id="explanation-box">
                        <div class="explanation-header">
                            <span style="color: var(--success);">üìñ Forklaring</span>
                            <button class="explanation-close" onclick="closeExplanation()">√ó</button>
                        </div>
                        <div class="explanation-content">
                            <div id="explanation-main"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-icon" id="result-icon">üéâ</div>
            <h2 class="result-title" id="result-title">Gratulerer!</h2>
            <p class="result-message" id="result-message"></p>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="result-correct">0</div>
                    <div class="result-stat-label">Riktige</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-total">0</div>
                    <div class="result-stat-label">Totalt</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="result-percent">0%</div>
                    <div class="result-stat-label">Score</div>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-sm); justify-content: center;">
                <button class="aq-btn aq-btn-primary" onclick="restartGame()">üîÑ Pr√∏v igjen</button>
                <button class="aq-btn aq-btn-ghost" onclick="backToWelcome()">‚Üê Nytt tema</button>
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="floating-calculator" id="floating-calculator">
        <div class="calculator" id="calculator-drag">
            <div class="calculator-header">
                <span class="calculator-title">üî¢ Kalkulator</span>
                <button class="calculator-close" onclick="toggleCalculator()">√ó</button>
            </div>
            <div class="calc-display">
                <div class="calc-equation" id="calc-equation"></div>
                <div class="calc-result" id="calc-result">0</div>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn function" onclick="calcFunction('pv')">PV</button>
                <button class="calc-btn function" onclick="calcFunction('fv')">FV</button>
                <button class="calc-btn function" onclick="calcFunction('sqrt')">‚àö</button>
                <button class="calc-btn operator" onclick="calcInput('/')">/</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn operator" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn operator" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcClear()">C</button>
                <button class="calc-btn operator" onclick="calcInput('^')">^</button>
                <button class="calc-btn equals" onclick="calcEquals()">=</button>
                <button class="calc-btn" onclick="calcInput('(')">(</button>
                <button class="calc-btn" onclick="calcInput(')')">)</button>
            </div>
        </div>
    </div>

    <!-- Kontoplan Modal -->
    <div class="kontoplan-modal" id="kontoplan-modal">
        <div class="kontoplan-content">
            <div class="kontoplan-header">
                <span class="kontoplan-title">üìã Kontoplan (NS 4102)</span>
                <button class="kontoplan-close" onclick="toggleKontoplan()">√ó</button>
            </div>
            <div class="kontoplan-tabs">
                <button class="kontoplan-tab active" onclick="showKontoklasse(1)">1 Eiendeler</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(2)">2 EK & Gjeld</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(3)">3 Inntekter</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(4)">4 Varekost</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(5)">5 L√∏nn</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(6)">6-7 Driftskost</button>
                <button class="kontoplan-tab" onclick="showKontoklasse(8)">8 Finans</button>
            </div>
            <div class="kontoplan-body" id="kontoplan-body">
                <!-- Content loads here -->
            </div>
        </div>
    </div>

    <!-- Scripts - Turso API (migrert fra Firebase) -->
    <script src="js/EXCEL-GRID-FINAL.js"></script>
    
    <script>
        // ==================== TURSO API CONFIG ====================
        var API_URL = 'https://api.accountingquest.app';
        var MODULE_IDS = ['grunnleggende', 'grunnleggende_regnskap', '1']; // Pr√∏v flere varianter
        
        async function apiCall(endpoint) {
            try {
                console.log('API Call:', API_URL + '/api' + endpoint);
                var response = await fetch(API_URL + '/api' + endpoint);
                if (!response.ok) throw new Error('API error: ' + response.status);
                var data = await response.json();
                console.log('API Response:', data.length || data, 'items');
                return data;
            } catch (err) {
                console.error('API call failed:', err);
                return [];
            }
        }
        // ==================== CONFIGURATION ====================
        var topics = [
            { id: 'grunnleggende', name: 'Grunnleggende regnskap', icon: 'üìñ' },
            { id: 'bokforing', name: 'Bokf√∏ring', icon: 'üìù' },
            { id: 'mva', name: 'Merverdiavgift', icon: 'üí∞' },
            { id: 'skatt', name: 'Skatt', icon: 'üèõÔ∏è' },
            { id: 'arsavslutning', name: '√Örsavslutning', icon: 'üìÖ' },
            { id: 'analyse', name: 'Regnskapsanalyse', icon: 'üìä' },
            { id: 'driftsregnskap', name: 'Driftsregnskap', icon: 'üè≠' },
            { id: 'lonn', name: 'L√∏nn', icon: 'üíµ' },
            { id: 'mixed', name: 'Blandet Quiz', icon: 'üé≤' }
        ];
        
        var formulas = {
            grunnleggende: [
                { name: 'Regnskapslikningen', equation: 'E = EK + G', description: 'Eiendeler = Egenkapital + Gjeld' },
                { name: 'Balansekrav', equation: 'Debet = Kredit', description: 'Sum debet = Sum kredit' }
            ],
            bokforing: [
                { name: 'Oppbevaringstid', equation: '5 √•r', description: 'Regnskapsmateriale (BOKL ¬ß 13)' },
                { name: 'Bilagskrav', equation: 'Dato + Bel√∏p + Parter', description: 'Minstekrav til bilag' }
            ],
            mva: [
                { name: 'Alminnelig MVA', equation: '25%', description: 'Standard sats' },
                { name: 'Mat-MVA', equation: '15%', description: 'N√¶ringsmidler' },
                { name: 'Lav MVA', equation: '12%', description: 'Transport, overnatting' },
                { name: 'MVA-beregning', equation: 'Netto √ó 1.25 = Brutto', description: 'Fra netto til brutto' }
            ],
            skatt: [
                { name: 'Selskapsskatt', equation: '22%', description: 'Skatt p√• alminnelig inntekt' },
                { name: 'Betalbar skatt', equation: 'Alm. inntekt √ó 22%', description: 'Skatteberegning' }
            ],
            arsavslutning: [
                { name: 'Line√¶r avskr.', equation: 'Kostpris / Levetid', description: '√Örlig avskrivning' },
                { name: 'Saldoavskr.', equation: 'Bokf√∏rt √ó Sats%', description: 'Skattemessig avskrivning' }
            ],
            analyse: [
                { name: 'LG1', equation: 'OM / KG', description: 'Likviditetsgrad 1' },
                { name: 'LG2', equation: '(OM - Varelager) / KG', description: 'Likviditetsgrad 2' },
                { name: 'EK-andel', equation: 'EK / TK √ó 100', description: 'Egenkapitalandel' },
                { name: 'TKR', equation: '(DR + FI) / Gj.sn TK √ó 100', description: 'Totalkapitalrentabilitet' },
                { name: 'EKR', equation: 'Resultat / Gj.sn EK √ó 100', description: 'Egenkapitalrentabilitet' }
            ],
            driftsregnskap: [
                { name: 'Dekningsbidrag', equation: 'Pris - VK', description: 'Bidrag per enhet' },
                { name: 'DG', equation: 'DB / Pris √ó 100', description: 'Dekningsgrad' },
                { name: 'Nullpunkt', equation: 'FK / DB per enhet', description: 'Break-even mengde' }
            ],
            lonn: [
                { name: 'AGA', equation: '14,1%', description: 'Arbeidsgiveravgift sone 1' },
                { name: 'Feriepenger', equation: '10,2%', description: 'Normal feriepengesats' }
            ],
            mixed: []
        };
        
        // Kontoplan (NS 4102) for journal entries
        var KONTOPLAN = {
            "1000": "Forskning og utvikling",
            "1200": "Tomter og bygninger",
            "1250": "Maskiner og anlegg",
            "1280": "Kontormaskiner",
            "1400": "Varelager r√•varer",
            "1460": "Varelager ferdigvarer",
            "1500": "Kundefordringer",
            "1580": "Avsetning tap p√• fordringer",
            "1700": "Forskuddsbetalt leie",
            "1720": "Forskuddsbetalt forsikring",
            "1900": "Kontanter",
            "1920": "Bankinnskudd",
            "1950": "Bankinnskudd skattetrekk",
            "2000": "Aksjekapital",
            "2050": "Annen egenkapital",
            "2400": "Leverand√∏rgjeld",
            "2500": "Betalbar skatt",
            "2600": "Skattetrekk",
            "2700": "Utg√•ende merverdiavgift",
            "2710": "Inng√•ende merverdiavgift",
            "2740": "Oppgj√∏rskonto MVA",
            "2770": "Skyldig arbeidsgiveravgift",
            "2780": "P√•l√∏pt arbeidsgiveravgift",
            "2930": "P√•l√∏pt l√∏nn",
            "2940": "P√•l√∏pt feriepenger",
            "3000": "Salgsinntekt, avgiftspliktig",
            "3100": "Salgsinntekt, avgiftsfri",
            "4000": "Innkj√∏p av r√•varer",
            "4300": "Innkj√∏p varer for videresalg",
            "4360": "Frakt og toll",
            "5000": "L√∏nn",
            "5180": "Feriepenger",
            "5400": "Arbeidsgiveravgift",
            "6000": "Avskrivning bygninger",
            "6010": "Avskrivning maskiner",
            "6300": "Leie lokaler",
            "6340": "Lys, varme",
            "6800": "Kontorrekvisita",
            "7000": "Bilkostnader",
            "7500": "Forsikringer",
            "7830": "Tap p√• fordringer",
            "8050": "Renteinntekt",
            "8150": "Rentekostnad",
            "8300": "Betalbar skatt",
            "8800": "√Örsresultat"
        };
        
        // ==================== STATE ====================
        var gameState = {
            currentTopic: null,
            currentDifficulty: 'all',
            questions: [],
            allQuestions: [],
            currentIndex: 0,
            currentQuestion: null,
            selectedAnswer: null,
            selectedAnswers: [], // for multi-select
            tfAnswer: null,      // for true/false
            dndState: {},        // for drag & drop
            answeredCorrectly: false,
            hintsUsed: 0,
            score: 0,
            correctCount: 0,
            answered: []
        };
        
        var currentSidebarView = 'topics';
        
        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', function() {
            renderTopicList();
            
            // Turso API - ingen Firebase init n√∏dvendig
            console.log('üöÄ AccountingQuest - Turso API Mode');
            
            loadQuestionCounts();
            loadFormulasForTopic('grunnleggende');
            
            // Load saved progress after a short delay
            setTimeout(loadSavedProgress, 500);
        });
        
        // ==================== SIDEBAR ====================
        function showSidebarView(viewId) {
            currentSidebarView = viewId;
            
            // Update icon buttons
            document.querySelectorAll('.icon-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            var btn = document.getElementById('btn-' + viewId);
            if (btn) btn.classList.add('active');
            
            // Update sidebar views
            document.querySelectorAll('.sidebar-view').forEach(function(view) {
                view.classList.remove('active');
            });
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Update title
            var titles = {
                topics: 'Velg tema',
                difficulty: 'Vanskelighetsgrad',
                formulas: 'Formler',
                data: 'Oppgavedata',
                accounts: 'Kontoer (dra til T-konto)'
            };
            document.getElementById('sidebar-title').textContent = titles[viewId] || viewId;
            
            // Initialize accounts if showing
            if (viewId === 'accounts') {
                renderAccountList();
                // Remove glow hint when user clicks
                var accountsBtn = document.getElementById('btn-accounts');
                if (accountsBtn) {
                    accountsBtn.classList.remove('glow-hint');
                }
            }
            
            // Mobile: show sidebar
            document.getElementById('sidebar-panel').classList.add('mobile-visible');
        }
        
        // ==================== ACCOUNTS (for T-konto drag & drop) ====================
        var accountGroups = {
            '1': {
                name: 'Klasse 1: Eiendeler',
                accounts: {
                    '1200': 'Maskiner og anlegg',
                    '1230': 'Personbiler, varebiler',
                    '1250': 'Inventar',
                    '1280': 'Kontormaskiner',
                    '1300': 'Aksjer i datterselskap',
                    '1350': 'Andre aksjer',
                    '1400': 'Varelager',
                    '1500': 'Kundefordringer',
                    '1530': 'Opptjent, ikke fakturert',
                    '1570': 'Andre fordringer',
                    '1580': 'Avsetning tap',
                    '1700': 'Forskuddsbetalt',
                    '1920': 'Bankinnskudd',
                    '1900': 'Kontanter'
                }
            },
            '2': {
                name: 'Klasse 2: EK og Gjeld',
                accounts: {
                    '2000': 'Aksjekapital',
                    '2020': 'Overkurs',
                    '2050': 'Annen egenkapital',
                    '2080': 'Udekket tap',
                    '2400': 'Leverand√∏rgjeld',
                    '2500': 'Betalbar skatt',
                    '2600': 'Forskuddstrekk',
                    '2610': 'Skyldig arb.giveravgift',
                    '2700': 'Utg√•ende MVA',
                    '2710': 'Inng√•ende MVA',
                    '2740': 'Skyldig MVA',
                    '2800': 'Avsatt utbytte',
                    '2900': 'Annen kortsiktig gjeld',
                    '2960': 'P√•l√∏pte feriepenger'
                }
            },
            '3': {
                name: 'Klasse 3: Salgsinntekter',
                accounts: {
                    '3000': 'Salgsinntekt, avgiftspliktig',
                    '3100': 'Salgsinntekt, avgiftsfri',
                    '3200': 'Inntekt av tjenester',
                    '3400': 'Offentlige tilskudd',
                    '3600': 'Leieinntekter',
                    '3900': 'Annen driftsinntekt'
                }
            },
            '4': {
                name: 'Klasse 4: Varekostnad',
                accounts: {
                    '4000': 'Varekostnad',
                    '4300': 'Innkj√∏p varer',
                    '4500': 'Fremmedytelse',
                    '4900': 'Beholdningsendring'
                }
            },
            '5': {
                name: 'Klasse 5: L√∏nn',
                accounts: {
                    '5000': 'L√∏nn til ansatte',
                    '5020': 'Feriepenger',
                    '5400': 'Arbeidsgiveravgift',
                    '5420': 'Innberetningspliktige ytelser',
                    '5900': 'Annen personalkostnad'
                }
            },
            '6-7': {
                name: 'Klasse 6-7: Driftskostnader',
                accounts: {
                    '6000': 'Avskrivning',
                    '6100': 'Frakt og transport',
                    '6300': 'Leie lokaler',
                    '6340': 'Lys og varme',
                    '6400': 'Leie maskiner',
                    '6500': 'Verkt√∏y og inventar',
                    '6700': 'Regnskap/revisjon',
                    '6800': 'Kontorrekvisita',
                    '6900': 'Telefon/internett',
                    '7000': 'Drivstoff',
                    '7100': 'Bilkostnader',
                    '7320': 'Reklamekostnader',
                    '7500': 'Forsikring',
                    '7700': 'Annen driftskostnad',
                    '7830': 'Tap p√• fordringer'
                }
            },
            '8': {
                name: 'Klasse 8: Finans og skatt',
                accounts: {
                    '8000': 'Finansinntekt',
                    '8050': 'Renteinntekt',
                    '8100': 'Annen finansinntekt',
                    '8150': 'Rentekostnad',
                    '8170': 'Annen finanskostnad',
                    '8300': 'Skattekostnad',
                    '8800': '√Örsresultat',
                    '8920': 'Avsatt utbytte',
                    '8960': 'Overf√∏ring annen EK'
                }
            }
        };
        
        function renderAccountList() {
            var container = document.getElementById('account-list');
            var html = '';
            
            Object.keys(accountGroups).forEach(function(groupKey) {
                var group = accountGroups[groupKey];
                html += '<div class="account-group" id="account-group-' + groupKey + '">';
                html += '<div class="account-group-header" onclick="toggleAccountGroup(\'' + groupKey + '\')">';
                html += '<span>' + group.name + '</span>';
                html += '<span class="toggle-icon">‚ñ∂</span>';
                html += '</div>';
                html += '<div class="account-group-items">';
                
                Object.keys(group.accounts).forEach(function(code) {
                    var name = group.accounts[code];
                    html += '<div class="account-item" draggable="true" data-account-code="' + code + '" data-account-name="' + name + '">';
                    html += '<span class="account-code">' + code + '</span>';
                    html += '<span class="account-name">' + name + '</span>';
                    html += '</div>';
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            initAccountDragDrop();
        }
        
        function toggleAccountGroup(groupKey) {
            var group = document.getElementById('account-group-' + groupKey);
            group.classList.toggle('expanded');
        }
        
        function filterAccounts(query) {
            query = query.toLowerCase();
            document.querySelectorAll('.account-item').forEach(function(item) {
                var code = item.dataset.accountCode;
                var name = item.dataset.accountName.toLowerCase();
                if (code.includes(query) || name.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Show all groups when searching
            if (query) {
                document.querySelectorAll('.account-group').forEach(function(g) {
                    g.classList.add('expanded');
                });
            }
        }
        
        function initAccountDragDrop() {
            // Make account items draggable
            document.querySelectorAll('.account-item').forEach(function(item) {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', item.dataset.accountCode);
                    e.dataTransfer.setData('account-name', item.dataset.accountName);
                    item.classList.add('dragging');
                });
                
                item.addEventListener('dragend', function() {
                    item.classList.remove('dragging');
                });
            });
        }
        
        function setupExcelGridDragDrop() {
            console.log('Setting up Excel Grid Drag & Drop...');
            
            // Find all account-input cells (type="account")
            var accountCells = document.querySelectorAll('.excel-cell.account-input, .excel-cell[data-type="account"]');
            console.log('Found', accountCells.length, 'account input cells');
            
            accountCells.forEach(function(input) {
                // Allow dropping
                input.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'copy';
                    input.classList.add('drag-over');
                });
                
                input.addEventListener('dragleave', function() {
                    input.classList.remove('drag-over');
                });
                
                input.addEventListener('drop', function(e) {
                    e.preventDefault();
                    input.classList.remove('drag-over');
                    
                    // Don't allow drops on answered questions
                    if (gameState.answered && gameState.answered[gameState.currentIndex]) return;
                    
                    // Get the account code from drag data
                    var accountCode = e.dataTransfer.getData('text/plain');
                    console.log('Dropped account code:', accountCode);
                    
                    if (accountCode) {
                        // Set the value in the cell
                        input.value = accountCode;
                        input.classList.add('correct-dropped');
                        
                        // Visual feedback
                        setTimeout(function() {
                            input.classList.remove('correct-dropped');
                        }, 500);
                        
                        // Trigger change event for balance update
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                        updateGridBalance();
                    }
                });
                
                // Keyboard navigation
                input.addEventListener('keydown', function(e) {
                    handleCellNavigation(e, input);
                });
            });
            
            // Setup for number cells
            var numberCells = document.querySelectorAll('.excel-cell.number-input, .excel-cell[data-type="number"]');
            console.log('Found', numberCells.length, 'number input cells');
            
            numberCells.forEach(function(input) {
                // Keyboard navigation
                input.addEventListener('keydown', function(e) {
                    handleCellNavigation(e, input);
                });
                
                // Update balance on input
                input.addEventListener('input', function() {
                    updateGridBalance();
                });
                
                // Formula evaluation on blur
                input.addEventListener('blur', function() {
                    if (input.value.trim().startsWith('=')) {
                        evaluateCellFormula(input);
                    }
                });
                
                // Show formula on focus
                input.addEventListener('focus', function() {
                    if (input.dataset.formula) {
                        input.value = input.dataset.formula;
                    }
                    // Start cell selection mode if typing =
                    gridState.currentCell = input;
                });
            });
            
            // Setup fill handles
            setupFillHandles();
        }
        
        // Fill handle state
        var fillState = {
            active: false,
            startCell: null,
            startRow: -1,
            startCol: -1
        };
        
        function setupFillHandles() {
            var handles = document.querySelectorAll('.fill-handle');
            console.log('Setting up', handles.length, 'fill handles');
            
            handles.forEach(function(handle) {
                handle.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var cell = handle.parentElement.querySelector('.excel-cell');
                    if (!cell) return;
                    
                    fillState.active = true;
                    fillState.startCell = cell;
                    fillState.startRow = parseInt(cell.dataset.row);
                    fillState.startCol = parseInt(cell.dataset.col);
                    
                    cell.classList.add('fill-source');
                    
                    document.addEventListener('mousemove', handleFillDrag);
                    document.addEventListener('mouseup', handleFillEnd);
                });
                
                // Touch support
                handle.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var cell = handle.parentElement.querySelector('.excel-cell');
                    if (!cell) return;
                    
                    fillState.active = true;
                    fillState.startCell = cell;
                    fillState.startRow = parseInt(cell.dataset.row);
                    fillState.startCol = parseInt(cell.dataset.col);
                    
                    cell.classList.add('fill-source');
                    
                    document.addEventListener('touchmove', handleFillDragTouch, { passive: false });
                    document.addEventListener('touchend', handleFillEnd);
                }, { passive: false });
            });
        }
        
        function handleFillDrag(e) {
            if (!fillState.active) return;
            
            var target = document.elementFromPoint(e.clientX, e.clientY);
            if (target && target.classList.contains('excel-cell') && !target.classList.contains('readonly')) {
                highlightFillRange(target);
            }
        }
        
        function handleFillDragTouch(e) {
            if (!fillState.active) return;
            e.preventDefault();
            
            var touch = e.touches[0];
            var target = document.elementFromPoint(touch.clientX, touch.clientY);
            if (target && target.classList.contains('excel-cell') && !target.classList.contains('readonly')) {
                highlightFillRange(target);
            }
        }
        
        function highlightFillRange(targetCell) {
            // Clear previous highlights
            document.querySelectorAll('.filling').forEach(function(c) {
                c.classList.remove('filling');
            });
            
            var targetRow = parseInt(targetCell.dataset.row);
            var targetCol = parseInt(targetCell.dataset.col);
            
            // Highlight cells in range (vertical only for simplicity)
            if (targetCol === fillState.startCol && targetRow !== fillState.startRow) {
                var minRow = Math.min(fillState.startRow, targetRow);
                var maxRow = Math.max(fillState.startRow, targetRow);
                
                for (var r = minRow; r <= maxRow; r++) {
                    if (r === fillState.startRow) continue;
                    var cell = document.querySelector('[data-row="' + r + '"][data-col="' + fillState.startCol + '"]');
                    if (cell && !cell.classList.contains('readonly')) {
                        cell.classList.add('filling');
                    }
                }
            }
            // Horizontal
            else if (targetRow === fillState.startRow && targetCol !== fillState.startCol) {
                var minCol = Math.min(fillState.startCol, targetCol);
                var maxCol = Math.max(fillState.startCol, targetCol);
                
                for (var c = minCol; c <= maxCol; c++) {
                    if (c === fillState.startCol) continue;
                    var cell = document.querySelector('[data-row="' + fillState.startRow + '"][data-col="' + c + '"]');
                    if (cell && !cell.classList.contains('readonly')) {
                        cell.classList.add('filling');
                    }
                }
            }
        }
        
        function handleFillEnd(e) {
            if (!fillState.active) return;
            
            // Get final target
            var clientX, clientY;
            if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            var target = document.elementFromPoint(clientX, clientY);
            if (target && target.classList.contains('excel-cell')) {
                executeFill(target);
            }
            
            // Cleanup
            fillState.startCell.classList.remove('fill-source');
            document.querySelectorAll('.filling').forEach(function(c) {
                c.classList.remove('filling');
            });
            
            fillState.active = false;
            fillState.startCell = null;
            
            document.removeEventListener('mousemove', handleFillDrag);
            document.removeEventListener('mouseup', handleFillEnd);
            document.removeEventListener('touchmove', handleFillDragTouch);
            document.removeEventListener('touchend', handleFillEnd);
            
            updateGridBalance();
        }
        
        function executeFill(endCell) {
            var endRow = parseInt(endCell.dataset.row);
            var endCol = parseInt(endCell.dataset.col);
            var startVal = fillState.startCell.value;
            var startFormula = fillState.startCell.dataset.formula || startVal;
            
            // Vertical fill
            if (endCol === fillState.startCol && endRow !== fillState.startRow) {
                var dir = endRow > fillState.startRow ? 1 : -1;
                for (var r = fillState.startRow + dir; dir > 0 ? r <= endRow : r >= endRow; r += dir) {
                    var cell = document.querySelector('[data-row="' + r + '"][data-col="' + fillState.startCol + '"]');
                    if (cell && !cell.classList.contains('readonly')) {
                        fillCell(cell, startFormula, startVal, r - fillState.startRow, 0);
                    }
                }
            }
            // Horizontal fill
            else if (endRow === fillState.startRow && endCol !== fillState.startCol) {
                var dir = endCol > fillState.startCol ? 1 : -1;
                for (var c = fillState.startCol + dir; dir > 0 ? c <= endCol : c >= endCol; c += dir) {
                    var cell = document.querySelector('[data-row="' + fillState.startRow + '"][data-col="' + c + '"]');
                    if (cell && !cell.classList.contains('readonly')) {
                        fillCell(cell, startFormula, startVal, 0, c - fillState.startCol);
                    }
                }
            }
        }
        
        function fillCell(cell, formula, value, rowOffset, colOffset) {
            if (formula && formula.startsWith('=')) {
                // Adjust formula references
                var adjusted = adjustFormula(formula.substring(1), rowOffset, colOffset);
                cell.value = '=' + adjusted;
                cell.dataset.formula = '=' + adjusted;
                evaluateCellFormula(cell);
            } else {
                // Check if it's a number sequence
                var num = parseFloat(value.replace(/\s/g, '').replace(',', '.'));
                if (!isNaN(num)) {
                    cell.value = formatNumber(num + rowOffset + colOffset);
                } else {
                    cell.value = value;
                }
            }
        }
        
        function adjustFormula(formula, rowOffset, colOffset) {
            return formula.replace(/(\$?)([A-Z])(\$?)(\d+)/gi, function(match, colLock, col, rowLock, row) {
                var newCol = col;
                var newRow = parseInt(row);
                
                if (!colLock && colOffset) {
                    newCol = String.fromCharCode(col.charCodeAt(0) + colOffset);
                }
                if (!rowLock && rowOffset) {
                    newRow = parseInt(row) + rowOffset;
                }
                
                return (colLock || '') + newCol + (rowLock || '') + newRow;
            });
        }
        
        // Grid state for cell selection
        var gridState = {
            selectingCell: false,
            currentCell: null
        };
        
        function setupExcelGridFormulas() {
            // Setup click handlers for cell reference selection
            var allCells = document.querySelectorAll('#excel-tbody .excel-cell:not(.readonly)');
            
            allCells.forEach(function(cell) {
                cell.addEventListener('click', function(e) {
                    if (gridState.selectingCell && gridState.currentCell && cell !== gridState.currentCell) {
                        e.preventDefault();
                        // Insert cell reference into current formula
                        var cellRef = getCellReference(cell);
                        var cursorPos = gridState.currentCell.selectionStart || gridState.currentCell.value.length;
                        var currentValue = gridState.currentCell.value;
                        gridState.currentCell.value = currentValue.slice(0, cursorPos) + cellRef + currentValue.slice(cursorPos);
                        gridState.currentCell.focus();
                        
                        // Visual feedback
                        cell.classList.add('selected-for-formula');
                        setTimeout(function() {
                            cell.classList.remove('selected-for-formula');
                        }, 300);
                    }
                });
                
                // Detect when user types = to start selection mode
                cell.addEventListener('input', function() {
                    if (cell.value === '=') {
                        gridState.selectingCell = true;
                        gridState.currentCell = cell;
                        // Add visual indicator to other cells
                        document.querySelectorAll('#excel-tbody .excel-cell:not(.readonly)').forEach(function(c) {
                            if (c !== cell) {
                                c.classList.add('selecting-mode');
                            }
                        });
                    } else if (!cell.value.startsWith('=')) {
                        endCellSelection();
                    }
                });
                
                // End selection on blur or Enter
                cell.addEventListener('blur', function() {
                    setTimeout(function() {
                        endCellSelection();
                    }, 100);
                });
            });
        }
        
        function endCellSelection() {
            gridState.selectingCell = false;
            document.querySelectorAll('.selecting-mode').forEach(function(c) {
                c.classList.remove('selecting-mode');
            });
        }
        
        function getCellReference(cell) {
            var row = parseInt(cell.dataset.row) + 1; // 1-indexed
            var col = parseInt(cell.dataset.col);
            var colLetter = String.fromCharCode(65 + col); // A, B, C...
            return colLetter + row;
        }
        
        // Cell navigation with arrow keys
        function handleCellNavigation(e, cell) {
            var key = e.key;
            
            // Escape - end selection mode and clear formula
            if (key === 'Escape') {
                if (gridState.selectingCell) {
                    endCellSelection();
                }
                return;
            }
            
            // Enter - evaluate formula if present, then move down
            if (key === 'Enter') {
                e.preventDefault();
                if (cell.value.trim().startsWith('=')) {
                    evaluateCellFormula(cell);
                }
                endCellSelection();
                navigateToCell(cell, 0, 1);
                return;
            }
            
            // Tab - move to next cell
            if (key === 'Tab') {
                e.preventDefault();
                if (cell.value.trim().startsWith('=')) {
                    evaluateCellFormula(cell);
                }
                endCellSelection();
                navigateToCell(cell, e.shiftKey ? -1 : 1, 0);
                return;
            }
            
            // Arrow keys - normal navigation (don't auto-add references)
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
                // Check cursor position - only navigate if at edge of text
                var cursorPos = cell.selectionStart || 0;
                var textLen = cell.value.length;
                
                if (key === 'ArrowLeft' && cursorPos > 0) {
                    return; // Let cursor move within text
                }
                if (key === 'ArrowRight' && cursorPos < textLen) {
                    return; // Let cursor move within text
                }
                
                // Navigate to adjacent cell
                e.preventDefault();
                var dRow = 0, dCol = 0;
                switch(key) {
                    case 'ArrowUp': dRow = -1; break;
                    case 'ArrowDown': dRow = 1; break;
                    case 'ArrowLeft': dCol = -1; break;
                    case 'ArrowRight': dCol = 1; break;
                }
                navigateToCell(cell, dCol, dRow);
                return;
            }
        }
        
        function navigateToCell(fromCell, dCol, dRow) {
            var row = parseInt(fromCell.dataset.row) + dRow;
            var col = parseInt(fromCell.dataset.col) + dCol;
            
            var targetCell = document.querySelector('[data-row="' + row + '"][data-col="' + col + '"]');
            if (targetCell && !targetCell.classList.contains('readonly')) {
                targetCell.focus();
            }
        }
        
        // Update balance display
        function updateGridBalance() {
            var totalDebet = 0;
            var totalKredit = 0;
            
            // Get all number cells and sum debet/kredit
            document.querySelectorAll('#excel-tbody .excel-cell[data-type="number"]').forEach(function(cell) {
                var col = parseInt(cell.dataset.col);
                var val = parseFloat(cell.value.replace(/\s/g, '').replace(/,/g, '')) || 0;
                
                // Column 1 = Debet, Column 2 = Kredit (0-indexed, col 0 is account)
                if (col === 1) {
                    totalDebet += val;
                } else if (col === 2) {
                    totalKredit += val;
                }
            });
            
            // Update sum row
            var sumDebet = document.querySelector('.sum-debet');
            var sumKredit = document.querySelector('.sum-kredit');
            
            if (sumDebet) sumDebet.value = formatNumber(totalDebet);
            if (sumKredit) sumKredit.value = formatNumber(totalKredit);
            
            // Visual indicator for balance
            var isBalanced = Math.abs(totalDebet - totalKredit) < 0.01;
            
            if (sumDebet && sumKredit) {
                if (isBalanced && totalDebet > 0) {
                    sumDebet.style.color = 'var(--success)';
                    sumKredit.style.color = 'var(--success)';
                } else if (totalDebet > 0 || totalKredit > 0) {
                    sumDebet.style.color = 'var(--error)';
                    sumKredit.style.color = 'var(--error)';
                } else {
                    sumDebet.style.color = 'var(--text-secondary)';
                    sumKredit.style.color = 'var(--text-secondary)';
                }
            }
        }
        
        // Simple formula evaluation
        function evaluateCellFormula(cell) {
            var value = cell.value.trim();
            
            // Not a formula - just update balance
            if (!value.startsWith('=')) {
                updateGridBalance();
                return;
            }
            
            var formula = value.substring(1).trim();
            
            // Empty formula (just "=")
            if (!formula) {
                cell.value = '';
                delete cell.dataset.formula;
                updateGridBalance();
                return;
            }
            
            cell.dataset.formula = value;
            
            // Check for incomplete formulas (ends with operator or is just "=")
            if (/[\+\-\*\/\(]$/.test(formula)) {
                cell.title = 'Ufullstendig formel - legg til tall eller celle';
                return;
            }
            
            try {
                var result = calculateFormula(formula.toUpperCase());
                
                if (result !== null && !isNaN(result) && isFinite(result)) {
                    cell.value = formatNumber(result);
                    cell.dataset.result = result;
                    cell.title = 'Formel: ' + value + '\nResultat: ' + formatNumber(result);
                } else {
                    cell.value = '#FEIL';
                    cell.title = 'Ugyldig formel - sjekk syntaks';
                }
            } catch (e) {
                console.error('Formula error:', e, 'Formula:', formula);
                cell.value = '#FEIL';
                cell.title = 'Feil i formel: ' + e.message;
            }
            
            updateGridBalance();
        }
        
        // Calculate formula
        function calculateFormula(formula) {
            // Trim and clean
            formula = formula.trim();
            
            // If formula is empty, return 0
            if (!formula) {
                return 0;
            }
            
            // If formula is just a number, return it
            var cleanFormula = formula.replace(/\s/g, '').replace(',', '.');
            if (/^-?\d+\.?\d*$/.test(cleanFormula)) {
                return parseFloat(cleanFormula);
            }
            
            // If formula is just a single cell reference like "B1", get that cell's value
            if (/^[A-Z]\d+$/i.test(formula)) {
                return getCellValueByRef(formula);
            }
            
            // Handle SUM(range)
            formula = formula.replace(/SUM\(([A-Z]\d+):([A-Z]\d+)\)/gi, function(match, start, end) {
                var cells = expandRange(start, end);
                var sum = cells.reduce(function(acc, ref) {
                    return acc + getCellValueByRef(ref);
                }, 0);
                return '(' + sum + ')';
            });
            
            // Handle AVERAGE(range)
            formula = formula.replace(/AVERAGE\(([A-Z]\d+):([A-Z]\d+)\)/gi, function(match, start, end) {
                var cells = expandRange(start, end);
                if (cells.length === 0) return '(0)';
                var sum = cells.reduce(function(acc, ref) {
                    return acc + getCellValueByRef(ref);
                }, 0);
                return '(' + (sum / cells.length) + ')';
            });
            
            // Handle MIN(range)
            formula = formula.replace(/MIN\(([A-Z]\d+):([A-Z]\d+)\)/gi, function(match, start, end) {
                var cells = expandRange(start, end);
                if (cells.length === 0) return '(0)';
                var values = cells.map(function(ref) { return getCellValueByRef(ref); });
                return '(' + Math.min.apply(null, values) + ')';
            });
            
            // Handle MAX(range)
            formula = formula.replace(/MAX\(([A-Z]\d+):([A-Z]\d+)\)/gi, function(match, start, end) {
                var cells = expandRange(start, end);
                if (cells.length === 0) return '(0)';
                var values = cells.map(function(ref) { return getCellValueByRef(ref); });
                return '(' + Math.max.apply(null, values) + ')';
            });
            
            // Handle simple cell references (A1, B2, etc) - replace with their values
            formula = formula.replace(/([A-Z])(\d+)/gi, function(match, col, row) {
                var value = getCellValueByRef(col + row);
                return '(' + value + ')';
            });
            
            // Clean up for eval
            formula = formula.replace(/√ó/g, '*').replace(/√∑/g, '/');
            
            // Safety check - only allow numbers, operators, parentheses
            if (!/^[\d\s\+\-\*\/\(\)\.,]+$/.test(formula)) {
                console.error('Invalid formula characters:', formula);
                return NaN;
            }
            
            // Evaluate
            return eval(formula);
        }
        
        // Expand range like A1:A3 to [A1, A2, A3]
        function expandRange(start, end) {
            var startCol = start.charAt(0).toUpperCase();
            var startRow = parseInt(start.substring(1));
            var endCol = end.charAt(0).toUpperCase();
            var endRow = parseInt(end.substring(1));
            
            var cells = [];
            
            // Vertical range (same column)
            if (startCol === endCol) {
                for (var r = startRow; r <= endRow; r++) {
                    cells.push(startCol + r);
                }
            }
            // Horizontal range (same row)
            else if (startRow === endRow) {
                for (var c = startCol.charCodeAt(0); c <= endCol.charCodeAt(0); c++) {
                    cells.push(String.fromCharCode(c) + startRow);
                }
            }
            
            return cells;
        }
        
        // Get cell value by reference like "A1"
        function getCellValueByRef(ref) {
            var col = ref.charAt(0).toUpperCase().charCodeAt(0) - 65; // A=0, B=1
            var row = parseInt(ref.substring(1)) - 1; // 1-indexed to 0-indexed
            
            var cell = document.querySelector('[data-row="' + row + '"][data-col="' + col + '"]');
            if (!cell) return 0;
            
            // Use stored result if available
            if (cell.dataset.result !== undefined) {
                return parseFloat(cell.dataset.result);
            }
            
            // Parse value
            var val = cell.value.replace(/\s/g, '').replace(/,/g, '');
            return parseFloat(val) || 0;
        }
        
        // ==================== TOPICS ====================
        function renderTopicList() {
            var html = '';
            topics.forEach(function(topic) {
                html += '<div class="topic-item" id="topic-' + topic.id + '" onclick="startGame(\'' + topic.id + '\')">';
                html += '<span class="topic-item-icon">' + topic.icon + '</span>';
                html += '<div class="topic-item-info">';
                html += '<div class="topic-item-name">' + topic.name + '</div>';
                html += '<div class="topic-item-count" id="count-' + topic.id + '">Laster...</div>';
                html += '</div>';
                html += '</div>';
            });
            document.getElementById('topic-list').innerHTML = html;
        }
        
        // Topic ID mapping (database values -> our IDs)
        var topicMapping = {
            'grunnleggende': 'grunnleggende',
            'grunnlag': 'grunnleggende',
            'basis': 'grunnleggende',
            'bokforing': 'bokforing',
            'bokf√∏ring': 'bokforing',
            'bilag': 'bokforing',
            'journal': 'bokforing',
            'mva': 'mva',
            'merverdiavgift': 'mva',
            'avgift': 'mva',
            'skatt': 'skatt',
            'beskatning': 'skatt',
            'selskapsskatt': 'skatt',
            'arsavslutning': 'arsavslutning',
            '√•rsavslutning': 'arsavslutning',
            'avslutning': 'arsavslutning',
            'avskrivning': 'arsavslutning',
            'analyse': 'analyse',
            'regnskapsanalyse': 'analyse',
            'n√∏kkeltall': 'analyse',
            'driftsregnskap': 'driftsregnskap',
            'kalkyle': 'driftsregnskap',
            'dekningsbidrag': 'driftsregnskap',
            'lonn': 'lonn',
            'l√∏nn': 'lonn',
            'feriepenger': 'lonn',
            'aga': 'lonn'
        };
        
        function mapTopic(dbTopic) {
            if (!dbTopic) return null;
            var lower = dbTopic.toLowerCase();
            return topicMapping[lower] || lower;
        }
        
        async function loadQuestionCounts() {
            console.log('Loading question counts from Turso API...');
            
            try {
                var questions = [];
                
                // Pr√∏v forskjellige module IDs
                for (var i = 0; i < MODULE_IDS.length && questions.length === 0; i++) {
                    console.log('Trying module:', MODULE_IDS[i]);
                    questions = await apiCall('/questions?module=' + MODULE_IDS[i] + '&limit=500');
                }
                
                // Fallback: hent alle og filtrer
                if (!questions || questions.length === 0) {
                    console.log('No questions with module filter, fetching all and filtering...');
                    var allQuestions = await apiCall('/questions?limit=500');
                    questions = allQuestions.filter(function(q) {
                        var mid = (q.module_id || '').toLowerCase();
                        return mid === 'grunnleggende' || mid === 'grunnleggende_regnskap' || mid === '1';
                    });
                }
                
                if (!questions || questions.length === 0) {
                    console.warn('No questions found for grunnleggende');
                    topics.forEach(function(topic) {
                        var countEl = document.getElementById('count-' + topic.id);
                        if (countEl) countEl.textContent = '0 oppgaver';
                    });
                    return;
                }
                
                var counts = {};
                var total = questions.length;
                var foundTopics = {};
                
                // Initialize counts
                topics.forEach(function(t) {
                    counts[t.id] = 0;
                });
                
                questions.forEach(function(q) {
                    // Get topic from question
                    var dbTopic = q.topic;
                    if (!dbTopic && q.id) {
                        var key = q.id.toLowerCase();
                        if (key.includes('grunn') || key.includes('generelt') || key.includes('teori')) dbTopic = 'grunnleggende';
                        else if (key.includes('bokf') || key.includes('prak')) dbTopic = 'bokforing';
                        else if (key.includes('mva')) dbTopic = 'mva';
                        else if (key.includes('skatt')) dbTopic = 'skatt';
                        else if (key.includes('aars') || key.includes('avskr')) dbTopic = 'arsavslutning';
                        else if (key.includes('analyse') || key.includes('nokkel')) dbTopic = 'analyse';
                        else if (key.includes('drift') || key.includes('kalkyl')) dbTopic = 'driftsregnskap';
                        else if (key.includes('lonn') || key.includes('ferie')) dbTopic = 'lonn';
                        else dbTopic = 'grunnleggende';
                    }
                    
                    var mappedTopic = mapTopic(dbTopic);
                    foundTopics[dbTopic || 'unknown'] = (foundTopics[dbTopic || 'unknown'] || 0) + 1;
                    
                    if (mappedTopic && counts[mappedTopic] !== undefined) {
                        counts[mappedTopic]++;
                    }
                });
                
                console.log('Found ' + total + ' questions from Turso');
                console.log('Topics:', foundTopics);
                
                // Store questions for later use
                gameState.cachedQuestions = questions;
                
                // Update UI
                topics.forEach(function(topic) {
                    var countEl = document.getElementById('count-' + topic.id);
                    if (countEl) {
                        if (topic.id === 'mixed') {
                            countEl.textContent = total + ' oppgaver';
                        } else {
                            countEl.textContent = counts[topic.id] + ' oppgaver';
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading questions:', err);
                topics.forEach(function(topic) {
                    var countEl = document.getElementById('count-' + topic.id);
                    if (countEl) countEl.textContent = 'Feil';
                });
            }
        }
        
        // ==================== GAME ====================
        async function startGame(topicId) {
            gameState.currentTopic = topicId;
            gameState.currentDifficulty = 'all';
            gameState.score = 0;
            gameState.correctCount = 0;
            gameState.currentIndex = 0;
            gameState.answered = [];
            gameState.allQuestions = [];
            
            // Update UI
            document.querySelectorAll('.topic-item').forEach(function(el) {
                el.classList.remove('active');
            });
            document.getElementById('topic-' + topicId).classList.add('active');
            
            document.getElementById('nav-score').textContent = '0';
            document.getElementById('nav-correct').textContent = '0';
            
            await loadQuestions();
            
            if (gameState.allQuestions.length === 0) {
                alert('Ingen sp√∏rsm√•l funnet for dette temaet.');
                return;
            }
            
            updateDifficultyCounts();
            loadFormulasForTopic(topicId);
            
            // Show game UI
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('game-view').classList.add('visible');
            document.getElementById('progress-section').classList.add('visible');
            document.getElementById('question-selector-section').classList.add('visible');
            
            renderQuestionSelector();
            loadQuestion(0);
        }
        
        async function loadQuestions() {
            console.log('Loading questions from Turso API...');
            
            var questions = [];
            
            // Use cached questions from loadQuestionCounts if available
            var allQuestions = gameState.cachedQuestions || await apiCall('/questions?module=' + MODULE_ID + '&limit=500');
            
            if (!allQuestions || allQuestions.length === 0) {
                console.warn('No questions found');
                gameState.allQuestions = [];
                gameState.questions = [];
                return;
            }
            
            allQuestions.forEach(function(q) {
                // Extract topic from ID if not present
                if (!q.topic && q.id) {
                    var key = q.id.toLowerCase();
                    if (key.includes('grunn') || key.includes('teori')) q.topic = 'grunnleggende';
                    else if (key.includes('bokf') || key.includes('prak')) q.topic = 'bokforing';
                    else if (key.includes('mva')) q.topic = 'mva';
                    else if (key.includes('skatt')) q.topic = 'skatt';
                    else if (key.includes('aars') || key.includes('avskr')) q.topic = 'arsavslutning';
                    else if (key.includes('analyse') || key.includes('nokkel')) q.topic = 'analyse';
                    else if (key.includes('drift') || key.includes('kalkyl')) q.topic = 'driftsregnskap';
                    else if (key.includes('lonn') || key.includes('ferie')) q.topic = 'lonn';
                    else q.topic = 'grunnleggende';
                }
                
                // Map type names
                if (q.type === 'mc') q.type = 'multiple_choice';
                else if (q.type === 'tf') q.type = 'true_false';
                else if (q.type === 'fill_blank') q.type = 'calculation';
                
                // Create title from question if not present
                if (!q.title && q.question) {
                    q.title = q.question.substring(0, 50) + (q.question.length > 50 ? '...' : '');
                }
                
                // Map topic for filtering
                var mappedTopic = mapTopic(q.topic);
                
                // Filter by topic if not mixed
                if (gameState.currentTopic !== 'mixed') {
                    if (mappedTopic !== gameState.currentTopic) return;
                }
                
                questions.push(q);
            });
            
            console.log('Loaded ' + questions.length + ' questions for topic: ' + gameState.currentTopic);
            if (questions.length > 0) {
                console.log('Sample question:', questions[0]);
            }
            
            gameState.allQuestions = questions;
            gameState.questions = shuffleArray(questions).slice(0, 10);
        }
        
        function updateDifficultyCounts() {
            var counts = { all: 0, easy: 0, medium: 0, hard: 0 };
            gameState.allQuestions.forEach(function(q) {
                counts.all++;
                if (counts[q.difficulty] !== undefined) counts[q.difficulty]++;
            });
            
            document.getElementById('diff-count-all').textContent = counts.all;
            document.getElementById('diff-count-easy').textContent = counts.easy;
            document.getElementById('diff-count-medium').textContent = counts.medium;
            document.getElementById('diff-count-hard').textContent = counts.hard;
        }
        
        function filterByDifficulty(diff) {
            gameState.currentDifficulty = diff;
            
            // Update UI
            document.querySelectorAll('.diff-card').forEach(function(el) {
                el.classList.remove('active');
            });
            event.target.closest('.diff-card').classList.add('active');
            
            // Filter
            var filtered = diff === 'all' 
                ? gameState.allQuestions.slice() 
                : gameState.allQuestions.filter(function(q) { return q.difficulty === diff; });
            
            if (filtered.length === 0) {
                alert('Ingen sp√∏rsm√•l med denne vanskelighetsgraden.');
                return;
            }
            
            // Reset game
            gameState.questions = shuffleArray(filtered).slice(0, 10);
            gameState.currentIndex = 0;
            gameState.answered = [];
            gameState.score = 0;
            gameState.correctCount = 0;
            
            document.getElementById('nav-score').textContent = '0';
            document.getElementById('nav-correct').textContent = '0';
            
            renderQuestionSelector();
            loadQuestion(0);
        }
        
        function loadFormulasForTopic(topicId) {
            var list = formulas[topicId] || formulas.grunnleggende;
            if (topicId === 'mixed') {
                list = [];
                Object.keys(formulas).forEach(function(t) {
                    list = list.concat(formulas[t].slice(0, 1));
                });
            }
            
            var html = '';
            list.forEach(function(f) {
                html += '<div class="formula-item">';
                html += '<div class="formula-name">' + f.name + '</div>';
                html += '<div class="formula-equation">' + f.equation + '</div>';
                html += '<div class="formula-description">' + f.description + '</div>';
                html += '</div>';
            });
            document.getElementById('formula-list').innerHTML = html;
        }
        
        // ==================== QUESTION RENDERING ====================
        function renderQuestionSelector() {
            var html = '';
            for (var i = 0; i < gameState.questions.length; i++) {
                var cls = 'question-selector-item';
                if (i === gameState.currentIndex) cls += ' current';
                if (gameState.answered[i]) cls += ' completed';
                html += '<div class="' + cls + '" onclick="loadQuestion(' + i + ')">' + (i + 1) + '</div>';
            }
            document.getElementById('question-selector').innerHTML = html;
            
            var pct = Math.round((gameState.answered.filter(Boolean).length / gameState.questions.length) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-bar').textContent = pct + '%';
            document.getElementById('nav-progress').textContent = (gameState.currentIndex + 1) + '/' + gameState.questions.length;
        }
        
        function loadQuestion(idx) {
            gameState.currentIndex = idx;
            gameState.currentQuestion = gameState.questions[idx];
            gameState.selectedAnswer = null;
            gameState.answeredCorrectly = false;
            gameState.hintsUsed = 0;
            
            var q = gameState.currentQuestion;
            
            document.getElementById('question-number').textContent = 'Sp√∏rsm√•l ' + (idx + 1) + ' av ' + gameState.questions.length;
            document.getElementById('question-title').textContent = q.title || 'Oppgave';
            document.getElementById('question-text').textContent = q.question || q.description || '';
            
            var badgesHtml = '<span class="badge badge-topic">' + q.topic + '</span>';
            badgesHtml += '<span class="badge badge-type">' + (q.type || 'calc') + '</span>';
            badgesHtml += '<span class="badge badge-diff">' + (q.difficulty || 'medium') + '</span>';
            document.getElementById('question-badges').innerHTML = badgesHtml;
            
            // Reset UI
            document.getElementById('hint-box').classList.remove('visible');
            document.getElementById('explanation-box').classList.remove('visible');
            document.getElementById('btn-check').style.display = 'inline-flex';
            document.getElementById('btn-check').disabled = false;
            document.getElementById('btn-next').style.display = 'none';
            document.getElementById('btn-explanation').style.display = 'none';
            document.getElementById('btn-hint').disabled = false;
            
            renderQuestionContent(q);
            renderVariables(q);
            renderQuestionSelector();
        }
        
        function renderQuestionContent(q) {
            // Hide all containers
            document.getElementById('options-container').style.display = 'none';
            document.getElementById('input-fields').style.display = 'none';
            document.getElementById('data-display').style.display = 'none';
            document.getElementById('excel-grid-container').style.display = 'none';
            document.getElementById('tf-container').style.display = 'none';
            document.getElementById('dnd-container').style.display = 'none';
            document.getElementById('journal-container').style.display = 'none';
            
            // Reset state
            gameState.selectedAnswer = null;
            gameState.selectedAnswers = [];
            gameState.tfAnswer = null;
            gameState.dndState = {};
            
            if (q.data) renderDataTable(q.data);
            
            var type = q.type || 'calculation';
            
            if (type === 'multiple_choice' || type === 'mc') {
                renderMultipleChoice(q);
            } else if (type === 'multi' || type === 'multi_select') {
                renderMultiSelect(q);
            } else if (type === 'true_false' || type === 'tf') {
                renderTrueFalse(q);
            } else if (type === 'dnd' || type === 'drag_drop') {
                renderDragDrop(q);
            } else if (type === 'journal_entry' || type === 'journal') {
                renderJournalEntry(q);
            } else if (type === 'excel_grid') {
                renderExcelGrid(q);
                // Auto-show accounts panel for T-konto questions
                if (q.grid && q.grid.rows) {
                    showSidebarView('accounts');
                    // Add glow hint to accounts button
                    var accountsBtn = document.getElementById('btn-accounts');
                    if (accountsBtn) {
                        accountsBtn.classList.add('glow-hint');
                        // Remove glow after user clicks or after 10 seconds
                        setTimeout(function() {
                            accountsBtn.classList.remove('glow-hint');
                        }, 10000);
                    }
                }
            } else {
                renderCalculation(q);
            }
        }
        
        function renderDataTable(data) {
            document.getElementById('data-display').style.display = 'block';
            var html = '';
            Object.keys(data).forEach(function(k) {
                var v = data[k];
                if (typeof v !== 'object' || Array.isArray(v)) {
                    html += '<tr><th>' + formatLabel(k) + '</th><td>' + formatNumber(v) + '</td></tr>';
                }
            });
            document.getElementById('data-table').querySelector('tbody').innerHTML = html;
        }
        
        function renderMultipleChoice(q) {
            var container = document.getElementById('options-container');
            container.style.display = 'flex';
            var opts = q.options || [];
            var html = '';
            opts.forEach(function(o, i) {
                // Handle both Turso format (option_text) and old format (text/string)
                var id = o.id || String(i);
                var text = o.option_text || o.text || (typeof o === 'string' ? o : '');
                html += '<div class="option-item" data-id="' + id + '" data-index="' + i + '" onclick="selectOption(\'' + id + '\')">';
                html += '<div class="option-letter">' + String.fromCharCode(65 + i) + '</div>';
                html += '<div>' + text + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }
        
        function renderTrueFalse(q) {
            document.getElementById('tf-container').style.display = 'flex';
            // Reset buttons
            document.querySelectorAll('.tf-btn').forEach(function(btn) {
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
        }
        
        function selectTF(value) {
            if (gameState.answeredCorrectly || gameState.answered[gameState.currentIndex]) return;
            gameState.tfAnswer = value;
            document.querySelectorAll('.tf-btn').forEach(function(btn) {
                var btnVal = btn.dataset.value === 'true';
                btn.classList.toggle('selected', btnVal === value);
            });
        }
        
        function renderMultiSelect(q) {
            var container = document.getElementById('options-container');
            container.style.display = 'flex';
            var opts = q.options || [];
            var html = '<p style="color: var(--text-secondary); margin-bottom: var(--space-sm); width: 100%;">Velg alle riktige svar:</p>';
            opts.forEach(function(o, i) {
                var id = o.id || i.toString();
                var text = typeof o === 'string' ? o : o.text;
                html += '<div class="option-item" data-id="' + id + '" onclick="toggleMultiOption(\'' + id + '\')">' +
                    '<div class="option-letter"></div>' +
                    '<div>' + text + '</div></div>';
            });
            container.innerHTML = html;
        }
        
        function toggleMultiOption(optId) {
            if (gameState.answeredCorrectly || gameState.answered[gameState.currentIndex]) return;
            var idx = gameState.selectedAnswers.indexOf(optId);
            if (idx > -1) {
                gameState.selectedAnswers.splice(idx, 1);
            } else {
                gameState.selectedAnswers.push(optId);
            }
            document.querySelectorAll('.option-item').forEach(function(item) {
                var isSelected = gameState.selectedAnswers.indexOf(item.dataset.id) > -1;
                item.classList.toggle('selected', isSelected);
                item.querySelector('.option-letter').textContent = isSelected ? '‚úì' : '';
            });
        }
        
        function renderDragDrop(q) {
            document.getElementById('dnd-container').style.display = 'flex';
            var items = q.items || [];
            var targets = q.targets || [];
            
            // Render draggable items
            var itemsHtml = '';
            items.forEach(function(item) {
                itemsHtml += '<div class="dnd-item" draggable="true" data-item-id="' + item.id + '">' + item.text + '</div>';
            });
            document.getElementById('dnd-items').innerHTML = itemsHtml;
            
            // Render drop targets
            var targetsHtml = '';
            targets.forEach(function(target) {
                targetsHtml += '<div class="dnd-target" data-target-id="' + target.id + '">' +
                    '<div class="dnd-target-label">' + target.label + '</div>' +
                    '<div class="dnd-target-items"></div></div>';
            });
            document.getElementById('dnd-targets').innerHTML = targetsHtml;
            
            // Initialize drag & drop
            initDragDrop();
        }
        
        function initDragDrop() {
            var items = document.querySelectorAll('.dnd-item');
            var targets = document.querySelectorAll('.dnd-target');
            var source = document.getElementById('dnd-items');
            
            items.forEach(function(item) {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', item.dataset.itemId);
                    item.classList.add('dragging');
                });
                item.addEventListener('dragend', function() {
                    item.classList.remove('dragging');
                });
            });
            
            targets.forEach(function(target) {
                target.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    target.classList.add('drag-over');
                });
                target.addEventListener('dragleave', function() {
                    target.classList.remove('drag-over');
                });
                target.addEventListener('drop', function(e) {
                    e.preventDefault();
                    target.classList.remove('drag-over');
                    if (gameState.answered[gameState.currentIndex]) return;
                    var itemId = e.dataTransfer.getData('text/plain');
                    var item = document.querySelector('[data-item-id="' + itemId + '"]');
                    if (item) {
                        target.querySelector('.dnd-target-items').appendChild(item);
                    }
                });
            });
            
            // Allow drop back to source
            source.addEventListener('dragover', function(e) { e.preventDefault(); });
            source.addEventListener('drop', function(e) {
                e.preventDefault();
                if (gameState.answered[gameState.currentIndex]) return;
                var itemId = e.dataTransfer.getData('text/plain');
                var item = document.querySelector('[data-item-id="' + itemId + '"]');
                if (item) source.appendChild(item);
            });
        }
        
        function renderJournalEntry(q) {
            document.getElementById('journal-container').style.display = 'block';
            var tbody = document.getElementById('journal-tbody');
            var rows = q.rows || 3;
            
            var html = '';
            for (var i = 0; i < rows; i++) {
                html += '<tr>' +
                    '<td class="row-number">' + (i + 1) + '</td>' +
                    '<td><input type="text" class="excel-cell account-cell" data-row="' + i + '" data-col="account" placeholder="Konto" oninput="updateAccountName(this)" ondrop="dropAccount(event, this)" ondragover="event.preventDefault(); this.classList.add(\'drag-over\')" ondragleave="this.classList.remove(\'drag-over\')"></td>' +
                    '<td><input type="text" class="excel-cell account-cell readonly" data-row="' + i + '" data-col="name" readonly placeholder="Kontonavn"></td>' +
                    '<td><input type="text" class="excel-cell" data-row="' + i + '" data-col="debit" placeholder="0" oninput="updateJournalBalance()"></td>' +
                    '<td><input type="text" class="excel-cell" data-row="' + i + '" data-col="credit" placeholder="0" oninput="updateJournalBalance()"></td>' +
                    '</tr>';
            }
            tbody.innerHTML = html;
            updateJournalBalance();
        }
        
        function updateAccountName(input) {
            var row = input.dataset.row;
            var code = input.value.trim();
            var nameCell = document.querySelector('[data-row="' + row + '"][data-col="name"]');
            if (nameCell) {
                nameCell.value = KONTOPLAN[code] || '';
            }
        }
        
        function dropAccount(event, cell) {
            event.preventDefault();
            cell.classList.remove('drag-over');
            if (gameState.answered[gameState.currentIndex]) return;
            try {
                var data = JSON.parse(event.dataTransfer.getData('application/json'));
                cell.value = data.code;
                updateAccountName(cell);
            } catch (e) {}
        }
        
        function updateJournalBalance() {
            var totalDebit = 0;
            var totalCredit = 0;
            document.querySelectorAll('#journal-tbody [data-col="debit"]').forEach(function(cell) {
                totalDebit += parseFloat(cell.value) || 0;
            });
            document.querySelectorAll('#journal-tbody [data-col="credit"]').forEach(function(cell) {
                totalCredit += parseFloat(cell.value) || 0;
            });
            var diff = totalDebit - totalCredit;
            
            document.getElementById('sum-debit').textContent = totalDebit.toLocaleString('nb-NO');
            document.getElementById('sum-credit').textContent = totalCredit.toLocaleString('nb-NO');
            
            var diffEl = document.getElementById('balance-diff');
            diffEl.textContent = diff.toLocaleString('nb-NO');
            diffEl.className = 'balance-value ' + (diff === 0 && totalDebit > 0 ? 'balanced' : 'unbalanced');
        }
        
        function renderCalculation(q) {
            document.getElementById('input-fields').style.display = 'grid';
            var fields = q.input_fields || [{ id: 'answer', label: 'Svar' }];
            var html = '';
            fields.forEach(function(f) {
                html += '<div class="input-group"><label>' + f.label + '</label><input type="text" id="input-' + f.id + '" placeholder="0"></div>';
            });
            document.getElementById('input-fields').innerHTML = html;
        }
        
        function renderExcelGrid(q) {
            document.getElementById('excel-grid-container').style.display = 'block';
            
            var thead = document.getElementById('excel-thead');
            var tbody = document.getElementById('excel-tbody');
            
            // Check if we have a proper grid structure
            var grid = q.grid || q.excel_grid;
            
            console.log('=== renderExcelGrid DEBUG ===');
            console.log('Question ID:', q.id);
            console.log('Question type:', q.type);
            console.log('Has q.grid:', !!q.grid);
            console.log('Has q.excel_grid:', !!q.excel_grid);
            console.log('grid value:', grid);
            console.log('grid.rows:', grid ? grid.rows : 'N/A');
            console.log('grid.rows.length:', grid && grid.rows ? grid.rows.length : 'N/A');
            
            if (grid && grid.rows && grid.rows.length > 0) {
                console.log('Using T-konto grid mode');
                
                // Update header to show T-konto style
                var headerRow = document.querySelector('#excel-grid-container .excel-header-row');
                if (headerRow) {
                    headerRow.innerHTML = '<span class="excel-title">üìä T-konto</span><span class="excel-hint">Fyll inn bel√∏pene</span>';
                }
                
                // Use the provided grid structure for T-konto
                // Columns should be ['Konto', 'Debet', 'Kredit'] or similar
                var columns = grid.columns || ['Konto', 'Debet', 'Kredit'];
                
                // Header: tom kolonne for row-labels + data-kolonner
                var headerHtml = '<tr><th style="min-width: 100px;"></th>';
                columns.forEach(function(c) {
                    headerHtml += '<th style="min-width: 120px;">' + c + '</th>';
                });
                headerHtml += '</tr>';
                thead.innerHTML = headerHtml;
                
                var bodyHtml = '';
                grid.rows.forEach(function(row, ri) {
                    bodyHtml += '<tr>';
                    
                    // Row label in first column
                    bodyHtml += '<td class="row-label">' + (row.label || '') + '</td>';
                    
                    // Cells for data columns
                    (row.cells || []).forEach(function(cell, ci) {
                        var isEditable = cell.editable !== false && cell.readonly !== true;
                        var val = cell.value !== undefined && cell.value !== null && cell.value !== '' ? cell.value : '';
                        var cellId = 'cell-' + ri + '-' + ci;
                        var cellType = cell.type || 'text';
                        
                        if (!isEditable) {
                            bodyHtml += '<td><input class="excel-cell readonly" value="' + val + '" readonly tabindex="-1"></td>';
                        } else if (cellType === 'account') {
                            // Account field - droppable with fill handle
                            bodyHtml += '<td><div class="cell-wrapper"><input class="excel-cell account-input" id="input-' + cellId + '" data-id="' + cellId + '" data-row="' + ri + '" data-col="' + ci + '" data-type="account" placeholder="Dra konto hit" type="text"><div class="fill-handle"></div></div></td>';
                        } else {
                            // Number field with fill handle
                            bodyHtml += '<td><div class="cell-wrapper"><input class="excel-cell number-input" id="input-' + cellId + '" data-id="' + cellId + '" data-row="' + ri + '" data-col="' + ci + '" data-type="number" placeholder="?" inputmode="numeric" pattern="[0-9]*"><div class="fill-handle"></div></div></td>';
                        }
                    });
                    bodyHtml += '</tr>';
                });
                
                // Add Sum row
                bodyHtml += '<tr class="sum-row">';
                bodyHtml += '<td class="row-label" style="font-weight: bold; color: var(--accent);">Sum</td>';
                bodyHtml += '<td></td>'; // Empty for account column
                bodyHtml += '<td><input class="excel-cell readonly sum-debet" value="0" readonly style="font-weight: bold; text-align: right;"></td>';
                bodyHtml += '<td><input class="excel-cell readonly sum-kredit" value="0" readonly style="font-weight: bold; text-align: right;"></td>';
                bodyHtml += '</tr>';
                
                tbody.innerHTML = bodyHtml;
                
                console.log('Grid rendered with', grid.rows.length, 'rows + sum row');
                
                // Setup drag & drop and other interactions
                setTimeout(function() {
                    setupExcelGridDragDrop();
                    setupExcelGridFormulas();
                    updateGridBalance();
                }, 100);
            } else {
                console.log('Using auto-generate mode (no valid grid found)');
                
                // Auto-generate grid from data and input_fields
                thead.innerHTML = '<tr><th>Parameter</th><th>Verdi</th></tr>';
                
                var bodyHtml = '';
                
                // First add readonly data rows
                if (q.data) {
                    Object.keys(q.data).forEach(function(key) {
                        var val = q.data[key];
                        if (typeof val !== 'object') {
                            bodyHtml += '<tr>';
                            bodyHtml += '<td class="row-label">' + formatLabel(key) + '</td>';
                            bodyHtml += '<td><input class="excel-cell readonly" value="' + formatNumber(val) + '" readonly></td>';
                            bodyHtml += '</tr>';
                        }
                    });
                }
                
                // Then add input fields as editable rows
                var fields = q.input_fields || [];
                fields.forEach(function(field, idx) {
                    bodyHtml += '<tr>';
                    bodyHtml += '<td class="row-label" style="color: var(--accent);">' + (field.label || field.id) + '</td>';
                    bodyHtml += '<td><input class="excel-cell" id="input-' + field.id + '" data-id="' + field.id + '" placeholder="Skriv svar..." type="number"></td>';
                    bodyHtml += '</tr>';
                });
                
                tbody.innerHTML = bodyHtml;
                
                if (fields.length === 0 && !q.data) {
                    tbody.innerHTML += '<tr><td colspan="2" style="text-align: center; color: var(--text-secondary);">Ingen input-felt definert</td></tr>';
                }
            }
        }
        
        function renderVariables(q) {
            var container = document.getElementById('variable-list');
            if (!q.data) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Ingen data for denne oppgaven.</p>';
                return;
            }
            
            var html = '';
            Object.keys(q.data).forEach(function(k) {
                var v = q.data[k];
                if (typeof v !== 'object') {
                    html += '<div class="data-item"><div class="data-label">' + formatLabel(k) + '</div><div class="data-value">' + formatNumber(v) + '</div></div>';
                }
            });
            container.innerHTML = html || '<p style="color: var(--text-secondary);">Ingen data</p>';
        }
        
        // ==================== ANSWER HANDLING ====================
        function selectOption(id) {
            if (gameState.answeredCorrectly) return;
            gameState.selectedAnswer = id;
            document.querySelectorAll('.option-item').forEach(function(el) {
                el.classList.toggle('selected', el.dataset.id === id);
            });
        }
        
        function checkAnswer() {
            var q = gameState.currentQuestion;
            document.getElementById('btn-check').disabled = true;
            
            console.log('Checking answer for question:', q.id);
            console.log('Question data:', q);
            
            // Turso API includes solution data in the question object
            // MC options have is_correct, other types have correct/answer field
            if (q.options && q.options.length > 0) {
                // MC type - options have is_correct flag
                console.log('Using MC options with is_correct flag');
                processAnswer(q, q);
                return;
            }
            
            if (q.correct !== undefined || q.answer !== undefined) {
                console.log('Using embedded solution data');
                processAnswer(q, q);
                return;
            }
            
            // No solution found
            console.error('No solution found for:', q.id);
            alert('Ingen fasit funnet for dette sp√∏rsm√•let. Kontakt administrator.');
            document.getElementById('btn-check').disabled = false;
        }
        
        function processAnswer(q, solution) {
            var correct;
            var type = q.type || 'calculation';
            
            if (type === 'multiple_choice' || type === 'mc') {
                correct = checkMC(solution);
            } else if (type === 'true_false' || type === 'tf') {
                correct = checkTF(solution);
            } else if (type === 'multi' || type === 'multi_select') {
                correct = checkMultiSelect(solution);
            } else if (type === 'dnd' || type === 'drag_drop') {
                correct = checkDnD(solution);
            } else if (type === 'journal_entry' || type === 'journal') {
                correct = checkJournalEntry(solution);
            } else if (type === 'excel_grid') {
                correct = checkExcelGrid(q);
            } else {
                correct = checkCalc(solution);
            }
            
            if (correct === null) {
                document.getElementById('btn-check').disabled = false;
                return;
            }
            
            if (correct) handleCorrect(); else handleIncorrect();
            document.getElementById('btn-check').disabled = false;
        }
        
        function checkTF(solution) {
            if (gameState.tfAnswer === null) {
                alert('Velg Sant eller Usant!');
                return null;
            }
            
            var correctVal = solution.correct;
            if (typeof correctVal === 'string') {
                correctVal = correctVal.toLowerCase() === 'true';
            }
            
            var isCorrect = gameState.tfAnswer === correctVal;
            
            document.querySelectorAll('.tf-btn').forEach(function(btn) {
                var btnVal = btn.dataset.value === 'true';
                if (btnVal === correctVal) {
                    btn.classList.add('correct');
                } else if (btnVal === gameState.tfAnswer && !isCorrect) {
                    btn.classList.add('incorrect');
                }
            });
            
            return isCorrect;
        }
        
        function checkMultiSelect(solution) {
            if (gameState.selectedAnswers.length === 0) {
                alert('Velg minst ett svar!');
                return null;
            }
            
            var correctAnswers = solution.correct || [];
            var userSorted = gameState.selectedAnswers.slice().sort();
            var correctSorted = correctAnswers.slice().sort();
            
            var isCorrect = JSON.stringify(userSorted) === JSON.stringify(correctSorted);
            
            document.querySelectorAll('.option-item').forEach(function(el) {
                var optId = el.dataset.id;
                if (correctAnswers.indexOf(optId) > -1) {
                    el.classList.add('correct');
                } else if (gameState.selectedAnswers.indexOf(optId) > -1) {
                    el.classList.add('incorrect');
                }
            });
            
            return isCorrect;
        }
        
        function checkDnD(solution) {
            var correctMapping = solution.correct || solution;
            var allCorrect = true;
            
            document.querySelectorAll('.dnd-target').forEach(function(target) {
                var targetId = target.dataset.targetId;
                var itemsInTarget = [];
                target.querySelectorAll('.dnd-item').forEach(function(item) {
                    itemsInTarget.push(item.dataset.itemId);
                });
                
                var correctItems = correctMapping[targetId] || [];
                // Convert to strings for comparison
                correctItems = correctItems.map(function(i) { return String(i); });
                var isTargetCorrect = JSON.stringify(itemsInTarget.sort()) === JSON.stringify(correctItems.slice().sort());
                
                if (isTargetCorrect) {
                    target.classList.add('correct');
                } else {
                    target.classList.add('incorrect');
                    allCorrect = false;
                }
            });
            
            return allCorrect;
        }
        
        function checkJournalEntry(solution) {
            var correctEntries = solution.correct || [];
            var matchedSolutions = [];
            var allCorrect = true;
            var hasEntries = false;
            
            document.querySelectorAll('#journal-tbody tr').forEach(function(row) {
                var accountCell = row.querySelector('[data-col="account"]');
                var debitCell = row.querySelector('[data-col="debit"]');
                var creditCell = row.querySelector('[data-col="credit"]');
                
                if (!accountCell || !debitCell || !creditCell) return;
                
                var account = accountCell.value.trim();
                var debit = parseFloat(debitCell.value) || 0;
                var credit = parseFloat(creditCell.value) || 0;
                
                if (!account && debit === 0 && credit === 0) return;
                hasEntries = true;
                
                var found = false;
                correctEntries.forEach(function(sol, idx) {
                    if (matchedSolutions.indexOf(idx) > -1) return;
                    if (sol.account === account && sol.debit === debit && sol.credit === credit) {
                        found = true;
                        matchedSolutions.push(idx);
                    }
                });
                
                if (found) {
                    accountCell.classList.add('correct');
                    debitCell.classList.add('correct');
                    creditCell.classList.add('correct');
                } else {
                    if (account || debit || credit) {
                        accountCell.classList.add('incorrect');
                        debitCell.classList.add('incorrect');
                        creditCell.classList.add('incorrect');
                        allCorrect = false;
                    }
                }
            });
            
            if (matchedSolutions.length !== correctEntries.length) {
                allCorrect = false;
            }
            
            if (!hasEntries) {
                alert('Fyll inn bilagsf√∏ringen!');
                return null;
            }
            
            return allCorrect;
        }
        
        function checkExcelGrid(q) {
            // For T-konto bokf√∏ring: sjekk balanse og posteringer
            var grid = q.grid;
            console.log('checkExcelGrid called with question:', q.id);
            console.log('Grid:', grid);
            console.log('q.correct:', q.correct);
            console.log('q.solution:', q.solution);
            
            // Collect user's entries
            var userEntries = [];
            var totalDebet = 0;
            var totalKredit = 0;
            var hasInput = false;
            
            // Get all editable cells
            document.querySelectorAll('#excel-tbody tr:not(.sum-row)').forEach(function(row, ri) {
                var accountCell = row.querySelector('[data-type="account"]');
                var debetCell = row.querySelector('[data-col="1"]');
                var kreditCell = row.querySelector('[data-col="2"]');
                
                var account = accountCell ? accountCell.value.trim() : '';
                var debet = debetCell ? parseFloat(debetCell.value.replace(/\s/g, '').replace(',', '.')) || 0 : 0;
                var kredit = kreditCell ? parseFloat(kreditCell.value.replace(/\s/g, '').replace(',', '.')) || 0 : 0;
                
                if (account || debet || kredit) {
                    hasInput = true;
                    userEntries.push({ account: account, debet: debet, kredit: kredit, row: ri });
                    totalDebet += debet;
                    totalKredit += kredit;
                }
            });
            
            console.log('User entries:', userEntries);
            console.log('Total debet:', totalDebet, 'Total kredit:', totalKredit);
            
            if (!hasInput) {
                alert('Fyll inn posteringene i T-kontoen!');
                return null;
            }
            
            // Check balance first
            if (Math.abs(totalDebet - totalKredit) > 0.01) {
                alert('Posteringen balanserer ikke! Debet (' + formatNumber(totalDebet) + ') m√• v√¶re lik Kredit (' + formatNumber(totalKredit) + ')');
                return false;
            }
            
            // If we have a solution/correct array, validate against it
            var solution = q.correct || q.solution;
            
            if (solution && Array.isArray(solution)) {
                // Validate each required entry exists
                var allCorrect = true;
                var matchedSolutions = [];
                
                userEntries.forEach(function(entry) {
                    var found = false;
                    solution.forEach(function(sol, idx) {
                        if (matchedSolutions.indexOf(idx) > -1) return;
                        
                        // Match account and amounts
                        var accountMatch = String(entry.account) === String(sol.account || sol.konto);
                        var debetMatch = Math.abs(entry.debet - (sol.debet || sol.debit || 0)) < 0.01;
                        var kreditMatch = Math.abs(entry.kredit - (sol.kredit || sol.credit || 0)) < 0.01;
                        
                        if (accountMatch && debetMatch && kreditMatch) {
                            found = true;
                            matchedSolutions.push(idx);
                        }
                    });
                    
                    // Mark row visually
                    var rowEl = document.querySelector('#excel-tbody tr:nth-child(' + (entry.row + 1) + ')');
                    if (rowEl) {
                        rowEl.querySelectorAll('.excel-cell:not(.readonly)').forEach(function(cell) {
                            if (found) {
                                cell.classList.remove('incorrect');
                                cell.classList.add('correct');
                            } else {
                                cell.classList.remove('correct');
                                cell.classList.add('incorrect');
                                allCorrect = false;
                            }
                        });
                    }
                });
                
                // Check if all required solutions were matched
                if (matchedSolutions.length < solution.length) {
                    allCorrect = false;
                }
                
                return allCorrect;
            }
            
            // If we have answer data in grid cells
            if (grid && grid.rows) {
                var allCorrect = true;
                var hasAnswers = false;
                
                grid.rows.forEach(function(row, ri) {
                    (row.cells || []).forEach(function(cell, ci) {
                        var correctValue = cell.answer !== undefined ? cell.answer : cell.correct;
                        if (correctValue === undefined) return;
                        
                        hasAnswers = true;
                        var inputEl = document.querySelector('[data-row="' + ri + '"][data-col="' + ci + '"]');
                        if (!inputEl) return;
                        
                        var userValue = inputEl.value.trim();
                        var isCorrect = false;
                        var cellType = cell.type || 'number';
                        
                        if (cellType === 'account') {
                            isCorrect = userValue === String(correctValue);
                        } else {
                            var userNum = parseFloat(userValue.replace(/\s/g, '').replace(',', '.')) || 0;
                            var correctNum = parseFloat(correctValue) || 0;
                            isCorrect = Math.abs(userNum - correctNum) < 0.01;
                        }
                        
                        if (isCorrect) {
                            inputEl.classList.remove('incorrect');
                            inputEl.classList.add('correct');
                        } else {
                            inputEl.classList.remove('correct');
                            inputEl.classList.add('incorrect');
                            allCorrect = false;
                        }
                    });
                });
                
                if (hasAnswers) {
                    return allCorrect;
                }
            }
            
            // No solution data - just check balance and mark all as correct if balanced
            console.log('No solution data found - checking balance only');
            document.querySelectorAll('#excel-tbody tr:not(.sum-row) .excel-cell:not(.readonly)').forEach(function(cell) {
                if (cell.value.trim()) {
                    cell.classList.add('correct');
                }
            });
            
            return true; // Balanced = correct when no solution
        }
        
        function checkMC(solution) {
            if (!gameState.selectedAnswer) { 
                alert('Velg et svar!'); 
                return null; 
            }
            
            var q = gameState.currentQuestion;
            var opts = q.options || [];
            var userAnswer = gameState.selectedAnswer;
            var isCorrect = false;
            var correctId = null;
            
            // Find correct answer from options (Turso format with is_correct)
            opts.forEach(function(o, i) {
                var optId = o.id || String(i);
                if (o.is_correct === 1 || o.is_correct === '1' || o.is_correct === true) {
                    correctId = optId;
                    if (userAnswer === optId) {
                        isCorrect = true;
                    }
                }
            });
            
            // Fallback to old format (solution.correct or solution.answer)
            if (correctId === null) {
                correctId = solution.correct || solution.answer;
                if (typeof correctId === 'number') {
                    correctId = String(correctId);
                }
                if (correctId !== null && correctId !== undefined) {
                    correctId = String(correctId).toLowerCase().trim();
                    isCorrect = userAnswer.toLowerCase().trim() === correctId;
                }
            }
            
            console.log('MC Check - User:', userAnswer, 'Correct:', correctId, 'Result:', isCorrect);
            
            // Mark options visually
            document.querySelectorAll('.option-item').forEach(function(el) {
                var optId = el.dataset.id;
                if (optId === correctId || (opts[parseInt(optId)] && (opts[parseInt(optId)].is_correct === 1 || opts[parseInt(optId)].is_correct === '1'))) {
                    el.classList.add('correct');
                } else if (optId === userAnswer && !isCorrect) {
                    el.classList.add('incorrect');
                }
            });
            
            return isCorrect;
        }
        
        function checkCalc(solution) {
            var q = gameState.currentQuestion;
            var ok = true;
            
            // Handle different solution structures
            var correctValues = solution.correct || solution;
            var tol = solution.tolerance !== undefined ? solution.tolerance : 1;
            
            console.log('checkCalc - Correct values:', correctValues);
            
            // If correctValues is a number, wrap it
            if (typeof correctValues === 'number') {
                correctValues = { answer: correctValues };
            }
            
            // For excel_grid type, get inputs from the grid
            if (q.type === 'excel_grid' && q.grid && q.grid.rows) {
                var allInputs = document.querySelectorAll('#excel-grid-container .excel-cell:not(.readonly)');
                console.log('Excel grid mode - found', allInputs.length, 'input cells');
                
                allInputs.forEach(function(inp) {
                    var cellId = inp.dataset.id;
                    if (!cellId) return;
                    
                    var userStr = inp.value.replace(/\s/g, '').replace(',', '.');
                    var user = parseFloat(userStr);
                    
                    // Find expected value
                    var expected = correctValues[cellId];
                    
                    console.log('Cell:', cellId, 'User:', user, 'Expected:', expected);
                    
                    if (expected !== undefined) {
                        var expectedNum = parseFloat(expected);
                        if (!isNaN(user) && !isNaN(expectedNum)) {
                            var diff = Math.abs(user - expectedNum);
                            var isOk = diff <= tol;
                            inp.classList.add(isOk ? 'correct' : 'incorrect');
                            if (!isOk) ok = false;
                        } else if (isNaN(user) && expectedNum !== 0) {
                            inp.classList.add('incorrect');
                            ok = false;
                        }
                    }
                });
                
                return ok;
            }
            
            // Standard input_fields handling
            var fields = q.input_fields || [{ id: 'answer', label: 'Svar' }];
            
            // If correctValues is an array, convert to object
            if (Array.isArray(correctValues)) {
                var temp = {};
                correctValues.forEach(function(v, i) {
                    if (fields[i]) temp[fields[i].id] = v;
                });
                correctValues = temp;
            }
            
            // Create flexible lookup map
            var valueMap = {};
            if (typeof correctValues === 'object') {
                Object.keys(correctValues).forEach(function(k) {
                    var v = correctValues[k];
                    if (typeof v === 'number' || typeof v === 'string') {
                        valueMap[k] = v;
                        valueMap[k.toLowerCase()] = v;
                        valueMap[k.replace(/_/g, '')] = v;
                        valueMap[k.replace(/_/g, '').toLowerCase()] = v;
                    }
                });
            }
            
            fields.forEach(function(f, idx) {
                var inp = document.getElementById('input-' + f.id);
                if (!inp) {
                    console.log('Input not found:', 'input-' + f.id);
                    return;
                }
                
                var userStr = inp.value.replace(/\s/g, '').replace(',', '.');
                var user = parseFloat(userStr);
                
                if (isNaN(user)) {
                    inp.classList.add('incorrect');
                    ok = false;
                    return;
                }
                
                // Find correct value
                var corr = null;
                if (valueMap[f.id] !== undefined) corr = valueMap[f.id];
                else if (valueMap[f.id.toLowerCase()] !== undefined) corr = valueMap[f.id.toLowerCase()];
                else if (Object.keys(correctValues).length === fields.length) {
                    var keys = Object.keys(correctValues);
                    corr = correctValues[keys[idx]];
                }
                else if (fields.length === 1 && Object.keys(correctValues).length >= 1) {
                    corr = correctValues[Object.keys(correctValues)[0]];
                }
                
                if (corr !== null && corr !== undefined) {
                    var corrNum = parseFloat(corr);
                    if (!isNaN(corrNum)) {
                        var tolerance = Math.max(tol, Math.abs(corrNum) * 0.01);
                        var diff = Math.abs(user - corrNum);
                        var isOk = diff <= tolerance;
                        inp.classList.add(isOk ? 'correct' : 'incorrect');
                        if (!isOk) ok = false;
                    }
                }
            });
            
            return ok;
        }
        
        function handleCorrect() {
            gameState.answeredCorrectly = true;
            gameState.answered[gameState.currentIndex] = true;
            gameState.correctCount++;
            gameState.score += Math.max(100 - gameState.hintsUsed * 25, 25);
            
            // Save the result
            var q = gameState.currentQuestion;
            var userAnswer = getUserAnswer(q);
            saveQuestionResult(q.id, true, userAnswer);
            saveProgress();
            
            document.getElementById('nav-score').textContent = gameState.score;
            document.getElementById('nav-correct').textContent = gameState.correctCount;
            document.getElementById('btn-explanation').style.display = 'inline-flex';
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-hint').style.display = 'none';
            document.getElementById('btn-next').style.display = 'inline-flex';
            
            renderQuestionSelector();
            if (gameState.answered.filter(Boolean).length === gameState.questions.length) {
                setTimeout(showResults, 1000);
            }
        }
        
        function handleIncorrect() {
            // Save incorrect attempt
            var q = gameState.currentQuestion;
            var userAnswer = getUserAnswer(q);
            saveQuestionResult(q.id, false, userAnswer);
            
            if (gameState.hintsUsed === 0) showHint();
            document.getElementById('btn-explanation').style.display = 'inline-flex';
        }
        
        function getUserAnswer(q) {
            if (q.type === 'multiple_choice' || q.type === 'mc' || q.type === 'true_false' || q.type === 'tf') {
                return gameState.selectedAnswer;
            } else {
                var fields = q.input_fields || [{ id: 'answer' }];
                var answers = {};
                fields.forEach(function(f) {
                    var inp = document.getElementById('input-' + f.id);
                    if (inp) answers[f.id] = inp.value;
                });
                return answers;
            }
        }
        
        // ==================== HINTS & EXPLANATIONS ====================
        function showHint() {
            var q = gameState.currentQuestion;
            document.getElementById('hint-text').textContent = 'Laster...';
            document.getElementById('hint-box').classList.add('visible');
            
            // Turso API returns hints as JSON array in question.hints
            var hints = q.hints || [];
            if (typeof hints === 'string') {
                try { hints = JSON.parse(hints); } catch(e) { hints = [hints]; }
            }
            
            if (gameState.hintsUsed >= hints.length) {
                document.getElementById('hint-text').textContent = 'Ingen flere hints.';
                document.getElementById('btn-hint').disabled = true;
                return;
            }
            
            var hint = hints[gameState.hintsUsed];
            document.getElementById('hint-text').textContent = typeof hint === 'string' ? hint : (hint.text || hint);
            gameState.hintsUsed++;
        }
        
        function closeHint() {
            document.getElementById('hint-box').classList.remove('visible');
        }
        
        function toggleExplanation() {
            var box = document.getElementById('explanation-box');
            if (box.classList.contains('visible')) {
                closeExplanation();
            } else {
                showExplanation();
            }
        }
        
        function showExplanation() {
            var q = gameState.currentQuestion;
            
            // Turso API returns explanation directly in question object
            var explanation = q.explanation || 'Ingen forklaring tilgjengelig.';
            document.getElementById('explanation-main').innerHTML = explanation.replace(/\n/g, '<br>');
            document.getElementById('explanation-box').classList.add('visible');
        }
        
        function closeExplanation() {
            document.getElementById('explanation-box').classList.remove('visible');
        }
        
        // ==================== NAVIGATION ====================
        function nextQuestion() {
            var next = gameState.currentIndex + 1;
            while (next < gameState.questions.length && gameState.answered[next]) next++;
            if (next >= gameState.questions.length) {
                for (var i = 0; i < gameState.questions.length; i++) {
                    if (!gameState.answered[i]) { next = i; break; }
                }
            }
            if (next < gameState.questions.length) loadQuestion(next);
            else showResults();
        }
        
        function showResults() {
            var pct = Math.round((gameState.correctCount / gameState.questions.length) * 100);
            
            // Save final progress to localStorage
            saveProgress();
            
            // TODO: Turso API progress saving kan legges til senere via /api/progress endpoint
            console.log('Results saved locally. Score:', gameState.score, 'Correct:', gameState.correctCount);
            
            document.getElementById('result-correct').textContent = gameState.correctCount;
            document.getElementById('result-total').textContent = gameState.questions.length;
            document.getElementById('result-percent').textContent = pct + '%';
            document.getElementById('result-icon').textContent = pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üìö';
            document.getElementById('result-title').textContent = pct >= 80 ? 'Fantastisk!' : pct >= 50 ? 'Bra jobbet!' : 'Fortsett √• √∏ve';
            document.getElementById('result-title').className = 'result-title ' + (pct >= 50 ? 'success' : 'error');
            document.getElementById('result-modal').classList.add('visible');
        }
        
        function restartGame() {
            document.getElementById('result-modal').classList.remove('visible');
            startGame(gameState.currentTopic);
        }
        
        function backToWelcome() {
            document.getElementById('result-modal').classList.remove('visible');
            document.getElementById('game-view').classList.remove('visible');
            document.getElementById('welcome-screen').style.display = 'flex';
            document.getElementById('progress-section').classList.remove('visible');
            document.getElementById('question-selector-section').classList.remove('visible');
            
            document.querySelectorAll('.topic-item').forEach(function(el) {
                el.classList.remove('active');
            });
            
            gameState.questions = [];
            gameState.allQuestions = [];
        }
        
        // ==================== PROGRESS SAVING ====================
        function saveProgress() {
            console.log('Saving progress...');
            
            var progressData = {
                topic: gameState.currentTopic,
                difficulty: gameState.currentDifficulty,
                score: gameState.score,
                correctCount: gameState.correctCount,
                totalQuestions: gameState.questions.length,
                answeredQuestions: gameState.answered.map(function(a, i) {
                    return a ? gameState.questions[i].id : null;
                }).filter(Boolean),
                lastUpdated: Date.now()
            };
            
            console.log('Progress data:', progressData);
            
            // Save to localStorage (Turso API progress kan legges til senere)
            saveToLocalStorage(progressData);
        }
        
        function saveToLocalStorage(data) {
            try {
                var key = 'acc_progress_' + data.topic;
                localStorage.setItem(key, JSON.stringify(data));
                console.log('Saved to localStorage:', key);
                
                // Also save overall stats
                var stats = JSON.parse(localStorage.getItem('cf_stats') || '{}');
                if (!stats[data.topic]) stats[data.topic] = {};
                stats[data.topic].bestScore = Math.max(stats[data.topic].bestScore || 0, data.score);
                stats[data.topic].totalAttempts = (stats[data.topic].totalAttempts || 0) + 1;
                stats[data.topic].lastPlayed = Date.now();
                localStorage.setItem('cf_stats', JSON.stringify(stats));
                console.log('Saved stats:', stats);
            } catch (e) {
                console.error('LocalStorage save failed:', e);
            }
        }
        
        function saveQuestionResult(questionId, isCorrect, userAnswer) {
            console.log('Saving question result:', questionId, isCorrect);
            
            // Save individual question result
            var result = {
                questionId: questionId,
                correct: isCorrect,
                answer: userAnswer,
                timestamp: Date.now(),
                hintsUsed: gameState.hintsUsed
            };
            
            // Save to localStorage
            try {
                var key = 'cf_answers_' + gameState.currentTopic;
                var answers = JSON.parse(localStorage.getItem(key) || '{}');
                answers[questionId] = result;
                localStorage.setItem(key, JSON.stringify(answers));
                console.log('Answer saved to localStorage:', key, result);
            } catch (e) {
                console.error('Answer save failed:', e);
            }
            
            // For now, we don't save individual answers to Turso API
            // because the main progress is tracked separately
        }
        
        function loadSavedProgress() {
            // Load from localStorage
            var stats = JSON.parse(localStorage.getItem('cf_stats') || '{}');
            if (Object.keys(stats).length > 0) {
                console.log('Loaded progress from localStorage:', stats);
                updateProgressDisplay(stats);
            }
        }
        
        function updateProgressDisplay(data) {
            // Update topic items with completion status
            topics.forEach(function(topic) {
                var topicData = data[topic.id];
                if (topicData && topicData.bestScore) {
                    var el = document.getElementById('topic-' + topic.id);
                    if (el) {
                        var countEl = el.querySelector('.topic-item-count');
                        if (countEl) {
                            var currentText = countEl.textContent;
                            countEl.innerHTML = currentText + ' <span style="color: var(--success);">‚òÖ ' + topicData.bestScore + '</span>';
                        }
                    }
                }
            });
        }
        var calcState = { equation: '', display: '0' };
        var calcDrag = { isDragging: false, offsetX: 0, offsetY: 0 };
        
        function initCalculatorDrag() {
            var calc = document.getElementById('floating-calculator');
            var header = document.querySelector('.calculator-header');
            
            header.addEventListener('mousedown', function(e) {
                calcDrag.isDragging = true;
                calcDrag.offsetX = e.clientX - calc.offsetLeft;
                calcDrag.offsetY = e.clientY - calc.offsetTop;
                calc.style.transition = 'none';
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!calcDrag.isDragging) return;
                e.preventDefault();
                var x = e.clientX - calcDrag.offsetX;
                var y = e.clientY - calcDrag.offsetY;
                
                // Keep within bounds
                x = Math.max(0, Math.min(x, window.innerWidth - calc.offsetWidth));
                y = Math.max(0, Math.min(y, window.innerHeight - calc.offsetHeight));
                
                calc.style.left = x + 'px';
                calc.style.top = y + 'px';
                calc.style.right = 'auto';
                calc.style.bottom = 'auto';
            });
            
            document.addEventListener('mouseup', function() {
                calcDrag.isDragging = false;
                document.getElementById('floating-calculator').style.transition = '';
            });
            
            // Touch support
            header.addEventListener('touchstart', function(e) {
                var touch = e.touches[0];
                calcDrag.isDragging = true;
                calcDrag.offsetX = touch.clientX - calc.offsetLeft;
                calcDrag.offsetY = touch.clientY - calc.offsetTop;
                calc.style.transition = 'none';
            });
            
            document.addEventListener('touchmove', function(e) {
                if (!calcDrag.isDragging) return;
                var touch = e.touches[0];
                var x = touch.clientX - calcDrag.offsetX;
                var y = touch.clientY - calcDrag.offsetY;
                
                x = Math.max(0, Math.min(x, window.innerWidth - calc.offsetWidth));
                y = Math.max(0, Math.min(y, window.innerHeight - calc.offsetHeight));
                
                calc.style.left = x + 'px';
                calc.style.top = y + 'px';
                calc.style.right = 'auto';
                calc.style.bottom = 'auto';
            });
            
            document.addEventListener('touchend', function() {
                calcDrag.isDragging = false;
                document.getElementById('floating-calculator').style.transition = '';
            });
        }
        
        function toggleCalculator() {
            var calc = document.getElementById('floating-calculator');
            calc.classList.toggle('visible');
            
            // Initialize drag on first open
            if (calc.classList.contains('visible') && !calcDrag.initialized) {
                initCalculatorDrag();
                calcDrag.initialized = true;
            }
        }
        
        // Kontoplan data
        var kontoplanData = {
            1: {
                title: 'Kontoklasse 1 ‚Äì Eiendeler',
                grupper: [
                    { title: 'Anleggsmidler', kontoer: [
                        { nr: '1000', navn: 'Forskning og utvikling' },
                        { nr: '1070', navn: 'Utsatt skattefordel' },
                        { nr: '1100', navn: 'Bygninger' },
                        { nr: '1150', navn: 'Tomter' },
                        { nr: '1200', navn: 'Maskiner' },
                        { nr: '1230', navn: 'Biler' },
                        { nr: '1250', navn: 'Inventar og kontormaskiner' },
                        { nr: '1300', navn: 'Investeringer i datterselskaper' }
                    ]},
                    { title: 'Oml√∏psmidler', kontoer: [
                        { nr: '1400', navn: 'R√•varer/materialer' },
                        { nr: '1420', navn: 'Varer i arbeid' },
                        { nr: '1440', navn: 'Ferdigvarer' },
                        { nr: '1460', navn: 'Innkj√∏pte varer for videresalg' },
                        { nr: '1500', navn: 'Kundefordringer' },
                        { nr: '1570', navn: 'Andre kortsiktige fordringer' },
                        { nr: '1580', navn: 'Avsetning tap p√• fordringer' },
                        { nr: '1700', navn: 'Forskuddsbetalt leie' },
                        { nr: '1720', navn: 'Forskuddsbetalt forsikring' },
                        { nr: '1810', navn: 'B√∏rsnoterte aksjer' },
                        { nr: '1900', navn: 'Kontanter' },
                        { nr: '1920', navn: 'Bankinnskudd' },
                        { nr: '1950', navn: 'Bankinnskudd skattetrekk' }
                    ]}
                ]
            },
            2: {
                title: 'Kontoklasse 2 ‚Äì Egenkapital og gjeld',
                grupper: [
                    { title: 'Egenkapital', kontoer: [
                        { nr: '2000', navn: 'Aksjekapital' },
                        { nr: '2020', navn: 'Overkurs' },
                        { nr: '2030', navn: 'Annen innskutt egenkapital' },
                        { nr: '2050', navn: 'Annen egenkapital' },
                        { nr: '2080', navn: 'Udekket tap' }
                    ]},
                    { title: 'Langsiktig gjeld', kontoer: [
                        { nr: '2120', navn: 'Utsatt skatt' },
                        { nr: '2220', navn: 'Gjeld til kredittinstitusjoner' },
                        { nr: '2240', navn: 'Pantel√•n' },
                        { nr: '2250', navn: 'Gjeld til konsernselskap' }
                    ]},
                    { title: 'Kortsiktig gjeld', kontoer: [
                        { nr: '2400', navn: 'Leverand√∏rgjeld' },
                        { nr: '2500', navn: 'Betalbar skatt' },
                        { nr: '2600', navn: 'Forskuddstrekk/Skattetrekk' },
                        { nr: '2700', navn: 'Utg√•ende merverdiavgift' },
                        { nr: '2710', navn: 'Inng√•ende merverdiavgift' },
                        { nr: '2740', navn: 'Oppgj√∏rskonto merverdiavgift' },
                        { nr: '2770', navn: 'Skyldig arbeidsgiveravgift' },
                        { nr: '2780', navn: 'P√•l√∏pt l√∏nn' },
                        { nr: '2900', navn: 'Annen kortsiktig gjeld' },
                        { nr: '2930', navn: 'Skyldig l√∏nn' },
                        { nr: '2960', navn: 'P√•l√∏pte feriepenger' }
                    ]}
                ]
            },
            3: {
                title: 'Kontoklasse 3 ‚Äì Driftsinntekter',
                grupper: [
                    { title: 'Salgsinntekter', kontoer: [
                        { nr: '3000', navn: 'Salgsinntekt varer, avgiftspliktig' },
                        { nr: '3050', navn: 'Vederlagsinntekt, avgiftspliktig' },
                        { nr: '3100', navn: 'Salgsinntekt, avgiftsfri' },
                        { nr: '3510', navn: 'Opptjent garanti-/serviceinntekt' },
                        { nr: '3600', navn: 'Husleieinntekt' },
                        { nr: '3800', navn: 'Gevinst avgang anleggsmidler' },
                        { nr: '3900', navn: 'Andre driftsinntekter' }
                    ]}
                ]
            },
            4: {
                title: 'Kontoklasse 4 ‚Äì Varekostnader',
                grupper: [
                    { title: 'Varekj√∏p og beholdningsendring', kontoer: [
                        { nr: '4000', navn: 'Innkj√∏p av r√•varer' },
                        { nr: '4090', navn: 'Beholdningsendring r√•varer' },
                        { nr: '4190', navn: 'Beholdningsendring varer i arbeid' },
                        { nr: '4290', navn: 'Beholdningsendring ferdigvarer' },
                        { nr: '4300', navn: 'Innkj√∏p varer for videresalg' },
                        { nr: '4360', navn: 'Frakt og toll vedr. varer' },
                        { nr: '4390', navn: 'Beholdningsendring varer for videresalg' }
                    ]}
                ]
            },
            5: {
                title: 'Kontoklasse 5 ‚Äì L√∏nnskostnader',
                grupper: [
                    { title: 'L√∏nn og sosiale kostnader', kontoer: [
                        { nr: '5000', navn: 'L√∏nn' },
                        { nr: '5180', navn: 'Feriepenger' },
                        { nr: '5400', navn: 'Arbeidsgiveravgift' },
                        { nr: '5410', navn: 'Arbeidsgiveravgift p√• feriepenger' },
                        { nr: '5900', navn: 'Andre personalkostnader' }
                    ]}
                ]
            },
            6: {
                title: 'Kontoklasse 6 og 7 ‚Äì Andre driftskostnader',
                grupper: [
                    { title: 'Avskrivninger', kontoer: [
                        { nr: '6000', navn: 'Avskrivning bygninger' },
                        { nr: '6010', navn: 'Avskrivning andre anleggsmidler' },
                        { nr: '6050', navn: 'Nedskrivning anleggsmidler' }
                    ]},
                    { title: 'Andre driftskostnader', kontoer: [
                        { nr: '6100', navn: 'Frakt, transport' },
                        { nr: '6200', navn: 'Leie av lokaler' },
                        { nr: '6300', navn: 'Leie av maskiner/inventar' },
                        { nr: '6400', navn: 'Verkt√∏y' },
                        { nr: '6500', navn: 'Rekvisita' },
                        { nr: '6700', navn: 'Reparasjon og vedlikehold' },
                        { nr: '6800', navn: 'Kontorutstyr' },
                        { nr: '6900', navn: 'Telefon' },
                        { nr: '7000', navn: 'Reisekostnader' },
                        { nr: '7100', navn: 'Bilkostnader' },
                        { nr: '7400', navn: 'Forsikring' },
                        { nr: '7500', navn: 'Tap p√• fordringer' },
                        { nr: '7700', navn: 'Bankkostnader' },
                        { nr: '7800', navn: 'Tap avgang anleggsmidler' }
                    ]}
                ]
            },
            8: {
                title: 'Kontoklasse 8 ‚Äì Finansposter og skatt',
                grupper: [
                    { title: 'Finansinntekter', kontoer: [
                        { nr: '8050', navn: 'Renteinntekt' },
                        { nr: '8060', navn: 'Valutagevinst' },
                        { nr: '8070', navn: 'Annen finansinntekt' },
                        { nr: '8080', navn: 'Verdi√∏kning aksjer' }
                    ]},
                    { title: 'Finanskostnader', kontoer: [
                        { nr: '8100', navn: 'Verdireduksjon aksjer' },
                        { nr: '8150', navn: 'Rentekostnad' },
                        { nr: '8160', navn: 'Valutatap' },
                        { nr: '8170', navn: 'Annen finanskostnad' }
                    ]},
                    { title: 'Skatt og disponering', kontoer: [
                        { nr: '8300', navn: 'Betalbar skatt' },
                        { nr: '8320', navn: 'Endring utsatt skatt' },
                        { nr: '8800', navn: '√Örsresultat' },
                        { nr: '8920', navn: 'Avsatt utbytte' },
                        { nr: '8960', navn: 'Overf√∏ring annen egenkapital' }
                    ]}
                ]
            }
        };
        
        function toggleKontoplan() {
            var modal = document.getElementById('kontoplan-modal');
            modal.classList.toggle('visible');
            if (modal.classList.contains('visible')) {
                showKontoklasse(1);
            }
        }
        
        function showKontoklasse(nr) {
            // Update tabs
            document.querySelectorAll('.kontoplan-tab').forEach(function(tab, i) {
                tab.classList.toggle('active', i + 1 === nr || (nr === 6 && i === 5));
            });
            
            var data = kontoplanData[nr];
            if (!data) return;
            
            var html = '<h3 style="color: var(--accent); margin-bottom: 12px;">' + data.title + '</h3>';
            
            data.grupper.forEach(function(gruppe) {
                html += '<div class="konto-gruppe">';
                html += '<div class="konto-gruppe-title">' + gruppe.title + '</div>';
                gruppe.kontoer.forEach(function(konto) {
                    html += '<div class="konto-item">';
                    html += '<span class="konto-nummer">' + konto.nr + '</span>';
                    html += '<span class="konto-navn">' + konto.navn + '</span>';
                    html += '</div>';
                });
                html += '</div>';
            });
            
            document.getElementById('kontoplan-body').innerHTML = html;
        }
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                var modal = document.getElementById('kontoplan-modal');
                if (modal.classList.contains('visible')) {
                    toggleKontoplan();
                }
            }
        });
        
        function calcInput(v) {
            calcState.display = calcState.display === '0' && v !== '.' ? v : calcState.display + v;
            document.getElementById('calc-result').textContent = calcState.display;
        }
        
        function calcClear() {
            calcState.display = '0';
            calcState.equation = '';
            document.getElementById('calc-result').textContent = '0';
            document.getElementById('calc-equation').textContent = '';
        }
        
        function calcEquals() {
            try {
                var r = eval(calcState.display.replace(/√ó/g, '*').replace(/‚àí/g, '-').replace(/\^/g, '**'));
                calcState.equation = calcState.display + ' =';
                calcState.display = Math.round(r * 10000) / 10000 + '';
            } catch (e) {
                calcState.display = 'Error';
            }
            document.getElementById('calc-equation').textContent = calcState.equation;
            document.getElementById('calc-result').textContent = calcState.display;
        }
        
        function calcFunction(fn) {
            var v = parseFloat(calcState.display) || 0;
            if (fn === 'sqrt') calcState.display = Math.round(Math.sqrt(v) * 10000) / 10000 + '';
            else if (fn === 'pv' || fn === 'fv') {
                var r = parseFloat(prompt('Rente (f.eks. 0.10):')), n = parseFloat(prompt('Perioder:'));
                if (!isNaN(r) && !isNaN(n)) calcState.display = Math.round((fn === 'pv' ? 1 / Math.pow(1 + r, n) : Math.pow(1 + r, n)) * 10000) / 10000 + '';
            }
            document.getElementById('calc-result').textContent = calcState.display;
        }
        
        // ==================== UTILS ====================
        function shuffleArray(a) {
            var b = a.slice();
            for (var i = b.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = b[i]; b[i] = b[j]; b[j] = t;
            }
            return b;
        }
        
        function formatNumber(n) {
            return typeof n === 'number' ? n.toLocaleString('nb-NO') : (Array.isArray(n) ? n.join(', ') : n);
        }
        
        function formatLabel(k) {
            return k.replace(/_/g, ' ').replace(/([A-Z])/g, ' $1').replace(/^./, function(s) { return s.toUpperCase(); });
        }
    </script>
</body>
</html>
