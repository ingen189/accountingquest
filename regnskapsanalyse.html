<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regnskapsanalyse - AccountingQuest</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <meta name="theme-color" content="#0f1419">

        
    <!-- External CSS -->
    <link rel="stylesheet" href="css/main.css">
    
    <style>
        /* ===== PAGE SPECIFIC STYLES ===== */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Top Navigation Bar */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: var(--border-color);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .back-btn:hover {
            background: #374151;
        }

        .wiki-btn {
            background: linear-gradient(135deg, var(--warning), #d97706);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wiki-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .module-name {
            color: var(--accent);
            font-size: 0.9em;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .nav-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .nav-stat-label {
            color: var(--text-secondary);
        }

        .nav-stat-value {
            color: var(--accent);
            font-weight: bold;
        }

        .theme-toggle {
            background: var(--border-color);
            border: none;
            color: var(--warning);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: #374151;
        }

        /* Progress Bar */
        .progress-section {
            padding: 20px 30px;
            background: var(--bg-secondary);
        }

        .progress-bar-container {
            background: var(--bg-primary);
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--info));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* Task Tabs */
        .task-tabs {
            display: flex;
            gap: 10px;
            padding: 0 30px 20px;
            background: var(--bg-secondary);
        }

        .task-tab {
            padding: 12px 24px;
            background: var(--border-color);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-tab:hover {
            background: #374151;
        }

        .task-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .task-tab.completed {
            background: var(--accent-hover);
            color: var(--bg-primary);
        }

        /* Workspace - Full width */
        .workspace {
            padding: 30px;
            overflow-y: auto;
            background: var(--bg-primary);
            min-height: calc(100vh - 180px);
            max-width: 1200px;
            margin: 0 auto;
        }

        .workspace::-webkit-scrollbar {
            width: 10px;
        }

        .workspace::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 5px;
        }

        .workspace::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        .task-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .task-title {
            font-size: 1.8em;
            color: var(--accent);
            margin-bottom: 15px;
        }

        .task-description {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            border-left: 4px solid var(--accent);
            color: var(--text-primary);
        }

        /* Spreadsheet */
        .spreadsheet-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .excel-grid-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            background: var(--bg-primary);
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .excel-table th {
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 12px;
            border: 1px solid #374151;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .excel-table td {
            border: 1px solid #374151;
            padding: 0;
        }

        .excel-table td.row-number {
            background: var(--border-color);
            color: var(--text-secondary);
            text-align: center;
            font-weight: bold;
            padding: 12px;
            font-size: 0.9em;
            width: 50px;
        }

        .cell-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .excel-cell {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            padding: 12px;
            font-size: 0.95em;
            font-family: 'Consolas', 'Monaco', monospace;
            text-align: right;
            outline: none;
            transition: background 0.2s;
        }

        .excel-cell:focus {
            outline: 2px solid var(--accent);
            background: rgba(74, 222, 128, 0.05);
            z-index: 5;
        }

        .excel-cell:hover {
            background: rgba(255,255,255,0.03);
        }

        .excel-cell.readonly {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .excel-cell.account-cell {
            text-align: left;
        }

        .excel-cell.correct {
            background: rgba(74, 222, 128, 0.2) !important;
        }

        .excel-cell.incorrect {
            background: rgba(239, 68, 68, 0.2) !important;
        }

        /* Fill Handle */
        .fill-handle {
            position: absolute;
            right: 1px;
            bottom: 1px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border: 2px solid var(--bg-primary);
            border-radius: 50%;
            cursor: crosshair;
            z-index: 25;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            transition: all 0.2s ease;
        }

        .fill-handle:hover {
            width: 14px;
            height: 14px;
            right: -1px;
            bottom: -1px;
            background: #5ef77c;
            box-shadow: 0 3px 8px rgba(74, 222, 128, 0.8);
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: #3bc46e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
        }

        .btn-secondary {
            background: var(--warning);
            color: white;
        }

        .btn-secondary:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-tertiary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-tertiary:hover {
            background: #374151;
        }

        .btn-next {
            background: var(--info);
            color: white;
        }

        .btn-next:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Hint Box */
        .hint-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--warning);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .hint-box.visible {
            display: block;
        }

        .hint-box strong {
            color: var(--warning);
        }

        .hint-box code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent);
        }

        /* Feedback */
        .feedback {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .feedback.show { display: block; }
        .feedback.correct { border-color: var(--accent); color: var(--accent); background: rgba(74, 222, 128, 0.1); }
        .feedback.incorrect { border-color: var(--error); color: var(--error); background: rgba(239, 68, 68, 0.1); }

        /* Responsive */
        @media (max-width: 768px) {
            .top-nav {
                padding: 10px 15px;
                flex-wrap: wrap;
            }
            .nav-right {
                gap: 15px;
            }
            .workspace {
                padding: 20px 15px;
            }
            .task-tabs {
                padding: 0 15px 15px;
                flex-wrap: wrap;
            }
            .controls {
                flex-direction: column;
            }
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    
    </style>

</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <div class="nav-left">
            <button class="back-btn" onclick="backToMenu()">‚Üê Tilbake</button>
            <button class="wiki-btn" onclick="openWiki()">üìö Wiki</button>
            <span class="module-name">Modul: Regnskapsanalyse</span>
        </div>
        <div class="nav-right">
            <div class="nav-stat">
                <span class="nav-stat-label">Oppgave:</span>
                <span class="nav-stat-value"><span id="current-task">1</span>/4</span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-label">Fullf√∏rt:</span>
                <span class="nav-stat-value" id="completed-count">0</span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-label">Poeng:</span>
                <span class="nav-stat-value" id="score">0</span>
            </div>
            <button class="theme-toggle">üåô</button>
        </div>
    </div>

    <!-- Progress Section -->
    <div class="progress-section">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar" style="width: 0%">0%</div>
        </div>
    </div>

    <!-- Task Tabs -->
    <div class="task-tabs" id="task-tabs"></div>

    <!-- Workspace -->
    <div class="workspace">
        <div id="task-content"></div>

        <div class="hint-box" id="hint-box">
            <strong>üí° Hint:</strong>
            <div id="hint-content"></div>
        </div>

        <div class="feedback" id="feedback"></div>
    </div>

    <script>
        const tasks = [
            {
                id: 1, title: "Oppgave 1: Horisontal analyse",
                description: "Analyser utviklingen fra 20x4 til 20x5. Fyll inn endring i kr og prosentvis endring.",
                headers: ["#", "Post", "20x5 (B)", "20x4 (C)", "Endring kr (D)", "Endring % (E)"],
                rows: [
                    { label: "Driftsinntekter", given: [30000, 27000, null, null] },
                    { label: "Varekostnad", given: [-15000, -14000, null, null] },
                    { label: "L√∏nnskostnad", given: [-5000, -4200, null, null] },
                    { label: "Andre driftskostnader", given: [-3000, -2800, null, null] },
                    { label: "Driftsresultat", given: [7000, 6000, null, null] },
                    { label: "Finanskostnader", given: [-500, -400, null, null] },
                    { label: "Resultat f√∏r skatt", given: [6500, 5600, null, null] }
                ],
                solution: [[3000, 11.11], [-1000, 7.14], [-800, 19.05], [-200, 7.14], [1000, 16.67], [-100, 25.00], [900, 16.07]],
                hint: "Endring i kr = <code>=B1-C1</code><br>Endring i % = <code>=(D1/ABS(C1))*100</code>"
            },
            {
                id: 2, title: "Oppgave 2: Vertikal analyse",
                description: "Beregn hver posts andel av omsetningen (driftsinntekter).",
                headers: ["#", "Post", "20x5 (B)", "% av oms. (C)", "20x4 (D)", "% av oms. (E)"],
                rows: [
                    { label: "Driftsinntekter", given: [30000, null, 27000, null] },
                    { label: "Varekostnad", given: [-15000, null, -14000, null] },
                    { label: "L√∏nnskostnad", given: [-5000, null, -4200, null] },
                    { label: "Andre driftskostnader", given: [-3000, null, -2800, null] },
                    { label: "Driftsresultat", given: [7000, null, 6000, null] }
                ],
                solution: [[100, 100], [50, 51.85], [16.67, 15.56], [10, 10.37], [23.33, 22.22]],
                hint: "% av omsetning = <code>=ABS(B2)/B$1*100</code>"
            },
            {
                id: 3, title: "Oppgave 3: N√∏kkeltall",
                description: "Beregn ROE og likviditetsgrad 1.",
                headers: ["#", "Post", "Verdi (B)", "Resultat (C)"],
                rows: [
                    { label: "√Örsresultat", given: [80000, null] },
                    { label: "Egenkapital", given: [500000, null] },
                    { label: "ROE (%)", given: [null, null] },
                    { label: "---", given: [null, null] },
                    { label: "Oml√∏psmidler", given: [800000, null] },
                    { label: "Kortsiktig gjeld", given: [500000, null] },
                    { label: "Likviditetsgrad 1", given: [null, null] }
                ],
                solution: [[null], [null], [16], [null], [null], [null], [1.6]],
                hint: "ROE = <code>=(B1/B2)*100</code><br>Likviditetsgrad = <code>=B5/B6</code>"
            },
            {
                id: 4, title: "Oppgave 4: Sammenligning",
                description: "Beregn endring i n√∏kkeltall fra 20x4 til 20x5.",
                headers: ["#", "N√∏kkeltall", "20x5 (B)", "20x4 (C)", "Endring (D)"],
                rows: [
                    { label: "Likviditetsgrad 1", given: [2.1, 1.8, null] },
                    { label: "Egenkapitalandel (%)", given: [45, 40, null] },
                    { label: "ROE (%)", given: [18, 15, null] },
                    { label: "Gjeldsgrad", given: [1.2, 1.5, null] }
                ],
                solution: [[0.3], [5], [3], [-0.3]],
                hint: "Endring = <code>=B1-C1</code>"
            }
        ];

        let gameState = { currentTask: 0, completedTasks: [], score: 0 };

        function init() {
            renderTaskTabs();
            loadTask(0);
            loadProgress();
        }

        function renderTaskTabs() {
            document.getElementById('task-tabs').innerHTML = tasks.map((t, i) => 
                `<button class="task-tab ${i === gameState.currentTask ? 'active' : ''} ${gameState.completedTasks.includes(t.id) ? 'completed' : ''}" onclick="loadTask(${i})">${i + 1}. ${t.title.split(': ')[1]}</button>`
            ).join('');
        }

        function loadTask(index) {
            gameState.currentTask = index;
            const task = tasks[index];
            document.getElementById('current-task').textContent = index + 1;
            renderTaskTabs();
            updateProgress();

            document.getElementById('task-content').innerHTML = `
                <div class="task-header">
                    <div class="task-title">${task.title}</div>
                    <div class="task-description">${task.description}</div>
                </div>

                <div class="spreadsheet-container">
                    <div class="excel-grid-wrapper">
                        <table class="excel-table">
                            <thead><tr>${task.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody id="spreadsheet-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="checkAnswer()">‚úì Sjekk svar</button>
                    <button class="btn btn-secondary" onclick="showHint()">üí° Hint</button>
                    <button class="btn btn-tertiary" onclick="clearAllInputs()">üóë T√∏m svar</button>
                    <button class="btn btn-next" id="next-btn" onclick="nextTask()" style="display:none;">Neste ‚Üí</button>
                </div>
            `;

            const tbody = document.getElementById('spreadsheet-body');
            task.rows.forEach((row, ri) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="row-number">${ri + 1}</td><td><input type="text" class="excel-cell account-cell" value="${row.label}" readonly></td>` +
                    row.given.map((val, ci) => `<td><div class="cell-wrapper"><input type="text" class="excel-cell ${val !== null ? 'readonly' : ''}" value="${val !== null ? val : ''}" ${val !== null ? 'readonly' : ''} data-row="${ri}" data-col="${ci}" placeholder="?" onkeydown="handleKey(event,this)" onblur="handleFormula(this)">${val === null ? '<div class="fill-handle"></div>' : ''}</div></td>`).join('');
                tbody.appendChild(tr);
            });

            document.getElementById('feedback').className = 'feedback';
            document.getElementById('hint-box').classList.remove('visible');
        }

        function handleKey(e, cell) {
            if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Tab','Enter'].includes(e.key)) {
                e.preventDefault();
                if (e.key === 'Enter') handleFormula(cell);
                const wrapper = cell.closest('.cell-wrapper');
                const td = wrapper ? wrapper.parentElement : cell.parentElement;
                const tr = td.parentElement;
                const ci = Array.from(tr.children).indexOf(td);
                let target;
                if (e.key === 'ArrowRight' || (e.key === 'Tab' && !e.shiftKey)) target = td.nextElementSibling?.querySelector('.excel-cell:not([readonly])');
                else if (e.key === 'ArrowLeft' || (e.key === 'Tab' && e.shiftKey)) target = td.previousElementSibling?.querySelector('.excel-cell:not([readonly])');
                else if (e.key === 'ArrowDown' || e.key === 'Enter') target = tr.nextElementSibling?.children[ci]?.querySelector('.excel-cell:not([readonly])');
                else if (e.key === 'ArrowUp') target = tr.previousElementSibling?.children[ci]?.querySelector('.excel-cell:not([readonly])');
                if (target) target.focus();
            }
        }

        function handleFormula(cell) {
            const val = cell.value.trim();
            if (!val.startsWith('=')) return;
            try {
                let formula = val.substring(1).replace(/([A-Z])(\d+)/gi, (m, col, row) => {
                    const c = col.toUpperCase().charCodeAt(0) - 65;
                    const r = parseInt(row) - 1;
                    const target = document.getElementById('spreadsheet-body').children[r]?.children[c + 2]?.querySelector('.excel-cell');
                    return target ? (parseFloat(target.value) || 0) : 0;
                }).replace(/ABS\(([^)]+)\)/gi, 'Math.abs($1)');
                const result = eval(formula);
                if (!isNaN(result)) { cell.dataset.formula = val; cell.dataset.result = result; cell.value = result.toFixed(2); }
            } catch(e) {}
        }

        function checkAnswer() {
            const task = tasks[gameState.currentTask];
            let correct = 0, total = 0, allFilled = true;
            document.querySelectorAll('.excel-cell:not([readonly]):not(.account-cell)').forEach(c => c.classList.remove('correct', 'incorrect'));
            task.rows.forEach((row, ri) => {
                let si = 0;
                row.given.forEach((val, ci) => {
                    if (val === null) {
                        const expected = task.solution[ri]?.[si];
                        if (expected === null || expected === undefined) { si++; return; }
                        total++;
                        const cell = document.getElementById('spreadsheet-body').children[ri]?.children[ci + 2]?.querySelector('.excel-cell');
                        if (!cell || cell.value.trim() === '') { allFilled = false; si++; return; }
                        const userVal = parseFloat(cell.dataset.result || cell.value) || 0;
                        if (Math.abs(userVal - expected) <= Math.abs(expected) * 0.02 || Math.abs(userVal - expected) <= 0.01) { correct++; cell.classList.add('correct'); }
                        else cell.classList.add('incorrect');
                        si++;
                    }
                });
            });
            const fb = document.getElementById('feedback');
            if (!allFilled) { fb.className = 'feedback incorrect show'; fb.textContent = '‚ö†Ô∏è Fyll inn alle celler f√∏rst!'; return; }
            if (correct === total) {
                gameState.score += 10;
                if (!gameState.completedTasks.includes(task.id)) gameState.completedTasks.push(task.id);
                fb.className = 'feedback correct show'; fb.textContent = 'üéâ Riktig! Flott jobbet!';
                document.getElementById('next-btn').style.display = 'inline-flex';
                updateProgress();
                renderTaskTabs();
            } else { fb.className = 'feedback incorrect show'; fb.textContent = `‚úó ${correct}/${total} riktige. Pr√∏v igjen!`; }
            updateStats(); saveProgress();
        }

        function clearAllInputs() {
            document.querySelectorAll('.excel-cell:not([readonly]):not(.account-cell)').forEach(c => { c.value = ''; c.classList.remove('correct', 'incorrect'); delete c.dataset.formula; delete c.dataset.result; });
            document.getElementById('feedback').className = 'feedback';
        }

        function showHint() { document.getElementById('hint-content').innerHTML = tasks[gameState.currentTask].hint; document.getElementById('hint-box').classList.add('visible'); }
        function nextTask() { if (gameState.currentTask + 1 < tasks.length) loadTask(gameState.currentTask + 1); }
        function updateStats() { document.getElementById('completed-count').textContent = gameState.completedTasks.length; document.getElementById('score').textContent = gameState.score; }
        function updateProgress() { const pct = (gameState.completedTasks.length / tasks.length) * 100; document.getElementById('progress-bar').style.width = pct + '%'; document.getElementById('progress-bar').textContent = Math.round(pct) + '%'; }
        function backToMenu() { saveProgress(); window.location.href = 'index.html'; }
        function openWiki() { window.open('wiki.html', '_blank'); }
        function saveProgress() { localStorage.setItem('regnskapsanalyse_progress', JSON.stringify({ completedTasks: gameState.completedTasks, score: gameState.score })); }
        function loadProgress() { const s = localStorage.getItem('regnskapsanalyse_progress'); if (s) { const p = JSON.parse(s); gameState.completedTasks = p.completedTasks || []; gameState.score = p.score || 0; updateStats(); updateProgress(); renderTaskTabs(); }}
        window.onload = init;
    </script>
    
    <!-- Theme Manager -->
    <script src="js/theme-manager.js"></script>
    <script>
        if (typeof ThemeManager !== 'undefined') {
            ThemeManager.init();
        }
    </script>
</body>
</html>
